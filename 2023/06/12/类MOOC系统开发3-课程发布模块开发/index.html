<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>类MOOC系统开发3-课程发布模块开发 | tのblog</title><meta name="author" content="taotaozi"><meta name="copyright" content="taotaozi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="模块功能介绍1、（机构段）课程预览 2、（平台端）课程审核（机构请求发布，自动审核，后台审核—&gt;发布成功）发布成功，用户端可查看发布的课程 3、（用户端）查看发布课程 课程预览课程预览是一个单独的门户页面 结构  说明如下： 1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。 2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏">
<meta property="og:type" content="article">
<meta property="og:title" content="类MOOC系统开发3-课程发布模块开发">
<meta property="og:url" content="https://differencer.github.io/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="tのblog">
<meta property="og:description" content="模块功能介绍1、（机构段）课程预览 2、（平台端）课程审核（机构请求发布，自动审核，后台审核—&gt;发布成功）发布成功，用户端可查看发布的课程 3、（用户端）查看发布课程 课程预览课程预览是一个单独的门户页面 结构  说明如下： 1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。 2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png">
<meta property="article:published_time" content="2023-06-12T05:35:38.000Z">
<meta property="article:modified_time" content="2023-06-15T00:32:53.179Z">
<meta property="article:author" content="taotaozi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://differencer.github.io/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '类MOOC系统开发3-课程发布模块开发',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-15 08:32:53'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png')"><nav id="nav"><span id="blog-info"><a href="/" title="tのblog"><span class="site-name">tのblog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">类MOOC系统开发3-课程发布模块开发</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-12T05:35:38.000Z" title="发表于 2023-06-12 13:35:38">2023-06-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-15T00:32:53.179Z" title="更新于 2023-06-15 08:32:53">2023-06-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">21.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>82分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="类MOOC系统开发3-课程发布模块开发"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="模块功能介绍"><a href="#模块功能介绍" class="headerlink" title="模块功能介绍"></a>模块功能介绍</h1><p>1、（机构段）课程预览</p>
<p>2、（平台端）课程审核（机构请求发布，自动审核，后台审核—&gt;发布成功）发布成功，用户端可查看发布的课程</p>
<p>3、（用户端）查看发布课程</p>
<h1 id="课程预览"><a href="#课程预览" class="headerlink" title="课程预览"></a>课程预览</h1><p>课程预览是一个单独的门户页面</p>
<p>结构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612134810185.png" alt="image-20230612134810185"></p>
<p>说明如下：</p>
<p>1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。</p>
<p>2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。</p>
<p>3、通过课程预览页面点击”马上学习“打开视频播放页面。</p>
<p>4、视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资服务查询课程计划绑定的视频文件地址，在线浏览播放视频。</p>
<h2 id="模板引擎Freemarker"><a href="#模板引擎Freemarker" class="headerlink" title="模板引擎Freemarker"></a>模板引擎Freemarker</h2><p>可以看到，根据前边的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致。</p>
<p>项目采用模板引擎技术实现课程预览界面。什么是模板引擎？</p>
<p>早期我们采用的jsp技术就是一种模板引擎技术，简单来说就是通过jsp浏览的页面的框架以及搭好，需要后端渲染（渲染的过程就是填充数据-模型的过程）</p>
<p>所以模板引擎就是：模板+数据=输出，<strong>Jsp页面就是模板</strong>，页面中嵌入的<strong>jsp标签就是数据</strong>（模型），两者相结合输出html网页。</p>
<p>可以说<strong>这种模式就不是前后端分离了，后端直接返回的是整个界面</strong>。</p>
<p>常用的java模板引擎还有哪些？</p>
<p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p>
<p>本项目采用Freemarker作为模板引擎技术。</p>
<p>Freemarker官方地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/">http://freemarker.foofun.cn/</a></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>在<strong>内容管理接口工层</strong> 添加Freemarker与SpringBoot的整合包</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-freemarker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在nacos为内容管理接口层配置freemarker，公用配置组新加一个freemarker-config-dev.yaml (资料中已做)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612140736811.png" alt="image-20230612140736811"></p>
<p>那么现在就是看配置信息：</p>
<p>template-loader-path: classpath:/templates/   #页面模板位置(默认为 classpath:/templates/)</p>
<p>这里规定了模板加载（存放）的位置，类路径也就是resources路径，那么我们再这个路径下新建templates文件夹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612140927653.png" alt="image-20230612140927653" style="zoom:50%;" /></p>
<p>再微服务的配置文件中引入 freemarker-config-dev.yaml  配置，则：</p>
<p>在内容管理的api工程中引入共享配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612141058408.png" alt="image-20230612141058408"></p>
<h3 id="添加模板"><a href="#添加模板" class="headerlink" title="添加模板"></a>添加模板</h3><p>添加模板，在resources下创建templates目录，添加test.ftl模板文件</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
Hello $&#123;name&#125;!
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="填充数据"><a href="#填充数据" class="headerlink" title="填充数据"></a>填充数据</h3><p>编写controller方法，准备模型数据</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreemarkerController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testfreemarker"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置模型数据</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"小明"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置模板名称</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刚才的模板名称</span>
        <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>启动内容管理接口工程，访问<a target="_blank" rel="noopener" href="http://localhost:63040/content/testfreemarker">http://localhost:63040/content/testfreemarker</a></p>
<p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612143206866.png" alt="image-20230612143206866"></p>
<p>成功</p>
<h2 id="静态资源"><a href="#静态资源" class="headerlink" title="静态资源"></a>静态资源</h2><h3 id="配置主站"><a href="#配置主站" class="headerlink" title="配置主站"></a>配置主站</h3><p>在课程预览界面上要加载css、js、图片等内容，这里部署nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求，如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/admin/AppData/Roaming/Typora/typora-user-images/image-20230612183230186.png" alt="image-20230612183230186" style="zoom: 50%;" /></p>
<ol>
<li><p>本机安装Nginx，直接用黑马提供的资料</p>
</li>
<li><p>运行nginx.exe，访问localhost，可以看到Nginx默认页面则启动成功（若失败，请检查是否存在中文目录或者端口占用情况）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612184506591.png" alt="image-20230612184506591"></p>
</li>
<li><p>前端资源：解压黑马提供的xc-ui-pc-static-portal.zip文件，并记录解压的位置，在第5步修改Nginx配置时，需要指定其所在目录</p>
</li>
<li><p>现在我们要实现：输入域名能够访问门户网址，这其实还涉及了 DNS解析，为了演示，我们仅修改host文件：</p>
<p>这就相当于一个简单的DNS过程，当浏览器访问上面的几个网址时，全部将域名解析为本地主机</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612185253407.png" alt="image-20230612185253407"></p>
</li>
<li><p>在Nginx的conf/nginx.conf文件中配置如下内容</p>
<p>解释 ：一个server相当于一个虚拟主机</p>
<p>是主机就需要配置域名，如果什么都不配置，代理的就是localhost 端口</p>
<p>配置生效：方法1、进入任务管理器，杀死nginx的两个进程 重启  方法 2、命令行 nginx.exe -s reload</p>
</li>
</ol>
<ul>
<li>server_name www.51xuecheng.cn localhost;  </li>
<li><h1 id="浏览器访问任意一个域名都能进入nignx-请求网站资源"><a href="#浏览器访问任意一个域名都能进入nignx-请求网站资源" class="headerlink" title="浏览器访问任意一个域名都能进入nignx 请求网站资源"></a>浏览器访问任意一个域名都能进入nignx 请求网站资源</h1></li>
<li><h1 id="默认输入域名后访问的时nignx-目录下-html-下的资源"><a href="#默认输入域名后访问的时nignx-目录下-html-下的资源" class="headerlink" title="默认输入域名后访问的时nignx 目录下 /html/下的资源"></a>默认输入域名后访问的时nignx 目录下 /html/下的资源</h1></li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">http <span class="token punctuation">&#123;</span>
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  <span class="token number">65</span>;

    
#外界访问 访问了一个端口号为<span class="token number">80</span>的虚拟主机，
    server <span class="token punctuation">&#123;</span>  		
        listen       <span class="token number">80</span>;
 		server_name  www.51xuecheng.cn  localhost;  
		#浏览器访问任意一个域名都能进入nignx 请求网站资源
        ssi on;
    	# 把页头页尾放进主页
        ssi_silent_errors on;

        location / <span class="token punctuation">&#123;</span>
            alias   E<span class="token operator">:</span>/homework/practice/CodePractice/JAVA/XCProj/xc-ui-pc-static-portal/;
            index  index.html index.htm;
        <span class="token punctuation">&#125;</span>
        #静态资源
        location /static/img/ <span class="token punctuation">&#123;</span>  
                alias  E<span class="token operator">:</span>/homework/practice/CodePractice/JAVA/XCProj/xc-ui-pc-static-portal/img/;
        <span class="token punctuation">&#125;</span> 
        location /static/css/ <span class="token punctuation">&#123;</span>  
                alias   E<span class="token operator">:</span>/homework/practice/CodePractice/JAVA/XCProj/xc-ui-pc-static-portal/css/;
        <span class="token punctuation">&#125;</span> 
        location /static/js/ <span class="token punctuation">&#123;</span>  
                alias   E<span class="token operator">:</span>/homework/practice/CodePractice/JAVA/XCProj/xc-ui-pc-static-portal/js/;
        <span class="token punctuation">&#125;</span> 
        location /static/plugins/ <span class="token punctuation">&#123;</span>  
                alias   E<span class="token operator">:</span>/homework/practice/CodePractice/JAVA/XCProj/xc-ui-pc-static-portal/plugins/;
                add_header Access-Control-Allow-Origin http<span class="token operator">:</span><span class="token comment">//ucenter.51xuecheng.cn;  </span>
                add_header Access-Control-Allow-Credentials <span class="token boolean">true</span>;  
                add_header Access-Control-Allow-Methods GET;
        <span class="token punctuation">&#125;</span> 
        location /plugins/ <span class="token punctuation">&#123;</span>  
                alias   E<span class="token operator">:</span>/homework/practice/CodePractice/JAVA/XCProj/xc-ui-pc-static-portal/plugins/;
        <span class="token punctuation">&#125;</span> 
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html;
        location = /50x.html <span class="token punctuation">&#123;</span>
            root   html;
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样访问 本机80端口就能访问静态界面啦</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612211729708.png" alt="image-20230612211729708"></p>
<h3 id="访问课程详情页"><a href="#访问课程详情页" class="headerlink" title="访问课程详情页"></a>访问课程详情页</h3><p><a target="_blank" rel="noopener" href="http://localhost/course/course_template.html">http://localhost/course/course_template.html</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612212923928.png" alt="image-20230612212923928"></p>
<p>访问的其实时尚未被后端渲染的数据。</p>
<h3 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a><strong>文件服务器</strong></h3><p>在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在MinIO文件系统存储，下边统一由Nginx代理，通过文件服务域名统一访问。如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612213649158.png" alt="image-20230612213649158" style="zoom:50%;" /></p>
<p>host文件添加 127.0.0.1 www.51xuecheng.cn file.51xuecheng.cn</p>
<p>在nginx.conf中配置文件<strong>服务器的代理地址</strong></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># server 上面加 
#文件服务 被代理的网址
upstream fileserver<span class="token punctuation">&#123;</span>
   server <span class="token number">192.168</span>.<span class="token number">101.65</span><span class="token operator">:</span><span class="token number">9000</span> weight=<span class="token number">10</span>;
<span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里支配了一台机器，如果以后有多台机器，可以这样</p>
<pre class="line-numbers language-none"><code class="language-none">upstream fileserver&#123;
   server 192.168.101.65:9000 weight&#x3D;10;
   server 192.168.101.64:9001 weight&#x3D;10;
   server 192.168.101.65:9002 weight&#x3D;10;
&#125; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">server <span class="token punctuation">&#123;</span>
     listen       <span class="token number">80</span><span class="token punctuation">;</span>
     server_name  file<span class="token punctuation">.</span><span class="token number">51</span>xuecheng<span class="token punctuation">.</span>cn<span class="token punctuation">;</span> # 外界访问的域名，文件服务的域名
     #charset koi8<span class="token operator">-</span>r<span class="token punctuation">;</span>
     ssi on<span class="token punctuation">;</span>
     ssi_silent_errors on<span class="token punctuation">;</span>
     #access_log  logs<span class="token operator">/</span>host<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>
     location <span class="token operator">/</span>video <span class="token punctuation">&#123;</span>  # 根据下属规则，当请求 域名<span class="token operator">/</span>video 时 其实nignx将请求转发给 fileserver fileserver在上面
         proxy_pass   http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>fileserver<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>

     location <span class="token operator">/</span>mediafiles <span class="token punctuation">&#123;</span>
         proxy_pass   http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>fileserver<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>访问通过 指定域名访问 文件是文件系统里面的视频</p>
<p><a target="_blank" rel="noopener" href="http://file.51xuecheng.cn/video/5/4/54489cc0c00c054824a9006e0c07e5e6/54489cc0c00c054824a9006e0c07e5e6.mp4">http://file.51xuecheng.cn/video/5/4/54489cc0c00c054824a9006e0c07e5e6/54489cc0c00c054824a9006e0c07e5e6.mp4</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612215846516.png" alt="image-20230612215846516"></p>
<p>正常访问！</p>
<h3 id="视频播放页面"><a href="#视频播放页面" class="headerlink" title="视频播放页面"></a><strong>视频播放页面</strong></h3><p>进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面。</p>
<p>首先在nginx.conf中配置视频播放页面的地址</p>
<pre><code>location /course/preview/learning.html &#123;
     alias D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/course/learning.html;
 &#125; 
 location /course/search.html &#123; 
     root  D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;
 &#125; 
 location /course/learning.html &#123; 
     root  D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;
 &#125; 
</code></pre><p>下边需要配置learning.html页面的视频播放路径来测试视频播放页面，找到learning.html页面中videoObject对象的定义处，配置视频的播放地址。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612220932419.png" alt="image-20230612220932419"></p>
<p>这样点击详情视频就能播放绑定的视频了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612221034708.png" alt="image-20230612221034708"></p>
<h2 id="课程预览界面接口"><a href="#课程预览界面接口" class="headerlink" title="课程预览界面接口"></a><strong>课程预览界面接口</strong></h2><p>将课程详情页作为一个模板，往里面填充数据。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612222648493.png" alt="image-20230612222648493"></p>
<h3 id="准备模板"><a href="#准备模板" class="headerlink" title="准备模板"></a>准备模板</h3><p>响应页面到浏览器使用freemarker模板引擎技术实现，首先从课程资料目录下获取课程预览页面course_template.html，拷贝至内容管理的接口工程的resources/templates下，并将其在本目录复制一份命名为course_template.ftl</p>
<h3 id="定义接口"><a href="#定义接口" class="headerlink" title="定义接口"></a>定义接口</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/coursepreview/&#123;courseId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">preview</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"courseId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

     <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">"course_template"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简单访问一下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612222924727.png" alt="image-20230612222924727"></p>
<p>发现能简单访问到，但是没有样式，样式都在门户网站里的静态资源里面</p>
<p>F12 发现 他访问静态资源直接访问本服域名路径下的静态资源；也就是说访问静态资源的域名和远端访问的域名绑定了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612223115344.png" alt="image-20230612223115344"></p>
<p>如何访问呢？统一使用门户网站网址访问所有资源</p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>可以用niginx代理内容管理的地址，实际访问门户网站（被代理）</p>
<p>怎么实现呢？</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">  #后台网关
 upstream gatewayserver<span class="token punctuation">&#123;</span>
   server <span class="token number">127.0</span>.<span class="token number">0.1</span><span class="token operator">:</span><span class="token number">63010</span> weight=<span class="token number">10</span>;
 <span class="token punctuation">&#125;</span> 

#门户虚拟主机
 server <span class="token punctuation">&#123;</span>
       listen       <span class="token number">80</span>;
       server_name  www.51xuecheng.cn localhost;
       ....
       #api
       location /api/ <span class="token punctuation">&#123;</span>
               proxy_pass http<span class="token operator">:</span><span class="token comment">//gatewayserver/;</span>
       <span class="token punctuation">&#125;</span> 
       ....
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启</p>
<p>访问:<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/124">http://www.51xuecheng.cn/api/content/coursepreview/124</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612224324833.png" alt="image-20230612224324833"></p>
<p>可以正常加载样式了。</p>
<h3 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a>接口开发</h3><p>在使用freemarker渲染生成视图时需要数据模型，此数据模型包括了基本信息、营销信息、课程计划、师资等信息。</p>
<p>所以首先定义一个数据模型类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePreviewDto</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//课程基本信息,课程营销信息</span>
    <span class="token class-name">CourseBaseInfoDto</span> courseBase<span class="token punctuation">;</span>


    <span class="token comment">//课程计划信息</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">></span></span> teachplans<span class="token punctuation">;</span>
    
    <span class="token comment">//师资信息暂时不加...</span>


<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Service接口</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CoursePublishService</span> <span class="token punctuation">&#123;</span>


   <span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口实现如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CoursePublishService</span> <span class="token punctuation">&#123;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">CourseBaseInfoService</span> courseBaseInfoService<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">TeachplanService</span> teachplanService<span class="token punctuation">;</span>


 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">//课程基本信息、营销信息</span>
  <span class="token class-name">CourseBaseInfoDto</span> courseBaseInfo <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//课程计划信息</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">></span></span> teachplanTree<span class="token operator">=</span> teachplanService<span class="token punctuation">.</span><span class="token function">findTeachplanTree</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">CoursePreviewDto</span> coursePreviewDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePreviewDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePreviewDto<span class="token punctuation">.</span><span class="token function">setCourseBase</span><span class="token punctuation">(</span>courseBaseInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePreviewDto<span class="token punctuation">.</span><span class="token function">setTeachplans</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> coursePreviewDto<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>接口层完善</strong></p>
<pre class="line-numbers language-none"><code class="language-none">@Autowired
CoursePublishService coursePublishService;


@GetMapping(&quot;&#x2F;coursepreview&#x2F;&#123;courseId&#125;&quot;)
public ModelAndView preview(@PathVariable(&quot;courseId&quot;) Long courseId)&#123;

    &#x2F;&#x2F;获取课程预览信息
    CoursePreviewDto coursePreviewInfo &#x3D; coursePublishService.getCoursePreviewInfo(courseId);

    ModelAndView modelAndView &#x3D; new ModelAndView();
    modelAndView.addObject(&quot;model&quot;,coursePreviewInfo);
    modelAndView.setViewName(&quot;course_template&quot;);
    return modelAndView;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>前后端联调</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612225347264.png" alt="image-20230612225347264"></p>
<p>重启前端工程，</p>
<p>进入课程列表点击”预览”按钮，</p>
<p>正常打开课程预览页面<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/124">http://www.51xuecheng.cn/api/content/coursepreview/124</a></p>
<h3 id="编写模板"><a href="#编写模板" class="headerlink" title="编写模板"></a><strong>编写模板</strong></h3><p>模型数据准备好后下一步将模型数据填充到course_template.ftl上，填充时注意不要一次填充太多，一边填充一边刷新调试。</p>
<p>完整的course_template.ftl模板在课程资料目录下，差不多学会了freemarker标签的使用方法，将课程资料下的course_template.ftl覆盖自己的工程下的course_template.ftl。</p>
<ul>
<li>freemarker提供了很多指令用于解析各种类型的数据模型，还有if等标签，参考地址：<a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/ref_directives.html">http://freemarker.foofun.cn/ref_directives.html</a></li>
<li>修改模板后需要编译</li>
<li></li>
</ul>
<p>测试成功！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612232426308.png" alt="image-20230612232426308"></p>
<h2 id="视频播放页面接口"><a href="#视频播放页面接口" class="headerlink" title="视频播放页面接口"></a><strong>视频播放页面接口</strong></h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612232822405.png" alt="image-20230612232822405"></p>
<p>在此页面需要从后台获取课程信息、根据课程计划获取对应的视频地址，下边编写这两个接口：</p>
<p>获取课程信息接口：/open/content/course/whole/{courseId}</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token operator">/</span><span class="token keyword">open</span><span class="token operator">/</span>content<span class="token operator">/</span>course<span class="token operator">/</span>whole<span class="token operator">/</span>课程id      

响应：同课程预览service接口返回数据  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>根据课程计划获取视频地址接口：/open/media/preview/{mediaId}</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">/</span><span class="token keyword">open</span><span class="token operator">/</span>media<span class="token operator">/</span>preview<span class="token operator">/</span>课程计划id

响应：
<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token operator">:</span><span class="token string">"success"</span><span class="token punctuation">,</span><span class="token string">"result"</span><span class="token operator">:</span><span class="token string">"视频的url"</span><span class="token punctuation">,</span><span class="token string">"successful"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>1、在nginx配置如下地址</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#openapi</span>
location /open/content/ <span class="token punctuation">&#123;</span>
        proxy_pass http://gatewayserver/content/open/<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> 
location /open/media/ <span class="token punctuation">&#123;</span>
        proxy_pass http://gatewayserver/media/open/<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置运行nginx.exe -s reload加载nginx的配置文件 </p>
<h3 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h3><p>内容管理</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程公开查询接口"</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">"课程公开查询接口"</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RestController</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/open"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseOpenController</span> <span class="token punctuation">&#123;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token keyword">private</span> <span class="token class-name">CourseBaseInfoService</span> courseBaseInfoService<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token keyword">private</span> <span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>


<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/course/whole/&#123;courseId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getPreviewInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"courseId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//获取课程预览信息</span>
    <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> coursePreviewInfo<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>媒资管理</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"媒资文件管理接口"</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">"媒资文件管理接口"</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RestController</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/open"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaOpenController</span> <span class="token punctuation">&#123;</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token class-name">MediaFileService</span> mediaFileService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"预览文件"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/preview/&#123;mediaId&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">getFileById</span><span class="token punctuation">(</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"视频还没有转码处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>


<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612234007238.png" alt="image-20230612234007238"></p>
<h2 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h2><ul>
<li><p>为什么要用Freemarker静态化？如何做的？</p>
</li>
<li><p>页面静态化是指使用模板引擎技术将一个动态网页生成html静态页面，满足以下条件可以考虑使用静态化</p>
<ol>
<li>该页面被访问频率高，例如：商品信息展示、讲师介绍页面</li>
<li>页面上数据变化频率低，例如：商品发布后对商品信息的修改频率低、讲师介绍信息修改频率低</li>
</ol>
</li>
<li>静态化的技术很多，Freemarker是一个成熟的开源的模板引擎工具，简单易用，功能强大，本项目使用Freemarker将课程信息静态化<ol>
<li>使用Freemarker的标签编写课程信息的模板</li>
<li>调用接口获取木板上需要的模型数据</li>
<li>调用Freemarker的API生成静态页面</li>
<li>生成的静态页面最终会上传到文件系统方便访问</li>
</ol>
</li>
</ul>
<h1 id="提交审核"><a href="#提交审核" class="headerlink" title="提交审核"></a>提交审核</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>根据模块需求分析，课程发布前先要审核，审核通过方可发布。下图是课程审核及发布的流程图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppksNjg.png" alt="img"></p>
<ol>
<li>一门课程新增后，它的审核状态为<code>未提交</code>，发布状态为<code>未发布</code></li>
<li>课程信息编辑完成，教学机构人员进行<code>提交审核</code>操作，此时课程的审核状态为<code>已提交</code></li>
<li>当课程状态为<code>已提交</code>时，运营平台人员对课程进行审核</li>
<li>运营平台人员审核课程，结果有两个：审核通过、审核不通过</li>
<li>课程审核后不管状态是否通过，教学机构都可以再次修改课程并提交审核，此时课程状态为<code>已提交</code>，运营平台人员再次审核课程</li>
<li>课程审核通过，教学机构人员可以发布课程，发布成功后，课程的发布状态为<code>已发布</code></li>
<li>课程发布后，通过<code>下架</code>操作可以更改课程发布状态为<code>下架</code></li>
<li>课程下架后，通过<code>上架</code>操作可以再次发布课程，上架后课程发布状态为<code>发布</code></li>
</ol>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>通过业务流程分析，现在我们思考：课程提交审核后，还允许修改课程吗？</p>
<ul>
<li>如果允许修改，可能会引发冲突 （审核的课程和修改的课程时同一份），本来审核完毕了，但是机构修改了课程（加了一些不合规的内容，这样倒霉的就是平台人员）</li>
<li>如果不允许修改，大部分审核周期都很长，想修改只能等到这一轮审核完，效率低</li>
</ul>
<ul>
<li>解决方案：<ul>
<li>提供一个预发布表（相当于sql的快照读一样）：审核人员审核的是快照；审核通过后，机构发布的也是快照（预发布表的内容）</li>
<li>如果审核过程中，机构修改了课程信息，那么修改的不是预发布表。而是原始表的信息，当再次提交时，<strong>如果平台正在审核，就暂时不能提交。</strong> 载体提交时还是将基本表信息转到预发布表，将审核状态改为审核中，发布状态改为未发布</li>
<li>审核通过需要1、将预发布表发表以及课程基本信息状态为审核通过 。 发布时，发布的不是原始表而是快照表，修改不影响快照</li>
</ul>
</li>
</ul>
<h2 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h2><p>提交审核</p>
<pre class="line-numbers language-none"><code class="language-none">请求网址: http:&#x2F;&#x2F;localhost:8601&#x2F;api&#x2F;content&#x2F;courseaudit&#x2F;commit&#x2F;1
请求方法: POST<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>请求路径：/content/courseaudit/commit/{courseId}</li>
<li>请求方式：POST</li>
<li>从请求路径可以看出，该接口需要定义在content-api下</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/courseaudit/commit/&#123;courseId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a>接口开发</h2><p><strong>DAO开发</strong></p>
<ul>
<li>使用自动生成的Mapper即可</li>
<li>通过上面的分析，我们要查询的内容如下<ol>
<li>根据传入的courseId，查询课程基本信息、课程营销信息、课程计划信息，并汇总成课程预发布信息</li>
<li>向课程预发布表中插入我们汇总好的信息，如果已经存在，则更新，并状态为<code>已提交</code></li>
<li>更新课程基本信息表的审核状态为<code>已提交</code></li>
</ol>
</li>
<li>约束<ol>
<li>未提交或审核完后，方可提交审核</li>
<li>本机构只允许提交本机构的课程</li>
<li>没有上传图片，不允许提交审核</li>
<li>没有添加课程计划，不允许提交审核</li>
</ol>
</li>
</ul>
<p><strong>service</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

 <span class="token comment">//约束校验</span>
 <span class="token class-name">CourseBase</span> courseBase <span class="token operator">=</span> courseBaseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程审核状态</span>
 <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> courseBase<span class="token punctuation">.</span><span class="token function">getAuditStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//当前审核状态为已提交不允许再次提交</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"202003"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"当前为等待审核状态，审核完成可以再次提交。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">//本机构只允许提交本机构的课程</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>courseBase<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"不允许提交其它机构的课程。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">//课程图片是否填写</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">.</span><span class="token function">getPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"提交失败，请上传课程图片"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">//添加课程预发布记录</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePublishPre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程基本信息加部分营销信息</span>
 <span class="token class-name">CourseBaseInfoDto</span> courseBaseInfo <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>courseBaseInfo<span class="token punctuation">,</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程营销信息</span>
 <span class="token class-name">CourseMarket</span> courseMarket <span class="token operator">=</span> courseMarketMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//转为json</span>
 <span class="token class-name">String</span> courseMarketJson <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>courseMarket<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//将课程营销信息json数据放入课程预发布表</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setMarket</span><span class="token punctuation">(</span>courseMarketJson<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//查询课程计划信息</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">></span></span> teachplanTree <span class="token operator">=</span> teachplanService<span class="token punctuation">.</span><span class="token function">findTeachplanTree</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"提交失败，还没有添加课程计划"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">//转json</span>
 <span class="token class-name">String</span> teachplanTreeString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setTeachplan</span><span class="token punctuation">(</span>teachplanTreeString<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//设置预发布记录状态,已提交</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"202003"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//教学机构id</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//提交时间</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPreUpdate <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPreUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">//添加课程预发布记录</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">//更新课程基本表的审核状态</span>
 courseBase<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">"202003"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 courseBaseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完善</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">"/courseaudit/commit/&#123;courseId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"courseId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
     coursePublishService<span class="token punctuation">.</span><span class="token function">commitAudit</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="课程发布"><a href="#课程发布" class="headerlink" title="课程发布"></a>课程发布</h1><p>在网站上展示课程信息需要解决课程信息显示的性能问题，如果速度慢(排除网速)会影响用户的体验性。</p>
<p>如何去快速搜索课程？</p>
<p>打开课程详情页面仍然去查询数据库可行吗？</p>
<p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入<strong>ES索引库</strong> 方便搜索，下图显示了课程发布后课程信息的流转情况</p>
<p>1、向内容管理数据库的课程发布表存储课程发布信息，更新课程基本信息表中发布状态为已发布。</p>
<p>2、向Redis存储课程缓存信息。</p>
<p>3、向Elasticsearch存储课程索引信息。</p>
<p>4、请求分布文件系统存储课程静态化页面(即html页面)，实现快速浏览课程详情页面。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613094307307.png" alt="image-20230613094307307" style="zoom:50%;" /></p>
<p>课程发布表的数据来源于课程预发布表，它们的结构基本一样，只是课程发布表中的状态是课程发布状态，如下图：</p>
<p>redis中的课程缓存信息是将课程发布表中的数据转为json进行存储。</p>
<p>elasticsearch中的课程索引信息是根据搜索需要将课程名称、课程介绍等信息进行索引存储。</p>
<p>MinIO中存储了课程的静态化页面文件（html网页），查看课程详情是通过文件系统去浏览课程详情页面。</p>
<h2 id="分布式事务框架搭建"><a href="#分布式事务框架搭建" class="headerlink" title="分布式事务框架搭建"></a>分布式事务框架搭建</h2><h3 id="分布式事务技术方案"><a href="#分布式事务技术方案" class="headerlink" title="分布式事务技术方案"></a><strong>分布式事务技术方案</strong></h3><p>什么是分布式事务？</p>
<p>现在的需求是课程发布操作后将数据写入数据库、redis、elasticsearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为<strong>分布式事务。</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">begin transaction； 
    //1.本地数据库操作：张三减少金额 
    //2.远程调用：让李四增加金额 
commit transation<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以设想，当远程调用让李四增加金额成功了，</p>
<p>由于网络问题远程调用并没有返回，</p>
<p>此时<strong>本地事务以为提交失败</strong>（其实成功了）就回滚了张三减少金额的操作，</p>
<p>此时张三和李四的数据就不一致了。 </p>
<p>说白了就是远程调用是网络出问题了，这种情况</p>
<h4 id="什么是CAP理论"><a href="#什么是CAP理论" class="headerlink" title="什么是CAP理论"></a><strong>什么是CAP理论</strong></h4><p>CAP是 Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p>
<p>CAP理论要强调的是在分布式系统中这三点不可能全部满足，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用。</p>
<p>满足P那么C和A不能同时满足：</p>
<p>比如我们添加一个用户小明的信息，该信息先添加到结点1中，再同步到结点2中，如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613094918104.png" alt="image-20230613094918104" style="zoom:50%;" /></p>
<p>如果要满足C一致性，必须等待小明的信息同步完成系统才可用（否则会出现请求到结点2时查询不到数据，违反了一致性），在信息同步过程中系统是不可用的，所以满足C的同时无法满足A。</p>
<p>如果要满足A可用性，要时刻保证系统可用就不用等待信息同步完成，此时系统的一致性无法满足。</p>
<p>所以在分布式系统中进行分布式事务控制，要么保证CP、要么保证AP。</p>
<p>CP的场景：满足C舍弃A，强调一致性（绝对安全。一般是转账）。</p>
<p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p>
<p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足CP。</p>
<p>AP的场景：满足A舍弃C，强调可用性。</p>
<p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p>
<p>注册送积分，注册成功积分在24分到账。</p>
<p>在实际应用中符合AP的场景较多，其实虽然AP舍弃C一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了BASE理论。</p>
<p>什么是BASE理论？</p>
<p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。</p>
<p>分布式事务控制有哪些常用的技术方案？</p>
<p>实现CP就是要实现强一致性:</p>
<p>使用Seata框架基于AT模式实现</p>
<p>使用Seata框架基于TCC模式实现。</p>
<p>实现AP则要保证最终数据一致性:</p>
<p>使用消息队列通知的方式去实现，通知失败自动重试，达到最大失败次数需要人工处理；</p>
<p>使用任务调度的方案，启动任务调度将课程信息由数据库同步到elasticsearch、MinIO、redis中。</p>
<h3 id="课程发布的事务控制方案"><a href="#课程发布的事务控制方案" class="headerlink" title="课程发布的事务控制方案"></a><strong>课程发布的事务控制方案</strong></h3><p>学习了这么多的理论，回到课程发布，执行课程发布操作后要向数据库、redis、elasticsearch、MinIO写四份数据，这个场景用哪种方案？</p>
<p>应该强调可用性AP，最终保证一致性即可</p>
<p>课程发布操作后，先更新数据库中的课程发布状态，更新后向redis、elasticsearch、MinIO写课程信息，只要在一定时间内最终向redis、elasticsearch、MinIO写数据成功即可。</p>
<p>步骤：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613130528562.png" alt="image-20230613130528562"></p>
<p>方案名称： 本地消息表+定时任务调度的方案来实现最终数据的一致性。</p>
<p>1、执行发布操作，内容管理服务存储课程<strong>发布表</strong>的同时向<strong>消息表</strong>添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p>
<p>2、<strong>任务调度服务定时调度</strong>内容管理服务<strong>扫描消息表</strong>，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p>
<p>3、拿到任务开始执行任务，分别向redis、elasticsearch及文件系统存储数据。</p>
<p>4、任务完成后<strong>删除</strong>消息表记录。</p>
<h3 id="发布接口定义"><a href="#发布接口定义" class="headerlink" title="发布接口定义"></a>发布接口定义</h3><p>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息并向消息表插入一条消息，这里定义的课程发布接口要实现该功能。</p>
<p>在内容管理接口工程中定义课程发布接口。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程发布"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">"/coursepublish/&#123;courseId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursepublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"courseId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口开发（消息-任务表同步）"><a href="#接口开发（消息-任务表同步）" class="headerlink" title="接口开发（消息/任务表同步）"></a>接口开发（消息/任务表同步）</h3><p>课程发布操作对<strong>数据库操</strong>作如下（整体是一个事务）：</p>
<p>1、向课程发布表course_publish插入一条记录,记录来源于课程预发布表，如果存在则更新，发布状态为：已发布。</p>
<p>2、更新course_base表的课程发布状态为：已发布</p>
<p>3、删除课程预发布表的对应记录。</p>
<p>4、向mq_message消息表插入一条消息，消息类型为：course_publish</p>
<p>后续就是 向 redis ES MinIO插入数据，<strong>xxljob循环遍历定时任务来保证最终一致性，这里如果出现问题就是运维的事情了</strong></p>
<p>约束：</p>
<p>1、课程审核通过方可发布。</p>
<p>2、本机构只允许发布本机构的课程。</p>
<p>service</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

 <span class="token comment">//约束校验</span>
 <span class="token comment">//查询课程预发布表</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"请先提交课程审核，审核通过才可以发布"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">//本机构只允许提交本机构的课程</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>coursePublishPre<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"不允许提交其它机构的课程。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>


 <span class="token comment">//课程审核状态</span>
 <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> coursePublishPre<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//审核通过方可发布</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"202004"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"操作失败，课程审核通过方可发布。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">//保存课程发布信息</span>
 <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//保存消息表</span>
 <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//删除课程预发布表对应记录</span>
 coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>


<span class="token comment">/**
 * @description 保存课程发布信息
 * @param courseId  课程id
 * @return void
 * @author Mr.M
 * @date 2022/9/20 16:32
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token comment">//整合课程发布信息</span>
 <span class="token comment">//查询课程预发布表</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"课程预发布数据为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePublish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//拷贝到课程发布对象</span>
 <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">,</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
 coursePublish<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"203002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">CoursePublish</span> coursePublishUpdate <span class="token operator">=</span> coursePublishMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  coursePublishMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
  coursePublishMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">//更新课程基本表的发布状态</span>
 <span class="token class-name">CourseBase</span> courseBase <span class="token operator">=</span> courseBaseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 courseBase<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"203002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 courseBaseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span class="token comment">/**
 * @description 保存消息表记录，稍后实现
 * @param courseId  课程id
 * @return void
 * @author Mr.M
 * @date 2022/9/20 16:32
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完善</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程发布"</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@ResponseBody</span>
 <span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">"/coursepublish/&#123;courseId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursepublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"courseId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
     coursePublishService<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先测试约束条件：</p>
<p>1、在未提交审核时进行课程发布测试。</p>
<p>2、在课程未审核通过时进行发布。</p>
<p>正常流程测试：</p>
<p>1、提交审核课程</p>
<p>2、手动修改课程预发布表与课程基本信息的审核状态为审核通过。</p>
<p>3、执行课程发布</p>
<p>4、观察课程发布表记录是否正常，课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为”发布“。</p>
<p>使用前后端联调方式测试。</p>
<h3 id="消息处理SDK（分布式任务框架搭建）"><a href="#消息处理SDK（分布式任务框架搭建）" class="headerlink" title="消息处理SDK（分布式任务框架搭建）"></a>消息处理SDK（分布式任务框架搭建）</h3><p>在发布任务，将一个任务放进消息表后，后续xxljob调用其他三个任务组件处理消息，有关于消息处理的步骤有哪些?</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2023/03/04/ppAjK8P.png" alt="img"></p>
<ol>
<li>新增消息表</li>
<li>扫描消息表</li>
<li>更新消息表</li>
<li>删除消息表</li>
</ol>
<p>本质上，所有这种需要满足AP（可用性优先、但要满足最终一致性）的，使用 本地消息表+任务调度的方式 都需要这些消息处理步骤，那么</p>
<ul>
<li>如果在每个地方都实现一套针对消息定时扫描、处理的逻辑，基本上都是重复的，软件的复用性太低、成本太高</li>
<li>如何解决这个问题？<ul>
<li>我们可以将消息处理相关的逻辑做成一个通用的东西，如果将消息处理做成一个SDK工具包，相比较通用服务，不仅可以解决将消息处理通用化的需求，还可以降低成本</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2023/03/04/ppAjUCq.png" alt="img"></p>
<ul>
<li>拿课程发布任务举例，执行课程发布任务是要向Redis、索引库等同步数据，其他任务的执行逻辑是不同的，所以执行任务在SDK中不用实现，只需要提供一个抽象方法由具体的执行任务方去实现</li>
</ul>
<ul>
<li><p>在视频处理章节介绍的视频处理的<strong>幂等性</strong>方案，这里可以采用类似方案</p>
<ul>
<li>任务执行完成后，从消息表删除</li>
<li>如果消息表的状态是完成或不存在，则无需执行</li>
</ul>
</li>
<li><p>如何保证任务<strong>不重复执行</strong>？</p>
<ul>
<li>任务调度采用分片广播，根据分片参数去获取处理任务，配置调度过期策略为<code>忽略</code>，配置任务阻塞处理策略为<code>丢弃后续调度</code></li>
</ul>
</li>
<li>例如课程发布任务需要执行3个同步操作：存储课程到Redis、存储课程到索引库、存储课程页面到MinIO。如果其中一个小任务已经完成，也不应该去重复执行这个小任务，那么该如何设计呢？（顺序性？）<ul>
<li>将小任务作为任务的不同阶段，在消息表中设立阶段状态</li>
<li>每完成一个阶段，就在对应的阶段状态字段打上标记，即使大任务还没有完成，重新执行大任务时，也会跳过执行完毕了的小任务</li>
</ul>
</li>
</ul>
<p>综上所述，除了消息表的基本的增、删、改、查的接口外，消息SDK还具有如下接口功能：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p>
 *  服务类
 * &lt;/p>
 *
 * @author Mr.M
 * @since 2022-09-21
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MqMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * @description 扫描消息表记录，采用与扫描视频处理表相同的思路
     * @param shardIndex 分片序号
     * @param shardTotal 分片总数
     * @param count 扫描记录数
     * @return java.util.List 消息记录
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">></span></span> <span class="token function">getMessageList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span>  <span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MqMessage</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token class-name">String</span> businessKey1<span class="token punctuation">,</span><span class="token class-name">String</span> businessKey2<span class="token punctuation">,</span><span class="token class-name">String</span> businessKey3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageOne</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageTwo</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageThree</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageFour</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageOne</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageTwo</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageThree</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageFour</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613203418916.png" alt="image-20230613203418916"></p>
<p>这些SDK已经写好了，我们仅需将资料中的SDK微服务拷贝到 项目代码目录下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613134509308.png" alt="image-20230613134509308"></p>
<p>消息SDK提供消息处理抽象类，此抽象类供使用方去继承使用，</p>
<p>首先谁用谁添加依赖</p>
<p>如在内容管理服务用</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613134826637.png" alt="image-20230613134826637"></p>
<p>那么刚才往消息表里面写数据可以用sdk工具包的内容,补全往课程发布表添加项目的函数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token class-name">MqMessage</span> mqMessage <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token string">"course_publish"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>mqMessage<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token class-name">CommonError</span><span class="token punctuation">.</span>UNKOWN_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ok 插入消息完成</p>
<p>后面该处理消息了</p>
<h4 id="课程发布任务处理"><a href="#课程发布任务处理" class="headerlink" title="课程发布任务处理"></a><strong>课程发布任务处理</strong></h4><p>关于消息的处理，SDK工具包也帮我们写了一部分</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 消息处理抽象类
 * @date 2022/9/21 19:44
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MqMessageService</span> mqMessageService<span class="token punctuation">;</span>


    <span class="token comment">/**
     * @param mqMessage 执行任务内容
     * @return boolean true:处理成功，false处理失败
     * @description 任务处理
     * @author Mr.M
     * @date 2022/9/21 19:47
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * @description 扫描消息表多线程执行任务
     * @param shardIndex 分片序号
     * @param shardTotal 分片总数
     * @param messageType  消息类型
     * @param count  一次取出任务总数
     * @param timeout 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒
     * @return void
     * @author Mr.M
     * @date 2022/9/21 20:35
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span>  <span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//扫描消息表获取任务清单</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">></span></span> messageList <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getMessageList</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">,</span>messageType<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//任务个数</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> messageList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"取出待处理消息"</span><span class="token operator">+</span>size<span class="token operator">+</span><span class="token string">"条"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//创建线程池</span>
            <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//计数器</span>
            <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>message <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"开始任务:&#123;&#125;"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//处理任务</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务执行成功:&#123;&#125;)"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//更新任务状态,删除消息表记录,添加到历史表</span>
                            <span class="token keyword">int</span> completed <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">completed</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>completed<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务执行成功:&#123;&#125;"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务执行失败:&#123;&#125;"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务出现异常:&#123;&#125;,任务:&#123;&#125;"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token comment">//计数</span>
                    countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"结束任务:&#123;&#125;"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"结束...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，执行逻辑（任务分配逻辑）和之前的处理视频一致，只不过，这里的execute（）函数就是具体的执行过程，需要我们自己取编写，</p>
<p>所以秩序继承这个抽象类作为一个模板来重写他的具体任务执行逻辑即可</p>
<p>现在我们来直接编写执行器任务</p>
<p>service工程导入xxljob依赖</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>xuxueli<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>xxl<span class="token operator">-</span>job<span class="token operator">-</span>core<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在内容service下新建jobhandler（存放任务）</p>
<p>编写任务需要继承刚才的抽象类MessageProcessAbstract（抽象类帮我们分配任务）</p>
<p>下面简单写一下三个小任务的伪代码（具体实现后面再写）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishTask</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//课程发布任务处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//获取消息相关的业务信息</span>
        <span class="token class-name">String</span> businessKey1 <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> courseId <span class="token operator">=</span> <span class="token class-name">Int</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>businessKey1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1、课程静态化 将课程预览静态资源放在MinIO</span>
        <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2、将课程信息存储在 ES 索引库里面</span>
        <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3、将课程信息存储在 Redis里面</span>
        <span class="token function">saveCourseCache</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">//生成课程静态化页面并上传至文件系统</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"开始进行课程静态化,课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息id</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息处理的service</span>
        <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息幂等性处理(设置该阶段的状态)</span>
        <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne <span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"课程静态化已处理直接返回，课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//保存第一阶段状态</span>
        mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">//将课程信息缓存至redis</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseCache</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"将课程信息缓存至redis,课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//保存课程索引信息</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"保存课程索引信息,课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加调度入口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//任务调度入口</span>
 <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"CoursePublishJobHandler"</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursePublishJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
     <span class="token comment">// 分片参数</span>
     <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"shardIndex="</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">",shardTotal="</span><span class="token operator">+</span>shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span>
     <span class="token function">process</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span>shardTotal<span class="token punctuation">,</span><span class="token string">"course_publish"</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="在xxl-job配置任务"><a href="#在xxl-job配置任务" class="headerlink" title="在xxl-job配置任务"></a>在xxl-job配置任务</h4><p>nacos配置xxljob执行器信息，才能被发现</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span> 
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>18088/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin/
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> course<span class="token punctuation">-</span>publish<span class="token punctuation">-</span>job
      <span class="token key atrule">address</span><span class="token punctuation">:</span>
      <span class="token key atrule">ip</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>xxljob还有个config，直接复制 mediaservice里面的</p>
<p>添加课程发布执行器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613214639403.png" alt="image-20230613214639403"></p>
<p>捯饬了半天终于上报成功了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613222952451.png" alt="image-20230613222952451"></p>
<p>在xxl-job添加任务</p>
<ul>
<li>JobHandler中填写@XxlJob注解中的内容</li>
</ul>
<p>启动任务测试，控制台可以看到<code>发布任务执行中...</code>字样</p>
<p>当然记得在发布表上添加数据哈</p>
<p>测试成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230613223744557.png" alt="image-20230613223744557"></p>
<p>至此，分布式事务的大体框架搭建完成</p>
<p>下面开始编写分布式任务的具体任务</p>
<h2 id="子任务：页面静态化"><a href="#子任务：页面静态化" class="headerlink" title="子任务：页面静态化"></a>子任务：页面静态化</h2><h3 id="页面静态化介绍"><a href="#页面静态化介绍" class="headerlink" title="页面静态化介绍"></a><strong>页面静态化</strong>介绍</h3><p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，<strong>服务端渲染的并发能力</strong>是<strong>有限</strong>的。</p>
<p><strong>页面静态化</strong>则强调将生成html页面的过程提前，<strong>提前使用模板引擎技术生成html页面</strong>，当客户端请求时直接请求html页面，由于是静态页面可以<strong>使用nginx</strong>、apache等高性能的web服务器<strong>访问</strong>，并发性能高。（<strong>就不用请求web服务器了</strong>）</p>
<p><strong>什么时候能用页面静态化技术？</strong></p>
<p>当数据<strong>变化不频繁</strong>，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p>
<p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化。</p>
<h3 id="静态化测试"><a href="#静态化测试" class="headerlink" title="静态化测试"></a><strong>静态化测试</strong></h3><p>下边使用freemarker技术对页面静态化生成html页面。</p>
<p>在内容管理service工程中添加freemarker依赖</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>freemarker<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>编写测试方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreemarkerTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>


    <span class="token comment">//测试页面静态化</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGenerateHtmlByTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TemplateException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//配置freemarker</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//加载模板</span>
        <span class="token comment">//选指定模板路径,classpath下templates下</span>
        <span class="token comment">//得到classpath路径</span>
        <span class="token class-name">String</span> classpath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classpath <span class="token operator">+</span> <span class="token string">"/templates/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置字符编码</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//指定模板文件名称</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"course_template.ftl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//准备数据</span>
        <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//静态化</span>
        <span class="token comment">//参数1：模板，参数2：数据模型</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将静态化内容输出到文件中</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输出流</span>
        <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"D:\\develop\\test.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>185行报错了，明天醒过来在改bug吧</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614004035910.png" alt="image-20230614004035910"></p>
<p>又又又发现了新bug，通过nignx访问<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/api/content/coursepreview/1#发现无法访问了">http://www.51xuecheng.cn/api/content/coursepreview/1#发现无法访问了</a></p>
<p>最后发现，原因是开了梯子之后改了我的代理</p>
<p>把这个取消勾选即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614113038443.png" alt="image-20230614113038443"></p>
<p>太蠢了。</p>
<p>但原来的bug还是没有解决。</p>
<p>解决：</p>
<p>报错信息来看是：由于在模板的第183行中的表达式<code>$&#123;secondNode.teachplanMedia.teachplanId!&#39;&#39;&#125;</code>中的<code>secondNode.teachplanMedia</code>为null或不存在所导致的。</p>
<p>存在，并采取相应的处理措施。你可以在<code>$&#123;secondNode.teachplanMedia.teachplanId!&#39;&#39;&#125;</code>表达式之前添加一个条件检查，例如：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">perlCopy code<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#if</span> <span class="token attr-name">secondNode.teachplanMedia??</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.51xuecheng.cn/course/preview/learning.html?id=$&#123;model.courseBase.id!<span class="token punctuation">'</span><span class="token punctuation">'</span>&#125;&amp;chapter=$&#123;secondNode.teachplanMedia.teachplanId!<span class="token punctuation">'</span><span class="token punctuation">'</span>&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>$&#123;secondNode.pname!''&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这样，如果<code>secondNode.teachplanMedia</code>为null或不存在，整个<code>&lt;li&gt;</code>元素将被跳过，避免出现空指针异常。</p>
<p>终于通了，哭了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614121646244.png" alt="image-20230614121646244"></p>
<p>成功生成静态页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614121929708.png" alt="image-20230614121929708"></p>
<h3 id="上传文件测试（内容管理任务远程调用媒资管理上传服务）"><a href="#上传文件测试（内容管理任务远程调用媒资管理上传服务）" class="headerlink" title="上传文件测试（内容管理任务远程调用媒资管理上传服务）"></a><strong>上传文件测试</strong>（内容管理任务远程调用媒资管理上传服务）</h3><p>微服务之间难免会存在远程调用，在Spring Cloud中可以使用Feign进行远程调用，</p>
<p>Feign是一个声明式的http客户端，官方地址：<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p>
<p>下边先准备Feign的开发环境:</p>
<p>1、在内容管理content-service工程添加依赖：</p>
<p>注意，只是openfeign还不能支持文件参数，还需要导入一个组件才能支持 multipart传参</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>discovery<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token class-name">Spring</span> <span class="token class-name">Cloud</span> 微服务远程调用 <span class="token operator">--</span><span class="token operator">></span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>openfeign<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>openfeign<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>feign<span class="token operator">-</span>httpclient<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>feign支持<span class="token class-name">Multipart</span>格式传参<span class="token operator">--</span><span class="token operator">></span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span>form<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>feign<span class="token operator">-</span>form<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">3.8</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span>form<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>feign<span class="token operator">-</span>form<span class="token operator">-</span>spring<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">3.8</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解释一下，discovery 是将自己的服务像上报，以及<strong>获取其他实例地址</strong>，后面的不用解释</p>
<p>2、远程调用时可能发生熔断（下级服务宕机），需要打开熔断开关</p>
<p>单独定义一个文件，在nacos配置feign-dev.yaml公用配置文件</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">30000</span>  <span class="token comment">#熔断超时时间</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#连接超时时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#读超时时间</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#重试次数</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#切换实例的重试次数</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3、在调用方（centent service ）以及配调用方 （media api） 都引入共享配置</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">shared<span class="token operator">-</span>configs<span class="token operator">:</span>
  <span class="token operator">-</span> data<span class="token operator">-</span>id<span class="token operator">:</span> feign<span class="token operator">-</span>$<span class="token punctuation">&#123;</span>spring<span class="token punctuation">.</span>profiles<span class="token punctuation">.</span>active<span class="token punctuation">&#125;</span><span class="token punctuation">.</span>yaml
    group<span class="token operator">:</span> xuecheng<span class="token operator">-</span>plus<span class="token operator">-</span>common
    refresh<span class="token operator">:</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>4、在内容管理service工程配置feign支持Multipart，拷贝课程资料下的MultipartSupportConfig 到content-service工程下的config包下。</p>
<h4 id="被调用方"><a href="#被调用方" class="headerlink" title="被调用方"></a>被调用方</h4><p>现在需要将课程的静态文件上传到minio，</p>
<p>但仅仅使用 上传图片接口是不行的，他的储存方式是 按照年月日存储</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614125317484.png" alt="image-20230614125317484"></p>
<p>现在呢，我想单独存储到course目录下objectname为”课程id.html”，那么</p>
<p>在原有的上传文件接口需要增加一个参数 objectname。</p>
<p>方案一： 可以在原来上传文件的基础上 增加一个参数，增加objectname （@RequestParam required =false），判断不为空就传到指定路径</p>
<p>如果为空，那就按照年月日格式上传。</p>
<p>方案二：可以重新编写一个函数</p>
<p>那么对原来的接口做如下改变（方案1）</p>
<pre class="line-numbers language-none"><code class="language-none">@ApiOperation(&quot;上传文件&quot;)
@RequestMapping(value &#x3D; &quot;&#x2F;upload&#x2F;coursefile&quot;,consumes &#x3D; MediaType.MULTIPART_FORM_DATA_VALUE)
public UploadFileResultDto upload(@RequestPart(&quot;filedata&quot;) MultipartFile filedata,
                                  @RequestParam(value&#x3D; &quot;objectName&quot;,required&#x3D;false) String objectName) throws IOException&#123;
                                  &#x2F;&#x2F;....
 &#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>service接口也增加一个参数：</p>
<pre class="line-numbers language-none"><code class="language-none">public UploadFileResultDto uploadFile(Long companyId, UploadFileParamsDto uploadFileParamsDto, String localFilePath,String objectName);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614130339396.png" alt="image-20230614130339396"></p>
<p>实现：</p>
<p>修改原有uploadFile方法，判断如果objectName为空则采取年月日样式的路径方式。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//存储到minio中的对象名(带目录)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    objectName <span class="token operator">=</span>  defaultFolderPath <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> extension<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//        String objectName = defaultFolderPath + fileMd5 + extension;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="调用方"><a href="#调用方" class="headerlink" title="调用方"></a>调用方</h4><h5 id="编写远程调用接口"><a href="#编写远程调用接口" class="headerlink" title="编写远程调用接口"></a><strong>编写远程调用接口</strong></h5><p>在contentservice 下创建feignclient 包，用于存放调用方接口函数</p>
<p>创建接口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614134339772.png" alt="image-20230614134339772" style="zoom: 67%;" /></p>
<p>如果相信远程调用，首先在接口上加 feignclient相关注解</p>
<p>1、调用方需要知道要调用的接口是什么？</p>
<p>当然是这个</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"上传文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/upload/coursefile"</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>MULTIPART_FORM_DATA_VALUE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"folder"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把这个接口函数复制到调用接口里面，后续修改。</p>
<p>1.1、补全请求路径，@RequestMapping 路径改为 “media/upload/coursefile” ,因为原来微服务配置里面帮忙在前面加了，但是在理作为被调用方，不会自动加</p>
<p>1.2、在接口上面添加@FeignClient()  注解，并在参数中指定调用的微服务名称@FeignClient(“media-api”)</p>
<p>2、原始的Feign不支持Multipart格式的传参，所以还需要加上配置类configuration = MultipartSupportConfig.class</p>
<p>最终接口上的注解应该为 @FeignClient(value = “media-api”,configuration = MultipartSupportConfig.class)</p>
<p>完整应该长这样</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614133244027.png" alt="image-20230614133244027"></p>
<p>发现返回值爆红，是因为还没导报，我们暂时先不导，将其转成String</p>
<h5 id="编写一个调用类（测试）"><a href="#编写一个调用类（测试）" class="headerlink" title="编写一个调用类（测试）"></a>编写一个调用类（测试）</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignUploadTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaServiceClient</span> mediaServiceClient<span class="token punctuation">;</span>

    <span class="token comment">//远程调用，上传文件</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\develop\\test.html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaServiceClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span><span class="token string">"course"</span><span class="token punctuation">,</span><span class="token string">"test.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后执行还要在启动类上加上@EnableFeignClients注解！！！</p>
<p>因为这里是单元测试，只需要在 service test里面的启动类加上即可</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"com.xuecheng.content.feignclient"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XC_ContentServiceApplication</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">XC_ContentServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>报错，说找不到服务</p>
<p>1、排查配置：</p>
<p>调用方和被调用方都需要将自己的服务上报。（配置discovery 以及 config）</p>
<p>2、依赖</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614135435018.png" alt="image-20230614135435018"></p>
<p>测试成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614135458242.png" alt="image-20230614135458242"></p>
<p>然后我们试试直接访问资源</p>
<p>输入网址</p>
<p><a target="_blank" rel="noopener" href="http://192.168.101.65:9000/mediafiles/course/test124.html">http://192.168.101.65:9000/mediafiles/course/test124.html</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614135636969.png" alt="image-20230614135636969"></p>
<p>可以的，但是没有样式，要想访问样式只能从主站走，那么</p>
<p>试着用nignx访问</p>
<p>那么需要增加一个主站下的代理</p>
<pre class="line-numbers language-conf" data-language="conf"><code class="language-conf"># 课程详情页的静态界面
# www.51xuecheng.cn&#x2F;course&#x2F;test124.html -&gt;file.51xuecheng.cn&#x2F;mediafiles&#x2F;course&#x2F;test124.html
location &#x2F;course&#x2F; &#123;
       proxy_pass 	http:&#x2F;&#x2F;fileserver&#x2F;mediafiles&#x2F;course&#x2F;; # 后面的斜杠一定不能少！！！！！
&#125; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>成功！！！！（又遇到梯子把我的代理给屏蔽了的情况，气死我了）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614141003584.png" alt="image-20230614141003584"></p>
<h3 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h3><p>微服务中难免存在服务之间的远程调用，当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致<strong>雪崩效应。</strong></p>
<p>如何解决由于微服务异常引起的雪崩效应呢？</p>
<p>可以采用熔断、降级的方法去解决。</p>
<p>熔断降级是两个步骤</p>
<p>熔断：下游服务有问题，触发熔断（相当于异常），可以通过负载均衡访问其他下游服务实例</p>
<p>降级：熔断触发，且没有可以使用的下游服务实例，走走另一套处理逻辑，或者走另一套服务，而不去再调用原来的熔断的服务。</p>
<h4 id="开启熔断（调用方和被调用方都）"><a href="#开启熔断（调用方和被调用方都）" class="headerlink" title="开启熔断（调用方和被调用方都）"></a>开启熔断（调用方和被调用方都）</h4><p>前面其实已经做过了引入通用配置，配置里面开启熔断</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">feign<span class="token operator">:</span>
  hystrix<span class="token operator">:</span>
    enabled<span class="token operator">:</span> <span class="token boolean">true</span>
  circuitbreaker<span class="token operator">:</span>
    enabled<span class="token operator">:</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>设置熔断的超时时间，为了防止一次处理时间较长触发熔断这里还需要设置请求和连接的超时时间，如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">hystrix<span class="token operator">:</span>
  command<span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      execution<span class="token operator">:</span>
        isolation<span class="token operator">:</span>
          thread<span class="token operator">:</span>
            timeoutInMilliseconds<span class="token operator">:</span> <span class="token number">30000</span>  #熔断超时时间
ribbon<span class="token operator">:</span>
  <span class="token class-name">ConnectTimeout</span><span class="token operator">:</span> <span class="token number">60000</span> #连接超时时间
  <span class="token class-name">ReadTimeout</span><span class="token operator">:</span> <span class="token number">60000</span> #读超时时间
  <span class="token class-name">MaxAutoRetries</span><span class="token operator">:</span> <span class="token number">0</span> #重试次数
  <span class="token class-name">MaxAutoRetriesNextServer</span><span class="token operator">:</span> <span class="token number">1</span> #切换实例的重试次数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>熔断是<strong>开启熔断</strong>远程调用出    超时/切换实例/异常后/   自动触发的，而降级需要我们编写降级处理逻辑，</p>
<p>有两种方法实现降级</p>
<h4 id="降级方案一-fallback："><a href="#降级方案一-fallback：" class="headerlink" title="降级方案一 fallback："></a>降级方案一 fallback：</h4><p>在定义 （@feignclient）feignclient接口的时候，在注解上添加 fallback 属性，fallback 指定一个类（.class），而这个类 实现了 feignclient接口。</p>
<p>缺点：无法取出熔断抛出的异常</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"media-api"</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"media/upload/coursefile"</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>MULTIPART_FORM_DATA_VALUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"folder"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaServiceClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">XuechengPlusException</span><span class="token punctuation">(</span><span class="token string">"调用失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return null;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="降级方案二-：-fallbackfactory"><a href="#降级方案二-：-fallbackfactory" class="headerlink" title="降级方案二 ： fallbackfactory"></a>降级方案二 ： fallbackfactory</h4><p>在定义 （@feignclient）feignclient接口的时候，在注解上添加 fallbackFactory 属性,  fallbackFactory 指定一个工厂类实习类，而这个工厂类实现一个fallbackFactory 工厂接口，接口需要指定feignclient接口 作为泛型， 其次工厂实体类需要重写里面的create方法</p>
<p>create方法自带一个Trowable 参数，这个参数其实就是 下游微服务爆出的异常。，其次create方法的返回值是 feignclient接口</p>
<p>也就是需要 也就是你需要返回一个 实现了feignclient接口的类（也就是书写处理逻辑的地方）,一般写一个匿名内部类，重写降级处理逻辑方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"media-api"</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaServiceClient</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//降级方法</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"调用媒资管理服务上传文件时发生熔断，异常信息:&#123;&#125;"</span><span class="token punctuation">,</span>throwable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>降级处理逻辑：</p>
<p>返回一个null对象，上游服务请求接口得到一个null说明执行了降级处理。</p>
<p>测试：</p>
<p>停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p>
<h3 id="完善页面静态化任务"><a href="#完善页面静态化任务" class="headerlink" title="完善页面静态化任务"></a>完善页面静态化任务</h3><p>首先定义好页面静态化 以及 上传静态化文件到minio 这两个 函数</p>
<p>在课程发布的service编写这两部分内容，最后通过消息去调度执行</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span><span class="token class-name">File</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>接口实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">//静态化文件</span>
  <span class="token class-name">File</span> htmlFile  <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//配置freemarker</span>
   <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//加载模板</span>
   <span class="token comment">//选指定模板路径,classpath下templates下</span>
   <span class="token comment">//得到classpath路径</span>
   <span class="token class-name">String</span> classpath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classpath <span class="token operator">+</span> <span class="token string">"/templates/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//设置字符编码</span>
   configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//指定模板文件名称</span>
   <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"course_template.ftl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//准备数据</span>
   <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//静态化</span>
   <span class="token comment">//参数1：模板，参数2：数据模型</span>
   <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            System.out.println(content);</span>
   <span class="token comment">//将静态化内容输出到文件中</span>
   <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//创建静态化文件</span>
   htmlFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"course"</span><span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"课程静态化，生成静态文件:&#123;&#125;"</span><span class="token punctuation">,</span>htmlFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//输出流</span>
   <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>htmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"课程静态化异常:&#123;&#125;"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"课程静态化异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> htmlFile<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span> <span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
   <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> course <span class="token operator">=</span> mediaServiceClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"course/"</span><span class="token operator">+</span>courseId<span class="token operator">+</span><span class="token string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>course<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"上传静态文件异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"课程静态化文件上传异常:&#123;&#125;"</span><span class="token punctuation">,</span>ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"课程静态化文件上传异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>任务完善</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"开始进行课程静态化,课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息id</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息处理的service</span>
    <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息幂等性处理</span>
    <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"课程静态化已处理直接返回，课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//生成静态化页面</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">generateCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传静态化页面</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        coursePublishService<span class="token punctuation">.</span><span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">XuechengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"生成的静态文件为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//保存第一阶段状态</span>
    mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意还需要开启启动类（api工程中）上的 Feign 的那个注解</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"com.xuecheng.content.feignclient"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>api 引入熔断配置</p>
<p>测试 124 课程</p>
<p>删除课程发布表的124行</p>
<p>更改课程基本信息表的124课程，修改其 （发布）状态 status 为 203001 （未发布） 审核状态audit status 为 202004（未审核）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614190247599.png" alt="image-20230614190247599"></p>
<p>稍微修改一下课程信息，如我改了名称</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614190322753.png" alt="image-20230614190322753"></p>
<p>修改后保存，提交审核</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614190419541.png" alt="image-20230614190419541"></p>
<p>点击后界面弹出提交成功</p>
<p>可以在预发布表看到这门课程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614190520741.png" alt="image-20230614190520741"></p>
<p><strong>审核</strong></p>
<p>人工修改他的审核状态 审核状态改为202004 审核通过</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614191051225.png" alt="image-20230614191051225">并修改基本信息表审核状态为通过</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614191310212.png" alt="image-20230614191310212"></p>
<p>发布</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614191446247.png" alt="image-20230614191446247"></p>
<p>点击的同时他会他预发布表的相关信息写道发布表以及信息表</p>
<p>先查看发布表，有了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614191601765.png" alt="image-20230614191601765"></p>
<p>再查看信息表</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614191628300.png" alt="image-20230614191628300"></p>
<p>都有啦</p>
<p>那么启动任务调度，让他扫描消息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614191734038.png" alt="image-20230614191734038"></p>
<p>似乎是启动成功了：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614192032480.png" alt="image-20230614192032480"></p>
<p>查看minio</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614192135795.png" alt="image-20230614192135795"></p>
<p>yeeeeeeeeeeh！！</p>
<p>别急，为了保证消息幂等性，看看消息是否还存在？，发现没有啦，跑通！！！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614192247894.png" alt="image-20230614192247894"></p>
<h2 id="子任务：课程搜索"><a href="#子任务：课程搜索" class="headerlink" title="子任务：课程搜索"></a>子任务：课程搜索</h2><p>采用<strong>全文检索</strong>的方式取搜索数据</p>
<p>传统搜索（先找文章再找词），先找文档（行数据）在分别判断行数据的每一个属性（全文）里面是否包含关键字</p>
<p>全文检索（先找词再找文章），集体是实现是计算机索引程序通过<strong>扫描文章</strong>中的每一个词，<strong>对每一个词建立一个索引（倒排索引），</strong>指明<strong>该词在哪个文章中出现？以及文章中出现的次数和位置</strong>，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p>
<p>这种全文检索技术我们使用ElasticSearch实现，</p>
<p>课程搜索也要将课程信息建立索引，<strong>在课程发布时建立课程索引</strong>，索引建立好用户可通过搜索网页去查询课程信息。</p>
<p>所以课程搜索这部分模块，我们有两个任务，</p>
<p>1、机构端 在数据插入时（课程发布时），创建（添加到）索引 （这也是我们子任务之一）</p>
<p>2、用户端 在搜索数据时（搜索课程时），利用索引返回文章（这里返回课程号，到时候之间用niginx返回静态化后的课程数据）（虽然是子任务之外的，但是为了行文逻辑流畅就放这里了）</p>
<h3 id="ES-KB环境部署"><a href="#ES-KB环境部署" class="headerlink" title="ES KB环境部署"></a>ES KB环境部署</h3><p>elasticsearch和kibana我之前已经安装在docker里面了，直接用即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> restart elasticsearch
<span class="token function">docker</span> restart kibana<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>试试通过kibanana浏览一下 端口号 5601</p>
<p>可以通过以下方式查看已经建立的索引</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614194740547.png" alt="image-20230614194740547" style="zoom:50%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614194802780.png" alt="image-20230614194802780"></p>
<p>嗯。这还是几个月以前玩剩下的</p>
<p>索引相当于MySQL中的表，Elasticsearch与MySQL之间概念的对应关系见下表：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/clip_image002.gif" alt="img"></p>
<p>要使用elasticsearch需要建立索引，Mapping相当于表结构，Mapping创建后其字段不能删除（要删除只能删除整个表。。。）</p>
<p>总体而言记住上面的与数据库的对应关系表就行。</p>
<p>那么我们先创建这个<strong>发布课程</strong>的这个索引,</p>
<p>先复制以下 http命令</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /course-publish

<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"companyId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"companyName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"users"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"mt"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"mtName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"st"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"stName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"teachmode"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"createDate"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"status"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"remark"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"charge"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"scaled_float"</span><span class="token punctuation">,</span>
        <span class="token property">"scaling_factor"</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"originalPrice"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"scaled_float"</span><span class="token punctuation">,</span>
        <span class="token property">"scaling_factor"</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"validDays"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614195525336.png" alt="image-20230614195525336"></p>
<p>粘贴运行即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614195709535.png" alt="image-20230614195709535"></p>
<p>成功</p>
<p>通过 GET /_cat/indices?v 查询所有的索引，查找course-publish是否创建成功。</p>
<p>通过GET /course-publish/_mapping 查询course-publish的索引结构。</p>
<h3 id="部署搜索工程"><a href="#部署搜索工程" class="headerlink" title="部署搜索工程"></a>部署搜索工程</h3><ul>
<li><p>拷贝黑马提供的搜索工程到项目根目录</p>
</li>
<li><p>修改配置文件 上报服务、接收配置</p>
</li>
<li><p>nacos配置</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">server<span class="token operator">:</span>
  servlet<span class="token operator">:</span>
    context<span class="token operator">-</span>path<span class="token operator">:</span> <span class="token operator">/</span>search
  port<span class="token operator">:</span> <span class="token number">53080</span>

elasticsearch<span class="token operator">:</span>
  hostlist<span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.101</span><span class="token number">.128</span><span class="token operator">:</span><span class="token number">9200</span>  
  course<span class="token operator">:</span>
    index<span class="token operator">:</span> course<span class="token operator">-</span>publish
    source_fields<span class="token operator">:</span> id<span class="token punctuation">,</span>companyId<span class="token punctuation">,</span>companyName<span class="token punctuation">,</span>name<span class="token punctuation">,</span>users<span class="token punctuation">,</span>grade<span class="token punctuation">,</span>mt<span class="token punctuation">,</span>mtName<span class="token punctuation">,</span>st<span class="token punctuation">,</span>stName<span class="token punctuation">,</span>charge<span class="token punctuation">,</span>pic<span class="token punctuation">,</span>price<span class="token punctuation">,</span>originalPrice<span class="token punctuation">,</span>description<span class="token punctuation">,</span>teachmode<span class="token punctuation">,</span>validDays<span class="token punctuation">,</span>createDate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>启动网关、搜索服务测试一下</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">### 添加课程索引

POST &#123;&#123;search_host&#125;&#125;/search/index/course
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token application-json">
<span class="token punctuation">&#123;</span>
  <span class="token property">"charge"</span> <span class="token operator">:</span> <span class="token string">"201000"</span><span class="token punctuation">,</span>
  <span class="token property">"companyId"</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">"companyName"</span> <span class="token operator">:</span> <span class="token string">"北京黑马程序"</span><span class="token punctuation">,</span>
  <span class="token property">"createDate"</span> <span class="token operator">:</span> <span class="token string">"2022-09-25 09:36:11"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span> <span class="token operator">:</span> <span class="token string">"《Spring编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作"</span><span class="token punctuation">,</span>
  <span class="token property">"grade"</span> <span class="token operator">:</span> <span class="token string">"204001"</span><span class="token punctuation">,</span>
  <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token property">"mt"</span> <span class="token operator">:</span> <span class="token string">"1-3"</span><span class="token punctuation">,</span>
  <span class="token property">"mtName"</span> <span class="token operator">:</span> <span class="token string">"编程开发"</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"Spring编程思想"</span><span class="token punctuation">,</span>
  <span class="token property">"originalPrice"</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png"</span><span class="token punctuation">,</span>
  <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">"remark"</span> <span class="token operator">:</span> <span class="token string">"没有备注"</span><span class="token punctuation">,</span>
  <span class="token property">"st"</span> <span class="token operator">:</span> <span class="token string">"1-3-2"</span><span class="token punctuation">,</span>
  <span class="token property">"stName"</span> <span class="token operator">:</span> <span class="token string">"Java语言"</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"203002"</span><span class="token punctuation">,</span>
  <span class="token property">"tags"</span> <span class="token operator">:</span> <span class="token string">"没有标签"</span><span class="token punctuation">,</span>
  <span class="token property">"teachmode"</span> <span class="token operator">:</span> <span class="token string">"200002"</span><span class="token punctuation">,</span>
  <span class="token property">"validDays"</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">&#125;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614203439656.png" alt="image-20230614203439656"></p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">### 搜索课程

GET &#123;&#123;search_host&#125;&#125;/search/course/list?pageNo=1&amp;keywords=spring
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614203639489.png" alt="image-20230614203639489"></p>
<p>进入前端搜索界面<a target="_blank" rel="noopener" href="http://www.51xuecheng.cn/course/search.html">http://www.51xuecheng.cn/course/search.html</a></p>
<p>可以看到刚才添加的那一条。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230614203826184.png" alt="image-20230614203826184"></p>
<h3 id="简单看看搜索工程代码"><a href="#简单看看搜索工程代码" class="headerlink" title="简单看看搜索工程代码"></a>简单看看搜索工程代码</h3><h4 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h4><p>config包下只有一个ElasticSearchConfig，主要是提供了一个Java的客户端来操作ES的，将其注册为一个bean</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 1. 从nacos中读取es的地址，不过我这里只部署了单体ES，它这里可能是ES集群</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.hostlist&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> hostlist<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">restHighLevelClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//2. 解析hostlist配置信息</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> hostlist<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3. 创建HttpHost数组，其中存放es主机和端口的配置信息</span>
        <span class="token class-name">HttpHost</span><span class="token punctuation">[</span><span class="token punctuation">]</span> httpHostArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">[</span>split<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> split<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> item <span class="token operator">=</span> split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            httpHostArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//4. 创建RestHighLevelClient客户端</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>httpHostArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不过只部署一个节点的话，可以简化一下代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.hostlist&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> hostlist<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">restHighLevelClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>hostlist<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><p>课程索引接口</p>
<ul>
<li>该接口根据课程信息来创建索引</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程信息索引接口"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"课程信息索引接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndexController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.course.index&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">IndexService</span> indexService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"添加课程索引"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"course"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"课程id为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> indexService<span class="token punctuation">.</span><span class="token function">addCourseIndex</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"添加课程索引失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>课程搜索接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程搜索接口"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"课程搜索接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/course"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseSearchController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CourseSearchService</span> courseSearchService<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程搜索列表"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">return</span> courseSearchService<span class="token punctuation">.</span><span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span>pageParams<span class="token punctuation">,</span> searchCourseParamDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="dto"><a href="#dto" class="headerlink" title="dto"></a>dto</h4><p>定义了两个dto类，一个是接收搜索课程参数的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchCourseParamDto</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//关键字</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keywords<span class="token punctuation">;</span>
   
    <span class="token comment">//大分类</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mt<span class="token punctuation">;</span>
   
    <span class="token comment">//小分类</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> st<span class="token punctuation">;</span>
   
    <span class="token comment">//难度等级</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> grade<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另一个是网站门户显示的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">PageResult</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//大分类列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> mtList<span class="token punctuation">;</span>
    <span class="token comment">//小分类列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stList<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> items<span class="token punctuation">,</span> <span class="token keyword">long</span> counts<span class="token punctuation">,</span> <span class="token keyword">long</span> page<span class="token punctuation">,</span> <span class="token keyword">long</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> counts<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="service"><a href="#service" class="headerlink" title="service"></a>service</h4><p>定义了两个Service接口</p>
<p>课程索引Service，提供了三个接口，添加索引、更新索引、删除索引</p>
<pre class="line-numbers language-none"><code class="language-none">public interface IndexService &#123;

    Boolean addCourseIndex(String indexName, String id, Object object);

    Boolean updateCourseIndex(String indexName, String id, Object object);

    Boolean deleteCourseIndex(String indexName, String id);

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>搜索</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CourseSearchService</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Impl"><a href="#Impl" class="headerlink" title="Impl"></a>Impl</h4><p>对应的两个实现类</p>
<p> 课程索引接口实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IndexService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">addCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指定索引文档内容</span>
        indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//索引响应对象</span>
        <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"添加索引出错:&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"添加索引出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> indexResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"created"</span><span class="token punctuation">)</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"updated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">updateCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UpdateRequest</span> updateRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        updateRequest<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UpdateResponse</span> updateResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            updateResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>updateRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"更新索引出错:&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"更新索引出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">DocWriteResponse<span class="token punctuation">.</span>Result</span> result <span class="token operator">=</span> updateResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"updated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">deleteCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">//删除索引请求对象</span>
        <span class="token class-name">DeleteRequest</span> deleteRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//响应对象</span>
        <span class="token class-name">DeleteResponse</span> deleteResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            deleteResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>deleteRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"删除索引出错:&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"删除索引出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//获取响应结果</span>
        <span class="token class-name">DocWriteResponse<span class="token punctuation">.</span>Result</span> result <span class="token operator">=</span> deleteResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"deleted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>搜索实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseSearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CourseSearchService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.course.index&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexStore<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.course.source_fields&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sourceFields<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">//设置索引</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//source源字段过虑</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>courseSearchParam <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//关键字</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//匹配关键字</span>
            <span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置匹配占比</span>
            multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">"70%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//提升另个字段的Boost值</span>
            multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//过虑</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"mtName"</span><span class="token punctuation">,</span> courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"stName"</span><span class="token punctuation">,</span> courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"grade"</span><span class="token punctuation">,</span> courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//分页</span>
        <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//布尔查询</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//高亮设置</span>
        <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">"&lt;font class='eslight'>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">"&lt;/font>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置高亮字段</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder<span class="token punctuation">.</span>Field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//请求搜索</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//聚合设置</span>
        <span class="token function">buildAggregation</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"课程搜索异常：&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//结果集处理</span>
        <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//记录总数</span>
        <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//数据列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//取出source</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> sourceAsMap <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//课程id</span>
            <span class="token class-name">Long</span> id <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取出名称</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取出高亮字段内容</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">></span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>highlightFields <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">HighlightField</span> nameField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nameField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Text</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fragments <span class="token operator">=</span> nameField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">StringBuffer</span> stringBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Text</span> str <span class="token operator">:</span> fragments<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    name <span class="token operator">=</span> stringBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            courseIndex<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            courseIndex<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
        <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//获取聚合结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> mtList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mtAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pageResult<span class="token punctuation">.</span><span class="token function">setMtList</span><span class="token punctuation">(</span>mtList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setStList</span><span class="token punctuation">(</span>stList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildAggregation</span><span class="token punctuation">(</span><span class="token class-name">SearchRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span>
                <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"mtAgg"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"mtName"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span>
                <span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"stAgg"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"stName"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getAggregation</span><span class="token punctuation">(</span><span class="token class-name">Aggregations</span> aggregations<span class="token punctuation">,</span> <span class="token class-name">String</span> aggName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 4.1.根据聚合名称获取聚合结果</span>
        <span class="token class-name">Terms</span> brandTerms <span class="token operator">=</span> aggregations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aggName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2.获取buckets</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">></span></span> buckets <span class="token operator">=</span> brandTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3.遍历</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> brandList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 4.4.获取key</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            brandList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> brandList<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="索引管理"><a href="#索引管理" class="headerlink" title="索引管理"></a><strong>索引管理</strong></h3><p>emmm。看到实现那部分就有点头大了，尤其是搜索那部分，什么高亮，聚合，几乎都忘了差不多了，来个小复习</p>
<h4 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a><strong>REST API</strong></h4><h5 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a><strong>添加文档</strong></h5><p>索引(结构mapping)创建好就可以向其中添加文档，此时elasticsearch会根据索引的mapping配置对有些字段进行分词。</p>
<p>语法：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /<span class="token punctuation">&#123;</span>索引库名<span class="token punctuation">&#125;</span>/_doc/<span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
    json ...
<span class="token punctuation">&#125;</span>


如：
    
POST /course-publish/_doc/<span class="token number">103</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"charge"</span> <span class="token operator">:</span> <span class="token string">"201001"</span><span class="token punctuation">,</span>
  <span class="token property">"companyId"</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">"companyName"</span> <span class="token operator">:</span> <span class="token string">"北京黑马程序"</span><span class="token punctuation">,</span>
  <span class="token property">"createDate"</span> <span class="token operator">:</span> <span class="token string">"2022-09-25 09:36:11"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span> <span class="token operator">:</span> <span class="token string">"HTML/CSS"</span><span class="token punctuation">,</span>
  <span class="token property">"grade"</span> <span class="token operator">:</span> <span class="token string">"204001"</span><span class="token punctuation">,</span>
  <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token property">"mt"</span> <span class="token operator">:</span> <span class="token string">"1-1"</span><span class="token punctuation">,</span>
  <span class="token property">"mtName"</span> <span class="token operator">:</span> <span class="token string">"前端开发"</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"Html参考大全"</span><span class="token punctuation">,</span>
  <span class="token property">"originalPrice"</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"/mediafiles/2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg"</span><span class="token punctuation">,</span>
  <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">"remark"</span> <span class="token operator">:</span> <span class="token string">"没有备注"</span><span class="token punctuation">,</span>
  <span class="token property">"st"</span> <span class="token operator">:</span> <span class="token string">"1-1-1"</span><span class="token punctuation">,</span>
  <span class="token property">"stName"</span> <span class="token operator">:</span> <span class="token string">"HTML/CSS"</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"203002"</span><span class="token punctuation">,</span>
  <span class="token property">"tags"</span> <span class="token operator">:</span> <span class="token string">"没有标签"</span><span class="token punctuation">,</span>
  <span class="token property">"teachmode"</span> <span class="token operator">:</span> <span class="token string">"200002"</span><span class="token punctuation">,</span>
  <span class="token property">"validDays"</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果要修改文档的内容可以使用上边相同的方法，如果没有则添加，如果存在则更新。</p>
<h5 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a><strong>查询文档</strong></h5><p>语法如下</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html">GET /&#123;索引库名称&#125;/_doc/&#123;id&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="修改文档，"><a href="#修改文档，" class="headerlink" title="修改文档，"></a>修改文档，</h5><p>分为全量修改和增量修改 </p>
<p>可以看到<strong>全量修改</strong> 和 <strong>增加</strong>共用一套api</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /<span class="token punctuation">&#123;</span>索引库名<span class="token punctuation">&#125;</span>/_doc/<span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
    json ...
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>增量修改</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">POST <span class="token operator">/</span><span class="token punctuation">&#123;</span>索引库名<span class="token punctuation">&#125;</span><span class="token operator">/</span>_update<span class="token operator">/</span><span class="token punctuation">&#123;</span>id<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"doc"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token string">"email"</span><span class="token operator">:</span><span class="token string">"BestApex@Apex.net"</span><span class="token punctuation">,</span>
        <span class="token string">"info"</span><span class="token operator">:</span><span class="token string">"恐怖G7人--马文"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h3><ul>
<li>当课程发布时，请求添加课程接口，添加课程信息到索引</li>
<li>当课程下架时，请求删除课程接口，从索引中删除课程信息</li>
<li>这里先实现添加课程接口</li>
</ul>
<p>根据索引的mapping结构构建po类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndex</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
    * 主键
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 机构ID
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> companyId<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 公司名称
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> companyName<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 课程名称
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 适用人群
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> users<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 标签
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>


    <span class="token comment">/**
    * 大分类
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mt<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 大分类名称
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mtName<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 小分类
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> st<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 小分类名称
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stName<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 课程等级
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> grade<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 教育模式
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> teachmode<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 课程图片
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> pic<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 课程介绍
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>


    <span class="token comment">/**
    * 发布时间
    */</span>
    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>format<span class="token operator">=</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createDate<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 状态
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 备注
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 收费规则，对应数据字典--203
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> charge<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 现价
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Float</span> price<span class="token punctuation">;</span>
    <span class="token comment">/**
    * 原价
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Float</span> originalPrice<span class="token punctuation">;</span>

    <span class="token comment">/**
    * 课程有效期天数
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> validDays<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口</p>
<p>创建添加课程索引接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程信息索引接口"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"课程信息索引接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndexController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"添加课程索引"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/course"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口开发-2"><a href="#接口开发-2" class="headerlink" title="接口开发"></a>接口开发</h3><p>定义service接口，请求ES添加课程信息</p>
<ul>
<li>注意：为了适应其他文档信息，需要将添加文档定义为通用的接口，此接口不仅适应添加课程，还适应添加其他信息</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 *  课程索引service
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IndexService</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
     * 添加索引
     * @param indexName 索引名称
     * @param id        主键
     * @param object    索引对象
     * @return          true：添加成功；false：添加失败
     */</span>
    <span class="token class-name">Boolean</span> <span class="token function">addCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">addCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1. 创建request对象</span>
    <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 准备请求参数，对应DSL语句中的JSON文档，所以要把对象序列化为JSON格式</span>
    <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 3. 发送请求</span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"添加索引出错：&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"添加索引出错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 4. 获取请求结果</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 若文档不存在，则为created，若文档存在，则为updated，若两者均不是，就是出错了</span>
    <span class="token keyword">return</span> <span class="token string">"UPDATED"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"CREATED"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口完善"><a href="#接口完善" class="headerlink" title="接口完善"></a>接口完善</h3><ul>
<li>完善Controller层，调用Service接口</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程信息索引接口"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"课程信息索引接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndexController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IndexService</span> indexService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.course.index&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"添加课程信息文档"</span><span class="token punctuation">)</span>   
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/course"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"课程id为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> indexService<span class="token punctuation">.</span><span class="token function">addCourseIndex</span><span class="token punctuation">(</span>courseIndexName<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当结果既不是created，又不是updated时，就会报这个错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"添加课程索引失败！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">### 新增课程文档测试

POST <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>search_host<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/search/index/course
Content-Type<span class="token operator">:</span> application/json

<span class="token punctuation">&#123;</span>
  <span class="token property">"charge"</span> <span class="token operator">:</span> <span class="token string">"201000"</span><span class="token punctuation">,</span>
  <span class="token property">"companyId"</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">"companyName"</span> <span class="token operator">:</span> <span class="token string">"测试CompanyName"</span><span class="token punctuation">,</span>
  <span class="token property">"createDate"</span> <span class="token operator">:</span> <span class="token string">"2023-03-07 15:41:44"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span> <span class="token operator">:</span> <span class="token string">"《测试测试测试测试》"</span><span class="token punctuation">,</span>
  <span class="token property">"grade"</span> <span class="token operator">:</span> <span class="token string">"204001"</span><span class="token punctuation">,</span>
  <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token property">"mt"</span> <span class="token operator">:</span> <span class="token string">"1-3"</span><span class="token punctuation">,</span>
  <span class="token property">"mtName"</span> <span class="token operator">:</span> <span class="token string">"编程开发"</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"Java编程思想"</span><span class="token punctuation">,</span>
  <span class="token property">"originalPrice"</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png"</span><span class="token punctuation">,</span>
  <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">"remark"</span> <span class="token operator">:</span> <span class="token string">"没有备注"</span><span class="token punctuation">,</span>
  <span class="token property">"st"</span> <span class="token operator">:</span> <span class="token string">"1-3-2"</span><span class="token punctuation">,</span>
  <span class="token property">"stName"</span> <span class="token operator">:</span> <span class="token string">"Java语言"</span><span class="token punctuation">,</span>
  <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"203002"</span><span class="token punctuation">,</span>
  <span class="token property">"tags"</span> <span class="token operator">:</span> <span class="token string">"没有标签"</span><span class="token punctuation">,</span>
  <span class="token property">"teachmode"</span> <span class="token operator">:</span> <span class="token string">"200002"</span><span class="token punctuation">,</span>
  <span class="token property">"validDays"</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h2><ul>
<li>索引信息维护完成下一步定义搜索接口，搜索课程信息</li>
<li>首先要搞清楚搜索功能的需求，进入学成在线首页的搜索页面</li>
</ul>
<ul>
<li>根据搜索页面可知需求如下<ol>
<li>根据一级分类、二级分类搜索课程信息</li>
<li>根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、内容</li>
<li>根据难度等级搜索课程</li>
<li>搜索页面分页显示</li>
</ol>
</li>
</ul>
<ul>
<li>技术点<ol>
<li>整体采用布尔查询</li>
<li>根据关键字搜索，采用MultiMatchQuery，搜索name、description字段</li>
<li>根据分类、课程等级搜索采用过滤器实现</li>
<li>分页查询</li>
<li>高亮显示</li>
</ol>
</li>
</ul>
<ul>
<li>为什么课程分类、课程等级等查询使用过滤器方式？<ul>
<li>使用关键字查询需要计算相关度算分，</li>
<li>根据课程分类、课程等级去查询不需要计算相关度得分，</li>
<li>使用过滤器实现根据课程分类、课程等级查询的过程不会计算相关度算分、效率更高</li>
</ul>
</li>
</ul>
<h3 id="接口定义-3"><a href="#接口定义-3" class="headerlink" title="接口定义"></a>接口定义</h3><p>定义搜索条件DTO类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchCourseParamDto</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//关键字（搜索条件）</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keywords<span class="token punctuation">;</span>
   
    <span class="token comment">//大分类</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mt<span class="token punctuation">;</span>
   
    <span class="token comment">//小分类</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> st<span class="token punctuation">;</span>
   
    <span class="token comment">//难度等级</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> grade<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了适应后期的扩展，定义搜索结果类，让其继承PageResult</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">PageResult</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> items<span class="token punctuation">,</span> <span class="token keyword">long</span> counts<span class="token punctuation">,</span> <span class="token keyword">long</span> page<span class="token punctuation">,</span> <span class="token keyword">long</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> counts<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义接口如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程搜索接口"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"课程搜索接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/course"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseSearchController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CourseSearchService</span> courseSearchService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程搜索列表"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口开发-3"><a href="#接口开发-3" class="headerlink" title="接口开发"></a>接口开发</h3><p>定义Service接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 *  课程搜索service
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CourseSearchService</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 搜索课程列表
     * @param pageParams            分页参数
     * @param searchCourseParamDto  搜索条件
     * @return
     */</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口实现，由于搜索接口的内容比较多，所以这里分几步实现</p>
<ol>
<li>实现根据分页搜索</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.course.index&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexName<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;elasticsearch.course.source_fields&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> sourceFields<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1. 准备Request对象</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 组织DSL参数，这里使用布尔查询</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 分页</span>
    <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.1 指定起始查询位置和查询条数</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 布尔查询</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5. 发送请求，获取响应结果</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"课程搜索异常：&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 6. 解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6.1 获取总条数</span>
    <span class="token keyword">long</span> totalHits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token comment">// 6.2 获取文档数组</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6.3 遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取文档source</span>
        <span class="token class-name">String</span> jsonCourseString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转为CourseIndex对象，加入到集合中</span>
        <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonCourseString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 7. 封装结果</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"># 网关中的服务名应与bootstrap中配置的服务名保持一致
<span class="token operator">-</span> id<span class="token operator">:</span> search
  uri<span class="token operator">:</span> lb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>search
  predicates<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token class-name">Path</span><span class="token operator">=</span><span class="token operator">/</span>search<span class="token comment">/**</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="根据条件搜索"><a href="#根据条件搜索" class="headerlink" title="根据条件搜索"></a>根据条件搜索</h3><p>下面实现根据关键字、一级分类、二级分类、难度等级搜索</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Override
</span><span class="token prefix unchanged"> </span><span class="token line">   public SearchPageResultDto&lt;CourseIndex> queryCoursePubIndex(PageParams pageParams, SearchCourseParamDto courseSearchParam) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 1. 准备Request对象
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchRequest request = new SearchRequest(courseIndexName);
</span><span class="token prefix unchanged"> </span><span class="token line">       // 2. 组织DSL参数，这里使用布尔查询
</span><span class="token prefix unchanged"> </span><span class="token line">       BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
</span><span class="token prefix unchanged"> </span><span class="token line">       String[] sourceFieldsArray = sourceFields.split(",");
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
</span><span class="token prefix unchanged"> </span><span class="token line">       // sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段
</span><span class="token prefix unchanged"> </span><span class="token line">       searchSourceBuilder.fetchSource(sourceFieldsArray, new String[]&#123;&#125;);
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3. 分页
</span><span class="token prefix unchanged"> </span><span class="token line">       Long pageNo = pageParams.getPageNo();
</span><span class="token prefix unchanged"> </span><span class="token line">       Long pageSize = pageParams.getPageSize();
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       // 3.1 指定起始查询位置和查询条数
</span><span class="token prefix inserted">+</span><span class="token line">       int start = (int) ((pageNo - 1) * pageSize);
</span><span class="token prefix inserted">+</span><span class="token line">       searchSourceBuilder.from(start)
</span><span class="token prefix inserted">+</span><span class="token line">               .size(Math.toIntExact(pageSize));
</span><span class="token prefix inserted">+</span><span class="token line">       // 3.2 指定条件查询
</span><span class="token prefix inserted">+</span><span class="token line">       if (courseSearchParam == null) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">           courseSearchParam = new SearchCourseParamDto();
</span><span class="token prefix inserted">+</span><span class="token line">       &#125;
</span><span class="token prefix inserted">+</span><span class="token line">       // 3.2.1 匹配关键字
</span><span class="token prefix inserted">+</span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;
</span><span class="token prefix inserted">+</span><span class="token line">           String keywords = courseSearchParam.getKeywords();
</span><span class="token prefix inserted">+</span><span class="token line">           boolQuery.must(QueryBuilders
</span><span class="token prefix inserted">+</span><span class="token line">                   .multiMatchQuery(keywords,"name", "description")
</span><span class="token prefix inserted">+</span><span class="token line">                   .minimumShouldMatch("70%")
</span><span class="token prefix inserted">+</span><span class="token line">                   .field("name", 10));
</span><span class="token prefix inserted">+</span><span class="token line">       &#125;
</span><span class="token prefix inserted">+</span><span class="token line">       // 3.2.2 匹配大分类
</span><span class="token prefix inserted">+</span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;
</span><span class="token prefix inserted">+</span><span class="token line">           boolQuery.filter(QueryBuilders
</span><span class="token prefix inserted">+</span><span class="token line">                   .termQuery("mtName", courseSearchParam.getMt()));
</span><span class="token prefix inserted">+</span><span class="token line">       &#125;
</span><span class="token prefix inserted">+</span><span class="token line">       // 3.2.3 匹配小分类
</span><span class="token prefix inserted">+</span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;
</span><span class="token prefix inserted">+</span><span class="token line">           boolQuery.filter(QueryBuilders
</span><span class="token prefix inserted">+</span><span class="token line">                   .termQuery("stName", courseSearchParam.getSt()));
</span><span class="token prefix inserted">+</span><span class="token line">       &#125;
</span><span class="token prefix inserted">+</span><span class="token line">       // 3.2.4 匹配难度
</span><span class="token prefix inserted">+</span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;
</span><span class="token prefix inserted">+</span><span class="token line">           boolQuery.filter(QueryBuilders
</span><span class="token prefix inserted">+</span><span class="token line">                   .termQuery("grade", courseSearchParam.getGrade()));
</span><span class="token prefix inserted">+</span><span class="token line">       &#125;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // 4. 布尔查询
</span><span class="token prefix unchanged"> </span><span class="token line">       searchSourceBuilder.query(boolQuery);
</span><span class="token prefix unchanged"> </span><span class="token line">       request.source(searchSourceBuilder);
</span><span class="token prefix unchanged"> </span><span class="token line">       // 5. 发送请求，获取响应结果
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchResponse response = null;
</span><span class="token prefix unchanged"> </span><span class="token line">       try &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           response = client.search(request, RequestOptions.DEFAULT);
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125; catch (IOException e) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           log.debug("课程搜索异常：&#123;&#125;", e.getMessage());
</span><span class="token prefix unchanged"> </span><span class="token line">           return new SearchPageResultDto&lt;>(new ArrayList&lt;>(), 0, 0, 0);
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6. 解析响应
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchHits searchHits = response.getHits();
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6.1 获取总条数
</span><span class="token prefix unchanged"> </span><span class="token line">       long totalHits = searchHits.getTotalHits().value;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6.2 获取文档数组
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchHit[] hits = searchHits.getHits();
</span><span class="token prefix unchanged"> </span><span class="token line">       ArrayList&lt;CourseIndex> list = new ArrayList&lt;>();
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6.3 遍历
</span><span class="token prefix unchanged"> </span><span class="token line">       for (SearchHit hit : hits) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           // 获取文档source
</span><span class="token prefix unchanged"> </span><span class="token line">           String jsonCourseString = hit.getSourceAsString();
</span><span class="token prefix unchanged"> </span><span class="token line">           // 转为CourseIndex对象，加入到集合中
</span><span class="token prefix unchanged"> </span><span class="token line">           CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);
</span><span class="token prefix unchanged"> </span><span class="token line">           list.add(courseIndex);
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 7. 封装结果
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchPageResultDto&lt;CourseIndex> pageResult = new SearchPageResultDto&lt;>(list, totalHits, pageNo, pageSize);
</span><span class="token prefix unchanged"> </span><span class="token line">       return pageResult;
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="聚合搜索"><a href="#聚合搜索" class="headerlink" title="聚合搜索"></a>聚合搜索</h3><ul>
<li>搜索页面上显示的一级分类、二级分类来源于搜索结果，使用聚合搜索实现找到搜索结果中的一级分类、二级分类<ol>
<li>首先在搜索结果DTO类中添加一级分类、二级分类列表</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">PageResult</span> <span class="token punctuation">&#123;</span>

<span class="token operator">+</span>   <span class="token comment">//大分类列表</span>
<span class="token operator">+</span>   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> mtList<span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token comment">//小分类列表</span>
<span class="token operator">+</span>   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stList<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> items<span class="token punctuation">,</span> <span class="token keyword">long</span> counts<span class="token punctuation">,</span> <span class="token keyword">long</span> page<span class="token punctuation">,</span> <span class="token keyword">long</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> counts<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Override
</span><span class="token prefix unchanged"> </span><span class="token line">   public SearchPageResultDto&lt;CourseIndex> queryCoursePubIndex(PageParams pageParams, SearchCourseParamDto courseSearchParam) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 1. 准备Request对象
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchRequest request = new SearchRequest(courseIndexName);
</span><span class="token prefix unchanged"> </span><span class="token line">       // 2. 组织DSL参数，这里使用布尔查询
</span><span class="token prefix unchanged"> </span><span class="token line">       BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
</span><span class="token prefix unchanged"> </span><span class="token line">       String[] sourceFieldsArray = sourceFields.split(",");
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();
</span><span class="token prefix unchanged"> </span><span class="token line">       // sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段
</span><span class="token prefix unchanged"> </span><span class="token line">       searchSourceBuilder.fetchSource(sourceFieldsArray, new String[]&#123;&#125;);
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3. 分页
</span><span class="token prefix unchanged"> </span><span class="token line">       Long pageNo = pageParams.getPageNo();
</span><span class="token prefix unchanged"> </span><span class="token line">       Long pageSize = pageParams.getPageSize();
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3.1 指定起始查询位置和查询条数
</span><span class="token prefix unchanged"> </span><span class="token line">       int start = (int) ((pageNo - 1) * pageSize);
</span><span class="token prefix unchanged"> </span><span class="token line">       searchSourceBuilder.from(start)
</span><span class="token prefix unchanged"> </span><span class="token line">               .size(Math.toIntExact(pageSize));
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3.2 指定条件查询
</span><span class="token prefix unchanged"> </span><span class="token line">       if (courseSearchParam == null) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           courseSearchParam = new SearchCourseParamDto();
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3.2.1 匹配关键字
</span><span class="token prefix unchanged"> </span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getKeywords()))&#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           String keywords = courseSearchParam.getKeywords();
</span><span class="token prefix unchanged"> </span><span class="token line">           boolQuery.must(QueryBuilders
</span><span class="token prefix unchanged"> </span><span class="token line">                   .multiMatchQuery(keywords,"name", "description")
</span><span class="token prefix unchanged"> </span><span class="token line">                   .minimumShouldMatch("70%")
</span><span class="token prefix unchanged"> </span><span class="token line">                   .field("name", 10));
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3.2.2 匹配大分类
</span><span class="token prefix unchanged"> </span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getMt()))&#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           boolQuery.filter(QueryBuilders
</span><span class="token prefix unchanged"> </span><span class="token line">                   .termQuery("mtName", courseSearchParam.getMt()));
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3.2.3 匹配小分类
</span><span class="token prefix unchanged"> </span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getSt()))&#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           boolQuery.filter(QueryBuilders
</span><span class="token prefix unchanged"> </span><span class="token line">                   .termQuery("stName", courseSearchParam.getSt()));
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3.2.4 匹配难度
</span><span class="token prefix unchanged"> </span><span class="token line">       if (StringUtils.isNotEmpty(courseSearchParam.getGrade()))&#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           boolQuery.filter(QueryBuilders
</span><span class="token prefix unchanged"> </span><span class="token line">                   .termQuery("grade", courseSearchParam.getGrade()));
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 4. 布尔查询
</span><span class="token prefix unchanged"> </span><span class="token line">       searchSourceBuilder.query(boolQuery);
</span><span class="token prefix unchanged"> </span><span class="token line">       request.source(searchSourceBuilder);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       // 聚合设置
</span><span class="token prefix inserted">+</span><span class="token line">       buildAggregation(request);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // 5. 发送请求，获取响应结果
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchResponse response = null;
</span><span class="token prefix unchanged"> </span><span class="token line">       try &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           response = client.search(request, RequestOptions.DEFAULT);
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125; catch (IOException e) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           log.debug("课程搜索异常：&#123;&#125;", e.getMessage());
</span><span class="token prefix unchanged"> </span><span class="token line">           return new SearchPageResultDto&lt;>(new ArrayList&lt;>(), 0, 0, 0);
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6. 解析响应
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchHits searchHits = response.getHits();
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6.1 获取总条数
</span><span class="token prefix unchanged"> </span><span class="token line">       long totalHits = searchHits.getTotalHits().value;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6.2 获取文档数组
</span><span class="token prefix unchanged"> </span><span class="token line">       SearchHit[] hits = searchHits.getHits();
</span><span class="token prefix unchanged"> </span><span class="token line">       ArrayList&lt;CourseIndex> list = new ArrayList&lt;>();
</span><span class="token prefix unchanged"> </span><span class="token line">       // 6.3 遍历
</span><span class="token prefix unchanged"> </span><span class="token line">       for (SearchHit hit : hits) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           // 获取文档source
</span><span class="token prefix unchanged"> </span><span class="token line">           String jsonCourseString = hit.getSourceAsString();
</span><span class="token prefix unchanged"> </span><span class="token line">           // 转为CourseIndex对象，加入到集合中
</span><span class="token prefix unchanged"> </span><span class="token line">           CourseIndex courseIndex = JSON.parseObject(jsonCourseString, CourseIndex.class);
</span><span class="token prefix unchanged"> </span><span class="token line">           list.add(courseIndex);
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 7. 封装结果
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       List&lt;String> mtList = getAggregation(response.getAggregations(), "mtAgg");
</span><span class="token prefix inserted">+</span><span class="token line">       List&lt;String> stList = getAggregation(response.getAggregations(), "stAgg");
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       SearchPageResultDto&lt;CourseIndex> pageResult = new SearchPageResultDto&lt;>(list, totalHits, pageNo, pageSize);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       pageResult.setMtList(mtList);
</span><span class="token prefix inserted">+</span><span class="token line">       pageResult.setStList(stList);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       return pageResult;
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;
</span></span>

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   private void buildAggregation(SearchRequest request) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">       request.source().aggregation(AggregationBuilders
</span><span class="token prefix inserted">+</span><span class="token line">               .terms("mtAgg")
</span><span class="token prefix inserted">+</span><span class="token line">               .field("mtName")
</span><span class="token prefix inserted">+</span><span class="token line">               .size(100)
</span><span class="token prefix inserted">+</span><span class="token line">       );
</span><span class="token prefix inserted">+</span><span class="token line">       request.source().aggregation(AggregationBuilders
</span><span class="token prefix inserted">+</span><span class="token line">               .terms("stAgg")
</span><span class="token prefix inserted">+</span><span class="token line">               .field("stName")
</span><span class="token prefix inserted">+</span><span class="token line">               .size(100)
</span><span class="token prefix inserted">+</span><span class="token line">       );
</span><span class="token prefix inserted">+</span><span class="token line">   &#125;
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   /**
</span><span class="token prefix inserted">+</span><span class="token line">   * 根据聚合名称获取聚合结果
</span><span class="token prefix inserted">+</span><span class="token line">   * @param aggregations  聚合对象
</span><span class="token prefix inserted">+</span><span class="token line">   * @param aggName       聚合名称
</span><span class="token prefix inserted">+</span><span class="token line">   * @return              聚合结果，返回List集合
</span><span class="token prefix inserted">+</span><span class="token line">   */
</span><span class="token prefix inserted">+</span><span class="token line">   private List&lt;String> getAggregation(Aggregations aggregations, String aggName) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">       // 1. 根据聚合名称获取聚合结果
</span><span class="token prefix inserted">+</span><span class="token line">       Terms brandTerms = aggregations.get(aggName);
</span><span class="token prefix inserted">+</span><span class="token line">       // 2. 获取buckets
</span><span class="token prefix inserted">+</span><span class="token line">       List&lt;? extends Terms.Bucket> buckets = brandTerms.getBuckets();
</span><span class="token prefix inserted">+</span><span class="token line">       // 3. 遍历
</span><span class="token prefix inserted">+</span><span class="token line">       List&lt;String> brandList = new ArrayList&lt;>();
</span><span class="token prefix inserted">+</span><span class="token line">       for (Terms.Bucket bucket : buckets) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">           // 4. 获取key
</span><span class="token prefix inserted">+</span><span class="token line">           String key = bucket.getKeyAsString();
</span><span class="token prefix inserted">+</span><span class="token line">           // 5. 加入到集合中
</span><span class="token prefix inserted">+</span><span class="token line">           brandList.add(key);
</span><span class="token prefix inserted">+</span><span class="token line">       &#125;
</span><span class="token prefix inserted">+</span><span class="token line">       return brandList;
</span><span class="token prefix inserted">+</span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="聚合搜索测试"><a href="#聚合搜索测试" class="headerlink" title="聚合搜索测试"></a>聚合搜索测试</h3><p>进入搜索界面，观察搜索请求的响应内容中是否存在mtList和stList</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2023/03/07/ppem1Fs.png" alt="img"></p>
<ul>
<li>注意：当选中一个一级分类时，才会显示二级分类</li>
</ul>
<h3 id="高亮设置"><a href="#高亮设置" class="headerlink" title="高亮设置"></a>高亮设置</h3><p> 最后实现关键字在课程名称中高亮显示</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"ES条件查询并响应分页结果"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 准备Request对象</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 组织DSL参数，这里使用布尔查询</span>
        <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// sourceFieldsArray指定要返回的字段，new String[]&#123;&#125;指定不返回的字段</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 分页</span>
        <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.1 指定起始查询位置和查询条数</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.2 指定条件查询</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>courseSearchParam <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 3.2.1 匹配关键字</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> keywords <span class="token operator">=</span> courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span>
                    <span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>keywords<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">"70%"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 3.2.2 匹配大分类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span>
                    <span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"mtName"</span><span class="token punctuation">,</span> courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 3.2.3 匹配小分类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span>
                    <span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"stName"</span><span class="token punctuation">,</span> courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 3.2.4 匹配难度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span>
                    <span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"grade"</span><span class="token punctuation">,</span> courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 4. 布尔查询</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token comment">// 高亮</span>
<span class="token operator">+</span>       searchSourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">+</span>               <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>
<span class="token operator">+</span>               <span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">"&lt;font class='eslight'>"</span><span class="token punctuation">)</span>
<span class="token operator">+</span>               <span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">"&lt;/font>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 聚合设置</span>
        <span class="token function">buildAggregation</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 发送请求，获取响应结果</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"课程搜索异常：&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 6. 解析响应</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.1 获取总条数</span>
        <span class="token keyword">long</span> totalHits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token comment">// 6.2 获取文档数组</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.3 遍历</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取文档source</span>
            <span class="token class-name">String</span> jsonCourseString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 转为CourseIndex对象</span>
            <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonCourseString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>           <span class="token comment">// 获取高亮</span>
<span class="token operator">+</span>           <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">></span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>           log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"获取高亮：&#123;&#125;"</span><span class="token punctuation">,</span> highlightFields<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>           <span class="token class-name">String</span> name <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>           <span class="token comment">// 健壮性判断</span>
<span class="token operator">+</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token operator">+</span>               <span class="token comment">// 获取高亮字段结果</span>
<span class="token operator">+</span>               <span class="token class-name">HighlightField</span> highlightField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>               log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"成功获取高亮字段"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>               <span class="token comment">// 健壮性判断</span>
<span class="token operator">+</span>               <span class="token keyword">if</span> <span class="token punctuation">(</span>highlightField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token operator">+</span>                   log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"取出高亮结果数组的第一个"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                   <span class="token comment">// 取出高亮结果数组的第一个</span>
<span class="token operator">+</span>                   name <span class="token operator">=</span> highlightField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>               <span class="token punctuation">&#125;</span>
<span class="token operator">+</span>           <span class="token punctuation">&#125;</span>
<span class="token operator">+</span>           courseIndex<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 7. 封装结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> mtList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mtAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"stAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">></span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setMtList</span><span class="token punctuation">(</span>mtList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pageResult<span class="token punctuation">.</span><span class="token function">setStList</span><span class="token punctuation">(</span>stList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSAN10A.png" alt="img"></p>
<h3 id="高亮设置测试"><a href="#高亮设置测试" class="headerlink" title="高亮设置测试"></a>高亮设置测试</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppeHHRP.png" alt="img"></p>
<h2 id="课程发布任务完善"><a href="#课程发布任务完善" class="headerlink" title="课程发布任务完善"></a>课程发布任务完善</h2><h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h3><ul>
<li>执行课程发布操作后，由消息处理机制向ElasticSearch索引保存课程信息</li>
<li>由内容管理服务远程调用搜索服务，添加课程信息索引</li>
<li>搜索服务请求ElasticSearch添加课程信息</li>
</ul>
<h3 id="课程索引任务开发"><a href="#课程索引任务开发" class="headerlink" title="课程索引任务开发"></a>课程索引任务开发</h3><ol>
<li>在内容管理服务中添加FeignClient</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"search"</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">SearchServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchServiceClient</span> <span class="token punctuation">&#123;</span>

 <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/search/index/course"</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchServiceClient</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"调用搜索发生熔断走降级方法,熔断异常:"</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编写课程索引任务执行方法</p>
<p>完善CoursePublishTask类中的saveCourseIndex方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//保存课程索引信息</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"保存课程索引信息,课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//消息id</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息处理的service</span>
    <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息幂等性处理</span>
    <span class="token keyword">int</span> stageTwo <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageTwo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stageTwo <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"课程索引已处理直接返回，课程id:&#123;&#125;"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//保存第一阶段状态</span>
        mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageTwo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">//取出课程发布信息</span>
    <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> coursePublishMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拷贝至课程索引对象</span>
    <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">,</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//远程调用搜索服务api添加课程信息到索引</span>
    <span class="token class-name">Boolean</span> add <span class="token operator">=</span> searchServiceClient<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>add<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"添加索引失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> add<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>5.5.3</strong> <strong>测试</strong></p>
<p>测试流程如下：</p>
<p>1、启动elasticsearch、kibana。</p>
<p>2、启动网关、内容管理、搜索服务、nginx。</p>
<p>3、启动xxl-job调度中心。</p>
<p>4、在任务调度中心开始课程发布任务。</p>
<p>5、发布一门课程，页面提示操作成功，查看发布课程任务是否写到任务表。</p>
<p>6、经过任务调度将课程信息写入索引。</p>
<p>7、通过门户进入搜索页面，查看课程信息是否展示。</p>
<h1 id="扩展：课程信息索引同步"><a href="#扩展：课程信息索引同步" class="headerlink" title="扩展：课程信息索引同步"></a><strong>扩展：课程信息索引同步</strong></h1><p>通过向索引中添加课程信息最终实现了课程的搜索，我们发现课程信息是先保存在关系数据库中，而后再写入索引，这个过程是将关系数据中的数据同步到elasticsearch索引中的过程，可以简单成为索引同步。</p>
<p>通常项目中使用elasticsearch需要完成索引同步，索引同步的方法很多：</p>
<h2 id="实时性高"><a href="#实时性高" class="headerlink" title="实时性高"></a>实时性高</h2><p>1、针对实时性非常高的场景需要满足数据的及时同步，可以同步调用，或使用Canal去实现。</p>
<p>1）方案一：手动写，同步调用。同步调用即在向MySQL写数据后远程调用搜索服务的接口写入索引，此方法简单但是耦合代码太高。</p>
<p>2）方案二：可以使用一个中间的软件canal解决耦合性的问题，但存在学习与维护成本。</p>
<p>canal主要用途是基于 MySQL 数据库增量日志解析，并能提供增量数据订阅和消费，实现将MySQL的数据同步到消息队列、Elasticsearch、其它数据库等，应用场景十分丰富。 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615082607260.png" alt="image-20230615082607260"></p>
<p>它的地址：</p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a> </p>
<p>版本下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/releases">https://github.com/alibaba/canal/releases</a></p>
<p>文档地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/Docker-QuickStart">https://github.com/alibaba/canal/wiki/Docker-QuickStart</a></p>
<p>Canal基于mysql的binlog技术实现数据同步，什么是binlog，它是一个文件，二进制格式，记录了对数据库更新的SQL语句，向数据库写数据的同时向binlog文件里记录对应的sql语句。当数据库服务器发生了故障就可以使用binlog文件对数据库进行恢复。</p>
<p>所以，使用canal是需要开启mysql的binlog写入功能，Canal工作原理如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615082640731.png" alt="image-20230615082640731"></p>
<p>1、canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump </p>
<p>协议 </p>
<p>2、MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal ) </p>
<p>3、canal 解析 binary log 对象(原始为 byte 流)</p>
<p>详细使用Canal进行索引同步的步骤参考：Canal实现索引同步.pdf</p>
<h2 id="实时性要求不高"><a href="#实时性要求不高" class="headerlink" title="实时性要求不高"></a>实时性要求不高</h2><p>2、当索引同步的实时性要求不高时可用的技术比较多，比如：MQ、Logstash、任务调度等。</p>
<p>MQ：向mysql写数据的时候向mq写入消息，搜索服务监听MQ，收到消息后写入索引。使用MQ的优势是代码解耦，但是需要处理消息可靠性的问题有一定的技术成本，做到消息可靠性需要做到生产者投递成功、消息持久化以及消费者消费成功三个方面，另外还要做好消息幂等性问题。</p>
<p>Logstash： 开源实时日志分析平台 ELK包括Elasticsearch、Kibana、Logstash，Logstash负责收集、解析和转换日志信息，可以实现MySQL与Elasticsearch之间的数据同步。也可以实现解耦合并且是官方推荐，但需要增加学习与维护成本。</p>
<p>任务调度：向mysql写数据的时候记录修改记录，开启一个定时任务根据修改记录将数据同步到Elasticsearch。</p>
<p>根据本项目的需求，课程发布后信息同步的实时性要求不高，从提交审核到发布成功一般两个工作日完成。综合比较以上技术方案本项目的索引同步技术使用任务调度的方法。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615083006881.png" alt="image-20230615083006881"></p>
<p>1、课程发布向消息表插入记录。</p>
<p>2、由任务调度程序通过消息处理SDK对消息记录进行处理。</p>
<p>3、向elasticsearch索引中保存课程信息。</p>
<p>如何向向elasticsearch索引中保存课程信息？</p>
<p>执行流程如下：</p>
<p>由内容管理服务远程调用搜索服务添加课程信息索引，搜索服务再请求elasticsearch向课程索引中添加文档。</p>
<h1 id="面试-1"><a href="#面试-1" class="headerlink" title="面试"></a>面试</h1><ul>
<li><p>ElasticSearch是怎么使用的</p>
</li>
<li><p>本项目使用ElasticSearch开发搜索服务，步骤如下</p>
<ol>
<li>创建索引（相当于数据库表），将课程信息添加到索引库，对课程信息进行分词，存储到索引库</li>
<li>开发一个搜索服务，编写课程搜索接口，调用ElasticSearch的rest接口根据关键字、课程分类等信息进行搜索</li>
</ol>
</li>
<li><p>如何保证索引同步？</p>
</li>
<li><p>本项目时使用本地任务表 + xxl-job任务调度进行索引同步，具体流程如下</p>
<ol>
<li>添加或修改或删除课程的同时，向任务表插入一条记录，这条记录就记录了是添加还是修改还是删除了哪个课程</li>
<li>任务调度定时扫描任务表，根据任务表的内容对课程信息进行同步<ul>
<li>如果添加了课程，将课程添加到索引库</li>
<li>如果修改了课程，就修改索引库的课程</li>
<li>如果是删除了课程，将课程信息从索引库删除</li>
</ul>
</li>
</ol>
</li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/06/15/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%914-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发4-认证授权模块开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230615083641.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">类MOOC系统开发4-认证授权模块开发</div></div></a></div><div class="next-post pull-right"><a href="/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发2-媒资管理模块开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">类MOOC系统开发2-媒资管理模块开发</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">taotaozi</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">60</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/differencer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/differencer?type=blog" target="_blank" title="Github"><i class="fab fa-CSDN"></i></a><a class="social-icon" href="https://space.bilibili.com/20713910" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a><a class="social-icon" href="/473439851" target="_blank" title="steam"><i class="fab fa-steam"></i></a><a class="social-icon" href="https://weibo.com/u/5856795355" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="mailto:1359114644@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">最近的新任务是 ： 努力啊</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-text">模块功能介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88"><span class="toc-text">课程预览</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8EFreemarker"><span class="toc-text">模板引擎Freemarker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%A8%A1%E6%9D%BF"><span class="toc-text">添加模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A1%AB%E5%85%85%E6%95%B0%E6%8D%AE"><span class="toc-text">填充数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-text">静态资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E7%AB%99"><span class="toc-text">配置主站</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E5%9F%9F%E5%90%8D%E9%83%BD%E8%83%BD%E8%BF%9B%E5%85%A5nignx-%E8%AF%B7%E6%B1%82%E7%BD%91%E7%AB%99%E8%B5%84%E6%BA%90"><span class="toc-text">浏览器访问任意一个域名都能进入nignx 请求网站资源</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E8%BE%93%E5%85%A5%E5%9F%9F%E5%90%8D%E5%90%8E%E8%AE%BF%E9%97%AE%E7%9A%84%E6%97%B6nignx-%E7%9B%AE%E5%BD%95%E4%B8%8B-html-%E4%B8%8B%E7%9A%84%E8%B5%84%E6%BA%90"><span class="toc-text">默认输入域名后访问的时nignx 目录下 &#x2F;html&#x2F;下的资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E8%AF%BE%E7%A8%8B%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-text">访问课程详情页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">文件服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2"><span class="toc-text">视频播放页面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E9%A2%84%E8%A7%88%E7%95%8C%E9%9D%A2%E6%8E%A5%E5%8F%A3"><span class="toc-text">课程预览界面接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%A8%A1%E6%9D%BF"><span class="toc-text">准备模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-text">定义接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%A8%A1%E6%9D%BF"><span class="toc-text">编写模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E9%A1%B5%E9%9D%A2%E6%8E%A5%E5%8F%A3"><span class="toc-text">视频播放页面接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95"><span class="toc-text">面试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E5%AE%A1%E6%A0%B8"><span class="toc-text">提交审核</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">数据模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-1"><span class="toc-text">接口开发</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83"><span class="toc-text">课程发布</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA"><span class="toc-text">分布式事务框架搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88"><span class="toc-text">分布式事务技术方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCAP%E7%90%86%E8%AE%BA"><span class="toc-text">什么是CAP理论</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E7%9A%84%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%96%B9%E6%A1%88"><span class="toc-text">课程发布的事务控制方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">发布接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%88%E6%B6%88%E6%81%AF-%E4%BB%BB%E5%8A%A1%E8%A1%A8%E5%90%8C%E6%AD%A5%EF%BC%89"><span class="toc-text">接口开发（消息&#x2F;任务表同步）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86SDK%EF%BC%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA%EF%BC%89"><span class="toc-text">消息处理SDK（分布式任务框架搭建）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="toc-text">课程发布任务处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8xxl-job%E9%85%8D%E7%BD%AE%E4%BB%BB%E5%8A%A1"><span class="toc-text">在xxl-job配置任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E4%BB%BB%E5%8A%A1%EF%BC%9A%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-text">子任务：页面静态化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96%E4%BB%8B%E7%BB%8D"><span class="toc-text">页面静态化介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="toc-text">静态化测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%B5%8B%E8%AF%95%EF%BC%88%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E4%BB%BB%E5%8A%A1%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E4%B8%8A%E4%BC%A0%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-text">上传文件测试（内容管理任务远程调用媒资管理上传服务）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A2%AB%E8%B0%83%E7%94%A8%E6%96%B9"><span class="toc-text">被调用方</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%96%B9"><span class="toc-text">调用方</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3"><span class="toc-text">编写远程调用接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%B0%83%E7%94%A8%E7%B1%BB%EF%BC%88%E6%B5%8B%E8%AF%95%EF%BC%89"><span class="toc-text">编写一个调用类（测试）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-text">熔断降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E7%86%94%E6%96%AD%EF%BC%88%E8%B0%83%E7%94%A8%E6%96%B9%E5%92%8C%E8%A2%AB%E8%B0%83%E7%94%A8%E6%96%B9%E9%83%BD%EF%BC%89"><span class="toc-text">开启熔断（调用方和被调用方都）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E6%96%B9%E6%A1%88%E4%B8%80-fallback%EF%BC%9A"><span class="toc-text">降级方案一 fallback：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E6%96%B9%E6%A1%88%E4%BA%8C-%EF%BC%9A-fallbackfactory"><span class="toc-text">降级方案二 ： fallbackfactory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96%E4%BB%BB%E5%8A%A1"><span class="toc-text">完善页面静态化任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E4%BB%BB%E5%8A%A1%EF%BC%9A%E8%AF%BE%E7%A8%8B%E6%90%9C%E7%B4%A2"><span class="toc-text">子任务：课程搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ES-KB%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="toc-text">ES KB环境部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%90%9C%E7%B4%A2%E5%B7%A5%E7%A8%8B"><span class="toc-text">部署搜索工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9C%8B%E7%9C%8B%E6%90%9C%E7%B4%A2%E5%B7%A5%E7%A8%8B%E4%BB%A3%E7%A0%81"><span class="toc-text">简单看看搜索工程代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller"><span class="toc-text">Controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dto"><span class="toc-text">dto</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#service"><span class="toc-text">service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Impl"><span class="toc-text">Impl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86"><span class="toc-text">索引管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#REST-API"><span class="toc-text">REST API</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3"><span class="toc-text">添加文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-text">查询文档</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3%EF%BC%8C"><span class="toc-text">修改文档，</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-2"><span class="toc-text">接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%8C%E5%96%84"><span class="toc-text">接口完善</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">接口测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2"><span class="toc-text">搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-3"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-3"><span class="toc-text">接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E6%9D%A1%E4%BB%B6%E6%90%9C%E7%B4%A2"><span class="toc-text">根据条件搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2"><span class="toc-text">聚合搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%90%9C%E7%B4%A2%E6%B5%8B%E8%AF%95"><span class="toc-text">聚合搜索测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E8%AE%BE%E7%BD%AE"><span class="toc-text">高亮设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E8%AE%BE%E7%BD%AE%E6%B5%8B%E8%AF%95"><span class="toc-text">高亮设置测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E4%BB%BB%E5%8A%A1%E5%AE%8C%E5%96%84"><span class="toc-text">课程发布任务完善</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E7%B4%A2%E5%BC%95%E4%BB%BB%E5%8A%A1%E5%BC%80%E5%8F%91"><span class="toc-text">课程索引任务开发</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%EF%BC%9A%E8%AF%BE%E7%A8%8B%E4%BF%A1%E6%81%AF%E7%B4%A2%E5%BC%95%E5%90%8C%E6%AD%A5"><span class="toc-text">扩展：课程信息索引同步</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%80%A7%E9%AB%98"><span class="toc-text">实时性高</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%80%A7%E8%A6%81%E6%B1%82%E4%B8%8D%E9%AB%98"><span class="toc-text">实时性要求不高</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95-1"><span class="toc-text">面试</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/07/01/SpringCloud%E5%85%A5%E9%97%A8/" title="SpringCloud入门"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230701192515.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud入门"/></a><div class="content"><a class="title" href="/2023/07/01/SpringCloud%E5%85%A5%E9%97%A8/" title="SpringCloud入门">SpringCloud入门</a><time datetime="2023-07-01T11:01:06.000Z" title="发表于 2023-07-01 19:01:06">2023-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/22/%E9%98%BF%E9%87%8C%E4%BA%91ECS%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/" title="阿里云ECS配置项目环境"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230622100635.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="阿里云ECS配置项目环境"/></a><div class="content"><a class="title" href="/2023/06/22/%E9%98%BF%E9%87%8C%E4%BA%91ECS%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/" title="阿里云ECS配置项目环境">阿里云ECS配置项目环境</a><time datetime="2023-06-22T02:05:14.000Z" title="发表于 2023-06-22 10:05:14">2023-06-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/17/spring-security%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" title="spring security框架学习（待写）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230617100825.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="spring security框架学习（待写）"/></a><div class="content"><a class="title" href="/2023/06/17/spring-security%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" title="spring security框架学习（待写）">spring security框架学习（待写）</a><time datetime="2023-06-17T02:06:51.000Z" title="发表于 2023-06-17 10:06:51">2023-06-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/15/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%914-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发4-认证授权模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230615083641.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发4-认证授权模块开发"/></a><div class="content"><a class="title" href="/2023/06/15/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%914-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发4-认证授权模块开发">类MOOC系统开发4-认证授权模块开发</a><time datetime="2023-06-15T00:35:37.000Z" title="发表于 2023-06-15 08:35:37">2023-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发3-课程发布模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发3-课程发布模块开发"/></a><div class="content"><a class="title" href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发3-课程发布模块开发">类MOOC系统开发3-课程发布模块开发</a><time datetime="2023-06-12T05:35:38.000Z" title="发表于 2023-06-12 13:35:38">2023-06-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By taotaozi</div><div class="footer_custom_text">世上最幸运的事就是喜欢上一个人</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'differencer/giscus',
    'data-repo-id': 'R_kgDOJMrL1A',
    'data-category-id': 'DIC_kwDOJMrL1M4CVC1y',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>