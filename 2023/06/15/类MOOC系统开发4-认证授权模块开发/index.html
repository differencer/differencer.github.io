<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>类MOOC系统开发4-认证授权模块开发 | tのblog</title><meta name="author" content="taotaozi"><meta name="copyright" content="taotaozi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本项目基于 SpringScurity 框架+ OAuth2 协议实现的用户单点登录。 认证授权的概念认证：就是身份认证，系统要知道登陆的用户是谁 ：  常见的用户身份认证表现形式有 用户名密码登录 微信扫码登录等    授权：不同的系统资源访问以及操作需要角色权限。 认证先发生，才能有授权发生。 业务流程统一认证 项目包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口">
<meta property="og:type" content="article">
<meta property="og:title" content="类MOOC系统开发4-认证授权模块开发">
<meta property="og:url" content="https://differencer.github.io/2023/06/15/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%914-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="tのblog">
<meta property="og:description" content="本项目基于 SpringScurity 框架+ OAuth2 协议实现的用户单点登录。 认证授权的概念认证：就是身份认证，系统要知道登陆的用户是谁 ：  常见的用户身份认证表现形式有 用户名密码登录 微信扫码登录等    授权：不同的系统资源访问以及操作需要角色权限。 认证先发生，才能有授权发生。 业务流程统一认证 项目包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230615083641.png">
<meta property="article:published_time" content="2023-06-15T00:35:37.000Z">
<meta property="article:modified_time" content="2023-06-24T17:04:42.589Z">
<meta property="article:author" content="taotaozi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230615083641.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://differencer.github.io/2023/06/15/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%914-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '类MOOC系统开发4-认证授权模块开发',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-25 01:04:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230615083641.png')"><nav id="nav"><span id="blog-info"><a href="/" title="tのblog"><span class="site-name">tのblog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">类MOOC系统开发4-认证授权模块开发</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-15T00:35:37.000Z" title="发表于 2023-06-15 08:35:37">2023-06-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-24T17:04:42.589Z" title="更新于 2023-06-25 01:04:42">2023-06-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">24.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>93分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="类MOOC系统开发4-认证授权模块开发"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>本项目基于 SpringScurity 框架+ OAuth2 协议实现的用户单点登录。</p>
<h1 id="认证授权的概念"><a href="#认证授权的概念" class="headerlink" title="认证授权的概念"></a>认证授权的概念</h1><p>认证：就是身份认证，系统要知道登陆的用户是谁 ：</p>
<ul>
<li>常见的用户身份认证表现形式有<ul>
<li>用户名密码登录</li>
<li>微信扫码登录等</li>
</ul>
</li>
</ul>
<p>授权：不同的<strong>系统资源</strong>访问以及操作需要<strong>角色</strong>权限。</p>
<p>认证先发生，才能有授权发生。</p>
<h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h2><h3 id="统一认证"><a href="#统一认证" class="headerlink" title="统一认证"></a>统一认证</h3><ul>
<li>项目包括学生、学习机构的老师、平台运营人员三类用户，三类用户将使用统一的认证入口</li>
<li>用户输入账号密码提交认证，认证通过后继续操作</li>
<li>认证通过由认证服务想用户颁发jwt令牌，相当于访问系统的通行证，用户拿着令牌去访问系统的资源</li>
<li>认证失败继续登录，如果用户强行跳过认证，没有令牌的话，很多资源没有权限访问</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppmVgrF.png" alt="img"></p>
<h3 id="单点登录"><a href="#单点登录" class="headerlink" title="单点登录"></a>单点登录</h3><p>特点：</p>
<p>1、在一个统一登录（认证）界面登录</p>
<p>2、登陆一次就可以访问所有相互信任的应用系统。</p>
<h3 id="第三方认证"><a href="#第三方认证" class="headerlink" title="第三方认证"></a>第三方认证</h3><p>扫码登录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppmmHMV.png" alt="img"></p>
<h1 id="Spring-Security认证"><a href="#Spring-Security认证" class="headerlink" title="Spring Security认证"></a>Spring Security认证</h1><h2 id="Spring-Security介绍"><a href="#Spring-Security介绍" class="headerlink" title="Spring Security介绍"></a>Spring Security介绍</h2><ul>
<li>与业务无关，市面上有很多认证框架，如Apache Shiro、CAS、Spring Security等</li>
<li>本项目是基于Spring Cloud技术构建，Spring Security是spring家族的一份子，且和Spring Cloud集成的很好，所以本项目采用Spring Security作为认证服务的技术框架</li>
<li>Spring Security是一个功能强大且可高度定制的身份验证和访问控制框架，它是一个专注于为Java应用程序提供身份验证和授权的框架</li>
<li>项目主页：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></li>
<li>SpringCloud Security：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-security">https://spring.io/projects/spring-cloud-security</a></li>
</ul>
<h2 id="认证授权入门"><a href="#认证授权入门" class="headerlink" title="认证授权入门"></a>认证授权入门</h2><p>现在从零开始搭建一个认证服务</p>
<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p>创建xc_users数据库</p>
<p>导入课程资料中的xcplus_users.sql脚本。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615095714675.png" alt="image-20230615095714675"></p>
<p>在nacos中新增auth-service-dev.yaml</p>
<p>配置数据库</p>
<pre class="line-numbers language-none"><code class="language-none">server:
  servlet:
    context-path: &#x2F;auth
  port: 63070
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql:&#x2F;&#x2F;192.168.101.65:3306&#x2F;xc_users?serverTimezone&#x3D;UTC&amp;userUnicode&#x3D;true&amp;useSSL&#x3D;false&amp;
    username: root
    password: root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建一个空的SpringBoot工程"><a href="#创建一个空的SpringBoot工程" class="headerlink" title="创建一个空的SpringBoot工程"></a>创建一个空的SpringBoot工程</h3><p>从课程资料中拷贝xuecheng-plus-auth工程到自己的工程目录下。</p>
<p>此工程是一个普通的spring boot工程，可以连接数据库。</p>
<p>里面基本上什么都没有，只是配置了MP连接数据库</p>
<p>自带一个controller</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> userMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/login-success"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"登录成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user/&#123;id&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">getuser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r1"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"访问r1资源"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"访问r2资源"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>启动工程，访问<code>localhost:63070/auth/r/r1</code>，</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615100907021.png" alt="image-20230615100907021"></p>
<h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><ul>
<li>下面向SpringBoot工程集成Spring Security</li>
<li>向pom.xml中加入Spring Security所需的依赖，只要加了依赖，这个系统就被没人配置管控了，只有认证通过的才能访问</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启工程，访问<code>localhost:63070/auth/r/r1</code>，<strong>自动进入</strong><code>/login</code>页面，<code>/login</code>页面是由Spring Security提供的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2023/03/09/ppmHEYn.png" alt="img"></p>
<p>那么账号和密码是什么呢？我们需要进行安全配置，创建WebSecurityConfig配置类，继承WebSecurityConfigurerAdapter</p>
<p>他需要配置三个信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>1、用户信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//配置用户信息服务</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
    <span class="token comment">// 后面读取数据库</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2、密码方式(这里用明文方式)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        //密码为明文方式</span>
        <span class="token keyword">return</span> <span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        return new BCryptPasswordEncoder();</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3、安全拦截机制</p>
<p>这里标识 以<code>/r/**</code>开头的请求都需要 需要认证，其他的不需要认证</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token comment">//配置安全拦截机制</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    http
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/r/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//访问/r开始的请求需要认证通过</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//其它请求全部放行</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/login-success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//登录成功跳转到/login-success</span>
            http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//退出地址</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li>配置说明：<ol>
<li>通过 <code>authorizeRequests()</code> 方法来配置请求授权规则。</li>
<li>使用 <code>antMatchers()</code> 方法指定需要进行访问控制的 <code>URL</code> 路径模式。在这里，<code>/r/**</code> 表示所有以 <code>/r/</code> 开头的 URL 都需要进行授权访问。</li>
<li>使用 <code>authenticated()</code> 方法指定需要进行身份验证的请求。</li>
<li>使用 <code>anyRequest()</code> 方法配置除了 <code>/r/**</code> 以外的所有请求都不需要进行身份验证。</li>
<li>使用 <code>permitAll()</code> 方法表示任何用户都可以访问不需要进行身份验证的 <code>URL</code>。</li>
<li>使用 <code>formLogin()</code> 方法配置登录页表单认证，其中 <code>successForwardUrl()</code> 方法指定登录成功后的跳转页面。</li>
<li>使用 <code>logout()</code> 方法配置退出登录，其中 <code>logoutUrl()</code> 方法指定退出登录的 <code>URL</code>。</li>
</ol>
</li>
</ul>
</blockquote>
<p>再次登录，访问资源需要 输入相应的用户名、密码即可访问资源</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615124231310.png" alt="image-20230615124231310"></p>
<p>但对于 非拦截的资源可以直接访问</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615124612220.png" alt="image-20230615124612220"></p>
<p>http.logout().logoutUrl(“/logout”); 退出</p>
<p>本质上我觉得认证授权是一件事</p>
<p>认证可以认为是粗粒度的授权，（对于需要认证的资源来说，需要认证通过的才有权限访问，对于不需要认证的资源，直接放行，赋予其访问权限）</p>
<p>而授权就是对于需要认证的资源，需要更细力度的 权力划分，一般通过用户的角色进行更细粒度划分。</p>
<p>下面演示以下授权：</p>
<p>用用p1权限才能访问r1方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r1"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('p1')"</span><span class="token punctuation">)</span><span class="token comment">//拥有p1权限方可访问</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"访问r1资源"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r2"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('p2')"</span><span class="token punctuation">)</span><span class="token comment">//拥有p2权限方可访问</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"访问r2资源"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启服务</p>
<p>如果登录的用户访问的是不符合权限的资源，就会发生报错403（标识用户没有资格访问）</p>
<p>这里我用李四我访问r1资源</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615130214749.png" alt="image-20230615130214749"></p>
<h2 id="SpringSecurity工作原理"><a href="#SpringSecurity工作原理" class="headerlink" title="SpringSecurity工作原理"></a>SpringSecurity工作原理</h2><p>如果没有这个框架我们会用什么实现呢？ 1、 SpringMVC的拦截器 2、SpringWeb中的过滤器Filter </p>
<p>Spring Security所解决的问题就是<strong>安全访问控制</strong>，而安全访问控制功能其实就是<strong>对所有进入系统的请求进行拦截</strong>，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过Filter或AOP等技术来实现，Spring Security对Web资源的保护是<strong>靠Filter</strong>实现的，所以从这个Filter来入手，逐步深入Spring Security原理。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615130619200.png" alt="image-20230615130619200" style="zoom:50%;" /></p>
<p>整体底层是一种过滤器链来实现的。</p>
<p>FilterChainProxy是一个代理，真正起作用的是FilterChainProxy中<strong>SecurityFilterChain</strong>所包含的各个Filter，同时这些Filter作为Bean被Spring管理，</p>
<p>它们是Spring Security核心，各有各的职责，但他们并不直接处理用户的<strong>认证</strong>，也不直接处理用户的<strong>授权</strong>，而是把它们交给了认证管理器（AuthenticationManager）和决策管理器（AccessDecisionManager）进行处理。</p>
<h3 id="SecurityFilterChain-的过滤器"><a href="#SecurityFilterChain-的过滤器" class="headerlink" title="SecurityFilterChain 的过滤器"></a>SecurityFilterChain 的过滤器</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615130820413.png" alt="image-20230615130820413"></p>
<p>SecurityFilterChain有多种过滤器</p>
<p><strong>SecurityContextPersistenceFilter</strong> 这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），主要用于存储用户的上下文信息（底层基于thraedLocal）</p>
<p><strong>UsernamePasswordAuthenticationFilter</strong>（非常非常非常之重要！！！） 用于处理来自表单提交的认证,由他来提取UP来交给人认证管理器AuthenticationManager ，认证通过后会将所有用户信息存储再上下文当中交给第一层过滤器SecurityContextPersistenceFilter</p>
<p><strong>FilterSecurityInterceptor</strong> 是用于保护web资源的，使用AccessDecisionManager对当前用户进行授权访问，前面已经详细介绍过了；</p>
<p><strong>ExceptionTranslationFilter</strong> 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常：AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</p>
<h3 id="Spring-Security的执行流程"><a href="#Spring-Security的执行流程" class="headerlink" title="Spring Security的执行流程"></a>Spring Security的执行流程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230615131605549.png" alt="image-20230615131605549"></p>
<ol>
<li><p>（1、2）用户提交<strong>用户名、密码</strong>被SecurityFilterChain中的<strong>UsernamePasswordAuthenticationFilter</strong>过滤器获取到，<strong>封装为请求</strong>Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。</p>
</li>
<li><p>（3）然后过滤器<strong>将请求</strong>Authentication<strong>提交至认证管理器</strong>（AuthenticationManager）进行认证</p>
<p>2.1 <strong>认证管理器</strong>认证管理器 本身没有认证的功能 但是可以<strong>选择 认证方式</strong>  这里展示了 通过默认方式 去认证也就是委托 认证提供类 DaoAuthentication Provider 的 loadUserByUsername 来 查询/验证 数据库 返回完整的用户数据信息，验证通过后返回</p>
</li>
<li><p>（9）<strong>认证成功</strong>后，AuthenticationManager身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除）Authentication实例。最后被<strong>存储进第一层过滤器的上下文信息当中</strong></p>
</li>
</ol>
<p>关于上下文，本质就是threadlocal，但是后就可以在上下文中获取用户id啦</p>
<p>4、更细节的信息：</p>
<p><strong>认证管理器</strong>（<strong>AuthenticationManager</strong>，实现类ProviderManager）自己<strong>无法完全完成认证</strong>的功能（一是因为他的功能不是提供认证，而是由他决定调用什么认证方式，以UP方式为例，2 主要是因为他没法直接获取用户所有信息），他底层是委托了<strong>认证服务提供方</strong>AuthenticationProvider 的实现类<strong>DaoAuthenticationProvider</strong>来实现的，</p>
<p>他怎么做的呢？</p>
<p>1、根据  UserDetailService 提供的接口 提供的UP查询数据库，返回该用户所有信息，也包括密码，</p>
<p>2、(密码)校验通过 后将用户的所有信息疯封装到响应 Authentication实例里面传给 认证管理器AuthenticationManager </p>
<h2 id="Outh2协议"><a href="#Outh2协议" class="headerlink" title="Outh2协议"></a>Outh2协议</h2><p>简单来说outh2协议就是专门用于第三方登录的。（为什么要用第三方登录？主要为了新网站推广，增大用户基数）</p>
<p>第三方登录的 “前提”</p>
<p>用户没有在本平台注册过，但是在第三方注册过；</p>
<p>主要有三个角色</p>
<p>用户、平台（我们）、第三方验证服务器（有用户的信息）第三方资源服务器</p>
<p>1、（用户同意）<strong>用户</strong>微信扫码，用户向（我们）<strong>平台</strong>申请，由于我们没有用户信息，申请访问转到<strong>第三方授认证服务</strong>（先申请授权码），</p>
<p><strong>授权微服务</strong>询问<strong>用户</strong>是否愿意将自己的信息授权给 我们平台。用户同意</p>
<p>2、（获取授权码）  <strong>第三方</strong>给平台展示用户信息的过程并不是直接给，而是先下发<strong>给平台</strong>一个<strong>授权码</strong>，</p>
<p>3、（获取令牌）<strong>平台</strong>通过<strong>授权码</strong>，向第三方<strong>获取令牌</strong>（证明）、平台端发放令牌</p>
<p>4、（获取资源） <strong>平台</strong>通过<strong>令牌</strong>再向<strong>第三方资源服务器</strong> 申请<strong>用户信息</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616090942736.png" alt="image-20230616090942736"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616092655452.png" alt="image-20230616092655452"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616093713284.png" alt="image-20230616093713284"></p>
<p>本项目基于 SpringScurity 框架+ OAuth2 协议实现的用户单点登录。</p>
<h3 id="OAuth2在本项目的应用"><a href="#OAuth2在本项目的应用" class="headerlink" title="OAuth2在本项目的应用"></a>OAuth2在本项目的应用</h3><ul>
<li>OAuth2是一个标准的开放的授权协议，应用程序可以根据自己的需求去使用</li>
<li>本项目使用OAuth2实现如下目标<ol>
<li>学成在线访问第三方系统的资源<ul>
<li>本项目要接入微信扫码登录，所以本项目要是用OAuth2协议访问微信中的用户信息</li>
</ul>
</li>
<li>外部系统访问学成在线的资源<ul>
<li>同样当第三方系统想要访问学成在线网站的资源，也可以基于OAuth2协议来访问用户信息</li>
</ul>
</li>
<li>学成在线前端（客户端）访问学成在线微服务的资源<ul>
<li>本项目是前后端分离架构，前端访问微服务资源也可以基于OAuth2协议</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="OAuth2的授权模式"><a href="#OAuth2的授权模式" class="headerlink" title="OAuth2的授权模式"></a>OAuth2的授权模式</h3><ul>
<li>Spring Security支持OAuth2认证，OAuth2提供授权码模式、密码模式、简化模式、客户端模式等四种授权模式。前面举的微信扫码登录的例子就是基于授权码模式。</li>
<li>这四种模式中，授权码模式和密码模式应用较多，这里使用Spring Security演示授权码模式、密码模式。</li>
</ul>
<h4 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h4><ul>
<li>授权码模式简单理解就是使用授权码去获取令牌，要想获取令牌，首先要获取授权码，授权码的获取需要资源拥有者亲自授权同意才可以获取</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616095316652.png" alt="image-20230616095316652"></p>
<ol>
<li>用户打开浏览器</li>
<li>通过浏览器访问客户端</li>
<li>通过浏览器想认证服务请求授权（用户扫描二维码）<ul>
<li>请求授权时会携带客户端的URL，此URL为下发授权码的重定向地址</li>
</ul>
</li>
<li>认证服务向资源拥有者返回授权页面</li>
<li>资源拥有者亲自授权同意（用户点击<code>同意登录</code>）</li>
<li>通过浏览器向认证服务发送授权同意</li>
<li>认证服务向客户端地址重定向，并携带授权码</li>
<li>客户端收到授权码</li>
<li>客户端携带授权码向认证服务申请令牌</li>
<li>认证服务向客户端颁发令牌</li>
</ol>
<h5 id="授权码模式测试"><a href="#授权码模式测试" class="headerlink" title="授权码模式测试"></a>授权码模式测试</h5><ul>
<li>要想测试授权码模式，首先要配置授权服务，即上图中的认证服务器，需要配置授权服务及令牌策略</li>
<li>1、拷贝黑马提供的AuthorizationServer.java、TokenConfig.java到config包下</li>
</ul>
<p><code>AuthorizationServerConfigurerAdapter</code>要求配置以下几个类</p>
<ul>
<li>AuthorizationServerSecurityConfigurer：用来配置令牌断点的安全约束</li>
<li>ClientDetailsServiceConfigurer：用来配置客户端详情服务<ul>
<li>随便一个客户端都可以随便接入到它的认证服务吗？答案是否定的，服务提供商会给批准接入的客户端一个身份，用于接入时的凭据，有客户端标识和客户端秘钥，在这里配置批准接入的客户端的详情信息</li>
</ul>
</li>
<li>AuthorizationServerEndpointsConfigurer：用来配置令牌（token）的访问端点和令牌服务（token services）</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">AuthorizationServerConfigurer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>​                -    </p>
<p>TokenConfig为令牌策略配置类</p>
<ul>
<li>暂时使用InMemoryTokenStore在内存存储令牌，令牌的有效期等信息配置如下</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//使用内存存储令牌（普通令牌）</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryTokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"authorizationServerTokenServicesCustom"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerTokenServices</span> <span class="token function">tokenService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DefaultTokenServices</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持刷新令牌</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//令牌存储策略</span>
        service<span class="token punctuation">.</span><span class="token function">setAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">7200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 令牌默认有效期2小时</span>
        service<span class="token punctuation">.</span><span class="token function">setRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">259200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新令牌默认有效期3天</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>2、在WebSecurityConfig下配置 AuthenticationManager相关的bean</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">@EnableWebSecurity
@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)
public class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    @Bean
</span><span class="token prefix inserted">+</span><span class="token line">    public AuthenticationManager authenticationManagerBean() throws Exception &#123;
</span><span class="token prefix inserted">+</span><span class="token line">        return super.authenticationManagerBean();
</span><span class="token prefix inserted">+</span><span class="token line">    &#125;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   ....
</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>重启认证服务</p>
<p>get请求获取授权码，地址：</p>
<p><a target="_blank" rel="noopener" href="http://auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn">http://auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn">http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</a></p>
<ul>
<li>参数列表如下<ul>
<li>client_id：客户端准入标志</li>
<li>response_type：授权码模式固定为code</li>
<li>scope：客户端权限</li>
<li>redirect_uri：跳转uri，当授权码申请成功后门会跳转到此地址，并在后面带上code参数（授权码）</li>
</ul>
</li>
<li>输入账号Kyle、密码123登录成功，</li>
<li>输入<a target="_blank" rel="noopener" href="http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn">http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</a> 显示授权页面</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616104044066.png" alt="image-20230616104044066"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616104127970.png" alt="image-20230616104127970"></p>
<p>选择all ，这时会返回一个code，这就是授权码。。。</p>
<p>（麻了，给我正糊涂了，授权码不应该是第三方认证服务给我i我们的吗）</p>
<p>。。。 oo 我好像有点懂了：</p>
<p>这里只是做了一个实验， 项目是第三方 的执行流程。。。。 就是接收到一个授权请求，就把授权码发给他，并且让他重定向指定网址？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616104154313.png" alt="image-20230616104154313"></p>
<p>httpclient测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">### 授权码模式</span>
<span class="token comment">### 第一步申请授权码(浏览器请求)</span>

GET http://localhost:63070/auth/oauth/authorize?client_id<span class="token operator">=</span>XcWebApp<span class="token operator">&amp;</span><span class="token assign-left variable">response_type</span><span class="token operator">=</span>code<span class="token operator">&amp;</span><span class="token assign-left variable">scope</span><span class="token operator">=</span>all<span class="token operator">&amp;</span><span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>http://www.51xuecheng.cn


<span class="token comment">### 第二步申请令牌</span>
POST <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>auth_host<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/auth/oauth/token?client_id<span class="token operator">=</span>XcWebApp<span class="token operator">&amp;</span><span class="token assign-left variable">client_secret</span><span class="token operator">=</span>XcWebApp<span class="token operator">&amp;</span><span class="token assign-left variable">grant_type</span><span class="token operator">=</span>authorization_code<span class="token operator">&amp;</span><span class="token assign-left variable">code</span><span class="token operator">=</span>18So1d<span class="token operator">&amp;</span><span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>http://www.51xuecheng.cn
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，第二部申请的令牌需要时第一次请求申请到的授权码</p>
<p>成功获取令牌</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616105829176.png" alt="image-20230616105829176" style="zoom: 33%;" /></p>
<ul>
<li>说明<ol>
<li><code>access_token</code>：<strong>访问令牌</strong>，用于访问资源使用</li>
<li><code>token_type</code>：bearer是在RFC6750中定义的一种token类型，在携带令牌访问资源时，需要在head中加入bearer空格令牌内容</li>
<li><code>refresh_token</code>：当令牌快过期时使用刷新令牌，可以再次生成令牌</li>
<li><code>expires_in</code>：过期时间</li>
<li><code>scope</code>：令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权</li>
</ol>
</li>
</ul>
<p>令牌的作用：</p>
<p>令牌可以用于 我们后续媒体资源 访问权限的校验，令牌是由有效期的</p>
<h4 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h4><p>密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器，如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616112526673.png" alt="image-20230616112526673" style="zoom:50%;" /></p>
<p>1、资源拥有者提供账号和密码</p>
<p>2、客户端向认证服务申请令牌，请求中携带账号和密码</p>
<p>3、认证服务校验账号和密码正确颁发令牌。</p>
<h5 id="密码模式测试"><a href="#密码模式测试" class="headerlink" title="密码模式测试"></a>密码模式测试</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java">### 密码模式
POST <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>auth_host<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">/</span>auth<span class="token operator">/</span>oauth<span class="token operator">/</span>token<span class="token operator">?</span>client_id<span class="token operator">=</span><span class="token class-name">XcWebApp</span><span class="token operator">&amp;</span>client_secret<span class="token operator">=</span><span class="token class-name">XcWebApp</span><span class="token operator">&amp;</span>grant_type<span class="token operator">=</span>password<span class="token operator">&amp;</span>username<span class="token operator">=</span>lisi<span class="token operator">&amp;</span>password<span class="token operator">=</span><span class="token number">123</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>参数列表如下：</p>
<p>•     client_id：客户端准入标识。</p>
<p>•     client_secret：客户端秘钥。</p>
<p>•     grant_type：授权类型，填写   <code>password</code> 表示密码模式 //授权码模式是 <code>authorization_code</code></p>
<p>•     username：资源拥有者用户名。</p>
<p>•     password：资源拥有者密码。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616124916782.png" alt="image-20230616124916782"></p>
<ul>
<li>这种模式十分简单，但是却意味着直接将用户敏感信息泄露给了client，因此说明这种模式只能用于client是我们自己开发的情况下</li>
</ul>
<h4 id="本项目的应用方式"><a href="#本项目的应用方式" class="headerlink" title="本项目的应用方式"></a>本项目的应用方式</h4><ul>
<li>通过演示授权码模式和密码模式，<strong>授权码模式适合客户端和认证服务非同一个系统</strong>的情况，所以本项目采用<strong>授权码模式完成微信扫码认证</strong>，采用<strong>密码模式作为前端请求微服务的认证方式</strong></li>
</ul>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><h3 id="普通令牌模式的缺陷"><a href="#普通令牌模式的缺陷" class="headerlink" title="普通令牌模式的缺陷"></a>普通令牌模式的缺陷</h3><ul>
<li>客户端申请到令牌，接下来客户端携带令牌去访问资源，到资源服务器会校验令牌的合法性。</li>
<li>资源服务器如何校验令牌的合法性？这里以OAuth2的密码模式为例进行说明</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppnWUDs.png" alt="img" style="zoom: 50%;" /></p>
<p>也即是每次我们的资源微服务想要校验令牌的合法性，都需要和 认证服务确认（5）。。。。emmm，dio他码的服了</p>
<p>执行性能低。</p>
<p>能不能让资源服务自己去校验呢？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616125743213.png" alt="image-20230616125743213" style="zoom:50%;" /></p>
<p>当然可以，令牌采用JWT格式即可解决上边的问题，用户认证通过后会得到一个JWT令牌，JWT令牌中已经包括了用户相关的信息，客户端只需要携带JWT访问资源服务，资源服务根据事先约定的算法自行完成令牌校验，无需每次都请求认证服务完成授权。</p>
<h3 id="什么是JWT"><a href="#什么是JWT" class="headerlink" title="什么是JWT"></a><strong>什么是JWT</strong></h3><p>为什么JWT令牌能让微服务自行校验呢？</p>
<p>JSON Web Token（JWT）是一种使用JSON格式传递数据的网络令牌技术</p>
<p>在讲JWT之前说一说传统的校验认证方式</p>
<h4 id="传统有状态认证"><a href="#传统有状态认证" class="headerlink" title="传统有状态认证"></a>传统有状态认证</h4><p>用户登录成功将用户的身份信息存储在服务端</p>
<p>具体步骤如下：当用户访问应用服务，每个应用服务都会去 服务器查看session信息（主要是查看有没有这个用户的信息），如果session中没有该用户则说明用户没有登录，此时就会重新认证，而解决这个问题的方法是Session复制、Session黏贴。</p>
<p>一句话就是传统令牌，没有不包含用户信息，只拿一个令牌，配发判断登录的到底是谁，要想知道是谁还得看看已有的资料（session）里面有没有他</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616130350694.png" alt="image-20230616130350694" style="zoom:50%;" /></p>
<h4 id="JWT无状态认证"><a href="#JWT无状态认证" class="headerlink" title="JWT无状态认证"></a>JWT无状态认证</h4><p>用户登录，认证服务通过给用户发令牌， </p>
<p>用户访问微服务直接用令牌访问，微服务直接校验令牌合法性</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616130715066.png" alt="image-20230616130715066" style="zoom:50%;" /></p>
<p>jwt令牌之所以能世界验证的根本 原因就是可以<strong>自定义里面携带的信息</strong>（因为他长度很长。。。），这样服务单只要解码成功就可以获取令牌里面的用户信息了，不用再查seesion了，所以JWT令牌是一种无状态的认证方式</p>
<p>JWT令牌较长，占存储空间比较大，下面是一个JWT令牌的示例</p>
<pre class="line-numbers language-none"><code class="language-none">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQyNTQ2NzIsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijg4OTEyYjJkLTVkMDUtNGMxNC1iYmMzLWZkZTk5NzdmZWJjNiIsImNsaWVudF9pZCI6ImMxIn0.wkDBL7roLrvdBG2oGnXeoXq-zZRgE9IVV2nxd-ez_oA<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>JWT令牌由三部分组成，每部分中间使用点（.）分隔，例如xxxx.yyyyyy.zzzzzzz</p>
<ol>
<li><p>Header：第一部分是头部</p>
<ul>
<li><p>头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC、SHA256或RSA），一个例子如下</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;alg&quot;: &quot;HS256&quot;,
    &quot;typ&quot;: &quot;JWT&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>将上面的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分</li>
</ul>
</li>
<li><p>Payload：第二部分是负载，内容也是一个Json对象</p>
<ul>
<li>它是存放有效信息的地方，它可以存放JWT提供的现成字段，如iss（签发者）、exp（过期时间戳）、sub（面向的用户）等，也可以自定义字段</li>
<li>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容</li>
<li>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token string">"sub"</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"456"</span><span class="token punctuation">,</span>
    <span class="token string">"admin"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ol>
<ul>
<li><p>Sugbature：第三部分是签名，此部分用于防止JWT内容被篡改。</p>
<ul>
<li>这个部分使用Base64Url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用Header中声明的签名算法进行签名</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">HMACSHA256(
    base64UrlEncode(header) + &quot;.&quot; +
    base64UrlEncode(payload),
    secret)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>base64UrlEncode(header)：JWT令牌的第一部分</li>
<li>base64UrlEncode(payload)：JWT令牌的第二部分</li>
</ul>
</li>
<li><p>为什么JWT可以防止篡改????</p>
<ul>
<li>第三部分使用签名算法对第一部分和第二部分的内容进行签名，常见的签名算法是HS526，常见的还有MD5、SHA等，<strong>签名算法需要使用密钥进行签名，密钥不对外公开，并且签名是不可逆的</strong>，如果第三方更改了内容，那么服务器验证前面就会失败，要想保证签名正确，必须保证内容、密钥与签名前一致</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230616131924163.png" alt="image-20230616131924163" style="zoom:50%;" /></p>
</li>
</ul>
<ul>
<li>从上图中可以看出，<strong>认证服务和资源服务使用相同的密钥</strong>，<strong>这叫对称加密</strong>，对称加密效率高，如果一旦密钥泄露可以伪造JWT令牌</li>
<li>JWT还可以使用非对称加密，认证服务自己保留私钥，将公钥下发给受信任的客户端、资源服务，公钥和私钥是配对的，成对的公钥和私钥才可以正常加密、解密，非对称加密效率低，但相比较于对称加密更加安全</li>
</ul>
<h3 id="测试生成JWT令牌"><a href="#测试生成JWT令牌" class="headerlink" title="测试生成JWT令牌"></a><strong>测试生成JWT令牌</strong></h3><p>没错，这里测试优势模拟的（第三方）认证服务，生成jwt令牌的过程</p>
<p>把下面的代码代替原来的 token config (覆盖原来生成普通令牌的方式，换成jwt令牌生成)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> SIGNING_KEY <span class="token operator">=</span> <span class="token string">"mq123"</span><span class="token punctuation">;</span> <span class="token comment">// 私钥</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

<span class="token comment">//    @Bean</span>
<span class="token comment">//    public TokenStore tokenStore() &#123;</span>
<span class="token comment">//        //使用内存存储令牌（普通令牌）</span>
<span class="token comment">//        return new InMemoryTokenStore();</span>
<span class="token comment">//    &#125;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtAccessTokenConverter</span> accessTokenConverter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>SIGNING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//令牌管理服务</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"authorizationServerTokenServicesCustom"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerTokenServices</span> <span class="token function">tokenService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DefaultTokenServices</span> service<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持刷新令牌</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//令牌存储策略</span>

        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>accessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>

        service<span class="token punctuation">.</span><span class="token function">setAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">7200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 令牌默认有效期2小时</span>
        service<span class="token punctuation">.</span><span class="token function">setRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">259200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新令牌默认有效期3天</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置好之后重启服务</p>
<p>模拟第三方生成令牌（密码模式）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230617103911705.png" alt="image-20230617103911705"></p>
<p>1、access_token，生成的jwt令牌，用于访问资源使用。</p>
<p>2、token_type，bearer是在RFC6750中定义的一种token类型，在携带jwt访问资源时需要在head中加入bearer jwt令牌内容</p>
<p>3、refresh_token，当jwt令牌快过期时使用刷新令牌可以再次生成jwt令牌。</p>
<p>4、expires_in：过期时间（秒）</p>
<p>5、scope，令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。</p>
<p>6、jti：令牌的唯一标识。</p>
<p>令牌中的数据一般都是可以公开的数据，就算解密可对用户信息造成不了太大影响那种（如用户昵称、用户头像等等，用base64可以还原。绝对不可以包含用户密码！！！）</p>
<p>我们可以通过check_token接口<strong>校验jwt令牌</strong></p>
<pre class="line-numbers language-none"><code class="language-none">###校验jwt令牌
POST &#123;&#123;auth_host&#125;&#125;&#x2F;auth&#x2F;oauth&#x2F;check_token?token&#x3D; 刚才得到的令牌<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230617105631523.png" alt="image-20230617105631523"></p>
<p>上面的校验本质上还是回到了 认证服务来 校验，我们学习 jwt 令牌的目的就是，不要再返回这里进行校验了</p>
<p>那么怎么能让微服务自己就能校验呢？</p>
<h3 id="测试资源服务校验令牌"><a href="#测试资源服务校验令牌" class="headerlink" title="测试资源服务校验令牌"></a>测试资源服务校验令牌</h3><p>拿到了JWT令牌下一步就要携带令牌去访问资源服务中的资源，本项目各个微服务就是资源服务，例如：内容管理服务，当客户端申请到JWT令牌，携带JWT去内容管理服务查询课程信息，此时内容管理服务需要对JWT进行校验，只有JWT合法才可以继续访问，如下图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppuKLdK.png" alt="img"></p>
<h4 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h4><p>将资源用SpringSecurity+oauth2框架管控</p>
<p>再内容管理服务，的api工程（content-api）导入如下依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--认证相关--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h4><p>在内容管理服务的<code>content-api</code>中添加<code>TokenConfig</code>、以及<code>ResourceServerConfig</code>配置类</p>
<p><code>TokenConfig</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> SIGNING_KEY <span class="token operator">=</span> <span class="token string">"mq123"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>SIGNING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>你会发现，</p>
<p>1、这里的密钥和之前认证系统的密钥是一样的，（所谓对称密钥嘛。）</p>
<p>2、 这里的tokenconfig也是jwt的方式</p>
<p>ResourceServerConfig</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResouceServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">&#123;</span>


 <span class="token comment">//资源服务标识</span>
 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> RESOURCE_ID <span class="token operator">=</span> <span class="token string">"xuecheng-plus"</span><span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ResourceServerSecurityConfigurer</span> resources<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  resources<span class="token punctuation">.</span><span class="token function">resourceId</span><span class="token punctuation">(</span>RESOURCE_ID<span class="token punctuation">)</span><span class="token comment">//资源 id</span>
          <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">stateless</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
 http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/r/**"</span><span class="token punctuation">,</span><span class="token string">"/course/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//所有/r/**的请求必须认证通过</span>
         <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>1、这里的资源名称RESOURCE_ID = “xuecheng-plus”; 与之前 auth工程里面的认证服务配置，资源列表.resourceIds(“xuecheng-plus”)//资源列表 相对应</p>
<p>2、.antMatchers(“/r/<strong>“,”/course/**</strong>“).authenticated()//所有/r/**的请求必须认证通过 标识所有以“/r/” 打头的资源，以及所有以“/course/” 打头的资源都需要认证，除了他们的就全部放行</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>重启内容管理服务</p>
<p>使用httpclient测试：</p>
<p>1、访问根据课程id查询课程接口</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">### 查询课程信息</span>
GET http://localhost:63040/content/course/2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>2、返回</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"error"</span><span class="token operator">:</span> <span class="token string">"unauthorized"</span><span class="token punctuation">,</span>
  <span class="token property">"error_description"</span><span class="token operator">:</span> <span class="token string">"Full authentication is required to access this resource"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见资源已经被管控，需要携带令牌才能访问资源</p>
<p>那么我们通过密码模式申请资源</p>
<pre class="line-numbers language-none"><code class="language-none">### 密码模式
POST &#123;&#123;auth_host&#125;&#125;&#x2F;auth&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;lisi&amp;password&#x3D;456<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>得到令牌后，携带JWT令牌访问资源服务地址</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">GET <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>content_host<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/content/course/160
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJLeWxlIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY3ODQzOTMwOSwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiNTAxNDNiZTItOGM3ZC00MmUzLWEwNDMtMTQwMGQ5NWQ5MmZiIiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.o3nWLeRkJncEnnZ0egFmBpyC8Keq-L8IY6k0Uc0a96c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618163959645.png" alt="image-20230618163959645"></p>
<p>成功访问</p>
<p>注意 Authorization: Bearer eyJhbGc。。。。。  是请求头里面的信息，Bearer 专门用于校验的（专门是oauth2 协议的标志）</p>
<h3 id="从jwt令牌获取信息"><a href="#从jwt令牌获取信息" class="headerlink" title="从jwt令牌获取信息"></a>从jwt令牌获取信息</h3><p>原理！！！</p>
<p>JWT令牌中记录了用户身份信息（因为一般只有登录的用户才能获取资源），</p>
<p>之前我们说过 SpringSecurity框架是由一系列过滤器构成的，一部分过滤器用于获取用户信息，一部分就用于存储获取的用户信息将其存储在过滤器的上下文当中（底层基于threadlocal实现）</p>
<p>当客户端携带JWT访问资源服务，资源服务认证通过后，将两部分内容还原，即可取出用户的身份信息，之后并将用户身份信息放在了<code>SecurityContextHolder</code>上下文，<code>SecurityContext</code>与当前线程进行绑定，方便获取用户身份</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618165920777.png" alt="image-20230618165920777"></p>
<p>那么我们获取时，可以通过 以下方式获取（以一个查询课程的函数接口为例）</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @ApiOperation("根据课程id查询课程基础信息")
</span><span class="token prefix unchanged"> </span><span class="token line">   @GetMapping("/course/&#123;courseId&#125;")
</span><span class="token prefix unchanged"> </span><span class="token line">   public CourseBaseInfoDto getCourseBaseById(@PathVariable Long courseId)&#123;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        // 获取当前用户身份信息
</span><span class="token prefix inserted">+</span><span class="token line">        Object principal = SecurityContextHolder.getContext() //拿到contenxt
</span><span class="token prefix inserted">+</span><span class="token line">                .getAuthentication() //  拿到认证信息
</span><span class="token prefix inserted">+</span><span class="token line">                .getPrincipal();// 拿到身份
</span><span class="token prefix inserted">+</span><span class="token line">        System.out.println(principal); // 看看打印出来的身份信息时什么样的
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       return courseBaseInfoService.getCourseBaseInfo(courseId);
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启内容管理服务，使用HttpClient测试接口，查看控制台是否会输出用户身份</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lisi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="网关认证"><a href="#网关认证" class="headerlink" title="网关认证"></a>网关认证</h2><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>现在捋一下整体的认证思路</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618171232422.png" alt="image-20230618171232422" style="zoom: 50%;" /></p>
<p>用户登录，进入统一认证入口，输入账号密码后获取jwt令牌，然后通过jwt令牌来访问我们的微服务</p>
<p><strong>每个微服务</strong>上添加校验相关的依赖和配置就能进行校验以及获取用户信息。</p>
<p>emmm。也就是每个微服务为了能够参会与校验，都要进行相关的依赖和配置。。。是否太太冗余了呢？</p>
<p>是的，校验的话，其实可以交给我们的网关就好（注意时gateway，而不是 nignx）</p>
<p>那么流程就是这样了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618171713495.png" alt="image-20230618171713495" style="zoom:50%;" /></p>
<p>一个请求过来之后，nginx 转发到网关，网关来做统一的认证。</p>
<p>问题：</p>
<p>1、网关做了认证了，那微服务还需要jwt吗？</p>
<p>2、网关做了认证了，微服务还能获取到用户的身份吗？</p>
<p>这两个问题其实是一个问题，网关认证（校验合法性）通过后，他就起到一个请求转发的作用，依然携带jwt令牌将请求转发下去。</p>
<p>后续微服务便不再校验合法性了（不在认证了）</p>
<p>后续微服务来做授权</p>
<p>3、为什么不再网关就把认证和授权一起做了？</p>
<p>不是不行，而是很难，或者说不方便。</p>
<p>资源是在微服务的，只有微服务再清除，这些接口供哪那些人使用，网关只能通过微服务才知道权限分别</p>
<h4 id="网关的作用"><a href="#网关的作用" class="headerlink" title="网关的作用"></a>网关的作用</h4><p>所以，综上。项目里网关的作用</p>
<p>1、路由转发、负载均衡</p>
<p>2、认证-校验合法性（没有授权！！！） </p>
<p>3、白名单维护（有些资源不需要身份，任何人都能访问，不需要校验令牌。如公开的课程）</p>
<p>再次注意：网关不负责授权，授权是在微服务做的</p>
<h3 id="网关认证的实现"><a href="#网关认证的实现" class="headerlink" title="网关认证的实现"></a>网关认证的实现</h3><p>基本上还是继承SpringSecurity+Oauth2的过程</p>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><p>1、网关工程添加依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="配置-amp-过滤器"><a href="#配置-amp-过滤器" class="headerlink" title="配置&amp;过滤器"></a>配置&amp;过滤器</h4><p>2、拷贝课程资料下网关认证配置类到网关工程的config包下。</p>
<div class="tabs" id="前缀名失效"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#前缀名失效-1">GatewayAuthFilter</button></li><li class="tab"><button type="button" data-href="#前缀名失效-2">RestErrorResponse</button></li><li class="tab"><button type="button" data-href="#前缀名失效-3">SecurityConfig</button></li><li class="tab"><button type="button" data-href="#前缀名失效-4">TokenConfig</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="前缀名失效-1"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayAuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//白名单</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> whitelist <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//加载白名单</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token class-name">InputStream</span> resourceAsStream <span class="token operator">=</span> <span class="token class-name">GatewayAuthFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"/security-whitelist.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            properties<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>resourceAsStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> strings <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">stringPropertyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            whitelist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>strings<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"加载/security-whitelist.properties出错:&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> requestUrl <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AntPathMatcher</span> pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//白名单放行</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> url <span class="token operator">:</span> whitelist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//检查token是否存在</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token string">"没有认证"</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//判断是否是有效的token</span>
        <span class="token class-name">OAuth2AccessToken</span> oAuth2AccessToken<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            oAuth2AccessToken <span class="token operator">=</span> tokenStore<span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> expired <span class="token operator">=</span> oAuth2AccessToken<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expired<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token string">"认证令牌已过期"</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidTokenException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"认证令牌无效: &#123;&#125;"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token string">"认证令牌无效"</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
    * 获取token
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> tokenStr <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tokenStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> tokenStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">,</span> <span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bits <span class="token operator">=</span> jsonString<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="前缀名失效-2"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestErrorResponse</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> errMessage<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> errMessage<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errMessage<span class="token operator">=</span> errMessage<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getErrMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> errMessage<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> errMessage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errMessage <span class="token operator">=</span> errMessage<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="前缀名失效-3"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableWebFluxSecurity</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//安全拦截配置</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityWebFilterChain</span> <span class="token function">webFluxSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">authorizeExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">pathMatchers</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="前缀名失效-4"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">String</span> SIGNING_KEY <span class="token operator">=</span> <span class="token string">"mq123"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>SIGNING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<p>需要能看懂第一个网关的验证过程（过滤器逻辑）</p>
<p>1、放行白名单</p>
<p>2、检查令牌是否存在</p>
<p>3、检查令牌是否过期</p>
<p>4、检查令牌是否校验通过</p>
<p>那么由于这里网关对令牌做了一个统一的校验，那么后面我们内容服务原来的那个校验就不用了。注释掉</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/r/**"</span><span class="token punctuation">,</span><span class="token string">"/course/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//所有/r/**的请求必须认证通过</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="白名单"><a href="#白名单" class="headerlink" title="白名单"></a>白名单</h4><p>把文件中的配置文件（有关白名单的）放进resources目录</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">/**</span><span class="token punctuation">=</span><span class="token attr-value">临时全部放行</span>
<span class="token attr-name">/auth/**</span><span class="token punctuation">=</span><span class="token attr-value">认证地址</span>
<span class="token attr-name">/content/open/**</span><span class="token punctuation">=</span><span class="token attr-value">内容管理公开访问接口</span>
<span class="token attr-name">/media/open/**</span><span class="token punctuation">=</span><span class="token attr-value">媒资管理公开访问接口</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>解释一下</p>
<ul>
<li>所有认证相关的地址全部放行：部先认证后续怎么根据jwt校验？</li>
<li>内容管理公开访问接口 ：可公开的接口，全部人的可以访问</li>
<li>媒资管理公开访问接口 同上</li>
</ul>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>重启网关</p>
<p>申请令牌</p>
<pre class="line-numbers language-none"><code class="language-none">### 密码模式
POST &#123;&#123;auth_host&#125;&#125;&#x2F;auth&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;lisi&amp;password&#x3D;456<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>携带令牌获取资源</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#123;&#123;gateway_host&#125;&#125;&#x2F;content&#x2F;course&#x2F;124
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJsaXNpIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY4NzA5Mzk5OSwiYXV0aG9yaXRpZXMiOlsicDIiXSwianRpIjoiMDgxOTczZTYtNTE4NC00NzQ5LWE2MjUtNDdjMjIxNWMyNDMzIiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.JxvOAAL1DLEBT4j_R5z7xXSfqjZQev9TNtFsaj8e0MA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618191501558.png" alt="image-20230618191501558"></p>
<p>成功！</p>
<h1 id="用户认证（密码登录）"><a href="#用户认证（密码登录）" class="headerlink" title="用户认证（密码登录）"></a>用户认证（密码登录）</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>以上演示了Spring Security 基本的功能，主要时作为第三方认证服务怎么生成 授权码、怎么生成令牌，怎么校验令牌，怎么统一做一个网关认证，这些点，</p>
<p>这一节，将在此基础上做进一步的补充</p>
<p>之前我们的用户名、密码是写死再代码里面的，这样肯定不行，到时候都是要从数据库里面读取的。</p>
<p>这一节中，我们将 用多种方式实现用户认证</p>
<p>包括</p>
<p>1、用户密码登录</p>
<p>2、验证码登录</p>
<p>3、微信扫码登录（第三方认证）</p>
<h2 id="连接用户中心数据库"><a href="#连接用户中心数据库" class="headerlink" title="连接用户中心数据库"></a><strong>连接用户中心数据库</strong></h2><p>我们之前的用户名、密码直接写死在代码里面的</p>
<p>就写在 WebSecurityConfig 里面</p>
<p>让我们再看一眼</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际生产过程中必然不能这样写的，我们再一次回忆SpringSecurity 那个执行流程图</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppnetIJ.png" alt="img"></p>
<p>可见：</p>
<p>用一个认证请求过来时（3），送到我们SpringSecurity框架中的认证管理器Authentication Manager</p>
<p>认证管理器 本身没有认证的功能 但是可以<strong>选择 认证方式</strong> ，如果他选择了 用本地的用户名密码比对的方式登录</p>
<p>他将委托 认证提供类 DaoAuthentication Provider 来 查询数据库（通过调用 UserDetailsService 接口的 loadUserByUsername来查询）</p>
<p> UserDetailsService 具体来说是一个接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>接口中只有一个函数loadUserByUsername，顾名思义，就是通过用户名来获取完整的用户信息。（可能会包括密码，然后框架帮助我们进行密码比对？）</p>
<p>那么，我们想要实现从本地数据库通过用户名密码登录，那么就需要</p>
<p>1、屏蔽之前直接写死在代码里面的操作</p>
<p>2、 自己注入一个自定义的UserDetailService的实现类，重写他的loadUserByUsername方法，将其注入进websecurity配置类</p>
<h3 id="UserDetailService实现"><a href="#UserDetailService实现" class="headerlink" title="UserDetailService实现"></a>UserDetailService实现</h3><p>在auth工程下新建service以及impl，新建UserDetailServiceImpl类,</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 没别的意思，只是变量名看着舒服</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> s<span class="token punctuation">;</span>
        <span class="token comment">// 根据username去XcUser表中查询对应的用户信息</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回NULL表示用户不存在，SpringSecurity会帮我们处理，框架抛出异常用户不存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 取出数据库存储的密码</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 权限</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"public"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//如果查到了用户拿到正确的密码，最终封装成一个UserDetails对象给spring security框架返回，由框架进行密码比对</span>
        <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>让我们看看SpringSecurity框架时怎么调用他的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618203132177.png" alt="image-20230618203132177" style="zoom: 50%;" /></p>
<h3 id="密码加密方式"><a href="#密码加密方式" class="headerlink" title="密码加密方式"></a>密码加密方式</h3><p>刚刚写完了UserDetailService 的自定义实现，但是 如果你查看数据库的话，发现里面都不是以明文方式存储的密码，</p>
<p>而默认返回比对的方式时明文（WebSecurity配置的NoOpPasswordEncoder），也就是输入是明文，查到的数据库时明文，然后明文之间进行比对</p>
<p>那么怎么才能改成非铭文呢?更改一下之前WebSecurity里面的加密方式就行了</p>
<p>目前对密码的加密方式最流行的时  BCryptPasswordEncoder ，他有个神奇的特征 : 就算密码一样，如果你但你加密后的密码仍然不一样</p>
<p>我们更改WebSecurity配置里面的加密方式：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        //密码为明文方式</span>
<span class="token comment">//        return NoOpPasswordEncoder.getInstance();</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以测试一下加密效果</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">"123456"</span><span class="token punctuation">;</span>
    <span class="token class-name">BCryptPasswordEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 每个计算出的Hash值都不一样</span>
        <span class="token class-name">String</span> encodePsw <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 虽然Hash值不一样，但是校验是可以通过的</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"转换后密码："</span> <span class="token operator">+</span> encodePsw <span class="token operator">+</span> <span class="token string">"比对情况："</span> <span class="token operator">+</span> encoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> encodePsw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 转换后密码：$2a$10$6hbvtCtgcISvbBHJ.UnhPO1io7StF.ySPkmAvzO/efvNmHVVJZOeK比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$ufYW9qXSAk0N201B/wCR7uGrzygawnwXtyL2vKpDLAOCOkF33sGnK比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$DEaVxYHakIE/kDvAU4eC7OZ7c9kqKBJedClVxDPnYH.zwuZvCRnzm比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$s2qgaKGgULYQ7tce2u6TIeHopap4HqfyghJYu1vdDZ2WcNk70ykFe比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$XQaQJIfXyd/UvMHC..uBNuDXNVrZHnEGn.tW0oSB6WVjdsZLFpkGq比对情况：true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改数据库中的密码为Bcrypt格式，并且记录明文密码，稍后申请令牌时需要。</p>
<p>由于修改密码编码方式还需要将<strong>客户端的密钥</strong>更改为Bcrypt格式.</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">@Override
public void configure(ClientDetailsServiceConfigurer clients)
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       throws Exception &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">   clients.inMemory()// 使用in-memory存储
</span><span class="token prefix unchanged"> </span><span class="token line">           .withClient("XcWebApp")// client_id
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        	//.secret("XcWebApp")//客户端密钥
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">            .secret(new BCryptPasswordEncoder().encode("XcWebApp"))//客户端密钥
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">           .resourceIds("xuecheng-plus")//资源列表
</span><span class="token prefix unchanged"> </span><span class="token line">           .authorizedGrantTypes("authorization_code", "password", "client_credentials", "implicit", "refresh_token")// 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials
</span><span class="token prefix unchanged"> </span><span class="token line">           .scopes("all")// 允许的授权范围
</span><span class="token prefix unchanged"> </span><span class="token line">           .autoApprove(false)//false跳转到授权页面                  
</span><span class="token prefix unchanged"> </span><span class="token line">           .redirectUris("http://localhost/");//客户端接收授权码的重定向地址
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>现在重启认证服务，使用HttpClient进行测试</p>
<pre class="line-numbers language-none"><code class="language-none">### 密码模式
POST &#123;&#123;auth_host&#125;&#125;&#x2F;auth&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;lisi&amp;password&#x3D;456<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>笑死，当然查不到了，因为数据库里面没有啊</p>
<pre class="line-numbers language-none"><code class="language-none">### 密码模式
POST &#123;&#123;auth_host&#125;&#125;&#x2F;auth&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;stu1&amp;password&#x3D;111111<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618215528502.png" alt="image-20230618215528502"></p>
<p>测试成功！</p>
<h2 id="扩展用户信息"><a href="#扩展用户信息" class="headerlink" title="扩展用户信息"></a>扩展用户信息</h2><p>上一步我们可以从数据库验证用户是否存在，但是，如果你校验jwt令牌会发现，给的信息实在是太少了，只有一个姓名。这完全够用，后面我们有些地方还需要获取用户的机构id？呢。</p>
<p>怎么扩展呢？</p>
<p>校验的话，框架使用我们返回的userdetailserviceimpl 那个UserDetails 来校验的，这时框架写好的，看看里面有什么</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>emmmm有用的信息只有用户名和密码。。。</p>
<p>所以啊，我们要扩展整个类，以便在JWT令牌中存储用户的昵称、头像、QQ等信息</p>
<ul>
<li><p>如何扩展Spring Security的用户身份信息呢？</p>
<blockquote>
<ul>
<li>在认证阶段DaoAuthenticationProvider会调用UserDetailsService查询用户的信息，这里是可以获取到齐全的用户信息。</li>
<li>由于JWT令牌中用户身份信息来源于UserDetails，UserDetails中仅定义了username为用户的身份信息，这里有两个思路<ol>
<li>扩展UserDetails，时期包括更多的自定义属性</li>
<li>扩展username的内容，例如存入Json数据作为username的内容</li>
</ol>
</li>
<li>相较而言，如果通过方案一的话就要该框架里面的内容了，比较麻烦；方案2比较简单，而且也不用破坏UserDetails的结构，这里采用方案二,</li>
</ul>
</blockquote>
</li>
</ul>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">@Slf4j
@Component
public class UserDetailServiceImpl implements UserDetailsService &#123;

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Autowired
</span><span class="token prefix unchanged"> </span><span class="token line">   XcUserMapper xcUserMapper;
</span><span class="token prefix unchanged"> </span><span class="token line">   @Override
</span><span class="token prefix unchanged"> </span><span class="token line">   public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 没别的意思，只是变量名看着舒服
</span><span class="token prefix unchanged"> </span><span class="token line">       String name = s;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 根据username去XcUser表中查询对应的用户信息
</span><span class="token prefix unchanged"> </span><span class="token line">       XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper&lt;XcUser>().eq(XcUser::getUsername, name));
</span><span class="token prefix unchanged"> </span><span class="token line">       // 返回NULL表示用户不存在，SpringSecurity会帮我们处理，框架抛出异常用户不存在
</span><span class="token prefix unchanged"> </span><span class="token line">       if (user == null) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           return null;
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 取出数据库存储的密码
</span><span class="token prefix unchanged"> </span><span class="token line">       String password = user.getPassword();
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        // 注意用户敏感信息不要写到令牌里面
</span><span class="token prefix inserted">+</span><span class="token line">        user.setPassword(null);
</span><span class="token prefix inserted">+</span><span class="token line">        String userinfoString = JSON.toJSONString(user);
</span></span>

<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // 权限
</span><span class="token prefix unchanged"> </span><span class="token line">       String[] authorities = &#123;"test","public"&#125;;
</span><span class="token prefix unchanged"> </span><span class="token line">       //如果查到了用户拿到正确的密码，最终封装成一个UserDetails对象给spring security框架返回，由框架进行密码比对
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        UserDetails userDetails = User.withUsername(user.getUsername())
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">		 UserDetails userDetails = User.withUsername(userinfoString)
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">               .password(password)
</span><span class="token prefix unchanged"> </span><span class="token line">               .authorities(authorities[0])
</span><span class="token prefix unchanged"> </span><span class="token line">               .build();
</span><span class="token prefix unchanged"> </span><span class="token line">       return userDetails;
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试</p>
<p>用密码模式获取令牌：</p>
<p>校验令牌看看有什么信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618222244568.png" alt="image-20230618222244568"></p>
<p>那么后续就可以从jwt令牌里面获取用户相关的信息了</p>
<p>具体怎么获得呢，</p>
<p>1、通过SecurityContextHolder获取user_name </p>
<p>2、然后将其转换为XcUser对象即可</p>
<p>几乎每需要jwt里面信息的时候都要进行这些操作，不如。。写一个工具类</p>
<p>放在新建一个 utils包谁用谁掉</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityUtil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">XcUser</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Object</span> principal <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>principal <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">String</span> userJson <span class="token operator">=</span> principal<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>userJson<span class="token punctuation">,</span> <span class="token class-name">XcUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"获取当前登录用户身份信息出错：&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    
    <span class="token comment">// 这里使用内部类，是为了不让content工程去依赖auth工程</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">XcUser</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> salt<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> wxUnionid<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> companyId<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> userpic<span class="token punctuation">;</span><span class="token comment">//头像</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> utype<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> birthday<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> qq<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span><span class="token comment">//用户状态</span>
        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createTime<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> updateTime<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试：</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @ApiOperation("根据课程id查询课程基础信息")
</span><span class="token prefix unchanged"> </span><span class="token line">   @GetMapping("/course/&#123;courseId&#125;")
</span><span class="token prefix unchanged"> </span><span class="token line">   public CourseBaseInfoDto getCourseBaseById(@PathVariable Long courseId)&#123;
</span></span>//        // 获取当前用户身份信息
//        Object principal = SecurityContextHolder.getContext() //拿到contenxt
//                .getAuthentication() //  拿到认证信息
//                .getPrincipal();// 拿到身份
//        System.out.println(principal); // 看看打印出来的身份信息时什么样的
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        SecurityUtil.XcUser user = SecurityUtil.getUser();
</span><span class="token prefix inserted">+</span><span class="token line">        System.out.println(JSON.toJSONString(user));
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       return courseBaseInfoService.getCourseBaseInfo(courseId);
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>重启认证服务、内容管理服务</li>
<li>生成新的令牌</li>
<li>携带令牌访问内容管理服务的查询课程接口，控制台可以看到输入的用户信息</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230618224646409.png" alt="image-20230618224646409"></p>
<p>成功解析</p>
<h2 id="认证方式多样化"><a href="#认证方式多样化" class="headerlink" title="认证方式多样化"></a>认证方式多样化</h2><h3 id="统一认证入口"><a href="#统一认证入口" class="headerlink" title="统一认证入口"></a><strong>统一认证入口</strong></h3><p>前面说了，我们的项目上向实现</p>
<p>1、用户名密码登录</p>
<p>2、验证码登录</p>
<p>3、微信扫码登录</p>
<p>怎么才能统一在一起呢，只是前端统一到一个界面是不行的，不同的认证方式提交的数据也是不一样的</p>
<p>为了接收不同认证方式的数据，我们可以定义一个统一的认证参数接收DTO类型：</p>
<p>我们已经加过了，如下</p>
<h4 id="统一接收参数"><a href="#统一接收参数" class="headerlink" title="统一接收参数"></a>统一接收参数</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthParamsDto</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span> <span class="token comment">//用户名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span> <span class="token comment">//域  用于扩展</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span><span class="token comment">//手机号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcode<span class="token punctuation">;</span><span class="token comment">//验证码</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcodekey<span class="token punctuation">;</span><span class="token comment">//验证码key</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> authType<span class="token punctuation">;</span> <span class="token comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之后传入的参数一律按照上面的json字符串的形式传入</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">@Service
public class UserDetailsImpl implements UserDetailsService &#123;
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Autowired
</span><span class="token prefix unchanged"> </span><span class="token line">   XcUserMapper xcUserMapper;
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   /**
</span><span class="token prefix unchanged"> </span><span class="token line">    * @param s 用户输入的登录账号
</span><span class="token prefix unchanged"> </span><span class="token line">    * @return UserDetails
</span><span class="token prefix unchanged"> </span><span class="token line">    * @throws UsernameNotFoundException
</span><span class="token prefix unchanged"> </span><span class="token line">    */
</span><span class="token prefix unchanged"> </span><span class="token line">   @Override
</span><span class="token prefix unchanged"> </span><span class="token line">   public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException &#123;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       AuthParamsDto authParamsDto = null;
</span><span class="token prefix inserted">+</span><span class="token line">       try &#123;
</span><span class="token prefix inserted">+</span><span class="token line">           authParamsDto = JSON.parseObject(s, AuthParamsDto.class);
</span><span class="token prefix inserted">+</span><span class="token line">       &#125; catch (Exception e) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">           log.error("认证请求数据格式不对：&#123;&#125;", s);
</span><span class="token prefix inserted">+</span><span class="token line">           throw new RuntimeException("认证请求数据格式不对");
</span><span class="token prefix inserted">+</span><span class="token line">       &#125;
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">       String name = s;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       String name = authParamsDto.getUsername();
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // 根据username去XcUser表中查询对应的用户信息
</span><span class="token prefix unchanged"> </span><span class="token line">       XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper&lt;XcUser>().eq(XcUser::getUsername, name));
</span><span class="token prefix unchanged"> </span><span class="token line">       // 返回空表示用户不存在，SpringSecurity会帮我们处理
</span><span class="token prefix unchanged"> </span><span class="token line">       if (user == null) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           return null;
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 取出数据库存储的密码
</span><span class="token prefix unchanged"> </span><span class="token line">       String password = user.getPassword();
</span><span class="token prefix unchanged"> </span><span class="token line">       user.setPassword(null);
</span><span class="token prefix unchanged"> </span><span class="token line">       String userString = JSON.toJSONString(user);
</span><span class="token prefix unchanged"> </span><span class="token line">       // 创建UserDetails对象，并返回，注意这里的authorities必须指定
</span><span class="token prefix unchanged"> </span><span class="token line">       return User.withUsername(userString).password(password).authorities("test").build();
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么，接受的请求格式应该是这样的：</p>
<pre class="line-numbers language-none"><code class="language-none">### 密码模式
POST localhost:53070&#x2F;auth&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;&#123;&quot;username&quot;:&quot;stu1&quot;,&quot;password&quot;:&quot;111111&quot;,&quot;authType&quot;:&quot;password&quot;&#125;&amp;password&#x3D;111111<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>再想一想，刚刚我们重写的loadUserByUsername()方法是由DaoAuthenticationProvider调用的（也就是用户名密码模式），</p>
<p>在用户名密码模式下，我们在这个函数里面 返回查询到的用户名密码，然后DaoAuthenticationProvider 调用他的additionalAuthenticationChecks方法去校验</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: no credentials provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: password does not match stored value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="屏蔽密码比对"><a href="#屏蔽密码比对" class="headerlink" title="屏蔽密码比对"></a>屏蔽密码比对</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppnetIJ.png" alt="img"></p>
<p>但是并非所有验证方式都需要校验密码。。。那么，怎么才能避免去校验密码呢？</p>
<p>答：重写DaoAuthenticationProvider即可，覆盖原来的additionalAuthenticationChecks方法（把这个方法写在config目录下）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DaoAuthenticationProviderCustom</span> <span class="token keyword">extends</span> <span class="token class-name">DaoAuthenticationProvider</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 由于DaoAuthenticationProvider调用UserDetailsService，所以这里需要注入一个</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDetailsService</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setUserDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 屏蔽密码对比，因为不是所有的认证方式都需要校验密码</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 里面啥也不写就不会校验密码了</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时也需要修改WebSecurityConfig类，指定我们重写的DaoAuthenticationProviderCustom</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">DaoAuthenticationProviderCustom</span> daoAuthenticationProviderCustom<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>daoAuthenticationProviderCustom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启认证服务，测试申请令牌，传入账号信息改为JSON数据，打个断点，看看传入的请求参数是否为JSON格式</p>
<pre class="line-numbers language-none"><code class="language-none">### 密码模式
POST localhost:63070&#x2F;auth&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;&#123;&quot;username&quot;:&quot;lisi&quot;,&quot;password&quot;:&quot;456&quot;,&quot;authTpye&quot;:&quot;password&quot;&#125;&amp;password&#x3D;456<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230619083921255.png" alt="image-20230619083921255" style="zoom:33%;" /></p>
<h4 id="定义统一认证接口"><a href="#定义统一认证接口" class="headerlink" title="定义统一认证接口"></a>定义统一认证接口</h4><ul>
<li>有了这些认证参数，我们可以定义一个统一的认证的Service接口去进行各种方式的认证，然后<strong>该Service的各种实现类</strong>来实现<strong>各种方式的认证</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthService</span> <span class="token punctuation">&#123;</span>

   <span class="token comment">/**
    * @description 认证方法
    * @param authParamsDto 认证参数
    * @return com.xuecheng.ucenter.model.po.XcUser 用户信息
   */</span>
   <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>定义用户信息，为了可扩展性，我们让其继承XcUser</li>
<li>这里最好不要直接用XcUser类，理由在之前的文章也说过，万一我们需要扩展一些其他的用户信息，那么我们直接修改XcUser类是不现实的，因为XcUser类对应的是数据库中的表。所以即使我们要使用XcUser类作为返回类型，也最好是让一个其他的类继承XcUser</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XcUserExt</span> <span class="token keyword">extends</span> <span class="token class-name">XcUser</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//用户权限</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>好了，那么我们就可以用service来实现各种各样的 登陆的验证方式</p>
<p>如 </p>
<h5 id="用户名密码登录"><a href="#用户名密码登录" class="headerlink" title="用户名密码登录"></a>用户名密码登录</h5><p>一个接口的多种实现，我们依靠beanName来做区分，例如这里的password_authservice，见名知意就知道是密码登录方式</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"password_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="微信扫码登录"><a href="#微信扫码登录" class="headerlink" title="微信扫码登录"></a>微信扫码登录</h5><p>这里的wx_authservice，一看就是微信扫码方式</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="修改loadUserByUsername"><a href="#修改loadUserByUsername" class="headerlink" title="修改loadUserByUsername()"></a>修改loadUserByUsername()</h4><p>根据不同的认证方式选择不同的认证Service实现类 主要通过拼接beanname获取认证的bena</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Override
</span><span class="token prefix unchanged"> </span><span class="token line">   public UserDetails loadUserByUsername(String s) throws UsernameNotFoundException &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">       AuthParamsDto authParamsDto = null;
</span><span class="token prefix unchanged"> </span><span class="token line">       try &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           authParamsDto = JSON.parseObject(s, AuthParamsDto.class);
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125; catch (Exception e) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           log.error("认证请求数据格式不对：&#123;&#125;", s);
</span><span class="token prefix unchanged"> </span><span class="token line">           throw new RuntimeException("认证请求数据格式不对");
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">       // 获取认证类型，beanName就是 认证类型 + 后缀，例如 password + _authservice = password_authservice
</span><span class="token prefix inserted">+</span><span class="token line">       String authType = authParamsDto.getAuthType();
</span><span class="token prefix inserted">+</span><span class="token line">       // 根据认证类型，从Spring容器中取出对应的bean
</span><span class="token prefix inserted">+</span><span class="token line">       AuthService authService = applicationContext.getBean(authType + "_authservice", AuthService.class);
</span><span class="token prefix inserted">+</span><span class="token line">       XcUserExt user = authService.execute(authParamsDto);
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">       String name = authParamsDto.getUsername();
</span><span class="token prefix deleted">-</span><span class="token line">       // 根据username去XcUser表中查询对应的用户信息
</span><span class="token prefix deleted">-</span><span class="token line">       XcUser user = xcUserMapper.selectOne(new LambdaQueryWrapper&lt;XcUser>().eq(XcUser::getUsername, name));
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // 返回空表示用户不存在，SpringSecurity会帮我们处理
</span><span class="token prefix unchanged"> </span><span class="token line">       if (user == null) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           return null;
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 取出数据库存储的密码
</span><span class="token prefix unchanged"> </span><span class="token line">       String password = user.getPassword();
</span><span class="token prefix unchanged"> </span><span class="token line">       user.setPassword(null);
</span><span class="token prefix unchanged"> </span><span class="token line">       String userinfoString = JSON.toJSONString(user);
</span><span class="token prefix unchanged"> </span><span class="token line">       //如果查到了用户拿到正确的密码，最终封装成一个UserDetails对象给spring security框架返回，由框架进行密码比对
</span><span class="token prefix unchanged"> </span><span class="token line">       UserDetails userDetails = User.withUsername(userinfoString)
</span><span class="token prefix unchanged"> </span><span class="token line">               .password(password)
</span><span class="token prefix unchanged"> </span><span class="token line">               .authorities(authorities[0])
</span><span class="token prefix unchanged"> </span><span class="token line">               .build();
</span><span class="token prefix unchanged"> </span><span class="token line">       return userDetails;
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230619090511093.png" alt="image-20230619090511093"></p>
<h3 id="实现用户名密码登录"><a href="#实现用户名密码登录" class="headerlink" title="实现用户名密码登录"></a>实现用户名密码登录</h3><p>上面我们只是简单定义了账号密码认证的实现类，并没有编写具体逻辑，那这个小节我们就来具体实现账号密码认证</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"password_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 获取账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 根据账号去数据库中查询是否存在</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 不存在抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xcUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 4. 校验密码</span>
        <span class="token comment">// 4.1 获取用户输入的密码</span>
        <span class="token class-name">String</span> passwordForm <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2 获取数据库中存储的密码</span>
        <span class="token class-name">String</span> passwordDb <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3 比较密码</span>
        <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>passwordForm<span class="token punctuation">,</span> passwordDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.4 不匹配，抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matches<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号或密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 4.5 匹配，封装返回</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为我们 这个认证方法供 loadUserByUsername 调用，我们返回的是xcUserExt 还需要再loadUserByUsername 封装成userdetail对象</p>
<p>修改loadUserByUsername()方法，我们可以将最后的封装UserDetails的相关代码抽取为一个方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 将传入的json字符串转成dto对象</span>
    <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        authParamsDto <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"请求认证的参数异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 获取认证方式</span>
    <span class="token comment">// 获取认证类型，beanName就是 认证类型 + 后缀，例如 password + _authservice = password_authservice</span>
    <span class="token class-name">String</span> authType <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getAuthType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据认证类型，从Spring容器中取出对应的bean</span>
    <span class="token class-name">AuthService</span> authService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>authType <span class="token operator">+</span> <span class="token string">"_authservice"</span><span class="token punctuation">,</span> <span class="token class-name">AuthService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcUserExt</span> user <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将返回的 XcUserExt 封装成userdetails</span>
    <span class="token keyword">return</span>  <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token class-name">XcUserExt</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"test"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> userJsonStr <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userJsonStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>申请令牌，注意JSON数据中要带上authType</p>
<p>成功！</p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230619100505718.png" alt="image-20230619100505718"></p>
<h2 id="验证码服务"><a href="#验证码服务" class="headerlink" title="验证码服务"></a>验证码服务</h2><p>为啥那么有了密码还需要验证码？</p>
<p>主要是为了<strong>防止被攻击</strong></p>
<ul>
<li>验证码可以防止恶性攻击，例如<ul>
<li>XSS跨站脚本攻击</li>
<li>CSRF跨站请求伪造攻击</li>
</ul>
</li>
<li>为了保护系统的安全，在进行一些比较重要的操作时，都需要验证码，例如<ul>
<li>认证</li>
<li>找回密码</li>
<li>人机判断</li>
<li>支付验证等</li>
</ul>
</li>
<li>验证码的类型也有很多：图片、语音、手机短信验证码等</li>
<li>本项目创建单独的验证码服务微各业务提供验证码的生成、校验等服务</li>
</ul>
<p>拷贝黑马提供的xuecheng-plus-checkcode验证码服务到自己的工程目录，修改bootstrap.yml</p>
<p>在nacos中新增checkcode-dev.yaml</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230620113643576.png" alt="image-20230620113643576"></p>
<p>同时，验证码需要存储在redis 中，配置redis</p>
<p>新增路由相关配置</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> auth<span class="token punctuation">-</span>service
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//auth<span class="token punctuation">-</span>service
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/auth/<span class="token important">**</span>
<span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> checkcode
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//checkcode
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/checkcode/<span class="token important">**</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>验证码是缓存在redis中</p>
<p>需要部署redis</p>
<p>用docker部署redis</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">docker pull redis
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name myredis <span class="token operator">-</span>p <span class="token number">6379</span><span class="token operator">:</span><span class="token number">6379</span> redis
docker start myredis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>md 吐了，docker崩了，重装了docker结果也还是崩，那大概率不行了，想买个服务器，看网上 8G服务器两百多一个月。。。额 好贵。算了</p>
<p>不行，妈的重新做系统吧，服了</p>
<p>干了一上午，白白浪费时间，服了 就这样吧</p>
<p>6月22日：还是买了阿里云的服务器(59.110.13.16)，不过是按照量计费，估计能比包月买便宜不少。</p>
<p>配了一上午环境。。。。终于回复差不多了，装了docker/jdk/nacos/mysql/xxl-job，继续干活！</p>
<p>同时在nacos中配置redis-dev.yaml，group设置为xuecheng-plus-common</p>
<pre class="line-numbers language-none"><code class="language-none">spring:
  redis:
    host: 59.110.13.16
    port: 6379
    password: 
    database: 0
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 0
    timeout: 10000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在验证码模块中引入redis的配置(已有)</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  - data-id: redis-$&#123;spring.profiles.active&#125;.yaml
</span><span class="token prefix inserted">+</span><span class="token line">    group: xuecheng-plus-common
</span><span class="token prefix inserted">+</span><span class="token line">    refresh: true</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在验证码模块中引入redis依赖（已有）</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--redis依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--common-pool--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622214846546.png" alt="image-20230622214846546" style="zoom:33%;" /></p>
<p>校验</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622220339994.png" alt="image-20230622220339994" style="zoom: 33%;" /></p>
<p>可以从redis 看到生成的key 以及 对应的答案</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622220800610.png" alt="image-20230622220800610" style="zoom: 33%;" /></p>
<p>测试成功</p>
<p>生成的东西一个是key，一个是验证码图片已经转成了base64编码</p>
<p>如果想预览直接输入浏览器即可</p>
<p>为啥那么有 图片就行了还要有key呢？</p>
<ul>
<li>答：主要用于校验</li>
<li>当用户使用验证码登录时，一方面会发给前端验证码图片，还会发key（只不过被前端隐藏起来了，其实用用户获取到也没啥用，因为key只是用于标识这次请求的，不能通过他来获取验证码的答案。）</li>
<li>在发送验证码给用户的同时还会将key 与答案 存在redis里面</li>
<li>在用户提交验证码时（其实提交的是两个东西，一个是隐藏起来的key 一个是验证码的答案）</li>
</ul>
<h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><p>验证码服务如何生成并校验验证码？</p>
<p>拿图片验证码举例：</p>
<p>1、先生成一个指定位数的验证码，根据需要可能是数字、数字字母组合或文字。</p>
<p>2、根据生成的验证码生成一个图片并返回给页面</p>
<p>3、给生成的验证码分配一个key，将key和验证码一同存入缓存。这个key和图片一同返回给页面。</p>
<p>4、用户输入验证码，连同key一同提交至认证服务。</p>
<p>5、认证服务拿key和输入的验证码请求验证码服务去校验</p>
<p>6、验证码服务根据key从缓存取出正确的验证码和用户输入的验证码进行比对，如果相同则校验通过，否则不通过。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622215933453.png" alt="image-20230622215933453" style="zoom: 67%;" /></p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>先草草看一遍黑马提供的验证码服务，有个CheckCodeService是验证码接口，其内部还有一个<code>CheckCodeStore</code>接口，<code>CheckCodeStore</code>接口是负责存储验证码的</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeService</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeGenerator</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">KeyGenerator</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeStore</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>CheckCodeStore  主要参数是 key value 核过期时间</p>
<p>顺藤摸瓜，找到它的实现类为<code>MemoryCheckCodeStore</code>，现在我们只需要修改这个类，改为用Redis缓存验证码即可</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"MemoryCheckCodeStore"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryCheckCodeStore</span> <span class="token keyword">implements</span> <span class="token class-name">CheckCodeService<span class="token punctuation">.</span>CheckCodeStore</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 注入StringRedisTemplate</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> expire<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expire<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>嗯嗯，大概流程就这样。。生生图片什么的就不看了</p>
<h2 id="账号密码认证"><a href="#账号密码认证" class="headerlink" title="账号密码认证"></a>账号密码认证</h2><h3 id="验证码微服务"><a href="#验证码微服务" class="headerlink" title="验证码微服务"></a>验证码微服务</h3><p>需求分析</p>
<p>到目前为止账号和密码认证所需要的技术、组件都已开发完毕，下边实现账号密码认证，输出如下图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622223523922.png" alt="image-20230622223523922" style="zoom:33%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppKQZIf.png" alt="img"></p>
<p>我们随便输入输入 以及验证码看看请求时往那个服务发的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622224721656.png" alt="image-20230622224721656"></p>
<p>发现正式我们之前写的那个统一认证入口申请令牌的那个函数</p>
<p>如果正确输入密码（t1 111111）以及验证码，则会将得到的令牌存入cookie</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622225021007.png" alt="image-20230622225021007" style="zoom:33%;" /></p>
<p>若点击退出就是把 本地cookie清除的过程。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622225151029.png" alt="image-20230622225151029" style="zoom: 33%;" /></p>
<p>输错密码</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622232205228.png" alt="image-20230622232205228" style="zoom:33%;" /></p>
<p>可见密码错误可以识别</p>
<p>但是这里我们的验证码的识别还未实现</p>
<p>现在我们回头去校验验证码</p>
<p>校验验证码其实已经在验证码服务里面实现了，所以，只需在认证服务里面远程调用 验证码服务的接口即可。</p>
<h3 id="远程调用校验服务"><a href="#远程调用校验服务" class="headerlink" title="远程调用校验服务"></a>远程调用校验服务</h3><p>在认证服务定义远程调用验证码服务的接口</p>
<p>ucenter.feignclient</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

 <span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"checkcode"</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">CheckCodeClientFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/checkcode"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeClient</span> <span class="token punctuation">&#123;</span>

 <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/verify"</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>回顾一下 远程调用 openfeign的写法，首先把 定义接口 </p>
<p>上面 加上  @FeignClient 注解 </p>
<ul>
<li>value值是服务名称：checkcode</li>
<li>fallbackFactory 是降级（工厂）方法</li>
</ul>
<p>在类内部定义请求方法，与被调方保持一致</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>ucenter<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckCodeClientFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CheckCodeClient</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CheckCodeClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CheckCodeClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"调用验证码服务熔断异常:&#123;&#125;"</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动类上开启@EnableFeignClients</p>
<pre class="line-numbers language-none"><code class="language-none">@EnableFeignClients(basePackages&#x3D;&#123;&quot;com.xuecheng.*.feignclient&quot;&#125;)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>因为引入熔断降级配置\  以及pom文件依赖（已在）</p>
<pre class="line-numbers language-none"><code class="language-none">- data-id: feign-$&#123;spring.profiles.active&#125;.yaml
  group: xuecheng-plus-common
  refresh: true
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>调用</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Autowired
</span><span class="token prefix unchanged"> </span><span class="token line">   XcUserMapper xcUserMapper;
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Autowired
</span><span class="token prefix unchanged"> </span><span class="token line">   PasswordEncoder passwordEncoder;
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    @Autowired
</span><span class="token prefix inserted">+</span><span class="token line">    CheckCodeClient checkCodeClient;
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   @Override
</span><span class="token prefix unchanged"> </span><span class="token line">   public XcUserExt execute(AuthParamsDto authParamsDto) &#123;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        // 0、校验验证码
</span><span class="token prefix inserted">+</span><span class="token line">        // 远程调用验证码服务去校验验证码
</span><span class="token prefix inserted">+</span><span class="token line">        String checkcode = authParamsDto.getCheckcode();
</span><span class="token prefix inserted">+</span><span class="token line">        String checkcodekey = authParamsDto.getCheckcodekey();
</span><span class="token prefix inserted">+</span><span class="token line">        if(checkcode==null || checkcodekey==null|| StringUtils.isEmpty(checkcode))&#123;
</span><span class="token prefix inserted">+</span><span class="token line">            throw new RuntimeException("验证码为空");
</span><span class="token prefix inserted">+</span><span class="token line">        &#125;
</span><span class="token prefix inserted">+</span><span class="token line">        Boolean verify = checkCodeClient.verify(checkcodekey,checkcode);
</span><span class="token prefix inserted">+</span><span class="token line">        if(!verify)&#123;
</span><span class="token prefix inserted">+</span><span class="token line">            throw new RuntimeException("验证码错误");
</span><span class="token prefix inserted">+</span><span class="token line">        &#125;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // 1. 获取账号
</span><span class="token prefix unchanged"> </span><span class="token line">       String username = authParamsDto.getUsername();
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       // 2. 根据账号去数据库中查询是否存在
</span><span class="token prefix unchanged"> </span><span class="token line">       XcUser xcUser = xcUserMapper.selectOne(new LambdaQueryWrapper&lt;XcUser>().eq(XcUser::getUsername, username));
</span><span class="token prefix unchanged"> </span><span class="token line">       // 3. 不存在抛异常
</span><span class="token prefix unchanged"> </span><span class="token line">       if (xcUser == null) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           throw new RuntimeException("账号不存在");
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 4. 校验密码
</span><span class="token prefix unchanged"> </span><span class="token line">       // 4.1 获取用户输入的密码
</span><span class="token prefix unchanged"> </span><span class="token line">       String passwordForm = authParamsDto.getPassword();
</span><span class="token prefix unchanged"> </span><span class="token line">       // 4.2 获取数据库中存储的密码
</span><span class="token prefix unchanged"> </span><span class="token line">       String passwordDb = xcUser.getPassword();
</span><span class="token prefix unchanged"> </span><span class="token line">       // 4.3 比较密码
</span><span class="token prefix unchanged"> </span><span class="token line">       boolean matches = passwordEncoder.matches(passwordForm, passwordDb);
</span><span class="token prefix unchanged"> </span><span class="token line">       // 4.4 不匹配，抛异常
</span><span class="token prefix unchanged"> </span><span class="token line">       if (!matches) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           throw new RuntimeException("账号或密码错误");
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 4.5 匹配，封装返回
</span><span class="token prefix unchanged"> </span><span class="token line">       XcUserExt xcUserExt = new XcUserExt();
</span><span class="token prefix unchanged"> </span><span class="token line">       BeanUtils.copyProperties(xcUser, xcUserExt);
</span><span class="token prefix unchanged"> </span><span class="token line">       return xcUserExt;
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启服务，看看验证码能不能保证生效。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622235859811.png" alt="image-20230622235859811" style="zoom:50%;" /></p>
<p>拦截成功</p>
<p>如果输入正确</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230622235936383.png" alt="image-20230622235936383" style="zoom:33%;" /></p>
<p>登陆成功！</p>
<h1 id="微信登录（第三方登录）"><a href="#微信登录（第三方登录）" class="headerlink" title="微信登录（第三方登录）"></a>微信登录（第三方登录）</h1><h2 id="技术背景"><a href="#技术背景" class="headerlink" title="技术背景"></a>技术背景</h2><p>微信提供的第三方登录接口是基于Oauth2的授权码模式，也就是1、用户同意 2、先申请授权码，3、再拿授权码申请令牌</p>
<p>接口文档</p>
<p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</a></p>
<p>前提，我们作为第三方引用，需要去微信开发平台申请相关权限，一般以公司的名义去申请，需要有一个网站、一个域名，等等，来申请的参数 如appid等 重定向地址 等</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623003304941.png" alt="image-20230623003304941"></p>
<ul>
<li><ol>
<li>第三方发起微信授权登录请求，微信用户允许授权第三方应用后，微信会拉起应用或重定向到第三方网站，并且带上授权临时票据 code 参数；</li>
<li>通过 code 参数加上 AppID 和AppSecret等，通过 API 换取access_token；</li>
<li>通过access_token进行接口调用，获取用户基本数据资源或帮助用户实现基本操作。</li>
</ol>
</li>
</ul>
<p>通过查看官方文档发现，（我们应用平台）获取授权码可以有两种方式</p>
<p>1、通过 一个 连接 来先获取授权码 ；</p>
<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;open.weixin.qq.com&#x2F;connect&#x2F;qrconnect?
appid&#x3D;APPID&amp;redirect_uri&#x3D;REDIRECT_URI&amp;response_type&#x3D;code&amp;scope&#x3D;SCOPE&amp;state&#x3D;STATE#wechat_redirect<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>微信申请授权码需要如下参数，其中最重要的就是appid 和重定向地址</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">是否必须</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">self_redirect</td>
<td style="text-align:center">否</td>
<td style="text-align:center">true：手机点击确认登录后可以在 iframe 内跳转到 redirect_uri，false：手机点击确认登录后可以在 top window 跳转到 redirect_uri。默认为 false。</td>
</tr>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">是</td>
<td style="text-align:center">第三方页面显示二维码的容器id</td>
</tr>
<tr>
<td style="text-align:center">appid</td>
<td style="text-align:center">是</td>
<td style="text-align:center">应用唯一标识，在微信开放平台提交应用审核通过后获得</td>
</tr>
<tr>
<td style="text-align:center">scope</td>
<td style="text-align:center">是</td>
<td style="text-align:center">应用授权作用域，拥有多个作用域用逗号（,）分隔，网页应用目前仅填写snsapi_login即可</td>
</tr>
<tr>
<td style="text-align:center">redirect_uri</td>
<td style="text-align:center">是</td>
<td style="text-align:center">重定向地址，需要进行UrlEncode</td>
</tr>
<tr>
<td style="text-align:center">state</td>
<td style="text-align:center">否</td>
<td style="text-align:center">用于保持请求和回调的状态，授权请求后原样带回给第三方。该参数可用于防止 csrf 攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数加 session 进行校验</td>
</tr>
<tr>
<td style="text-align:center">style</td>
<td style="text-align:center">否</td>
<td style="text-align:center">提供”black”、”white”可选，默认为黑色文字描述。详见文档底部FAQ</td>
</tr>
<tr>
<td style="text-align:center">href</td>
<td style="text-align:center">否</td>
<td style="text-align:center">自定义样式链接，第三方可根据实际需求覆盖默认样式。详见文档底部FAQ</td>
</tr>
</tbody>
</table>
</div>
<p>用户允许授权后，将会重定向到redirect_uri的网址上，并且带上 code 和state参数</p>
<pre class="line-numbers language-none"><code class="language-none">redirect_uri?code&#x3D;CODE&amp;state&#x3D;STATE<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2、通过让用户扫描一个二维码（微信提供），扫完，微信会将授权码发给我们</p>
<p>自然第二种方案（对用户而言）最简单，我们只需将二维码生成的代码（js，<a target="_blank" rel="noopener" href="http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js）引入到我们的前端，注意二维码并不是不是我们生成的，而是微信收到我们前端的那些申请参数自动生成的">http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js）引入到我们的前端，注意二维码并不是不是我们生成的，而是微信收到我们前端的那些申请参数自动生成的</a></p>
<p>我们可以在静态资源wxsign.html （前端工程中）发现页面引入了这个函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623005027995.png" alt="image-20230623005027995" style="zoom: 50%;" /></p>
<p>本质上这两种方案都一样；</p>
<h3 id="准备开发环境"><a href="#准备开发环境" class="headerlink" title="准备开发环境"></a>准备开发环境</h3><p>那么怎么才能获得上面的这些申请验证码/令牌的参数呢？</p>
<p>我上面也提及到了，一般是企业以项目名义等方式来申请。</p>
<p>需要注册微信开放平台，并且为你的项目指备案后注册外网域名（到时候指定这个域名作为微信登录的回调地址），emmm这里，我肯定做不到了。。。。</p>
<ul>
<li>审核通过后微信会给你分配一个appID 和 AppSecret</li>
</ul>
<h3 id="准备内网穿透工具"><a href="#准备内网穿透工具" class="headerlink" title="准备内网穿透工具"></a>准备内网穿透工具</h3><p>用户扫码后，会以重定向的方式把授权码给我们。</p>
<p>微信是在公网，而现在我们的后端处于开发环境，微信怎么才能定位到我们呢？</p>
<ul>
<li>答：需要中间使用一个内网穿透的服务器</li>
<li><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623151444433.png" alt="image-20230623151444433"></p>
</li>
<li><p>微信访问的应该是我们的认证服务端口，所以是63070</p>
</li>
</ul>
<p>当后续我们脱离了开发环境，微信就能直接通过公网来访问我们的认证服务，这样就不需要内网穿透工具了。</p>
<p>为什么需要配置呢？</p>
<p>主要是因为黑马没有给我们对应的 appid 以及serect 只能自己去申请，但是个人开发者很难申请到这些东西</p>
<ul>
<li>你会发现 当你扫码之后，微信给你的回调地址并不是我们现在的域名，而是<a target="_blank" rel="noopener" href="http://tjxt-user-t.itheima.net/xuecheng/auth/wxLogin?code=081CtW0w3iElS03Gfe3w3LUkAt0CtW0I&amp;state=checkcode:1e5e6b08a628422e9f61a0e1ea579da5">http://tjxt-user-t.itheima.net/xuecheng/auth/wxLogin?code=081CtW0w3iElS03Gfe3w3LUkAt0CtW0I&amp;state=checkcode:1e5e6b08a628422e9f61a0e1ea579da5</a></li>
</ul>
<p>以上两个配置方案都需要相当的时间，我在课程评论区发现了一个可以绕过这些申请、认证的方式（不知道具体的原理是什么，大概意思是使用了尚硅谷提供的一些appid以及secret，总之先试试把）</p>
<p>步骤</p>
<ul>
<li>1、(auth-server.yaml中配置) 这个端口改为8160,添加appid 和 appsecret、</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">server:
  servlet:
    context-path: &#x2F;auth
  port: 8160

weixin:
  appid: wxed9954c01bb89b47
  secret: a7482517235173ddb4083788de60b90e

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql:&#x2F;&#x2F;59.110.13.16:3306&#x2F;xc_users?serverTimezone&#x3D;UTC&amp;userUnicode&#x3D;true&amp;useSSL&#x3D;false&amp;
    username: root
    password: root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>2、更改nginx配置</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen 8160;
    server_name localhost;

    location &#x2F;api &#123;
	proxy_pass http:&#x2F;&#x2F;gatewayserver;
	#proxy_pass http:&#x2F;&#x2F;localhost:63010;
	proxy_set_header Host $host;
	proxy_set_header X-Real-IP $remote_addr;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

	# 这里需要添加一个rewrite规则，把请求中的&#x2F;api去掉
	rewrite ^&#x2F;api(.*)$ $1 break;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>3、更改原来扫码js脚本</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> wxObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxLogin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">self_redirect</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">"login_container"</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">appid</span><span class="token operator">:</span> <span class="token string">"wxed9954c01bb89b47"</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">"snsapi_login"</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">"http://localhost:8160/auth/wxLogin"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">state</span><span class="token operator">:</span> token<span class="token punctuation">,</span>
        <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token literal-property property">href</span><span class="token operator">:</span> <span class="token string">""</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623160047435.png" alt="image-20230623160047435" style="zoom:50%;" /></p>
<p>二维码从“天机学堂”变成了“我的谷粒”</p>
<h2 id="接收授权码-微信验证登录"><a href="#接收授权码-微信验证登录" class="headerlink" title="接收授权码/微信验证登录"></a>接收授权码/微信验证登录</h2><p>做到这里，相当于实现了下面这些步骤</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623160906826.png" alt="image-20230623160906826" style="zoom:50%;" /></p>
<p>当用户扫完点同意后，微信就会我们重定向地址以及授权码。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623161420183.png" alt="image-20230623161420183"></p>
<p>那么我们就</p>
<p>1、<strong>需要定义接口接收微信下发的授权码</strong></p>
<p>2、接收到授权码后，拿授权码去微信申请令牌</p>
<p>3、拿到令牌后去微信资源服务器查询用户信息，</p>
<p>4、保存用户信息进我们的数据库，</p>
<p>5、如果这个用户真的存在</p>
<p>​    就让用户（自动）登录（这个controller 返回 重定向地址，重定向到登录网址）并给他发放<strong>我们给他的jwt令牌</strong></p>
<h3 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h3><p>按照上述接口，定义WxLoginController类</p>
<p>可以定义一个wx的service 去 执行1-4 步骤，执行完返回用户信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxLoginController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxAuthServiceImpl</span> wxAuthService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/wxLogin"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"微信扫码回调,code:&#123;&#125;,state:&#123;&#125;"</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1-4 步 ：全部在service 实现里面执行</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> wxAuthService<span class="token punctuation">.</span><span class="token function">wxAuth</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>xcUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/error.html"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/sign.html?username="</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">"&amp;authType=wx"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义微信验证</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//TODO: 获取access_token</span>
        <span class="token comment">//TODO: 获取用户信息</span>
        <span class="token comment">// 这里先用个假数据</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO: 添加用户信息到数据库</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 微信扫码认证，不需要校验密码和验证码
     * @param authParamsDto 认证参数
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>// 其实完整的功能还没有搭建完成，我们先试试能不能正常跑通</p>
<p>扫码后点击同意，成功重定向到 微信 给我们的 授权码，我们接收授权码的接口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623164225704.png" alt="image-20230623164225704" style="zoom:33%;" /></p>
<p>假设我们通过1-4步获取到完整的用户信息，返回controller接口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623164345297.png" alt="image-20230623164345297" style="zoom:33%;" /></p>
<p>最终，controller接口会将 让前端的页面重定向到登录接口，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623165024535.png" alt="image-20230623165024535"></p>
<p>那么，走的相当于原来定义的统一的认证接口</p>
<p>等价于我们测试时的</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST localhost<span class="token operator">:</span><span class="token number">63070</span>/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;username=<span class="token punctuation">&#123;</span><span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"t1"</span><span class="token punctuation">,</span><span class="token property">"password"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"authType"</span><span class="token operator">:</span><span class="token string">"wx"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>SpringSecurity 接收到这个请求后，和上一节一样，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/ppnetIJ.png" alt="img"></p>
<ol>
<li><p>（1、2）用户提交<strong>用户名、认证方式等信息</strong>被SecurityFilterChain中的<strong>UsernamePasswordAuthenticationFilter</strong>过滤器获取到，<strong>封装为请求</strong>Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。</p>
</li>
<li><p>（3）然后过滤器<strong>将请求</strong>Authentication<strong>提交至认证管理器</strong>（AuthenticationManager）进行认证</p>
<p>2.1 <strong>认证管理器</strong>认证管理器 本身没有认证的功能 但是可以<strong>选择 认证方式</strong>  这里展示了 通过默认方式 去认证也就是委托 认证提供类 DaoAuthentication Provider 的 loadUserByUsername 来 查询/验证 数据库 返回完整的用户数据信息，验证通过后返回</p>
<p>2.2 我们重写DaoAuthentication Provider这个类 重新实现loadUserByUsername  以及 里面的 校验方法 execute</p>
</li>
<li><p>（9）<strong>认证成功</strong>后，AuthenticationManager身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除）Authentication实例。最后被<strong>存储进第一层过滤器的上下文信息当中</strong></p>
</li>
</ol>
<h3 id="逻辑实现"><a href="#逻辑实现" class="headerlink" title="逻辑实现"></a>逻辑实现</h3><p><strong>远程调用</strong>中如果通过<strong>HTTP协议</strong>来调用</p>
<p>如果是在我们<strong>自己的微服务</strong>之间，我们采用的是<strong>Feign</strong></p>
<p>如果是自己调用<strong>第三方</strong>的微服务，那么我们采用的是<strong>RestTemplate</strong></p>
<p>这里我们申请第三方获取令牌，明显就是与第三方的HTTP交互，所以，采用restTemplate的方式</p>
<h4 id="使用restTemplate"><a href="#使用restTemplate" class="headerlink" title="使用restTemplate"></a>使用restTemplate</h4><p>前提</p>
<p>1、使用RestTemplate请求微信，在AuthApplication里配置RestTemplate的bean</p>
<p>需要在启动类注入RestTemplate的bean（第三方的Bean都需要在配置类或者启动类中注入成bean）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OkHttp3ClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  restTemplate<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="提取方法"><a href="#提取方法" class="headerlink" title="提取方法"></a>提取方法</h4><p>2、定义一个WxAuthService，将刚刚写的wxAuth()方法提取到该接口中</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>让WxAuthService实现WxAuthService，这样代码更规范，没别的意思,其实没有多少实际意义</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span><span class="token punctuation">,</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//TODO: 申请令牌即获取access_token</span>

        <span class="token comment">//TODO: 获取用户信息</span>

        <span class="token comment">// 这里先用个假数据</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token string">"Kyle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO: 添加用户信息到数据库</span>

        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="获取令牌"><a href="#获取令牌" class="headerlink" title="获取令牌"></a>获取令牌</h4><p>在WxAuthServiceImpl类中定义申请令牌的私有方法，</p>
<p>我们把这个方法单独提取出来</p>
<p>看看微信官方怎么说明需要的参数的</p>
<p>请求参数</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">GET https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">是否必须</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">appid</td>
<td style="text-align:left">是</td>
<td style="text-align:left">应用唯一标识，在微信开放平台提交应用审核通过后获得</td>
</tr>
<tr>
<td style="text-align:left">secret</td>
<td style="text-align:left">是</td>
<td style="text-align:left">应用密钥 AppSecret，在微信开放平台提交应用审核通过后获得</td>
</tr>
<tr>
<td style="text-align:left">code</td>
<td style="text-align:left">是</td>
<td style="text-align:left">填写第一步获取的 code 参数</td>
</tr>
<tr>
<td style="text-align:left">grant_type</td>
<td style="text-align:left">是</td>
<td style="text-align:left">填 authorization_code</td>
</tr>
</tbody>
</table>
</div>
<p>enn需要这些个玩意。</p>
<p>将以json返回下面这些东西</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"access_token"</span><span class="token operator">:</span> <span class="token string">"ACCESS_TOKEN"</span><span class="token punctuation">,</span>
  <span class="token property">"expires_in"</span><span class="token operator">:</span> <span class="token number">7200</span><span class="token punctuation">,</span>
  <span class="token property">"refresh_token"</span><span class="token operator">:</span> <span class="token string">"REFRESH_TOKEN"</span><span class="token punctuation">,</span>
  <span class="token property">"openid"</span><span class="token operator">:</span> <span class="token string">"OPENID"</span><span class="token punctuation">,</span>
  <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"SCOPE"</span><span class="token punctuation">,</span>
  <span class="token property">"unionid"</span><span class="token operator">:</span> <span class="token string">"UNIONID"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">access_token</td>
<td style="text-align:left">接口调用凭证</td>
</tr>
<tr>
<td style="text-align:left">expires_in</td>
<td style="text-align:left">access_token 接口调用凭证超时时间，单位（秒）</td>
</tr>
<tr>
<td style="text-align:left">refresh_token</td>
<td style="text-align:left">用户刷新 access_token</td>
</tr>
<tr>
<td style="text-align:left">openid</td>
<td style="text-align:left">授权用户唯一标识</td>
</tr>
<tr>
<td style="text-align:left">scope</td>
<td style="text-align:left">用户授权的作用域，使用逗号（,）分隔</td>
</tr>
<tr>
<td style="text-align:left">unionid</td>
<td style="text-align:left">用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的 unionid 是唯一的</td>
</tr>
</tbody>
</table>
</div>
<p>// 还是在WxAuthServiceImpl 里面</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;weixin.appid&#125;"</span><span class="token punctuation">)</span> 
    <span class="token class-name">String</span> appid<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;weixin.secret&#125;"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> secret<span class="token punctuation">;</span>
<span class="token comment">// 上面这俩黑马都没有提供给我们，我们利用的尚硅谷的。。。。，太感谢了！！</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 请求路径模板，参数用%s占位符</span>
        <span class="token class-name">String</span> url_template <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code"</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 填充占位符：appid，secret，code</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>url_template<span class="token punctuation">,</span> appid<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        
        <span class="token comment">// 3. 远程调用URL，POST方式（详情参阅官方文档）</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 获取相应结果，响应结果为json格式的字符串</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 转为map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>啊啊啊啊啊啊 真相了，原来 post也可以在url传参呐。。。。。我一直以为只能在 请求体里面传参。</p>
<p>测试</p>
<p>打个断点看一下，看看是否能拿到access_token</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">@Override
public XcUser wxAuth(String code) &#123;
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   //获取access_token
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    Map&lt;String, String> access_token_map = getAccess_token(code);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   //TODO: 获取用户信息
</span><span class="token prefix unchanged"> </span><span class="token line">   // 这里先用个假数据
</span><span class="token prefix unchanged"> </span><span class="token line">   XcUser xcUser = xcUserMapper.selectOne(new LambdaQueryWrapper&lt;XcUser>().eq(XcUser::getUsername, "Kyle"));
</span><span class="token prefix unchanged"> </span><span class="token line">   //TODO: 添加用户信息到数据库
</span><span class="token prefix unchanged"> </span><span class="token line">   return xcUser;
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>发现突然启动不了 niginx了</p>
<p>错误信息如下</p>
<pre class="line-numbers language-none"><code class="language-none">2023&#x2F;06&#x2F;23 22:01:42 [emerg] 17128#23268: bind() to 0.0.0.0:8160 failed (10013: An attempt was made to access a socket in a way forbidden by its access permissions)
2023&#x2F;06&#x2F;23 22:03:17 [notice] 13608#3736: signal process started
2023&#x2F;06&#x2F;23 22:03:17 [error] 13608#3736: OpenEvent(&quot;Global\ngx_reload_24488&quot;) failed (2: The system cannot find the file specified)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>网上大概意思是说8160被占用了？，我尼玛就是要用啊 他是验证服务端口啊，要不先启动ngnix再启动服务试试？</p>
<p>还是不行。。。</p>
<p>emmmm</p>
<p>看看端口</p>
<pre class="line-numbers language-none"><code class="language-none">netstat -aon | findstr :80

  TCP    [2001:da8:215:3c0a:8f3f:ca64:32d5:787d]:14404  [2001:da8:215:3c0a:8f3f:ca64:32d5:787d]:8160  TIME_WAIT       0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>把这个线程关了试试？</p>
<pre class="line-numbers language-none"><code class="language-none">tasklist|findstr “14404”


没输出任何玩意啊。。。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>麻了。。。</p>
<p>网上说退出一下就行，输入了一下以下代码，好了。。。。什么鬼？</p>
<pre class="line-numbers language-none"><code class="language-none">nginx -s quit
start nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>开始测试！</p>
<p>emmmmm 又遇到新的问题了，开启nginx后，微服务有报错了</p>
<pre class="line-numbers language-none"><code class="language-none">Action:

Identify and stop the process that&#39;s listening on port 8160 or configure this application to listen on another port.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>意思大概说 8160 已经被占用了，这个多半是因为nignx设置了一个监听，好像不用也可以，我试试？</p>
<p>把原来这里的注释掉</p>
<pre class="line-numbers language-none"><code class="language-none">#     server &#123;
# 	    listen 8160;
# 	    server_name localhost;

# 	    location &#x2F;api &#123;
# 		proxy_pass http:&#x2F;&#x2F;gatewayserver;
# 		#proxy_pass http:&#x2F;&#x2F;localhost:63010;
# 		proxy_set_header Host $host;
# 		proxy_set_header X-Real-IP $remote_addr;
# 		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

# 		# 这里需要添加一个rewrite规则，把请求中的&#x2F;api去掉
# 		rewrite ^&#x2F;api(.*)$ $1 break;
# 	    &#125;
# 	&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>啊终于好了。。。</p>
<p>开始测试！！！</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623222747204.png" alt="image-20230623222747204" style="zoom:33%;" /></p>
<p>成功获取令牌（access_token！）</p>
<h4 id="获取用户信息"><a href="#获取用户信息" class="headerlink" title="获取用户信息"></a>获取用户信息</h4><p>同样的我们把这一步提取成一个方法</p>
<p>看看微信发放平台上怎么获取信息的？</p>
<p>请求参数</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">GET https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&amp;openid=OPENID<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">是否必须</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">access_token</td>
<td style="text-align:left">是</td>
<td style="text-align:left">调用凭证</td>
</tr>
<tr>
<td style="text-align:left">openid</td>
<td style="text-align:left">是</td>
<td style="text-align:left">普通用户的标识，对当前开发者帐号唯一</td>
</tr>
<tr>
<td style="text-align:left">lang</td>
<td style="text-align:left">否</td>
<td style="text-align:left">国家地区语言版本，zh_CN 简体，zh_TW 繁体，en 英语，默认为 en</td>
</tr>
</tbody>
</table>
</div>
<p>响应为</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"openid"</span><span class="token operator">:</span> <span class="token string">"OPENID"</span><span class="token punctuation">,</span>
  <span class="token property">"nickname"</span><span class="token operator">:</span> <span class="token string">"NICKNAME"</span><span class="token punctuation">,</span>
  <span class="token property">"sex"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"province"</span><span class="token operator">:</span> <span class="token string">"PROVINCE"</span><span class="token punctuation">,</span>
  <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"CITY"</span><span class="token punctuation">,</span>
  <span class="token property">"country"</span><span class="token operator">:</span> <span class="token string">"COUNTRY"</span><span class="token punctuation">,</span>
  <span class="token property">"headimgurl"</span><span class="token operator">:</span> <span class="token string">"https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/0"</span><span class="token punctuation">,</span>
  <span class="token property">"privilege"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"PRIVILEGE1"</span><span class="token punctuation">,</span> <span class="token string">"PRIVILEGE2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"unionid"</span><span class="token operator">:</span> <span class="token string">" o6_bmasdasdsad6_2sgVt7hMZOPfL"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">openid</td>
<td style="text-align:left">普通用户的标识，对当前开发者帐号唯一</td>
</tr>
<tr>
<td style="text-align:left">nickname</td>
<td style="text-align:left">普通用户昵称</td>
</tr>
<tr>
<td style="text-align:left">sex</td>
<td style="text-align:left">普通用户性别，1 为男性，2 为女性</td>
</tr>
<tr>
<td style="text-align:left">province</td>
<td style="text-align:left">普通用户个人资料填写的省份</td>
</tr>
<tr>
<td style="text-align:left">city</td>
<td style="text-align:left">普通用户个人资料填写的城市</td>
</tr>
<tr>
<td style="text-align:left">country</td>
<td style="text-align:left">国家，如中国为 CN</td>
</tr>
<tr>
<td style="text-align:left">headimgurl</td>
<td style="text-align:left">用户头像，最后一个数值代表正方形头像大小（有 0、46、64、96、132 数值可选，0 代表 640*640 正方形头像），用户没有头像时该项为空</td>
</tr>
<tr>
<td style="text-align:left">privilege</td>
<td style="text-align:left">用户特权信息，json 数组，如微信沃卡用户为（chinaunicom）</td>
</tr>
<tr>
<td style="text-align:left">unionid</td>
<td style="text-align:left">用户统一标识。针对一个微信开放平台帐号下的应用，同一用户的 unionid 是唯一的</td>
</tr>
</tbody>
</table>
</div>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> access_token<span class="token punctuation">,</span><span class="token class-name">String</span> openid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">String</span> wxUrl_template <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s"</span><span class="token punctuation">;</span>
    <span class="token comment">//请求微信地址</span>
    <span class="token class-name">String</span> wxUrl <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>wxUrl_template<span class="token punctuation">,</span> access_token<span class="token punctuation">,</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用微信接口申请access_token, url:&#123;&#125;"</span><span class="token punctuation">,</span> wxUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>wxUrl<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//防止乱码进行转码!!!</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">new</span>     <span class="token class-name">String</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>ISO_8859_1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用微信接口申请access_token: 返回值:&#123;&#125;"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> resultMap <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">@Override
public XcUser wxAuth(String code) &#123;
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   //获取access_token
</span><span class="token prefix unchanged"> </span><span class="token line">   Map&lt;String, String> access_token_map = getAccess_token(code);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    String accessToken = access_token_map.get("access_token");
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // 获取用户信息
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    String openid = access_token_map.get("openid");
</span><span class="token prefix inserted">+</span><span class="token line">    Map&lt;String, String> userInfo = getUserInfo(accessToken, openid);
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // 这里先用个假数据
</span><span class="token prefix unchanged"> </span><span class="token line">   XcUser xcUser = xcUserMapper.selectOne(new LambdaQueryWrapper&lt;XcUser>().eq(XcUser::getUsername, "Kyle"));
</span><span class="token prefix unchanged"> </span><span class="token line">   //TODO: 添加用户信息到数据库
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   return xcUser;
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623224740819.png" alt="image-20230623224740819" style="zoom:50%;" /></p>
<p>这里的headimgurl是你微信的头像图片，如果一切正常，是可以在浏览器中打开查看的</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623224818582.png" alt="image-20230623224818582" style="zoom: 33%;" /></p>
<h4 id="保存用户信息"><a href="#保存用户信息" class="headerlink" title="保存用户信息"></a>保存用户信息</h4><ul>
<li>向数据库保存用户信息，如果用户不存在，则将其保存在数据库</li>
<li>在WxAuthServiceImpl中定义方法addWxUser()</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">XcUserRoleMapper</span> xcUserRoleMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">addWxUser</span><span class="token punctuation">(</span><span class="token class-name">Map</span> userInfo_map<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> unionid <span class="token operator">=</span> userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"unionid"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据unionid查询数据库</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getWxUnionid</span><span class="token punctuation">,</span> unionid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>xcUser<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">String</span> userId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 微信上的id</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setWxUnionid</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录从微信得到的昵称</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"nickname"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUserpic</span><span class="token punctuation">(</span>userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"headimgurl"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>userInfo_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"nickname"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUtype</span><span class="token punctuation">(</span><span class="token string">"101001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//学生类型</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用户状态</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcUserRole</span> xcUserRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token string">"17"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//学生角色</span>
    xcUserRoleMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUserRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//申请令牌即获取access_token</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> access_token_map <span class="token operator">=</span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> accessToken <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">//获取用户信息</span>
    <span class="token class-name">String</span> openid <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> userInfo <span class="token operator">=</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//添加用户信息到数据库   非事务方法调用事务方法</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> currentProxy<span class="token punctuation">.</span><span class="token function">addWxUser</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>注意：非事务方法调用事务方法，要使用代理对象调用，前面也提到过这点</li>
<li>这里的addWxUser()方法涉及到了多表操作，所以需要进行事务控制，而wxAuth()是非事务方法，所以这里我们需要注入自身，然后调用addWxUser()</li>
</ul>
<p>Controller层接口代码如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/wxLogin"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"微信扫码回调,code:&#123;&#125;,state:&#123;&#125;"</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcUser</span> user <span class="token operator">=</span> wxAuthService<span class="token punctuation">.</span><span class="token function">wxAuth</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/error.html"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/sign.html?username="</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">"&amp;authType=wx"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启服务，扫码登录测试</p>
<blockquote>
<p>报错了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230623235353542.png" alt="image-20230623235353542"></p>
<p>看日志，至少到 获取用户信息这一块都是正常的</p>
<p>应该是保存用户信息这一步出错了</p>
<p>报错的意思大概是检测到<code>\xF0\x9F\x8D\x91\</code> 字符非法 ，估计是我的昵称是 桃图案导致的 哈哈哈哈哈</p>
<p>网上说，可以改一改数据库的的编码 ，改成 utf8mb4 即可，试试</p>
<p>因为有外键约束，改动总不行，我把外键删了试试，一般好像也不设置外键，因为外键约束很影响数据库的性能</p>
<p>还是不行</p>
<p>好像是JDBC不支持utf8mb4 </p>
<pre class="line-numbers language-none"><code class="language-none">&gt;spring.datasource.type&#x3D;org.apache.commons.dbcp2.BasicDataSource
&gt;spring.datasource.dbcp2.connection-init-sqls&#x3D;SET NAMES utf8mb4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这回好像成功啦</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624010431297.png" alt="image-20230624010431297"></p>
<p>不过好像又遇到问题了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624010741944.png" alt="image-20230624010741944"></p>
<p>发生了跨域。。。。</p>
<p>再看看细节</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624012048624.png" alt="image-20230624012048624"></p>
<p>还是没能解决，好困啊，先睡了明天再看看</p>
<p>第二天：发现浏览器有弹出了一个禁止重定向的选框，我们将其反选</p>
<p>这个“缩小”bug展示解决了，但是好像还有问题： </p>
<p>1、我们的controller 重定向到”redirect:<a target="_blank" rel="noopener" href="http://localhost/sign.html?username=&quot;+username+&quot;&amp;authType=wx">http://localhost/sign.html?username=&quot;+username+&quot;&amp;authType=wx</a>“;</p>
<p>2、接就是又走了 那一套 Spring Security 的流程，我们在UserDetailServiceImpl 里面的loadUserByUsername 里面打个断点</p>
<p>设一下断点看看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624105616549.png" alt="image-20230624105616549" style="zoom:33%;" /></p>
<p>目前loadUserByUsername  接收倒是没啥问题，后面到了验证的时候 即进入WxAuthServiceImpl 的execute 方法</p>
<p>执行完应该也没问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624105909154.png" alt="image-20230624105909154" style="zoom: 33%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624110251026.png" alt="image-20230624110251026"></p>
<p>到这里也没问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624110832163.png" alt="image-20230624110832163"></p>
<p>暂时都没问题啊，问什么就是不显示呢？</p>
<p>试试密码登录到这：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624111641399.png" alt="image-20230624111641399"></p>
<p>username：</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&#123;
   &quot;companyId&quot;:&quot;1232141425&quot;,
   &quot;createTime&quot;:&quot;2022-09-28T08:32:03&quot;,
   &quot;id&quot;:&quot;52&quot;,
   &quot;name&quot;:&quot;M老师&quot;,
   &quot;permissions&quot;:[],
   &quot;sex&quot;:&quot;1&quot;,
   &quot;status&quot;:&quot;&quot;,
   &quot;username&quot;:&quot;t1&quot;,
   &quot;utype&quot;:&quot;101002&quot;
&gt;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而微信</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&#123;
   &quot;createTime&quot;:&quot;2023-06-24T11:19:37&quot;,
   &quot;id&quot;:&quot;e913f158-c8be-4658-8eed-8fbf59fe8f30&quot;,
   &quot;name&quot;:&quot;🍑🍑&quot;,
   &quot;nickname&quot;:&quot;🍑🍑&quot;,
   &quot;permissions&quot;:[],
   &quot;status&quot;:&quot;1&quot;,
   &quot;username&quot;:&quot;oWgGz1EYHi0Oq_hprfCcboiNgiHA&quot;,
   &quot;userpic&quot;:&quot;https:&#x2F;&#x2F;thirdwx.qlogo.cn&#x2F;...&quot;,
   &quot;utype&quot;:&quot;101001&quot;,
   &quot;wxUnionid&quot;:&quot;oWgGz1EYHi0Oq_hprfCcboiNgiHA&quot;
&gt;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前端还是报错</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&#123;
   &quot;timestamp&quot;: &quot;2023-06-24T03:35:03.818+00:00&quot;,
   &quot;path&quot;: &quot;&#x2F;auth&#x2F;oauth&#x2F;token&quot;,
   &quot;status&quot;: 503,
   &quot;error&quot;: &quot;Service Unavailable&quot;,
   &quot;message&quot;: &quot;&quot;,
   &quot;requestId&quot;: &quot;2e873f4c-67&quot;
&gt;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这也就相当于输入：</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;&quot;redirect:http:&#x2F;&#x2F;localhost&#x2F;sign.html?username&#x3D;&quot;+username+&quot;&amp;authType&#x3D;wx&quot;;

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">&gt;http:&#x2F;&#x2F;localhost&#x2F;api&#x2F;auth&#x2F;oauth&#x2F;token?username&#x3D;%7B%22username%22%3A%22oWgGz1EYHi0Oq_hprfCcboiNgiHA%22%2C%22password%22%3A%22%22%2C%22checkcode%22%3A%22%22%2C%22checkcodekey%22%3A%22%22%2C%22authType%22%3A%22wx%22%7D&amp;grant_type&#x3D;password&amp;client_secret&#x3D;XcWebApp&amp;client_id&#x3D;XcWebApp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里应该是调用了<a target="_blank" rel="noopener" href="http://localhost/static/js/page-learing-sign.js">http://localhost/static/js/page-learing-sign.js</a></p>
<pre class="line-numbers language-none"><code class="language-none">const loginSubmit &#x3D; (params) &#x3D;&gt; &#123;
     return  requestPostForm(&#39;&#x2F;api&#x2F;auth&#x2F;oauth&#x2F;token?&#39;+params,&#123;&#125;);
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我自测时正常的啊….</p>
<pre class="line-numbers language-none"><code class="language-none">&gt;POST localhost:8160&#x2F;auth&#x2F;oauth&#x2F;token?client_id&#x3D;XcWebApp&amp;client_secret&#x3D;XcWebApp&amp;grant_type&#x3D;password&amp;username&#x3D;&#123;&quot;username&quot;:&quot;oWgGz1EYHi0Oq_hprfCcboiNgiHA&quot;,&quot;authType&quot;:&quot;wx&quot;&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624122043328.png" alt="image-20230624122043328"></p>
<p>可以正常获取令牌啊。。为什么还是不行呢？</p>
<p>崩溃了,忙活了一上午,还没明白</p>
<p>卧槽终于成功了!!!!!</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624141711110.png" alt="image-20230624141711110"></p>
<p>我把回调的地址改成了</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line">@RequestMapping("/wxLogin")
</span><span class="token prefix inserted">></span><span class="token line">public String wxLogin(String code, String state) throws IOException &#123;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  log.debug("微信扫码回调,code:&#123;&#125;,state:&#123;&#125;",code,state);
</span><span class="token prefix unchanged"> </span><span class="token line">  XcUser xcUser = wxAuthService.wxAuth(code);
</span><span class="token prefix unchanged"> </span><span class="token line">  if(xcUser==null)&#123;
</span><span class="token prefix unchanged"> </span><span class="token line">      return "redirect:http://localhost/error.html";
</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">  String username = xcUser.getUsername();
</span><span class="token prefix unchanged"> </span><span class="token line">  log.debug("执行完微信登录获取用户信息，下面验证用户信息,username:&#123;&#125;,authType:&#123;&#125;",username,"wx");
</span></span><span class="token inserted-arrow inserted"><span class="token prefix inserted">></span><span class="token line">+    return "redirect:http://www.51xuecheng.cn/sign.html?username="+username+"&amp;authType=wx";
</span><span class="token prefix inserted">></span><span class="token line">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>原先一直没法存上令牌的原因可能是 存的位置不对?</p>
<p>其实本质原理还是没搞懂,只是瞎猫碰着死耗子了,有时间一定研究研究…好累</p>
</blockquote>
<h1 id="用户授权"><a href="#用户授权" class="headerlink" title="用户授权"></a>用户授权</h1><h2 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h2><ul>
<li><p>如何实现授权？业界通常基于RBAC实现授权</p>
</li>
<li><p>RBAC分为两种方式</p>
</li>
<li><p>基于角色的访问控制（Role-Based Access Control）</p>
<p>基于资源的访问控制（Resource-Based Access Control）</p>
</li>
</ul>
<ol>
<li><p>基于<strong>角色</strong>的访问控制（Role-Based Access Control）</p>
<ul>
<li><p>按角色进行授权，例如：只有主体角色为总经理，才可以查询企业运营报表，查询员工工资等，其授权代码可以表示如下</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">if(主体.hasRole(&quot;总经理角色ID&quot;))&#123;
    &#x2F;&#x2F;TODO: 查询报表
    &#x2F;&#x2F;TODO: 查询工资
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>但是如果现在的需求是：总经理和部门经理都可以查询报表和工资，那么此时就需要修改逻辑判断</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">if(主体.hasRole(&quot;总经理角色ID&quot;) || 主体.hasRole(&quot;部门经理角色ID&quot;))&#123;
    &#x2F;&#x2F;TODO: 查询报表
    &#x2F;&#x2F;TODO: 查询工资
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>此种方式当需要修改角色权限时，就需要修改授权相关的代码，系统可扩展性差</p>
</li>
</ul>
</li>
<li><p>基于<strong>资源</strong>的访问控制（Resource-Based Access Control）</p>
<ul>
<li><p>按资源（或权限）进行授权，例如：用户必须具有查询工资的权限才可以查询员工工资，其授权代码可以表示如下</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">if(主体.hasPermission(&quot;查询工资权限标识&quot;))&#123;
    &#x2F;&#x2F;TODO: 查询工资
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>优点：系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理，也不需要修改授权代码，系统可扩展性强</p>
</li>
<li><p>所以现如今一般嗾使基于资源的访问控制</p>
</li>
</ul>
</li>
</ol>
<h2 id="资源服务授权流程"><a href="#资源服务授权流程" class="headerlink" title="资源服务授权流程"></a>资源服务授权流程</h2><ul>
<li>本项目在资源服务内部进行授权，基于资源的授权方式，因为接口在资源服务，通过在接口处添加授权注解实现授权</li>
</ul>
<h3 id="配置nginx代理"><a href="#配置nginx代理" class="headerlink" title="配置nginx代理"></a>配置nginx代理</h3><pre class="line-numbers language-conf" data-language="conf"><code class="language-conf">#前端开发服务
upstream uidevserver&#123;
    server 127.0.0.1:8601 weight&#x3D;10;
&#125; 
server &#123;
    listen       80;
    server_name  teacher.51xuecheng.cn;
    ssi on;
    ssi_silent_errors on;
    location &#x2F; &#123;
        proxy_pass   http:&#x2F;&#x2F;uidevserver;
        proxy_cookie_path &#x2F; &quot;&#x2F;; HTTPOnly; SameSite&#x3D;strict&quot;;
        proxy_cookie_domain uidevserver teacher.localhost;
    &#125;

    location &#x2F;api&#x2F; &#123;
        proxy_pass http:&#x2F;&#x2F;gatewayserver&#x2F;;

    &#125;   
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>这里配完了之后要是访问<code>教学机构</code>的时候,teacher.51xuecheng.cn;，的访问路径</li>
</ul>
<h3 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h3><p>在资源服务集成Spring Security</p>
<ul>
<li>在需要授权的接口处使用<code>@PreAuthorize(&quot;hasAuthority(&#39;权限标识符&#39;)&quot;)</code>进行控制</li>
<li>下面代码指定<code>/course/list</code>接口需要拥有<code>xc_teachmanager_course_list</code>权限</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程查询接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('xc_teachmanager_course_list')"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/course/list"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseBase</span><span class="token punctuation">></span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">QueryCourseParamDto</span> queryCourseParams<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseBase</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">queryCourseBaseList</span><span class="token punctuation">(</span>pageParams<span class="token punctuation">,</span> queryCourseParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动 content  system auth gateway 以及 8601前端</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624151434608.png" alt="image-20230624151434608"></p>
<p>由于配置了统一的异常处理，所以，前端并不知到发生了什么，我们从后端才知道权限判定生效了</p>
<p>那么为了让前端知道是权限不足导致的，我们需要把这个异常捕获，返回到前端</p>
<p>照理说应该捕获 AccessDeniedException 但是 统一异常处理在base包下，</p>
<ul>
<li>如果向捕获AccessDeniedException  就必须引入SpringSecurtiy依赖，，，这样Base工程就在SpringSecurity管控之下了，而且因为其他所有的 服务都依赖于 Base工程，那么其他所有微服务都将在SpringSecuroty的管控之下</li>
<li>所以不需要引入依赖</li>
<li>在原来的通用异常打一个补丁，看看里面的信息是不是 不允许访问</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestErrorResponse</span> <span class="token function">exception</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

   log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"【系统异常】&#123;&#125;"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"不允许访问"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span><span class="token string">"没有操作此功能的权限"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span><span class="token class-name">CommonError</span><span class="token punctuation">.</span>UNKOWN_ERROR<span class="token punctuation">.</span><span class="token function">getErrMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624153817834.png" alt="image-20230624153817834" style="zoom: 33%;" /></p>
<p>我们肯定会很好奇，当对接口进行资源管控时，他是怎么校验的呢？</p>
<h3 id="校验权限的流程"><a href="#校验权限的流程" class="headerlink" title="校验权限的流程"></a>校验权限的流程</h3><p>首先微服务引入了SpringSecurity的依赖</p>
<p>以及相关配置信息（ResouceServerConfig、TokenConfig）</p>
<p>当我们访问接口时，是携带令牌去访问的</p>
<blockquote>
<p> 发现了一个bug 必须先运行nignx 后运行的话 会报错，无法代理，，这时为社么？</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624175903811.png" alt="image-20230624175903811"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624180339553.png" alt="image-20230624180339553"></p>
<p>微服务获取令牌，解开令牌时，还附带了令牌的权限</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624180534516.png" alt="image-20230624180534516"></p>
<p>这个test时让是我们封装userdetail时加的，如果想要赋予他某某权限需要封装时 自己去添加即可</p>
<h2 id="授权相关的数据模型（用户-角色-权限）"><a href="#授权相关的数据模型（用户-角色-权限）" class="headerlink" title="授权相关的数据模型（用户/角色/权限）"></a><strong>授权相关的数据模型</strong>（用户/角色/权限）</h2><p>对于用户的授权，简单来说就是封装userdetail 给他再权限数组中增加相关权限即可，但是如何能够侵入性小的方式添加/删除权限呢？</p>
<p>这要从  <strong>用户/ 角色 /权限表</strong>    说起</p>
<ul>
<li>如何给用户分配权限呢？查看数据库中的表结构<ul>
<li><code>xc_user</code>：用户表，存储了系统用户信息</li>
<li><code>xc_user_role</code>：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户拥有</li>
<li><code>xc_role</code>：角色表，存储了系统的角色类型，角色类型包括：学生、老师、管理员、教学管理员、超级管理员</li>
<li><code>xc_permission</code>：角色权限表，一个角色可拥有多个权限，一个权限可被多个角色拥有</li>
<li><code>xc_menu</code>：权限菜单表，里面记录了各种操作的权限code</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624182028830.png" alt="image-20230624182028830"></p>
<ul>
<li>本项目要求掌握基于权限模型数据，要求在数据库中操作完成给用户分配权限、查询用户权限等需求</li>
</ul>
<h3 id="用户权限查询"><a href="#用户权限查询" class="headerlink" title="用户权限查询"></a>用户权限查询</h3><p>如果向申请令牌是给这个令牌上注入权限，那么 首先肯定是向数据库查询这个用户的权限</p>
<p>查询语句应该是(查询id为51的用户他的权限)</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT * FROM xc_menu WHERE id IN (
    SELECT menu_id FROM xc_permission WHERE	role_id IN ( 
    SELECT role_id FROM xc_user_role WHERE user_id &#x3D; &#39;52&#39; 
    )
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义mapper接口（已经有了）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">XcMenuMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"SELECT    * FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #&#123;userId&#125; ))"</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">></span></span> <span class="token function">selectPermissionByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="将权限“注入”UserDetail"><a href="#将权限“注入”UserDetail" class="headerlink" title="将权限“注入”UserDetail"></a>将权限“注入”UserDetail</h3><p>修改UserServiceImpl类的 loadUserPassword  getUserPrincipal方法，查询权限信息</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   public UserDetails getUserPrincipal(XcUserExt user) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 查询用户权限
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">        String[] authorities = &#123;"test"&#125;;
</span><span class="token prefix inserted">+</span><span class="token line">        List&lt;XcMenu> xcMenus = xcMenuMapper.selectPermissionByUserId(user.getId());
</span><span class="token prefix inserted">+</span><span class="token line">        if(xcMenus.size()>0)&#123;
</span><span class="token prefix inserted">+</span><span class="token line">            List&lt;String> permissions = new ArrayList&lt;>();
</span><span class="token prefix inserted">+</span><span class="token line">            xcMenus.forEach(item->&#123;
</span><span class="token prefix inserted">+</span><span class="token line">                permissions.add(item.getCode());
</span><span class="token prefix inserted">+</span><span class="token line">            &#125;);
</span><span class="token prefix inserted">+</span><span class="token line">            authorities = permissions.toArray(new String[0]);
</span><span class="token prefix inserted">+</span><span class="token line">        &#125;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       
</span><span class="token prefix unchanged"> </span><span class="token line">       String password = user.getPassword();
</span><span class="token prefix unchanged"> </span><span class="token line">       user.setPassword(null);
</span><span class="token prefix unchanged"> </span><span class="token line">       String userJsonStr = JSON.toJSONString(user);
</span><span class="token prefix unchanged"> </span><span class="token line">       UserDetails userDetails = User.withUsername(userJsonStr).password(password).authorities(authorities).build();
</span><span class="token prefix unchanged"> </span><span class="token line">       return userDetails;
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试：访问成功！</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624185929031.png" alt="image-20230624185929031"></p>
<h2 id="细粒度授权"><a href="#细粒度授权" class="headerlink" title="细粒度授权"></a>细粒度授权</h2><ul>
<li><p>什么叫细粒度授权？</p>
<ul>
<li>细粒度授权也叫数据范围授权，即不同的用户所拥有的的<strong>操作权限相同</strong>，但是能够<strong>操作的数据范围是不一样</strong>的。</li>
<li>例如：用户A和网易的，用户B是字节的，他们都拥有<code>我的课程</code>的权限，但他们查询到的数据是不一样的，因为不能查询别的机构的课程</li>
</ul>
</li>
<li><p>本项目有哪些细粒度授权？</p>
<ul>
<li>我的课程：教学机构只允许查询本机构下的课程信息</li>
<li>我的选课：学生只允许查询自己所选的课</li>
</ul>
</li>
<li><p>如何实现细粒度授权？</p>
<ul>
<li>细粒度授权涉及到不同的业务逻辑，通常在service层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据，或操作不同的数据</li>
</ul>
</li>
</ul>
<h3 id="教学机构细粒度授权"><a href="#教学机构细粒度授权" class="headerlink" title="教学机构细粒度授权"></a>教学机构细粒度授权</h3><ul>
<li>教学机构在维护课程时，只允许维护本机构的课程，教学机构细粒度授权过程如下<ol>
<li>获取当前登录的用户身份 通过SpringSecurity 的函数 SecurityUtil.getUser(); // 本质从上下文过滤器获取</li>
<li>得到用户所属教育机构的id</li>
<li>查询该教学机构下的课程信息</li>
</ol>
</li>
<li>最终实现了用户只允许查询自己机构的课程信息</li>
<li>在之前的做法，我们是模拟了一个假数据，用的是一个写死的companyId</li>
<li>根据companyId查询课程，流程如下<ol>
<li>教学机构用户登录系统，从用户身份中取出所属机构的id</li>
<li>接口层取出当前登录用户的身份，取出机构id</li>
<li>将机构id传入service方法</li>
<li>service方法将机构id传入dao方法，作为SQL查询参数（where companyId = ${companyId}），最终查询出本机构的课程信息</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">@ApiOperation("课程查询接口")
@PreAuthorize("hasAuthority('xc_teachmanager_course_list')")
@PostMapping("/course/list")
public PageResult&lt;CourseBase> list(PageParams pageParams, @RequestBody QueryCourseParamDto queryCourseParams) &#123;
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    SecurityUtil.XcUser user = SecurityUtil.getUser();
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   Long companyId = null;
</span><span class="token prefix unchanged"> </span><span class="token line">   if (StringUtils.isNotEmpty(user.getCompanyId())) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">       companyId = Long.parseLong(user.getCompanyId());
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    PageResult&lt;CourseBase> result = courseBaseInfoService.queryCourseBaseList(companyId,pageParams, queryCourseParams);
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   return result;
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为该机构下没什么课程所以搜不到</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230624210655729.png" alt="image-20230624210655729"></p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h2 id="找回密码-实战"><a href="#找回密码-实战" class="headerlink" title="找回密码(实战)"></a><strong>找回密码(实战)</strong></h2><ul>
<li>由于邮件发送比手机验证码要方便的多，所以这里就只做邮件注册、找回密码了</li>
<li>需求：忘记密码需要找回，可以通过邮箱找回密码</li>
<li>页面访问地址：localhost/findpassword.html</li>
</ul>
<h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><ul>
<li>邮箱验证码：/api/checkcode/phone?param1=电子邮箱地址</li>
<li>找回密码：/api/auth/findpassword</li>
</ul>
<p>请求</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;cellphone&quot;:&#39;&#39;,
    &quot;email&quot;:&#39;&#39;,
    &quot;checkcodekey&quot;:&#39;&#39;,
    &quot;checkcode&quot;:&#39;&#39;,
    &quot;confirmpwd&quot;:&#39;&#39;,
    &quot;password&quot;:&#39;&#39;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>执行流程<ol>
<li>校验验证码，不一致则抛异常</li>
<li>判断两次密码是否一致，不一致则抛异常</li>
<li>根据邮箱查询用户</li>
<li>如果找到用户，更新其密码</li>
</ol>
</li>
</ul>
<h3 id="导入依赖-1"><a href="#导入依赖-1" class="headerlink" title="导入依赖"></a>导入依赖</h3><h4 id="邮箱"><a href="#邮箱" class="headerlink" title="邮箱"></a>邮箱</h4><p>在checkcode模块中导入邮件发送相关依赖（之前瑞吉外卖那篇文章也用过的）</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/javax.activation/activation --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>javax.activation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>activation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/javax.mail/mail --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>javax.mail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.4.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-email --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="redis依赖"><a href="#redis依赖" class="headerlink" title="redis依赖"></a>redis依赖</h4><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--redis依赖--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--common-pool--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="编写邮箱工具类"><a href="#编写邮箱工具类" class="headerlink" title="编写邮箱工具类"></a>编写邮箱工具类</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>checkcode<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailUtil</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//可以在这里直接测试方法，填自己的邮箱即可</span>
        <span class="token function">sendTestMail</span><span class="token punctuation">(</span><span class="token string">"1359114644@qq.com"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MailUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">achieveCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 发送邮件
     * @param email 收件邮箱号
     * @param code  验证码
     * @throws MessagingException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendTestMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建Properties 类用于记录邮箱的一些属性</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 表示SMTP发送邮件，必须进行身份验证</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.auth"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//此处填写SMTP服务器</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.host"</span><span class="token punctuation">,</span> <span class="token string">"smtp.qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//端口号，QQ邮箱端口587</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.port"</span><span class="token punctuation">,</span> <span class="token string">"587"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处填写，写信人的账号</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.user"</span><span class="token punctuation">,</span> <span class="token string">"1359114644@qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处填写16位STMP口令</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.password"</span><span class="token punctuation">,</span> <span class="token string">"gdkoqdggj******b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建授权信息，用于进行SMTP进行身份验证</span>
        <span class="token class-name">Authenticator</span> authenticator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Authenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">protected</span> <span class="token class-name">PasswordAuthentication</span> <span class="token function">getPasswordAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 用户名、密码</span>
                <span class="token class-name">String</span> userName <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"mail.user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> password <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"mail.password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PasswordAuthentication</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用环境属性和授权信息，创建邮件会话</span>
        <span class="token class-name">Session</span> mailSession <span class="token operator">=</span> <span class="token class-name">Session</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> authenticator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建邮件消息</span>
        <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessage</span><span class="token punctuation">(</span>mailSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置发件人</span>
        <span class="token class-name">InternetAddress</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"mail.user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置收件人的邮箱</span>
        <span class="token class-name">InternetAddress</span> <span class="token keyword">to</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setRecipient</span><span class="token punctuation">(</span><span class="token class-name">RecipientType</span><span class="token punctuation">.</span>TO<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置邮件标题</span>
        message<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"Kyle's Blog 邮件测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置邮件的内容体</span>
        message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token string">"尊敬的用户:你好!\n注册验证码为:"</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">"(有效期为一分钟,请勿告知他人)"</span><span class="token punctuation">,</span> <span class="token string">"text/html;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最后当然就是发送邮件啦</span>
        <span class="token class-name">Transport</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     *  生成验证码
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">achieveCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//由于数字 1 、 0 和字母 O 、l 有时分不清楚，所以，没有数字 1 、 0</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beforeShuffle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">,</span>
                <span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token string">"O"</span><span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token string">"U"</span><span class="token punctuation">,</span> <span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span>
                <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token string">"j"</span><span class="token punctuation">,</span> <span class="token string">"k"</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token string">"m"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"o"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"t"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"v"</span><span class="token punctuation">,</span>
                <span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token string">"z"</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>beforeShuffle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将数组转换为集合</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//打乱集合顺序</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将集合转化为字符串</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h3><p>在Controller层中添加对应的接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/phone"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"param1"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"找回密码"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"找回密码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/findpassword"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findPassword</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">FindPswDto</span> findPswDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义FindPswDto类，用于接收找回密码的参数信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FindPswDto</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span>
    <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    <span class="token class-name">String</span> checkcodekey<span class="token punctuation">;</span>
    <span class="token class-name">String</span> checkcode<span class="token punctuation">;</span>
    <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token class-name">String</span> confirmpwd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SendCodeService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">VerifyService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token function">findPassword</span><span class="token punctuation">(</span><span class="token class-name">FindPswDto</span> findPswDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendCodeServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SendCodeService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> CODE_TTL <span class="token operator">=</span> <span class="token number">120L</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 向用户发送验证码</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">MailUtil</span><span class="token punctuation">.</span><span class="token function">sendTestMail</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MessagingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"邮件发送失败：&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"发送验证码失败，请稍后再试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 2. 将验证码缓存到redis，TTL设置为2分钟</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> code<span class="token punctuation">,</span> CODE_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VerifyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">VerifyService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findPassword</span><span class="token punctuation">(</span><span class="token class-name">FindPswDto</span> findPswDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> email <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> checkcode <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getCheckcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> verify <span class="token operator">=</span> picCheckCodeServiceImpl<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> checkcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verify<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> confirmpwd <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getConfirmpwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>password<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>confirmpwd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"两次输入的密码不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getEmail</span><span class="token punctuation">,</span> findPswDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完善</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">SendCodeService</span> sendCodeService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/phone"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"param1"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">MailUtil</span><span class="token punctuation">.</span><span class="token function">achieveCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sendCodeService<span class="token punctuation">.</span><span class="token function">sendEMail</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"找回密码"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"找回密码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/findpassword"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findPassword</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">FindPswDto</span> findPswDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    verifyService<span class="token punctuation">.</span><span class="token function">findPassword</span><span class="token punctuation">(</span>findPswDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h3><ul>
<li>需求：为学生提供注册入口，通过此入口注册的用户为学生用户</li>
<li>页面访问地址：localhost/register.html</li>
</ul>
<p>接口</p>
<ul>
<li>邮箱验证码：/api/checkcode/phone?param1=邮箱</li>
<li>注册：/api/auth/register</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;cellphone&quot;:&#39;&#39;,
    &quot;username&quot;:&#39;&#39;,
    &quot;email&quot;:&#39;&#39;,
    &quot;nickname&quot;:&#39;&#39;,
    &quot;password&quot;:&#39;&#39;,
    &quot;confirmpwd&quot;:&#39;&#39;,
    &quot;checkcodekey&quot;:&#39;&#39;,
    &quot;checkcode&quot;:&#39;&#39;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>执行流程<ol>
<li>校验验证码，不一致，抛异常</li>
<li>校验两次密码是否一致，不一致，抛异常</li>
<li>校验用户是否存在，已存在，抛异常</li>
<li>向用户表、用户关系角色表添加数据，角色为学生</li>
</ol>
</li>
</ul>
<h3 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"注册"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"注册"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RegisterDto</span> registerDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>准备一个Dto类，接收注册请求的参数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterDto</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcode<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcodekey<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> confirmpwd<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><pre class="line-numbers language-none"><code class="language-none">void register(RegisterDto registerDto);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">RegisterDto</span> registerDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> email <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> checkcode <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getCheckcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> verify <span class="token operator">=</span> picCheckCodeServiceImpl<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> checkcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verify<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> confirmpwd <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getConfirmpwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>password<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>confirmpwd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"两次输入的密码不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">></span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getEmail</span><span class="token punctuation">,</span> registerDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcUser</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户已存在，一个邮箱只能注册一个账号"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>registerDto<span class="token punctuation">,</span> xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUtype</span><span class="token punctuation">(</span><span class="token string">"101001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 学生类型</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>registerDto<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> insert <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"新增用户信息失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">XcUserRole</span> xcUserRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token string">"17"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> insert1 <span class="token operator">=</span> xcUserRoleMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUserRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>insert1 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"新增用户角色信息失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完善</p>
<pre class="line-numbers language-none"><code class="language-none">@ApiOperation(value &#x3D; &quot;注册&quot;, tags &#x3D; &quot;注册&quot;)
@PostMapping(&quot;&#x2F;register&quot;)
public void register(@RequestBody RegisterDto registerDto) &#123;
    verifyService.register(registerDto);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启服务，进行测试，观察数据库中是否有对应的注册用户信息</p>
<p>卧槽，终于整理完毕了，感觉还有很多地方不太明白，改天做一个 关于Spring Security 和 jwt 相关的总结</p>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/06/17/spring-security%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" title="spring security框架学习（待写）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230617100825.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">spring security框架学习（待写）</div></div></a></div><div class="next-post pull-right"><a href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发3-课程发布模块开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">类MOOC系统开发3-课程发布模块开发</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">taotaozi</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/differencer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/differencer?type=blog" target="_blank" title="Github"><i class="fab fa-CSDN"></i></a><a class="social-icon" href="https://space.bilibili.com/20713910" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a><a class="social-icon" href="/473439851" target="_blank" title="steam"><i class="fab fa-steam"></i></a><a class="social-icon" href="https://weibo.com/u/5856795355" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="mailto:1359114644@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">最近的新任务是 ： 努力啊</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-text">认证授权的概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">业务流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81"><span class="toc-text">统一认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95"><span class="toc-text">单点登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E8%AE%A4%E8%AF%81"><span class="toc-text">第三方认证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Security%E8%AE%A4%E8%AF%81"><span class="toc-text">Spring Security认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security%E4%BB%8B%E7%BB%8D"><span class="toc-text">Spring Security介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E5%85%A5%E9%97%A8"><span class="toc-text">认证授权入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%A9%BA%E7%9A%84SpringBoot%E5%B7%A5%E7%A8%8B"><span class="toc-text">创建一个空的SpringBoot工程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">引入依赖</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSecurity%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">SpringSecurity工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityFilterChain-%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">SecurityFilterChain 的过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Security%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">Spring Security的执行流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Outh2%E5%8D%8F%E8%AE%AE"><span class="toc-text">Outh2协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth2%E5%9C%A8%E6%9C%AC%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">OAuth2在本项目的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth2%E7%9A%84%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-text">OAuth2的授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-text">授权码模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%B5%8B%E8%AF%95"><span class="toc-text">授权码模式测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-text">密码模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%B5%8B%E8%AF%95"><span class="toc-text">密码模式测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%BA%94%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">本项目的应用方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-text">JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E4%BB%A4%E7%89%8C%E6%A8%A1%E5%BC%8F%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-text">普通令牌模式的缺陷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFJWT"><span class="toc-text">什么是JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%9C%89%E7%8A%B6%E6%80%81%E8%AE%A4%E8%AF%81"><span class="toc-text">传统有状态认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JWT%E6%97%A0%E7%8A%B6%E6%80%81%E8%AE%A4%E8%AF%81"><span class="toc-text">JWT无状态认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%94%9F%E6%88%90JWT%E4%BB%A4%E7%89%8C"><span class="toc-text">测试生成JWT令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%A0%A1%E9%AA%8C%E4%BB%A4%E7%89%8C"><span class="toc-text">测试资源服务校验令牌</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8Ejwt%E4%BB%A4%E7%89%8C%E8%8E%B7%E5%8F%96%E4%BF%A1%E6%81%AF"><span class="toc-text">从jwt令牌获取信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%AE%A4%E8%AF%81"><span class="toc-text">网关认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-text">流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">网关的作用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%AE%A4%E8%AF%81%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">网关认证的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96"><span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-amp-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">配置&amp;过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-text">白名单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%EF%BC%88%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%EF%BC%89"><span class="toc-text">用户认证（密码登录）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">连接用户中心数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UserDetailService%E5%AE%9E%E7%8E%B0"><span class="toc-text">UserDetailService实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%96%B9%E5%BC%8F"><span class="toc-text">密码加密方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">扩展用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%E5%A4%9A%E6%A0%B7%E5%8C%96"><span class="toc-text">认证方式多样化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81%E5%85%A5%E5%8F%A3"><span class="toc-text">统一认证入口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%8E%A5%E6%94%B6%E5%8F%82%E6%95%B0"><span class="toc-text">统一接收参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%8F%E8%94%BD%E5%AF%86%E7%A0%81%E6%AF%94%E5%AF%B9"><span class="toc-text">屏蔽密码比对</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%BB%9F%E4%B8%80%E8%AE%A4%E8%AF%81%E6%8E%A5%E5%8F%A3"><span class="toc-text">定义统一认证接口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-text">用户名密码登录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-text">微信扫码登录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9loadUserByUsername"><span class="toc-text">修改loadUserByUsername()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"><span class="toc-text">实现用户名密码登录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E6%9C%8D%E5%8A%A1"><span class="toc-text">验证码服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-1"><span class="toc-text">流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E8%AE%A4%E8%AF%81"><span class="toc-text">账号密码认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">验证码微服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%A0%A1%E9%AA%8C%E6%9C%8D%E5%8A%A1"><span class="toc-text">远程调用校验服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%EF%BC%88%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%EF%BC%89"><span class="toc-text">微信登录（第三方登录）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E8%83%8C%E6%99%AF"><span class="toc-text">技术背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-text">准备开发环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7"><span class="toc-text">准备内网穿透工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%8E%88%E6%9D%83%E7%A0%81-%E5%BE%AE%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95"><span class="toc-text">接收授权码&#x2F;微信验证登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E5%AE%9E%E7%8E%B0"><span class="toc-text">逻辑实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8restTemplate"><span class="toc-text">使用restTemplate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E6%96%B9%E6%B3%95"><span class="toc-text">提取方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BB%A4%E7%89%8C"><span class="toc-text">获取令牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">获取用户信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">保存用户信息</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%8E%88%E6%9D%83"><span class="toc-text">用户授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RBAC"><span class="toc-text">RBAC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B"><span class="toc-text">资源服务授权流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnginx%E4%BB%A3%E7%90%86"><span class="toc-text">配置nginx代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-text">权限管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%A1%E9%AA%8C%E6%9D%83%E9%99%90%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-text">校验权限的流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%EF%BC%88%E7%94%A8%E6%88%B7-%E8%A7%92%E8%89%B2-%E6%9D%83%E9%99%90%EF%BC%89"><span class="toc-text">授权相关的数据模型（用户&#x2F;角色&#x2F;权限）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E6%9F%A5%E8%AF%A2"><span class="toc-text">用户权限查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%9D%83%E9%99%90%E2%80%9C%E6%B3%A8%E5%85%A5%E2%80%9DUserDetail"><span class="toc-text">将权限“注入”UserDetail</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%88%E6%9D%83"><span class="toc-text">细粒度授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%99%E5%AD%A6%E6%9C%BA%E6%9E%84%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8E%88%E6%9D%83"><span class="toc-text">教学机构细粒度授权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BE%E5%9B%9E%E5%AF%86%E7%A0%81-%E5%AE%9E%E6%88%98"><span class="toc-text">找回密码(实战)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="toc-text">导入依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%82%AE%E7%AE%B1"><span class="toc-text">邮箱</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis%E4%BE%9D%E8%B5%96"><span class="toc-text">redis依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%82%AE%E7%AE%B1%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">编写邮箱工具类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service"><span class="toc-text">service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C"><span class="toc-text">注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-text">Service</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/22/%E9%98%BF%E9%87%8C%E4%BA%91ECS%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/" title="阿里云ECS配置项目环境"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230622100635.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="阿里云ECS配置项目环境"/></a><div class="content"><a class="title" href="/2023/06/22/%E9%98%BF%E9%87%8C%E4%BA%91ECS%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8/" title="阿里云ECS配置项目环境">阿里云ECS配置项目环境</a><time datetime="2023-06-22T02:05:14.000Z" title="发表于 2023-06-22 10:05:14">2023-06-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/17/spring-security%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" title="spring security框架学习（待写）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230617100825.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="spring security框架学习（待写）"/></a><div class="content"><a class="title" href="/2023/06/17/spring-security%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/" title="spring security框架学习（待写）">spring security框架学习（待写）</a><time datetime="2023-06-17T02:06:51.000Z" title="发表于 2023-06-17 10:06:51">2023-06-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/15/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%914-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发4-认证授权模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230615083641.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发4-认证授权模块开发"/></a><div class="content"><a class="title" href="/2023/06/15/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%914-%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发4-认证授权模块开发">类MOOC系统开发4-认证授权模块开发</a><time datetime="2023-06-15T00:35:37.000Z" title="发表于 2023-06-15 08:35:37">2023-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发3-课程发布模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发3-课程发布模块开发"/></a><div class="content"><a class="title" href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发3-课程发布模块开发">类MOOC系统开发3-课程发布模块开发</a><time datetime="2023-06-12T05:35:38.000Z" title="发表于 2023-06-12 13:35:38">2023-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发2-媒资管理模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发2-媒资管理模块开发"/></a><div class="content"><a class="title" href="/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发2-媒资管理模块开发">类MOOC系统开发2-媒资管理模块开发</a><time datetime="2023-06-01T07:27:10.000Z" title="发表于 2023-06-01 15:27:10">2023-06-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230615083641.png')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By taotaozi</div><div class="footer_custom_text">世上最幸运的事就是喜欢上一个人</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'differencer/giscus',
    'data-repo-id': 'R_kgDOJMrL1A',
    'data-category-id': 'DIC_kwDOJMrL1M4CVC1y',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>