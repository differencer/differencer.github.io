<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>类MOOC系统开发2-媒资管理模块开发 | tのblog</title><meta name="author" content="taotaozi"><meta name="copyright" content="taotaozi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="媒资管理大体功能介绍媒资查询：教学机构查询自己所拥有的媒资信息。文件上传：包括上传图片、上传文档、上传视频。视频处理：视频上传成功，系统自动对视频进行编码处理。审核： 自动审核（自动校验鉴黄接口）  为什么要媒资管理统一进行文件管理 将文件（图片、视频、文档）本身放进分布式文件系统当中。 叫文件信息存入数据库当中 如：冗余文件上传校验 （避免重复上传） 搭建网关微服务（gateway）为什么要网关">
<meta property="og:type" content="article">
<meta property="og:title" content="类MOOC系统开发2-媒资管理模块开发">
<meta property="og:url" content="https://differencer.github.io/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="tのblog">
<meta property="og:description" content="媒资管理大体功能介绍媒资查询：教学机构查询自己所拥有的媒资信息。文件上传：包括上传图片、上传文档、上传视频。视频处理：视频上传成功，系统自动对视频进行编码处理。审核： 自动审核（自动校验鉴黄接口）  为什么要媒资管理统一进行文件管理 将文件（图片、视频、文档）本身放进分布式文件系统当中。 叫文件信息存入数据库当中 如：冗余文件上传校验 （避免重复上传） 搭建网关微服务（gateway）为什么要网关">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png">
<meta property="article:published_time" content="2023-06-01T07:27:10.000Z">
<meta property="article:modified_time" content="2023-06-02T14:38:47.814Z">
<meta property="article:author" content="taotaozi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://differencer.github.io/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '类MOOC系统开发2-媒资管理模块开发',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-02 22:38:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">63</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">58</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png')"><nav id="nav"><span id="blog-info"><a href="/" title="tのblog"><span class="site-name">tのblog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">类MOOC系统开发2-媒资管理模块开发</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-01T07:27:10.000Z" title="发表于 2023-06-01 15:27:10">2023-06-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-02T14:38:47.814Z" title="更新于 2023-06-02 22:38:47">2023-06-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>37分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="类MOOC系统开发2-媒资管理模块开发"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="媒资管理大体功能介绍"><a href="#媒资管理大体功能介绍" class="headerlink" title="媒资管理大体功能介绍"></a>媒资管理大体功能介绍</h1><p>媒资查询：教学机构查询自己所拥有的媒资信息。<br>文件上传：包括上传图片、上传文档、上传视频。<br>视频处理：视频上传成功，系统自动对视频进行编码处理。<br>审核： 自动审核（自动校验鉴黄接口）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601153001821.png" alt="image-20230601153001821"></p>
<h2 id="为什么要媒资管理"><a href="#为什么要媒资管理" class="headerlink" title="为什么要媒资管理"></a>为什么要媒资管理</h2><p>统一进行文件管理</p>
<p>将文件（图片、视频、文档）本身放进分布式文件系统当中。</p>
<p>叫文件信息存入数据库当中</p>
<p>如：冗余文件上传校验 （避免重复上传）</p>
<h1 id="搭建网关微服务（gateway）"><a href="#搭建网关微服务（gateway）" class="headerlink" title="搭建网关微服务（gateway）"></a>搭建网关微服务（gateway）</h1><p>为什么要网关？</p>
<p>1、降低前端与后端对接成本，网关作为前后端连接的中间层，不需要前端写死调用的微服务资源地址（到时候上线微服务地址可能会变还要改，麻烦）</p>
<p>2、具体作用</p>
<p><strong>路由转发</strong>（针对不同微服务功能）、<strong>负载均衡</strong>（针对于同一微服务的不同实例）</p>
<p>还能实现<strong>认证授权 限流</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601155607375.png" alt="image-20230601155607375" style="zoom:50%;" /></p>
<p>项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用<strong>Nacos作用服务注册/发现中心和配置中心</strong>，整体的架构图如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601160623042.png" alt="image-20230601160623042" style="zoom:50%;" /></p>
<p>网关的工作流程</p>
<p>1、微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址。</p>
<p>2、网关从Nacos读取服务列表，包括服务名称、服务地址等。</p>
<p>3、请求到达网关，网关将请求路由到具体的微服务。</p>
<p>所以为了能让网关顺利获取各个微服务实例地址，需要先搭建一个Nacos 注册/发现  配置 中心 。</p>
<p>要使用网关首先搭建Nacos，Nacos有两个作用：</p>
<p>1、服务发现中心。</p>
<p>微服务将自身注册至Nacos，网关从Nacos获取微服务列表。</p>
<p>2、配置中心。</p>
<p>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置。</p>
<h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><p>Spring Cloud ：一套规范</p>
<p>Spring Cloud alibaba:  根据这套提出了多种实现案例</p>
<ul>
<li>nacos 服务注册中心，配置中心</li>
<li>远程调用（RPC） feign</li>
<li>Sentinel 一种限流、熔断中间件</li>
</ul>
<p>根据上节讲解的网关的架构图，要使用网关首先搭建Nacos。</p>
<p>首先搭建Nacos服务发现中心。</p>
<h2 id="搭建Nacos"><a href="#搭建Nacos" class="headerlink" title="搭建Nacos"></a>搭建Nacos</h2><ul>
<li><p>在此之前我们先下载安装并启动</p>
<ul>
<li><p>拉取镜像</p>
<pre class="line-numbers language-none"><code class="language-none">docker pull nacos&#x2F;nacos-server:1.4.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建并运行一个容器</p>
<pre class="line-numbers language-none"><code class="language-none">docker run --name nacos -e MODE&#x3D;standalone -p 8849:8848 -d nacos&#x2F;nacos-server:1.4.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>访问<code>虚拟机ip:8848/nacos</code>登录，默认的账号密码均为nacos</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601173712991.png" alt="image-20230601173712991" style="zoom:33%;" /></p>
<p>啊折腾了一下午，终于搞出来了，不知道为啥之前总是报错或者启动不起来。。。。。</p>
<p>索性试了好好几个版本的镜像</p>
</li>
</ul>
<h3 id="上报（注册）服务"><a href="#上报（注册）服务" class="headerlink" title="上报（注册）服务"></a>上报（注册）服务</h3><ul>
<li><p>搭建Nacos服务发现中心之前，需要搞清楚两个概念</p>
<ol>
<li>namespace：用于区分环境，例如：开发环境dev、测试环境test、生产环境prod</li>
<li>group：用于区分项目，例如xuecheng-plus、reggie项目</li>
</ol>
</li>
</ul>
<p>  点击左侧菜单“命名空间”进入命名空间管理界面，新建命名空间</p>
<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601180618865.png" alt="image-20230601180618865" style="zoom:50%;" /></p>
<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601180801884.png" alt="image-20230601180801884" style="zoom: 33%;" /></p>
<p>如何把服务上报到 nacos呢？</p>
<p>首先要把要上报的服务导入nacos依赖</p>
<ul>
<li>在parent 工程添加依赖管理（第一节已经添加）</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud-alibaba.version</span><span class="token punctuation">></span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud-alibaba.version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring-cloud-alibaba.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>如果要上报服务信息（让nacos发现该服务实例）  需要在要启动实例的 工程（system ， content， gateway还没建） 添加nacos依赖</li>
<li>第二点，content 有三个服务 分别是 api service model 该上报哪一个呢？ 答案是上报api 因为 是api 工程启动的整个服务，http服务，所以在content api pom文件中添加依赖</li>
<li>如果有一天 service 也需要往上报服务，那么到时候将 service 也添加整个依赖即可。</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在系统管理的接口工程的配置文件中配置如下信息：配置nacos地址</p>
<h4 id="上报四要素"><a href="#上报四要素" class="headerlink" title="上报四要素"></a>上报四要素</h4><p>总体来说用四项（服务名、上报地址、命名空间、项目组）就可以把自己的服务上报上去</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">#微服务配置
spring:
  application:
    name: system-api
  cloud:
    nacos:
      server-addr: 192.168.101.65:8848
      discovery:
        namespace: dev
        group: xuecheng-plus-project<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理上报system服务</p>
<p>PS: 我们学习的 spring cloud 里面的feign 其底层是基于HTTP/TCP协议的，而 dubbo 技术底层基于RPC/TCP，所以远程调用微服务接口调用的比较频繁，建议用dubbo，如果 servcie 提供了dubbo服务，那么service也要上报（添加依赖，配置nacos）</p>
<p>重启服务。</p>
<p>报错，发现是</p>
<p> <a href=""><spring-cloud-alibaba.version>2.2.6.RELEASE&lt;/spring-cloud-alibaba.version&gt;</a>这个版本依赖报找不到，换了一个 2.1.0 的不知道对后面后没有影响反正这回编译通过了</p>
<p>发现又报错，无法上报服务。。。。。</p>
<p>我认为还是版本问题，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601191333521.png" alt="image-20230601191333521" style="zoom:50%;" /></p>
<p>依赖版本导致无法读取nacos配置</p>
<p>查证：</p>
<p>所有的依赖都是从镜像网站<a target="_blank" rel="noopener" href="http://maven.aliyun.com/nexus/content/groups/public">http://maven.aliyun.com/nexus/content/groups/public</a> 下载的，我就往这个网站看了看</p>
<p>搜了以下这个仓库，果然没有 2.2.6 这个版本。。。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601192921149.png" alt="image-20230601192921149" style="zoom: 33%;" /></p>
<p>emmmm，真够傻逼的</p>
<p>就改成了2.2.1这个版本</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601193134420.png" alt="image-20230601193134420" style="zoom: 67%;" /></p>
<p>可以解析了，应该没问题了，打开nacos</p>
<p>服务也顺利上报了。。。</p>
<p>好累</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601193220778.png" alt="image-20230601193220778"></p>
<h3 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h3><p>nacos的另一个功能就是配置微服务，以后 微服务里面的 配置信息就可以不用写或者写的很少了。</p>
<p>更重要的是，这些配置信息可以根据环境（开发，生产，测试）切换，也可以设置通用配置，这就很nice了</p>
<p>PS：记得在被配置的项目pom文件上添加 config 依赖（作用 从 nacos 定时拉取配置到本地）</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;&#x2F;artifactId&gt;
&lt;&#x2F;dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置分类</p>
<ul>
<li><p>微服务特有的配置</p>
<p>服务名spring.application.name 、端口 、servlet路径（访问路径）</p>
</li>
<li><p>微服务通用的配置</p>
<p>例如redis的配置，很多项目用的同一套redis服务，所以配置也一样</p>
</li>
<li><p>微服务扩展配置</p>
<p>如 api 可以 引用 servcie 数据库相关配置</p>
</li>
</ul>
<h4 id="（被）配置三要素"><a href="#（被）配置三要素" class="headerlink" title="（被）配置三要素"></a>（被）配置三要素</h4><p>Nacos 如何去定位一个具体的配置？</p>
<p>nacos制定了这样一套规则，强制性的！！！</p>
<p>分三个要素</p>
<ul>
<li>namespace ： 环境</li>
<li>group：项目</li>
<li><p>data id:   (在nocas中具体的)  配置文件名，配置文件名具体也分三个要素 如 例如<code>content-service-dev.yml</code></p>
<ul>
<li>应用名：<code>content-service</code>，特指在<code>application.yml</code>中配置的应用名</li>
<li>环境名：<code>dev</code> 由<code>spring.profile.active</code>指定 ，（一般和 namespace对应）</li>
<li>文件类型：<code>file-extension: .yaml</code> <code>.yml</code> 注意 yml 与 yaml等价，但是一定要本地一定要和 nocas真正的文件后缀对应，否则会报错。。。</li>
</ul>
</li>
<li><p>所以，如果我们要配置content-service工程的配置文件</p>
<ul>
<li>在开发环境中配置content-service-dev.yml</li>
<li>在生产环境中配置content-service-prod.yml</li>
<li>在测试环境中配置content-service-test.yml</li>
</ul>
</li>
</ul>
<p>下面对 content-api 进行配置上传</p>
<p>原本本地的配置放在 content-api resources 目录下的bootstrap里面，具体配置是这样的。</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">server:
  servlet:
    context-path: &#x2F;content
  port: 63040
#微服务配置
spring:
  application:
    name: content-api
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql:&#x2F;&#x2F;192.168.101.65:3306&#x2F;xc_content?serverTimezone&#x3D;UTC&amp;userUnicode&#x3D;true&amp;useSSL&#x3D;false
    username: root
    password: root
#微服务配置
  cloud:
    nacos:
      server-addr: 192.168.101.65:8848
      discovery:
        namespace: dev
        group: xuecheng-plus-project
  profiles:
    active: dev

# 日志文件配置路径
logging:
  config: classpath:log4j2-dev.xml


# swagger 文档配置
swagger:
  title: &quot;学成在线内容管理&quot;
  description: &quot;系统管理接口&quot;
  base-package: com.xuecheng.system
  enabled: true
  version: 1.0.0
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，我们之后将用nacos配置中心的配置代替原来这个配置，这个文件里面只会放一些基础的配置。</p>
<p>现在我们打开nacos 配置列表，新建配置</p>
<p>按照上面的约定，我们的配置文件的名称应该叫<code>content-api-dev.yml</code>(也即 data id)</p>
<h4 id="本地配置"><a href="#本地配置" class="headerlink" title="本地配置"></a>本地配置</h4><p>此外，想一想，配置文件那些配置可以交到nacos管理呢，又有哪些不能交由 nacos管理必须留在本地呢？</p>
<p>其实很明晰的：</p>
<p>除了上报服务所需要的那四个关键点(服务名、上报地址、命名空间（开发环境）、项目组)其他的都可以上报</p>
<p>除此之外，上面这四项只是为了上报服务，然后然后<strong>被发现</strong>， 如果想要 <strong>被配置</strong> 还需要 本地配置一些额外的信息</p>
<p>总的来说，本地最少最少应该有这些东西</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">#微服务配置
spring:
  application:
    name: content-api
#微服务配置
  cloud:
    nacos:
      server-addr: 192.168.101.65:8848
      discovery:
        namespace: dev
        group: xuecheng-plus-project
      #服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）
      #也即配置三要素
      config:
      	namespace: dev
      	group: xuecheng-plus-project
      	# 必须写 yml 要与nacos 后缀一致，否则报错。。。 可能和依赖版本有关。。。
      	file-extension: yml
      	refresh-enabled: true   	
  # 环境名，也是nacos dataid中拼接的那个东东
  profiles:
    active: dev
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="nacos配置"><a href="#nacos配置" class="headerlink" title="nacos配置"></a>nacos配置</h4><p>其他所有的内容都可以放到nacos配置（文件名应该为 content-api-dev.yml ）上面了，来看看都有什么：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">server:
  servlet:
    context-path: &#x2F;content
  port: 63040
#微服务配置
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql:&#x2F;&#x2F;192.168.101.65:3306&#x2F;xc_content?serverTimezone&#x3D;UTC&amp;userUnicode&#x3D;true&amp;useSSL&#x3D;false
    username: root
    password: root

# 日志文件配置路径
logging:
  config: classpath:log4j2-dev.xml

# swagger 文档配置
swagger:
  title: &quot;学成在线内容管理&quot;
  description: &quot;系统管理接口&quot;
  base-package: com.xuecheng.system
  enabled: true
  version: 1.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动服务，正常启动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601203615658.png" alt="image-20230601203615658"></p>
<p>可以发现微服务定时向 nacos 发送心跳信息。</p>
<h3 id="配置改进"><a href="#配置改进" class="headerlink" title="配置改进"></a>配置改进</h3><p>在api工程中其实不需要 数据库连接配置，应为 与数据库直接交互的应该是 持久层 service 与持久层交互，所以，只应该在 service配置一下，如果api用到了数据库，只用“引用”service层的配置即可。</p>
<p>所以分两步</p>
<p>1、把service层的配置（数据库等）放到nacos中</p>
<p>2、接口层 api 引用service 层的数据库配置。</p>
<h4 id="配置service"><a href="#配置service" class="headerlink" title="配置service"></a>配置service</h4><p>注意导入依赖</p>
<p>问： service 需要上报服务吗？ 不需要，所以其实可以只导入config即可，但是上报可无伤大雅(其实不会被上报上去，因为没有启动类)</p>
<p>service层只需要配置一个数据源即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601211932372.png" alt="image-20230601211932372" style="zoom:50%;" /></p>
<p>service本地配置（就直接在test 目录的 配置。）</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">
spring:
  application:
    name: content-service
  #微服务配置
  cloud:
    nacos:
      server-addr: 192.168.101.65:8848
      discovery:
        namespace: dev
        group: xuecheng-plus-project
      #服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）
      #也即配置三要素
      config:
        namespace: dev
        group: xuecheng-plus-project
        file-extension: yml
        refresh-enabled: true
  # 环境名，也是nacos dataid中拼接的那个东东
  profiles:
    active: dev
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试原来的文件那些 test 函数，发现可以正常启动，所以，读取到了nacos的配置。</p>
<h4 id="api-扩展配置"><a href="#api-扩展配置" class="headerlink" title="api 扩展配置"></a>api 扩展配置</h4><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">#微服务配置
spring:
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> application:
</span><span class="token prefix unchanged"> </span><span class="token line">   name: content-api
</span><span class="token prefix unchanged"> </span><span class="token line"> #微服务配置
</span><span class="token prefix unchanged"> </span><span class="token line"> cloud:
</span><span class="token prefix unchanged"> </span><span class="token line">   nacos:
</span><span class="token prefix unchanged"> </span><span class="token line">     server-addr: 192.168.101.65:8848
</span><span class="token prefix unchanged"> </span><span class="token line">     discovery:
</span><span class="token prefix unchanged"> </span><span class="token line">       namespace: dev
</span><span class="token prefix unchanged"> </span><span class="token line">       group: xuecheng-plus-project
</span><span class="token prefix unchanged"> </span><span class="token line">     #服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）
</span><span class="token prefix unchanged"> </span><span class="token line">     #也即配置三要素
</span><span class="token prefix unchanged"> </span><span class="token line">     config:
</span><span class="token prefix unchanged"> </span><span class="token line">       namespace: dev
</span><span class="token prefix unchanged"> </span><span class="token line">       group: xuecheng-plus-project
</span><span class="token prefix unchanged"> </span><span class="token line">       # 必须写 yml 要与nacos 后缀一致，否则报错。。。 可能和依赖版本有关。。。
</span><span class="token prefix unchanged"> </span><span class="token line">       file-extension: yml
</span><span class="token prefix unchanged"> </span><span class="token line">       refresh-enabled: true
</span><span class="token prefix unchanged"> </span><span class="token line">       extension-configs:
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">         - data-id: content-service-$&#123;spring.profiles.active&#125;.yaml
</span><span class="token prefix inserted">+</span><span class="token line">           group: xuecheng-plus-project
</span><span class="token prefix inserted">+</span><span class="token line">           refresh: true
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> # 环境名，也是nacos dataid中拼接的那个东东
</span><span class="token prefix unchanged"> </span><span class="token line"> profiles:
</span><span class="token prefix unchanged"> </span><span class="token line">   active: dev</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后就可以把 原来 nacos content-api-dev.yml 里面的数据库配置部分删去了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601214024426.png" alt="image-20230601214024426"></p>
<p>重启服务</p>
<p>功能正常！！！</p>
<h4 id="公用配置"><a href="#公用配置" class="headerlink" title="公用配置"></a>公用配置</h4><p>所有的微服务都需要日志，所有的结构都需要swagger文档，这个也可以提取出来</p>
<p>单独在xuecheng-plus-common分组下创建公用配置，进入nacos的开发环境，添加swagger-dev.yaml公用配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601220059751.png" alt="image-20230601220059751"></p>
<p>同理 添加logging-dev.yaml 用用配置</p>
<p>然后把 nacos 里面 api对应的配置注释掉</p>
<p>那么最终 本地api 配置可以写成</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">#微服务配置
spring:
  application:
    name: content-api
  #微服务配置
  cloud:
    nacos:
      server-addr: 192.168.101.65:8848
      discovery:
        namespace: dev
        group: xuecheng-plus-project
      #服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）
      #也即配置三要素
      config:
        namespace: dev
        group: xuecheng-plus-project
        # 必须写 yml 要与nacos 后缀一致，否则报错。。。 可能和依赖版本有关。。。
        file-extension: yml
        refresh-enabled: true
        # 扩展配置，其实就是读取了数据库
        extension-configs:
          - data-id: content-service-$&#123;spring.profiles.active&#125;.yaml
            group: xuecheng-plus-project
            refresh: true
        # 通用配置 所有的微服务都需要日志，所有的结构都需要swagger文档，这个也可以提取出来
        shared-configs:
          - data-id: swagger-$&#123;spring.profiles.active&#125;.yaml
            group: xuecheng-plus-common
            refresh: true
          - data-id: logging-$&#123;spring.profiles.active&#125;.yaml
            group: xuecheng-plus-common
            refresh: true
  # 环境名，也是nacos dataid中拼接的那个东东
  profiles:
    active: dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样看起来有点变复杂了，但其实通用性更强，以后不需要再这里该配置，在nacos 改改就行了。</p>
<h3 id="配置优先级问题"><a href="#配置优先级问题" class="headerlink" title="配置优先级问题"></a><strong>配置优先级问题</strong></h3><h4 id="读取顺序"><a href="#读取顺序" class="headerlink" title="读取顺序"></a>读取顺序</h4><p>SpringBoot读取配置文件 的顺序如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601220644272.png" alt="image-20230601220644272"  /></p>
<p>首先读取bootstrap.yml，获取nacos 弟子，读取 nacos 配置</p>
<p>将所有本地配置 与 nacos 配置文件合并（这里合并的优先级？称为配置优先级）</p>
<h4 id="配置优先级顺序"><a href="#配置优先级顺序" class="headerlink" title="配置优先级顺序"></a>配置优先级顺序</h4><p>项目应用名配置文件(content-api-dev.yaml) &gt; 扩展配置文件(content-service-dev.html) &gt; 共享配置文件(swagger-dev.yaml) &gt; 本地配置文件(bootstrap.yml&gt;application.yml)</p>
<p>总结 外部配置（前三个都在nacos）大于内部配置</p>
<h4 id="举例：启动一个服务多个实例"><a href="#举例：启动一个服务多个实例" class="headerlink" title="举例：启动一个服务多个实例"></a>举例：启动一个服务多个实例</h4><p>如果远程已经配置了端口</p>
<p>在本地如果你想在开启一个实例 ，仅仅在本地 yml 文件上增加端口信息（想覆盖远端的端口信息）是不能尘垢构建实例的，报端口占用错误。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601221627095.png" alt="image-20230601221627095" style="zoom:50%;" /></p>
<p>点击复制</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601221705543.png" alt="image-20230601221705543" style="zoom: 33%;" /></p>
<h5 id="解决方案：nocas-设置本地优先"><a href="#解决方案：nocas-设置本地优先" class="headerlink" title="解决方案：nocas 设置本地优先"></a>解决方案：nocas 设置本地优先</h5><p>步骤1、</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601222524463.png" alt="image-20230601222524463"></p>
<p>步骤2  在nacos 配置本地优先</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">#配置本地优先
spring:
 cloud:
  config:
    override-none: true
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601223101591.png" alt="image-20230601223101591" style="zoom:50%;" /></p>
<p>用途：</p>
<p>还可以 在 VM 参数中输入</p>
<p><code>-Dserver.port=63041 spring.profiles.active=dev</code> </p>
<p>这样就可以随时切换环境了。</p>
<h2 id="搭建网关"><a href="#搭建网关" class="headerlink" title="搭建网关"></a>搭建网关</h2><p>本项目使用Spring Cloud Gateway作为网关，下边创建网关工程。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601224609337.png" alt="image-20230601224609337"></p>
<h3 id="导入网关依赖"><a href="#导入网关依赖" class="headerlink" title="导入网关依赖"></a>导入网关依赖</h3><p>指定父工程添加依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--指定父工程为xuecheng-plus-parent--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.xuecheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">></span></span>../xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>relativePath</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>xuecheng-plus-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>xuecheng-plus-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>xuecheng-plus-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!--网关--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!--服务发现中心--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!-- Spring Boot 集成 log4j2 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-log4j2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本地配置</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">YAML
#微服务配置
spring:
  application:
    name: gateway
  cloud:
    nacos:
      server-addr: 192.168.101.65:8848
      discovery:
        namespace: dev
        group: xuecheng-plus-project
      config:
        namespace: dev
        group: xuecheng-plus-project
        file-extension: yaml
        refresh-enabled: true
        shared-configs:
          - data-id: logging-$&#123;spring.profiles.active&#125;.yaml
            group: xuecheng-plus-common
            refresh: true


  profiles:
    active: dev
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="远端配置-路由策略"><a href="#远端配置-路由策略" class="headerlink" title="远端配置(路由策略)"></a>远端配置(路由策略)</h3><p>网关具有路由转发的功能，其路由策略可直接在routes属性里面配置</p>
<p>springboot</p>
<p>PS：</p>
<p>在gateway中配置uri配置有三种方式，包括<br>第一种：ws(websocket)方式: uri: ws://localhost:9000<br>第二种：http方式: uri: <a target="_blank" rel="noopener" href="http://localhost:8130/">http://localhost:8130/</a><br>第三种：lb(注册中心中服务名字)方式: uri: lb://brilliance-consumer</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">server:
  port: 63010 # 网关端口
spring:
  cloud:
    gateway:
#      filter:
#        strip-prefix:
#          enabled: true
      routes: # 网关路由配置
        - id: content-api # 路由id，自定义，只要唯一即可
          # uri: http:&#x2F;&#x2F;127.0.0.1:8081 # 路由的目标地址 http就是固定地址
          uri: lb:&#x2F;&#x2F;content-api # 路由的目标地址 lb就是负载均衡，后面跟服务名称
          predicates: # 路由断言，也就是判断请求是否符合路由规则的条件
            - Path&#x3D;&#x2F;content&#x2F;** # 这个是按照路径匹配，只要以&#x2F;content&#x2F;开头就符合要求
#          filters:
#            - StripPrefix&#x3D;1
        - id: system-api
          # uri: http:&#x2F;&#x2F;127.0.0.1:8081
          uri: lb:&#x2F;&#x2F;system-api
          predicates:
            - Path&#x3D;&#x2F;system&#x2F;**
#          filters:
#            - StripPrefix&#x3D;1
        - id: media-api
          # uri: http:&#x2F;&#x2F;127.0.0.1:8081
          uri: lb:&#x2F;&#x2F;media-api
          predicates:
            - Path&#x3D;&#x2F;media&#x2F;**
#          filters:
#            - StripPrefix&#x3D;1
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>http client 设置 gateway 地址</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">&#123;
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> "dev": &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">   "host": "localhost:53010",
</span><span class="token prefix unchanged"> </span><span class="token line">   "content_host": "localhost:53040",
</span><span class="token prefix unchanged"> </span><span class="token line">   "system_host": "localhost:53110",
</span><span class="token prefix unchanged"> </span><span class="token line">   "media_host": "localhost:53050",
</span><span class="token prefix unchanged"> </span><span class="token line">   "cache_host": "localhost:53035",
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   "gateway_host": "localhost:53010"
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &#125;
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动gateway服务</p>
<p>查询测试是否正常</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/admin/AppData/Roaming/Typora/typora-user-images/image-20230602110330942.png" alt="image-20230602110330942" style="zoom:50%;" /></p>
<p>以后可以<strong>外部调用微服务</strong>可以走统一的端口啦！</p>
<p>那么网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602110641027.png" alt="image-20230602110641027" style="zoom:67%;" /></p>
<h3 id="搭建媒资工程"><a href="#搭建媒资工程" class="headerlink" title="搭建媒资工程"></a>搭建媒资工程</h3><p>至此网关、Nacos已经搭建完成，下边将媒资工程导入项目</p>
<p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p>
<p>右键pom.xml转为maven工程。</p>
<p>下边做如下配置：</p>
<p>1、创建媒资数据库xc_media，并导入资料目录中的xcplus_media.sql</p>
<p>2、修改nacos上的media-service-dev.yaml配置文件中的数据库链接信息</p>
<p>重启media-api工程只要能正常启动成功即可，稍后根据需求写接口。</p>
<h1 id="分布式文件系统"><a href="#分布式文件系统" class="headerlink" title="分布式文件系统"></a><strong>分布式文件系统</strong></h1><h2 id="什么是分布式文件系统"><a href="#什么是分布式文件系统" class="headerlink" title="什么是分布式文件系统"></a><strong>什么是分布式文件系统</strong></h2><p>简单来说就是大量计算机组成的一个容量超大的文件存储管理系统，外界看起来是一个整体。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602112640514.png" alt="image-20230602112640514" style="zoom: 50%;" /></p>
<p>优势：</p>
<p>1、性能 （多个计算机同时处理）</p>
<p>2、安全（多数具有备份能力）</p>
<p>3、访问快捷 （放在不同地域，就近访问提高速度）</p>
<p>市面上有哪些分布式文件系统的产品呢？</p>
<p>1、NFS</p>
<blockquote>
<p>NFS是基于UDP/IP协议的应用，其实现主要是采用远程过程调用RPC机制，RPC提供了一组与机器、操作系统以及低层传送协议无关的存取远程文件的操作。RPC采用了XDR的支持。XDR是一种与机器无关的数据描述编码的协议，他以独立与任意机器体系结构的格式对网上传送的数据进行编码和解码，支持在异构系统之间数据的传送。</p>
<p>特点</p>
<ul>
<li>在客户端上映射NFS服务器的驱动器</li>
<li>客户端通过万国访问NFS服务器的硬盘完全透明</li>
</ul>
</blockquote>
<p>2、GFS</p>
<blockquote>
<p>google</p>
<p>GFS是一个可扩展的分布式文件系统，用于大型的、分布式的、对大量数据进行访问的应用。它运行于廉价的普通硬件上，并提供容错功能。它可以给大量的用户提供总体性能较高的服务。<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/02/14/pSTw5xx.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSTw5xx.png" alt="img"></a></p>
<ul>
<li>GFS采用主从结构，一个GFS集群由一个master和大量的chunkserver组成</li>
<li>master存储了数据文件的元数据，一个文件被分成了若干块存储在多个chunkserver中</li>
<li>用户从master中获取数据元信息，向chunkserver存储数据</li>
</ul>
</blockquote>
<p>3、HDFS</p>
<blockquote>
<p>Hadoop 框架下的分布式文件系统</p>
<p>1）HDFS采用主从结构，一个HDFS集群由一个名称结点（nameNode）和若干数据结点(DataNode)组成。</p>
<p>2) 名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</p>
<p>3）客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</p>
</blockquote>
<p>4、云对象</p>
<p>云计算厂家</p>
<blockquote>
<ul>
<li>阿里云对象存储服务（Object Storage Service，简称 OSS）(本博客使用的就是<ul>
<li>官方网站：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss">https://www.aliyun.com/product/oss</a></li>
</ul>
</li>
<li>百度对象存储BOS提供稳定、安全、高效、高可扩展的云存储服务。<ul>
<li>官方网站：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/product/bos.html">https://cloud.baidu.com/product/bos.html</a></li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h2><ul>
<li>本项目采用MinIO构建分布式文件系统，MinIO是一个非常轻量的服务，可以很简单的和其他应用结合使用。它兼容亚马逊S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等</li>
<li>它的一大特点就是轻量，使用简单、功能强大，支持各种平台，单个文件最大5TB，兼容提供了Java、Python、GO等多版本SDK支持</li>
<li>官网：<a target="_blank" rel="noopener" href="https://min.io/，">https://min.io/，</a></li>
<li>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/，">https://www.minio.org.cn/，</a> <a target="_blank" rel="noopener" href="http://docs.minio.org.cn/docs/">http://docs.minio.org.cn/docs/</a></li>
</ul>
<p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式MinIO避免了单点故障</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pS7VqFH.png" alt="img"></p>
<ul>
<li>MinIO使用<strong>纠删码技术</strong>来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块，冗余地分散存储在各个节点的磁盘上，所有可用的磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时，会通过纠删码算法计算对文件进行分块存储，除了将文件<strong>本身分成4个数据块，还会生成4个校验块，数据块和校验开会分散的存储在这8块硬盘上</strong></li>
</ul>
<p>使用纠删码的好处是即便丢失一半数量(N/2)的硬盘，仍可以恢复数据。例如上面集合中有4个以内的硬盘损害，仍可保证数据恢复，不影响上传和下载；但如果多余一半的硬盘损坏，则无法恢复</p>
<h3 id="安装-MinIO"><a href="#安装-MinIO" class="headerlink" title="安装 MinIO"></a>安装 MinIO</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><ul>
<li>MinIO下载地址：<a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/">https://dl.min.io/server/minio/release/</a></li>
</ul>
<p>安装完毕后，CMD进入minio.exe所在目录，执行下面的命令，会在D盘创建4个目录，模拟4个硬盘</p>
<p>注意改成自己的目录</p>
<p><code>minio.exe server E:\software\MinIO\minio_data\data1 E:\software\MinIO\minio_data\data2 E:\software\MinIO\minio_data\data3 E:\software\MinIO\minio_data\data4</code></p>
<ul>
<li>默认账号密码均为<code>minioadmin</code>，访问<code>localhost:9000</code>进行登录</li>
</ul>
<p>进入后</p>
<p>之后创建两个buckets（文件目录）</p>
<ul>
<li><code>mediafiles</code>：普通文件</li>
<li><code>video</code>：视频文件</li>
</ul>
<p>将访问权限给位public</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602115201850.png" alt="image-20230602115201850"></p>
<h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><pre class="line-numbers language-none"><code class="language-none">docker pull minio&#x2F;minio

&#x2F;&#x2F;一个用来存放配置，一个用来存储上传文件的目录
&#x2F;&#x2F;启动前需要先创建Minio外部挂载的配置文件（ &#x2F;home&#x2F;minio&#x2F;config）,和存储上传文件的目录（ &#x2F;home&#x2F;minio&#x2F;data）
mkdir -p &#x2F;home&#x2F;minio&#x2F;config
mkdir -p &#x2F;home&#x2F;minio&#x2F;data


&#x2F;&#x2F;创建容器并运行
docker run -p 9000:9000 -p 9090:9090 \
     --net&#x3D;host \
     --name minio \
     -d --restart&#x3D;always \
     -e &quot;MINIO_ACCESS_KEY&#x3D;minioadmin&quot; \
     -e &quot;MINIO_SECRET_KEY&#x3D;minioadmin&quot; \
     -v &#x2F;home&#x2F;minio&#x2F;data:&#x2F;data \
     -v &#x2F;home&#x2F;minio&#x2F;config:&#x2F;root&#x2F;.minio \
     minio&#x2F;minio server \
     &#x2F;data --console-address &quot;:9090&quot; -address &quot;:9000&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="MinIO-java-SDK配置"><a href="#MinIO-java-SDK配置" class="headerlink" title="MinIO java SDK配置"></a>MinIO java SDK配置</h4><p>MinIO提供多个语言版本SDK的支持，下边找到java版本的文档：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p>
<p>最低需求Java 1.8或更高版本:</p>
<p>在media-service工程中添加依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>8.4.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.squareup.okhttp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>从官方文档中看到，需要三个参数才能连接到minio服务</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameters</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Endpoint</td>
<td style="text-align:center">URL to S3 service.</td>
</tr>
<tr>
<td style="text-align:center">Access Key</td>
<td style="text-align:center">Access key (aka user ID) of an account in the S3 service.</td>
</tr>
<tr>
<td style="text-align:center">Secret Key</td>
<td style="text-align:center">Secret key (aka password) of an account in the S3 service.</td>
</tr>
</tbody>
</table>
</div>
<h5 id="分析官方给出的代码如下"><a href="#分析官方给出的代码如下" class="headerlink" title="分析官方给出的代码如下"></a>分析官方给出的代码如下</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploader</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        
      <span class="token comment">// 1、创建客户端</span>
      <span class="token comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span>
      <span class="token comment">// 创建MinIO客户端，连接参数就是上述表格中的三个参数，127.0.0.1:9000、minioadmin、minioadmin</span>
      <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
          <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">"https://play.min.io"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">"Q3AM3UQ867SPQQA43P2F"</span><span class="token punctuation">,</span> <span class="token string">"zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
        
        
        <span class="token comment">// 创建桶</span>
      <span class="token comment">// Make 'asiatrip' bucket if not exist.</span>
      <span class="token comment">// 由于backet我们已经手动创建了，所以这段代码可以删掉</span>
      <span class="token keyword">boolean</span> found <span class="token operator">=</span>
          minioClient<span class="token punctuation">.</span><span class="token function">bucketExists</span><span class="token punctuation">(</span><span class="token class-name">BucketExistsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"asiatrip"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Make a new bucket called 'asiatrip'.</span>
        minioClient<span class="token punctuation">.</span><span class="token function">makeBucket</span><span class="token punctuation">(</span><span class="token class-name">MakeBucketArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"asiatrip"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Bucket 'asiatrip' already exists."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
        
        
        <span class="token comment">// 上传文件到桶</span>

      <span class="token comment">// Upload '/home/user/Photos/asiaphotos.zip' as object name 'asiaphotos-2015.zip' to bucket</span>
      <span class="token comment">// 'asiatrip'.</span>
      <span class="token comment">// 将 '/home/user/Photos/asiaphotos.zip' 文件命名为 'asiaphotos-2015.zip'</span>
      <span class="token comment">// 并上传到 'asiatrip' 里（示例代码创建的bucket）</span>
      minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
          <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"asiatrip"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"asiaphotos-2015.zip"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">"/home/user/Photos/asiaphotos.zip"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这段输出也没有用，可以直接删掉</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
          <span class="token string">"'/home/user/Photos/asiaphotos.zip' is successfully uploaded as "</span>
              <span class="token operator">+</span> <span class="token string">"object 'asiaphotos-2015.zip' to bucket 'asiatrip'."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MinioException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error occurred: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HTTP trace: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">httpTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="上传测试"><a href="#上传测试" class="headerlink" title="上传测试"></a>上传测试</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">UploadObjectArgs</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinIOTest</span> <span class="token punctuation">&#123;</span>



    <span class="token comment">// 创建MinioClient对象</span>
    <span class="token keyword">static</span> <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
            <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">"http://192.168.101.65:9000"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">"minioadmin"</span><span class="token punctuation">,</span> <span class="token string">"minioadmin"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 上传测试方法
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
                    <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span>    <span class="token comment">// 同一个桶内对象名不能重复</span>
                            <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\111.png"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上传成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上传失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602132658369.png" alt="image-20230602132658369"></p>
<h5 id="删除测试"><a href="#删除测试" class="headerlink" title="删除测试"></a>删除测试</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        minioClient<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>
               <span class="token class-name">RemoveObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="查询测试"><a href="#查询测试" class="headerlink" title="查询测试"></a>查询测试</h5><p>通过查询文件查看文件是否存在minio中。</p>
<h5 id="下载校验"><a href="#下载校验" class="headerlink" title="下载校验"></a>下载校验</h5><p>校验文件的完整性，对文件计算出md5值，比较原始文件的md5和目标文件的md5，一致则说明完整</p>
<pre class="line-numbers language-none"><code class="language-none">@Test
public void getFileTest() &#123;
    try &#123;
        InputStream inputStream &#x3D; minioClient.getObject(GetObjectArgs.builder()
                .bucket(&quot;testbucket&quot;)
                .object(&quot;test&#x2F;111.png&quot;)
                .build());
        FileOutputStream fileOutputStream &#x3D; new FileOutputStream(&quot;E:\\test\\picture\\tmp1.png&quot;);
        byte[] buffer &#x3D; new byte[1024];
        int len;
        while ((len &#x3D; inputStream.read(buffer)) !&#x3D; -1) &#123;
            fileOutputStream.write(buffer,0,len);
        &#125;
        inputStream.close();
        fileOutputStream.close();
        System.out.println(&quot;下载成功&quot;);
    &#125; catch (Exception e) &#123;
        System.out.println(&quot;下载失败&quot;);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用IOUtils简化代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
 <span class="token annotation punctuation">@Test</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFileTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
         <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\temp1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//校验文件的完整性对文件的内容进行md5</span>
         <span class="token class-name">String</span> source_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">String</span> local_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>source_md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>local_md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
             <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"下载成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


     <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"下载失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="文件扩展名获取"><a href="#文件扩展名获取" class="headerlink" title="文件扩展名获取"></a>文件扩展名获取</h4><p>设置contentType可以通过com.j256.simplemagic.ContentType枚举类查看常用的mimeType（媒体类型）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//根据扩展名取出mimeType</span>
<span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span><span class="token string">".mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_OCTET_STREAM_VALUE<span class="token punctuation">;</span><span class="token comment">//通用mimeType，字节流</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="MD5校验"><a href="#MD5校验" class="headerlink" title="MD5校验"></a>MD5校验</h3><p>String local_md5 = DigestUtils.md5Hex(“输入流”);</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFileTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\temp1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//校验文件的完整性对文件的内容进行md5</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\temp1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> minIO_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> down_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>minIO_md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>down_md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"minio与下载文件校验一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"minio与下载文件校验不一致？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//为什么？</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">FileInputStream</span> originInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\111.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> origin_local_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>originInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>origin_local_md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>down_md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"本地与下载文件校验一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"本地与下载文件校验不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        


    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"下载失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出如下</p>
<pre class="line-numbers language-none"><code class="language-none">minio与下载文件校验不一致？
本地与下载文件校验一致<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>为什么？</p>
<p>远程流不稳定，所以完整性校验只能 下载完整后校验。。。。。。</p>
<h2 id="功能1-：-上传文件"><a href="#功能1-：-上传文件" class="headerlink" title="功能1 ： 上传文件"></a>功能1 ： 上传文件</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>我们在新增课程的时候 需要有一个上传图片的功能</p>
<p>这个步骤其实用了两个微服务两个步骤</p>
<ul>
<li>1、图片上传： 将图片上传到 MinIO 并将图片信息（包括地址信息）存到媒资管理数据库中 </li>
<li>2、更新课程信息表： <strong>课程信息中保存课程图片路径</strong></li>
</ul>
<p>注意不能直接将图片地址复制到课程信息表（不好修改）</p>
<p>为了验证是否重复上传，一般使用 md5值作为文件信息的 主键。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602144223774.png" alt="image-20230602144223774"></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>nacos配置 media-service-dev</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql:&#x2F;&#x2F;192.168.101.65:3306&#x2F;xc_media?serverTimezone&#x3D;UTC&amp;userUnicode&#x3D;true&amp;useSSL&#x3D;false&amp;
    username: root
    password: root
  cloud:
   config:
    override-none: true

minio:
  endpoint: http:&#x2F;&#x2F;192.168.101.65:9000
  accessKey: minioadmin
  secretKey: minioadmin
  bucket:
    files: mediafiles
    videofiles: video
xxl:
  job:
    admin: 
      addresses: http:&#x2F;&#x2F;192.168.101.65:8088&#x2F;xxl-job-admin
    executor:
      appname: media-process-service
      address: 
      ip: 
      port: 9999
      logpath: &#x2F;data&#x2F;applogs&#x2F;xxl-job&#x2F;jobhandler
      logretentiondays: 30
    accessToken: default_token

videoprocess:
 ffmpegpath: E:&#x2F;software&#x2F;FFmpeg&#x2F;ffmpeg.exe
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在media-service工程编写minio的配置类：</p>
<pre class="line-numbers language-none"><code class="language-none">package com.xuecheng.media.config;


 @Configuration
public class MinioConfig &#123;

 @Value(&quot;$&#123;minio.endpoint&#125;&quot;)
 private String endpoint;
 @Value(&quot;$&#123;minio.accessKey&#125;&quot;)
 private String accessKey;
 @Value(&quot;$&#123;minio.secretKey&#125;&quot;)
 private String secretKey;

 @Bean
 public MinioClient minioClient() &#123;

  MinioClient minioClient &#x3D;
          MinioClient.builder()
                  .endpoint(endpoint)
                  .credentials(accessKey, secretKey)
                  .build();
  return minioClient;
 &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h3><pre class="line-numbers language-none"><code class="language-none">根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。
首先分析接口：

请求地址：&#x2F;media&#x2F;upload&#x2F;coursefile
请求头内容：
Content-Type: multipart&#x2F;form-data;boundary&#x3D;….. 
FormData: filedata&#x3D;??, 
folder&#x3D;?, 
objectName&#x3D;?
form-data; name&#x3D;&quot;filedata&quot;; filename&#x3D;&quot;具体的文件名称&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602180026341.png" alt="image-20230602180026341"></p>
<p>接收DTO（上传应该就是把图片上传到系统并返回信息的过程）</p>
<p>定义上传返回信息模型类，虽然响应结果与MediaFiles表中的字段完全一致，但最好不要直接用MediaFiles类。因为该类属于PO类，如果后期我们要对响应结果进行修改，那么模型类也需要进行修改，但是MediaFiles是PO类，我们不能动。所以可以直接用一个类继承MediaFiles，里面什么属性都不用加</p>
<pre class="line-numbers language-none"><code class="language-none">@Data
public class UploadFileResultDto extends MediaFiles &#123;
  
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上传图片</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
filedata 上传的文件
folder 

*/</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"上传文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/upload/coursefile"</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>MULTIPART_FORM_DATA_VALUE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"folder"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先用 httpclinet测试一下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">### 上传文件
POST <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>media_host<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>coursefile
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> multipart<span class="token operator">/</span>form<span class="token operator">-</span>data<span class="token punctuation">;</span> boundary<span class="token operator">=</span><span class="token class-name">WebAppBoundary</span>

<span class="token operator">--</span><span class="token class-name">WebAppBoundary</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Disposition</span><span class="token operator">:</span> form<span class="token operator">-</span>data<span class="token punctuation">;</span> name<span class="token operator">=</span><span class="token string">"filedata"</span><span class="token punctuation">;</span> filename<span class="token operator">=</span><span class="token string">"1.jpg"</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>octet<span class="token operator">-</span>stream

<span class="token operator">&lt;</span> e<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">/</span>picture<span class="token operator">/</span><span class="token number">222.</span>png
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h3><p>定义请求通用参数类（适用于更多的文件类型）：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadFileParamsDto</span> <span class="token punctuation">&#123;</span>

 <span class="token comment">/**
  * 文件名称
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> filename<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 文件content-type
 */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> contentType<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 文件类型（文档，图片，视频）
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> fileType<span class="token punctuation">;</span>
 <span class="token comment">/**
  * 文件大小
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> fileSize<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 标签
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 上传人
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 备注
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义service方法，MultipartFile是SpringMVC提供简化上传操作的工具类，不使用框架之前，都是使用原生的HttpServletRequest来接收上传的数据,文件是以二进制流传递到后端的。为了使接口更通用，我们可以用字节数组代替MultpartFile类型</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 上传文件
 * @param companyId 机构id
 * @param uploadFileParamsDto 上传文件信息
 * @param localFilePath 文件磁盘路径
 * @return 文件信息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实现方法如下，主要分为两部分<ol>
<li>将文件上传到minio</li>
<li>将文件信息写入media_file表中</li>
</ol>
</li>
</ul>
<p>service实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MinioClient</span> minioClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

<span class="token comment">//普通文件桶</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;minio.bucket.files&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> bucket_Files<span class="token punctuation">;</span>


<span class="token comment">/**
 * @description 将文件写入minIO
 * @param localFilePath  文件地址
 * @param bucket  桶
 * @param objectName 对象名称
 * @return void
 * @author Mr.M
 * @date 2022/10/12 21:22
 */</span>


<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"文件不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//文件名称</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件扩展名</span>
    <span class="token class-name">String</span> extension <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件mimeType</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token function">getMimeType</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件的md5值</span>
    <span class="token class-name">String</span> fileMd5 <span class="token operator">=</span> <span class="token function">getFileMd5</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件的默认目录</span>
    <span class="token class-name">String</span> defaultFolderPath <span class="token operator">=</span> <span class="token function">getDefaultFolderPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存储到minio中的对象名(带目录)</span>
    <span class="token class-name">String</span>  objectName <span class="token operator">=</span> defaultFolderPath <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> exension<span class="token punctuation">;</span>
    <span class="token comment">//将文件上传到minio</span>
    <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> bucket_files<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件大小</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将文件信息存储到数据库</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> bucket_files<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//准备返回数据</span>
    <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileResultDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">,</span> uploadFileResultDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span><span class="token class-name">String</span> localFilePath<span class="token punctuation">,</span><span class="token class-name">String</span> mimeType<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UploadObjectArgs</span> testbucket <span class="token operator">=</span> <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>testbucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"上传文件到minio成功,bucket:&#123;&#125;,objectName:&#123;&#125;"</span><span class="token punctuation">,</span>bucket<span class="token punctuation">,</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上传成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"上传文件到minio出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误原因:&#123;&#125;"</span><span class="token punctuation">,</span>bucket<span class="token punctuation">,</span>objectName<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"上传文件到文件系统失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * @description 将文件信息添加到文件表
 * @param companyId  机构id
 * @param fileMd5  文件md5值
 * @param uploadFileParamsDto  上传文件的信息
 * @param bucket  桶
 * @param objectName 对象名称
 * @return com.xuecheng.media.model.po.MediaFiles
 * @author Mr.M
 * @date 2022/10/12 21:22
 */</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//从数据库查询文件</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拷贝基本信息</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFilePath</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">"002003"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存文件信息到文件表</span>
        <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"保存文件信息到数据库失败,&#123;&#125;"</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"保存文件信息失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"保存文件信息到数据库成功,&#123;&#125;"</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>



<span class="token comment">//获取文件默认存储目录路径 年/月/日/</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getDefaultFolderPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> folder <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> folder<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//获取文件的md5</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFileMd5</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> fileMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fileMd5<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token class-name">String</span> extension<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>extension<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        extension <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token comment">//根据扩展名取出mimeType</span>
    <span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通用mimeType，字节流</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_OCTET_STREAM_VALUE<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>extensionMatch<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        mimeType <span class="token operator">=</span> extensionMatch<span class="token punctuation">.</span><span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> mimeType<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="完善接口"><a href="#完善接口" class="headerlink" title="完善接口"></a>完善接口</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"上传文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/upload/coursefile"</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>MULTIPART_FORM_DATA_VALUE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"folder"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
    <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileParamsDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件大小</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//图片</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">"001001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件名称</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFilename</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//文件名称</span>
    <span class="token comment">//文件大小</span>
    <span class="token keyword">long</span> fileSize <span class="token operator">=</span> filedata<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">//创建临时文件(在服务器中，toamcat的一个指定地址上)</span>
    <span class="token class-name">File</span> tempFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"minio"</span><span class="token punctuation">,</span> <span class="token string">"temp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传的文件拷贝到临时文件</span>
    filedata<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>tempFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件路径</span>
    <span class="token class-name">String</span> absolutePath <span class="token operator">=</span> tempFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传文件</span>
    <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h3><p>关于测试中的 </p>
<p>—WebAppBoundary <a target="_blank" rel="noopener" href="https://blog.csdn.net/a1472750149/article/details/121266532">含义</a></p>
<p>以及为什么有两个 Content Type 其实 ，我们宏观上接受的 content type 是第一个</p>
<p>第二个content type 其实是表单自带的 content type</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602203916688.png" alt="image-20230602203916688" style="zoom:50%;" /></p>
<p>前后端联调：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602215438425.png" alt="image-20230602215438425"></p>
<p>终于成功了，之前网关除了 conten总是不生效。。。问题在哪里，也没查出来，最后也没改啥，把所有服务重启了一遍才好。。。。。</p>
<p>我真的崩溃了。。</p>
<h3 id="Service事务优化"><a href="#Service事务优化" class="headerlink" title="Service事务优化"></a>Service事务优化</h3><p>上边的service方法优化后并测试通过，现在思考关于uploadFile方法的是否应该开启事务。</p>
<p>目前是在uploadFile方法上添加@Transactional，当调用uploadFile方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。</p>
<p>我们只将addMediaFilesToDb方法添加事务控制即可,uploadFile方法上的@Transactional注解去掉。</p>
<p>也就是 事物的范围应该更小</p>
<p>但是，发现事务失效了 （addMediaFilesToDb内添加除零异常）为什么在uploadFile 上加 @Transactional注解就能生效而 addMediaFilesToDb不行呢？</p>
<p>方法拥有事务的能力是因为spring aop生成代理了对象，<strong>通过代理对象调用事务方法才能直接生成事务</strong></p>
<p>debug会发现，只有 uploadFile  加注解调用的时 代理对象 的方法， 而 addMediaFilesToDb 加注解 走的不是代理 而是本类（相当于this. 方法 调用）</p>
<p>解决方案：</p>
<p>1、在MediaFileService的实现类中<strong>注入自己</strong> （这时 通过注入的对象调用（注入的对象一定是代理对象）），并把调用的函数内调用的整个事务函数<strong>提到接口</strong></p>
<p>可能有些人可能会有这样的疑问：这种做法会不会出现循环依赖问题？</p>
<p>答案：不会。</p>
<p>其实spring ioc内部的三级缓存保证了它，不会出现循环依赖问题。</p>
<p>2、通过AopContext.currentProxy()获取代理对象再调用</p>
<p>3、重新创建一个新的service类，里面有事务han’shu（不推荐）在原来的类中 注入新类</p>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/05/25/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%911-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发1-内容管理模块开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230525224811.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">类MOOC系统开发1-内容管理模块开发</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">taotaozi</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">63</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">58</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/differencer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/differencer?type=blog" target="_blank" title="Github"><i class="fab fa-CSDN"></i></a><a class="social-icon" href="https://space.bilibili.com/20713910" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a><a class="social-icon" href="/473439851" target="_blank" title="steam"><i class="fab fa-steam"></i></a><a class="social-icon" href="https://weibo.com/u/5856795355" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="mailto:1359114644@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">最近的新任务是 ： 努力啊</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E5%A4%A7%E4%BD%93%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-text">媒资管理大体功能介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86"><span class="toc-text">为什么要媒资管理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%88gateway%EF%BC%89"><span class="toc-text">搭建网关微服务（gateway）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud"><span class="toc-text">Spring Cloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BANacos"><span class="toc-text">搭建Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E6%8A%A5%EF%BC%88%E6%B3%A8%E5%86%8C%EF%BC%89%E6%9C%8D%E5%8A%A1"><span class="toc-text">上报（注册）服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E6%8A%A5%E5%9B%9B%E8%A6%81%E7%B4%A0"><span class="toc-text">上报四要素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">配置服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E8%A2%AB%EF%BC%89%E9%85%8D%E7%BD%AE%E4%B8%89%E8%A6%81%E7%B4%A0"><span class="toc-text">（被）配置三要素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">本地配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nacos%E9%85%8D%E7%BD%AE"><span class="toc-text">nacos配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%94%B9%E8%BF%9B"><span class="toc-text">配置改进</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEservice"><span class="toc-text">配置service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#api-%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE"><span class="toc-text">api 扩展配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">公用配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7%E9%97%AE%E9%A2%98"><span class="toc-text">配置优先级问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%A1%BA%E5%BA%8F"><span class="toc-text">读取顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7%E9%A1%BA%E5%BA%8F"><span class="toc-text">配置优先级顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B%EF%BC%9A%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%A4%9A%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="toc-text">举例：启动一个服务多个实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9Anocas-%E8%AE%BE%E7%BD%AE%E6%9C%AC%E5%9C%B0%E4%BC%98%E5%85%88"><span class="toc-text">解决方案：nocas 设置本地优先</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3"><span class="toc-text">搭建网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%BD%91%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-text">导入网关依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%AB%AF%E9%85%8D%E7%BD%AE-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5"><span class="toc-text">远端配置(路由策略)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%AA%92%E8%B5%84%E5%B7%A5%E7%A8%8B"><span class="toc-text">搭建媒资工程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">分布式文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">什么是分布式文件系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MinIO"><span class="toc-text">MinIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-MinIO"><span class="toc-text">安装 MinIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#windows"><span class="toc-text">windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux"><span class="toc-text">linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MinIO-java-SDK%E9%85%8D%E7%BD%AE"><span class="toc-text">MinIO java SDK配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%AE%98%E6%96%B9%E7%BB%99%E5%87%BA%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B"><span class="toc-text">分析官方给出的代码如下</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%B5%8B%E8%AF%95"><span class="toc-text">上传测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%B5%8B%E8%AF%95"><span class="toc-text">删除测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%B5%8B%E8%AF%95"><span class="toc-text">查询测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%A0%A1%E9%AA%8C"><span class="toc-text">下载校验</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D%E8%8E%B7%E5%8F%96"><span class="toc-text">文件扩展名获取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MD5%E6%A0%A1%E9%AA%8C"><span class="toc-text">MD5校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD1-%EF%BC%9A-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-text">功能1 ： 上传文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">完善接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%8E%A5%E5%8F%A3"><span class="toc-text">测试接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service%E4%BA%8B%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-text">Service事务优化</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发2-媒资管理模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发2-媒资管理模块开发"/></a><div class="content"><a class="title" href="/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发2-媒资管理模块开发">类MOOC系统开发2-媒资管理模块开发</a><time datetime="2023-06-01T07:27:10.000Z" title="发表于 2023-06-01 15:27:10">2023-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/25/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%911-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发1-内容管理模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230525224811.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发1-内容管理模块开发"/></a><div class="content"><a class="title" href="/2023/05/25/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%911-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发1-内容管理模块开发">类MOOC系统开发1-内容管理模块开发</a><time datetime="2023-05-25T14:46:56.000Z" title="发表于 2023-05-25 22:46:56">2023-05-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/22/%E7%AE%97%E6%B3%95_%E5%8D%95%E8%B0%83%E6%A0%88%E9%97%AE%E9%A2%98/" title="算法:单调栈问题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230522212237.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法:单调栈问题"/></a><div class="content"><a class="title" href="/2023/05/22/%E7%AE%97%E6%B3%95_%E5%8D%95%E8%B0%83%E6%A0%88%E9%97%AE%E9%A2%98/" title="算法:单调栈问题">算法:单调栈问题</a><time datetime="2023-05-22T13:20:06.000Z" title="发表于 2023-05-22 21:20:06">2023-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/22/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%910-%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="类MOOC系统开发0-项目基础环境搭建"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230522110116.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发0-项目基础环境搭建"/></a><div class="content"><a class="title" href="/2023/05/22/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%910-%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="类MOOC系统开发0-项目基础环境搭建">类MOOC系统开发0-项目基础环境搭建</a><time datetime="2023-05-22T02:59:45.000Z" title="发表于 2023-05-22 10:59:45">2023-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/17/%E7%AE%97%E6%B3%95%EF%BC%9A%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/" title="算法：回溯问题 （未完待续~~）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230517165923.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法：回溯问题 （未完待续~~）"/></a><div class="content"><a class="title" href="/2023/05/17/%E7%AE%97%E6%B3%95%EF%BC%9A%E5%9B%9E%E6%BA%AF%E9%97%AE%E9%A2%98/" title="算法：回溯问题 （未完待续~~）">算法：回溯问题 （未完待续~~）</a><time datetime="2023-05-17T08:57:46.000Z" title="发表于 2023-05-17 16:57:46">2023-05-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By taotaozi</div><div class="footer_custom_text">世上最幸运的事就是喜欢上一个人</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'differencer/giscus',
    'data-repo-id': 'R_kgDOJMrL1A',
    'data-category-id': 'DIC_kwDOJMrL1M4CVC1y',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>