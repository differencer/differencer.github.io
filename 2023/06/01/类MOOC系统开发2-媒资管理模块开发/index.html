<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>类MOOC系统开发2-媒资管理模块开发 | tのblog</title><meta name="author" content="taotaozi"><meta name="copyright" content="taotaozi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="媒资管理大体功能介绍媒资查询：教学机构查询自己所拥有的媒资信息。文件上传：包括上传图片、上传文档、上传视频。视频处理：视频上传成功，系统自动对视频进行编码处理。审核： 自动审核（自动校验鉴黄接口）  为什么要媒资管理统一进行文件管理 将文件（图片、视频、文档）本身放进分布式文件系统当中。 叫文件信息存入数据库当中 其中的文件上传下载等功能接口需要给其他模块调用。 如：冗余文件上传校验 （避免重复上">
<meta property="og:type" content="article">
<meta property="og:title" content="类MOOC系统开发2-媒资管理模块开发">
<meta property="og:url" content="https://differencer.github.io/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="tのblog">
<meta property="og:description" content="媒资管理大体功能介绍媒资查询：教学机构查询自己所拥有的媒资信息。文件上传：包括上传图片、上传文档、上传视频。视频处理：视频上传成功，系统自动对视频进行编码处理。审核： 自动审核（自动校验鉴黄接口）  为什么要媒资管理统一进行文件管理 将文件（图片、视频、文档）本身放进分布式文件系统当中。 叫文件信息存入数据库当中 其中的文件上传下载等功能接口需要给其他模块调用。 如：冗余文件上传校验 （避免重复上">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png">
<meta property="article:published_time" content="2023-06-01T07:27:10.000Z">
<meta property="article:modified_time" content="2023-06-12T03:59:18.207Z">
<meta property="article:author" content="taotaozi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://differencer.github.io/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '类MOOC系统开发2-媒资管理模块开发',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-12 11:59:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png')"><nav id="nav"><span id="blog-info"><a href="/" title="tのblog"><span class="site-name">tのblog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">类MOOC系统开发2-媒资管理模块开发</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-01T07:27:10.000Z" title="发表于 2023-06-01 15:27:10">2023-06-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-06-12T03:59:18.207Z" title="更新于 2023-06-12 11:59:18">2023-06-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">20k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>78分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="类MOOC系统开发2-媒资管理模块开发"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="媒资管理大体功能介绍"><a href="#媒资管理大体功能介绍" class="headerlink" title="媒资管理大体功能介绍"></a>媒资管理大体功能介绍</h1><p>媒资查询：教学机构查询自己所拥有的媒资信息。<br>文件上传：包括上传图片、上传文档、上传视频。<br>视频处理：视频上传成功，系统自动对视频进行编码处理。<br>审核： 自动审核（自动校验鉴黄接口）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601153001821.png" alt="image-20230601153001821"></p>
<h2 id="为什么要媒资管理"><a href="#为什么要媒资管理" class="headerlink" title="为什么要媒资管理"></a>为什么要媒资管理</h2><p>统一进行文件管理</p>
<p>将文件（图片、视频、文档）本身放进分布式文件系统当中。</p>
<p>叫文件信息存入数据库当中</p>
<p><strong>其中的文件上传下载等功能接口需要给其他模块调用</strong>。</p>
<p>如：冗余文件上传校验 （避免重复上传）</p>
<h1 id="搭建网关微服务（gateway）"><a href="#搭建网关微服务（gateway）" class="headerlink" title="搭建网关微服务（gateway）"></a>搭建网关微服务（gateway）</h1><p>为什么要网关？</p>
<p>1、降低前端与后端对接成本，网关作为前后端连接的中间层，不需要前端写死调用的微服务资源地址（到时候上线微服务地址可能会变还要改，麻烦）</p>
<p>2、具体作用</p>
<p><strong>路由转发</strong>（针对不同微服务功能）、<strong>负载均衡</strong>（针对于同一微服务的不同实例）</p>
<p>还能实现<strong>认证授权 限流</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601155607375.png" alt="image-20230601155607375" style="zoom:50%;" /></p>
<p>项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用<strong>Nacos作用服务注册/发现中心和配置中心</strong>，整体的架构图如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601160623042.png" alt="image-20230601160623042" style="zoom:50%;" /></p>
<p>网关的工作流程</p>
<p>1、微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址。</p>
<p>2、网关从Nacos读取服务列表，包括服务名称、服务地址等。</p>
<p>3、请求到达网关，网关将请求路由到具体的微服务。</p>
<p>所以为了能让网关顺利获取各个微服务实例地址，需要先搭建一个Nacos 注册/发现  配置 中心 。</p>
<p>要使用网关首先搭建Nacos，Nacos有两个作用：</p>
<p>1、服务发现中心。</p>
<p>微服务将自身注册至Nacos，网关从Nacos获取微服务列表。</p>
<p>2、配置中心。</p>
<p>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置。</p>
<h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><p>Spring Cloud ：一套规范</p>
<p>Spring Cloud alibaba:  根据这套提出了多种实现案例</p>
<ul>
<li>nacos 服务注册中心，配置中心</li>
<li>远程调用（RPC） feign</li>
<li>Sentinel 一种限流、熔断中间件</li>
</ul>
<p>根据上节讲解的网关的架构图，要使用网关首先搭建Nacos。</p>
<p>首先搭建Nacos服务发现中心。</p>
<h2 id="搭建Nacos"><a href="#搭建Nacos" class="headerlink" title="搭建Nacos"></a>搭建Nacos</h2><ul>
<li><p>在此之前我们先下载安装并启动</p>
<ul>
<li><p>拉取镜像</p>
<pre class="line-numbers language-none"><code class="language-none">docker pull nacos&#x2F;nacos-server:1.4.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>创建并运行一个容器</p>
<pre class="line-numbers language-none"><code class="language-none">docker run --name nacos -e MODE&#x3D;standalone -p 8849:8848 -d nacos&#x2F;nacos-server:1.4.1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>访问<code>虚拟机ip:8848/nacos</code>登录，默认的账号密码均为nacos</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601173712991.png" alt="image-20230601173712991" style="zoom:33%;" /></p>
<p>啊折腾了一下午，终于搞出来了，不知道为啥之前总是报错或者启动不起来。。。。。</p>
<p>索性试了好好几个版本的镜像</p>
</li>
</ul>
<h3 id="上报（注册）服务"><a href="#上报（注册）服务" class="headerlink" title="上报（注册）服务"></a>上报（注册）服务</h3><ul>
<li><p>搭建Nacos服务发现中心之前，需要搞清楚两个概念</p>
<ol>
<li>namespace：用于区分环境，例如：开发环境dev、测试环境test、生产环境prod</li>
<li>group：用于区分项目，例如xuecheng-plus、reggie项目</li>
</ol>
</li>
</ul>
<p>  点击左侧菜单“命名空间”进入命名空间管理界面，新建命名空间</p>
<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601180618865.png" alt="image-20230601180618865" style="zoom:50%;" /></p>
<p>  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601180801884.png" alt="image-20230601180801884" style="zoom: 33%;" /></p>
<p>如何把服务上报到 nacos呢？</p>
<p>首先要把要上报的服务导入nacos依赖</p>
<ul>
<li>在parent 工程添加依赖管理（第一节已经添加）</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud-alibaba.version</span><span class="token punctuation">></span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud-alibaba.version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring-cloud-alibaba.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>如果要上报服务信息（让nacos发现该服务实例）  需要在要启动实例的 工程（system ， content， gateway还没建） 添加nacos依赖</li>
<li>第二点，content 有三个服务 分别是 api service model 该上报哪一个呢？ 答案是上报api 因为 是api 工程启动的整个服务，http服务，所以在content api pom文件中添加依赖</li>
<li>如果有一天 service 也需要往上报服务，那么到时候将 service 也添加整个依赖即可。</li>
</ul>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在系统管理的接口工程的配置文件中配置如下信息：配置nacos地址</p>
<h4 id="上报四要素"><a href="#上报四要素" class="headerlink" title="上报四要素"></a>上报四要素</h4><p>总体来说用四项（服务名、上报地址、命名空间、项目组）就可以把自己的服务上报上去</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同理上报system服务</p>
<p>PS: 我们学习的 spring cloud 里面的feign 其底层是基于HTTP/TCP协议的，而 dubbo 技术底层基于RPC/TCP，所以远程调用微服务接口调用的比较频繁，建议用dubbo，如果 servcie 提供了dubbo服务，那么service也要上报（添加依赖，配置nacos）</p>
<p>重启服务。</p>
<p>报错，发现是</p>
<p> <a href=""><spring-cloud-alibaba.version>2.2.6.RELEASE&lt;/spring-cloud-alibaba.version&gt;</a>这个版本依赖报找不到，换了一个 2.1.0 的不知道对后面后没有影响反正这回编译通过了</p>
<p>发现又报错，无法上报服务。。。。。</p>
<p>我认为还是版本问题，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601191333521.png" alt="image-20230601191333521" style="zoom:50%;" /></p>
<p>依赖版本导致无法读取nacos配置</p>
<p>查证：</p>
<p>所有的依赖都是从镜像网站<a target="_blank" rel="noopener" href="http://maven.aliyun.com/nexus/content/groups/public">http://maven.aliyun.com/nexus/content/groups/public</a> 下载的，我就往这个网站看了看</p>
<p>搜了以下这个仓库，果然没有 2.2.6 这个版本。。。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601192921149.png" alt="image-20230601192921149" style="zoom: 33%;" /></p>
<p>emmmm，真够傻逼的</p>
<p>就改成了2.2.1这个版本</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601193134420.png" alt="image-20230601193134420" style="zoom: 67%;" /></p>
<p>可以解析了，应该没问题了，打开nacos</p>
<p>服务也顺利上报了。。。</p>
<p>好累</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601193220778.png" alt="image-20230601193220778"></p>
<h3 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h3><p>nacos的另一个功能就是配置微服务，以后 微服务里面的 配置信息就可以不用写或者写的很少了。</p>
<p>更重要的是，这些配置信息可以根据环境（开发，生产，测试）切换，也可以设置通用配置，这就很nice了</p>
<p>PS：记得在被配置的项目pom文件上添加 config 依赖（作用 从 nacos 定时拉取配置到本地）</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;&#x2F;groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;&#x2F;artifactId&gt;
&lt;&#x2F;dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置分类</p>
<ul>
<li><p>微服务特有的配置</p>
<p>服务名spring.application.name 、端口 、servlet路径（访问路径）</p>
</li>
<li><p>微服务通用的配置</p>
<p>例如redis的配置，很多项目用的同一套redis服务，所以配置也一样</p>
</li>
<li><p>微服务扩展配置</p>
<p>如 api 可以 引用 servcie 数据库相关配置</p>
</li>
</ul>
<h4 id="（被）配置三要素"><a href="#（被）配置三要素" class="headerlink" title="（被）配置三要素"></a>（被）配置三要素</h4><p>Nacos 如何去定位一个具体的配置？</p>
<p>nacos制定了这样一套规则，强制性的！！！</p>
<p>分三个要素</p>
<ul>
<li>namespace ： 环境</li>
<li>group：项目</li>
<li><p>data id:   (在nocas中具体的)  配置文件名，配置文件名具体也分三个要素 如 例如<code>content-service-dev.yml</code></p>
<ul>
<li>应用名：<code>content-service</code>，特指在<code>application.yml</code>中配置的应用名</li>
<li>环境名：<code>dev</code> 由<code>spring.profile.active</code>指定 ，（一般和 namespace对应）</li>
<li>文件类型：<code>file-extension: .yaml</code> <code>.yml</code> 注意 yml 与 yaml等价，但是一定要本地一定要和 nocas真正的文件后缀对应，否则会报错。。。</li>
</ul>
</li>
<li><p>所以，如果我们要配置content-service工程的配置文件</p>
<ul>
<li>在开发环境中配置content-service-dev.yml</li>
<li>在生产环境中配置content-service-prod.yml</li>
<li>在测试环境中配置content-service-test.yml</li>
</ul>
</li>
</ul>
<p>下面对 content-api 进行配置上传</p>
<p>原本本地的配置放在 content-api resources 目录下的bootstrap里面，具体配置是这样的。</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /content
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63040</span>
<span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>3306/xc_content<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;userUnicode=true&amp;useSSL=false</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
<span class="token comment">#微服务配置</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev

<span class="token comment"># 日志文件配置路径</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>log4j2<span class="token punctuation">-</span>dev.xml


<span class="token comment"># swagger 文档配置</span>
<span class="token key atrule">swagger</span><span class="token punctuation">:</span>
  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">"学成在线内容管理"</span>
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"系统管理接口"</span>
  <span class="token key atrule">base-package</span><span class="token punctuation">:</span> com.xuecheng.system
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，我们之后将用nacos配置中心的配置代替原来这个配置，这个文件里面只会放一些基础的配置。</p>
<p>现在我们打开nacos 配置列表，新建配置</p>
<p>按照上面的约定，我们的配置文件的名称应该叫<code>content-api-dev.yml</code>(也即 data id)</p>
<h4 id="本地配置"><a href="#本地配置" class="headerlink" title="本地配置"></a>本地配置</h4><p>此外，想一想，配置文件那些配置可以交到nacos管理呢，又有哪些不能交由 nacos管理必须留在本地呢？</p>
<p>其实很明晰的：</p>
<p>除了上报服务所需要的那四个关键点(服务名、上报地址、命名空间（开发环境）、项目组)其他的都可以上报</p>
<p>除此之外，上面这四项只是为了上报服务，然后然后<strong>被发现</strong>， 如果想要 <strong>被配置</strong> 还需要 本地配置一些额外的信息</p>
<p>总的来说，本地最少最少应该有这些东西</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
<span class="token comment">#微服务配置</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token comment">#服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）</span>
      <span class="token comment">#也即配置三要素</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
      	<span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
      	<span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      	<span class="token comment"># 必须写 yml 要与nacos 后缀一致，否则报错。。。 可能和依赖版本有关。。。</span>
      	<span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml
      	<span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   	
  <span class="token comment"># 环境名，也是nacos dataid中拼接的那个东东</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="nacos配置"><a href="#nacos配置" class="headerlink" title="nacos配置"></a>nacos配置</h4><p>其他所有的内容都可以放到nacos配置（文件名应该为 content-api-dev.yml ）上面了，来看看都有什么：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /content
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63040</span>
<span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>3306/xc_content<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;userUnicode=true&amp;useSSL=false</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root

<span class="token comment"># 日志文件配置路径</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>log4j2<span class="token punctuation">-</span>dev.xml

<span class="token comment"># swagger 文档配置</span>
<span class="token key atrule">swagger</span><span class="token punctuation">:</span>
  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">"学成在线内容管理"</span>
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"系统管理接口"</span>
  <span class="token key atrule">base-package</span><span class="token punctuation">:</span> com.xuecheng.system
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动服务，正常启动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601203615658.png" alt="image-20230601203615658"></p>
<p>可以发现微服务定时向 nacos 发送心跳信息。</p>
<h3 id="配置改进"><a href="#配置改进" class="headerlink" title="配置改进"></a>配置改进</h3><p>在api工程中其实不需要 数据库连接配置，应为 与数据库直接交互的应该是 持久层 service 与持久层交互，所以，只应该在 service配置一下，如果api用到了数据库，只用“引用”service层的配置即可。</p>
<p>所以分两步</p>
<p>1、把service层的配置（数据库等）放到nacos中</p>
<p>2、接口层 api 引用service 层的数据库配置。</p>
<h4 id="配置service"><a href="#配置service" class="headerlink" title="配置service"></a>配置service</h4><p>注意导入依赖</p>
<p>问： service 需要上报服务吗？ 不需要，所以其实可以只导入config即可，但是上报可无伤大雅(其实不会被上报上去，因为没有启动类)</p>
<p>service层只需要配置一个数据源即可</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601211932372.png" alt="image-20230601211932372" style="zoom:50%;" /></p>
<p>service本地配置（就直接在test 目录的 配置。）</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service
  <span class="token comment">#微服务配置</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token comment">#服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）</span>
      <span class="token comment">#也即配置三要素</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># 环境名，也是nacos dataid中拼接的那个东东</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试原来的文件那些 test 函数，发现可以正常启动，所以，读取到了nacos的配置。</p>
<h4 id="api-扩展配置"><a href="#api-扩展配置" class="headerlink" title="api 扩展配置"></a>api 扩展配置</h4><pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">#微服务配置
spring:
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> application:
</span><span class="token prefix unchanged"> </span><span class="token line">   name: content-api
</span><span class="token prefix unchanged"> </span><span class="token line"> #微服务配置
</span><span class="token prefix unchanged"> </span><span class="token line"> cloud:
</span><span class="token prefix unchanged"> </span><span class="token line">   nacos:
</span><span class="token prefix unchanged"> </span><span class="token line">     server-addr: 192.168.101.65:8848
</span><span class="token prefix unchanged"> </span><span class="token line">     discovery:
</span><span class="token prefix unchanged"> </span><span class="token line">       namespace: dev
</span><span class="token prefix unchanged"> </span><span class="token line">       group: xuecheng-plus-project
</span><span class="token prefix unchanged"> </span><span class="token line">     #服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）
</span><span class="token prefix unchanged"> </span><span class="token line">     #也即配置三要素
</span><span class="token prefix unchanged"> </span><span class="token line">     config:
</span><span class="token prefix unchanged"> </span><span class="token line">       namespace: dev
</span><span class="token prefix unchanged"> </span><span class="token line">       group: xuecheng-plus-project
</span><span class="token prefix unchanged"> </span><span class="token line">       # 必须写 yml 要与nacos 后缀一致，否则报错。。。 可能和依赖版本有关。。。
</span><span class="token prefix unchanged"> </span><span class="token line">       file-extension: yml
</span><span class="token prefix unchanged"> </span><span class="token line">       refresh-enabled: true
</span><span class="token prefix unchanged"> </span><span class="token line">       extension-configs:
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">         - data-id: content-service-$&#123;spring.profiles.active&#125;.yaml
</span><span class="token prefix inserted">+</span><span class="token line">           group: xuecheng-plus-project
</span><span class="token prefix inserted">+</span><span class="token line">           refresh: true
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> # 环境名，也是nacos dataid中拼接的那个东东
</span><span class="token prefix unchanged"> </span><span class="token line"> profiles:
</span><span class="token prefix unchanged"> </span><span class="token line">   active: dev</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后就可以把 原来 nacos content-api-dev.yml 里面的数据库配置部分删去了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601214024426.png" alt="image-20230601214024426"></p>
<p>重启服务</p>
<p>功能正常！！！</p>
<h4 id="公用配置"><a href="#公用配置" class="headerlink" title="公用配置"></a>公用配置</h4><p>所有的微服务都需要日志，所有的结构都需要swagger文档，这个也可以提取出来</p>
<p>单独在xuecheng-plus-common分组下创建公用配置，进入nacos的开发环境，添加swagger-dev.yaml公用配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601220059751.png" alt="image-20230601220059751"></p>
<p>同理 添加logging-dev.yaml 用用配置</p>
<p>然后把 nacos 里面 api对应的配置注释掉</p>
<p>那么最终 本地api 配置可以写成</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
  <span class="token comment">#微服务配置</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token comment">#服务如果想要 “被配置”，本地需要配置如下信息（前面是上报四要素，下面是配置三要素）</span>
      <span class="token comment">#也即配置三要素</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token comment"># 必须写 yml 要与nacos 后缀一致，否则报错。。。 可能和依赖版本有关。。。</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># 扩展配置，其实就是读取了数据库</span>
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>spring.profiles.active<span class="token punctuation">&#125;</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># 通用配置 所有的微服务都需要日志，所有的结构都需要swagger文档，这个也可以提取出来</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> swagger<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>spring.profiles.active<span class="token punctuation">&#125;</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>spring.profiles.active<span class="token punctuation">&#125;</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># 环境名，也是nacos dataid中拼接的那个东东</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样看起来有点变复杂了，但其实通用性更强，以后不需要再这里该配置，在nacos 改改就行了。</p>
<h3 id="配置优先级问题"><a href="#配置优先级问题" class="headerlink" title="配置优先级问题"></a><strong>配置优先级问题</strong></h3><h4 id="读取顺序"><a href="#读取顺序" class="headerlink" title="读取顺序"></a>读取顺序</h4><p>SpringBoot读取配置文件 的顺序如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601220644272.png" alt="image-20230601220644272"  /></p>
<p>首先读取bootstrap.yml，获取nacos 弟子，读取 nacos 配置</p>
<p>将所有本地配置 与 nacos 配置文件合并（这里合并的优先级？称为配置优先级）</p>
<h4 id="配置优先级顺序"><a href="#配置优先级顺序" class="headerlink" title="配置优先级顺序"></a>配置优先级顺序</h4><p>项目应用名配置文件(content-api-dev.yaml) &gt; 扩展配置文件(content-service-dev.html) &gt; 共享配置文件(swagger-dev.yaml) &gt; 本地配置文件(bootstrap.yml&gt;application.yml)</p>
<p>总结 外部配置（前三个都在nacos）大于内部配置</p>
<h4 id="举例：启动一个服务多个实例"><a href="#举例：启动一个服务多个实例" class="headerlink" title="举例：启动一个服务多个实例"></a>举例：启动一个服务多个实例</h4><p>如果远程已经配置了端口</p>
<p>在本地如果你想在开启一个实例 ，仅仅在本地 yml 文件上增加端口信息（想覆盖远端的端口信息）是不能尘垢构建实例的，报端口占用错误。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601221627095.png" alt="image-20230601221627095" style="zoom:50%;" /></p>
<p>点击复制</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601221705543.png" alt="image-20230601221705543" style="zoom: 33%;" /></p>
<h5 id="解决方案：nocas-设置本地优先"><a href="#解决方案：nocas-设置本地优先" class="headerlink" title="解决方案：nocas 设置本地优先"></a>解决方案：nocas 设置本地优先</h5><p>步骤1、</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601222524463.png" alt="image-20230601222524463"></p>
<p>步骤2  在nacos 配置本地优先</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token comment">#配置本地优先</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">override-none</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601223101591.png" alt="image-20230601223101591" style="zoom:50%;" /></p>
<p>用途：</p>
<p>还可以 在 VM 参数中输入</p>
<p><code>-Dserver.port=63041 spring.profiles.active=dev</code> </p>
<p>这样就可以随时切换环境了。</p>
<h2 id="搭建网关"><a href="#搭建网关" class="headerlink" title="搭建网关"></a>搭建网关</h2><p>本项目使用Spring Cloud Gateway作为网关，下边创建网关工程。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230601224609337.png" alt="image-20230601224609337"></p>
<h3 id="导入网关依赖"><a href="#导入网关依赖" class="headerlink" title="导入网关依赖"></a>导入网关依赖</h3><p>指定父工程添加依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!--指定父工程为xuecheng-plus-parent--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.xuecheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">></span></span>../xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>relativePath</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>xuecheng-plus-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>xuecheng-plus-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>xuecheng-plus-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!--网关--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!--服务发现中心--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!-- Spring Boot 集成 log4j2 --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-log4j2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本地配置</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">YAML
<span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>spring.profiles.active<span class="token punctuation">&#125;</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>


  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="远端配置-路由策略"><a href="#远端配置-路由策略" class="headerlink" title="远端配置(路由策略)"></a>远端配置(路由策略)</h3><p>网关具有路由转发的功能，其路由策略可直接在routes属性里面配置</p>
<p>springboot</p>
<p>PS：</p>
<p>在gateway中配置uri配置有三种方式，包括<br>第一种：ws(websocket)方式: uri: ws://localhost:9000<br>第二种：http方式: uri: <a target="_blank" rel="noopener" href="http://localhost:8130/">http://localhost:8130/</a><br>第三种：lb(注册中心中服务名字)方式: uri: lb://brilliance-consumer</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63010</span> <span class="token comment"># 网关端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
<span class="token comment">#      filter:</span>
<span class="token comment">#        strip-prefix:</span>
<span class="token comment">#          enabled: true</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api <span class="token comment"># 路由id，自定义，只要唯一即可</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//content<span class="token punctuation">-</span>api <span class="token comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span>
            <span class="token punctuation">-</span> Path=/content/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span>
<span class="token comment">#          filters:</span>
<span class="token comment">#            - StripPrefix=1</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>api
          <span class="token comment"># uri: http://127.0.0.1:8081</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//system<span class="token punctuation">-</span>api
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
<span class="token comment">#          filters:</span>
<span class="token comment">#            - StripPrefix=1</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>api
          <span class="token comment"># uri: http://127.0.0.1:8081</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//media<span class="token punctuation">-</span>api
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/media/<span class="token important">**</span>
<span class="token comment">#          filters:</span>
<span class="token comment">#            - StripPrefix=1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>http client 设置 gateway 地址</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff">&#123;
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> "dev": &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">   "host": "localhost:53010",
</span><span class="token prefix unchanged"> </span><span class="token line">   "content_host": "localhost:53040",
</span><span class="token prefix unchanged"> </span><span class="token line">   "system_host": "localhost:53110",
</span><span class="token prefix unchanged"> </span><span class="token line">   "media_host": "localhost:53050",
</span><span class="token prefix unchanged"> </span><span class="token line">   "cache_host": "localhost:53035",
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   "gateway_host": "localhost:53010"
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &#125;
</span></span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动gateway服务</p>
<p>查询测试是否正常</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="C:/Users/admin/AppData/Roaming/Typora/typora-user-images/image-20230602110330942.png" alt="image-20230602110330942" style="zoom:50%;" /></p>
<p>以后可以<strong>外部调用微服务</strong>可以走统一的端口啦！</p>
<p>那么网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602110641027.png" alt="image-20230602110641027" style="zoom:67%;" /></p>
<h3 id="搭建媒资工程"><a href="#搭建媒资工程" class="headerlink" title="搭建媒资工程"></a>搭建媒资工程</h3><p>至此网关、Nacos已经搭建完成，下边将媒资工程导入项目</p>
<p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p>
<p>右键pom.xml转为maven工程。</p>
<p>下边做如下配置：</p>
<p>1、创建媒资数据库xc_media，并导入资料目录中的xcplus_media.sql</p>
<p>2、修改nacos上的media-service-dev.yaml配置文件中的数据库链接信息</p>
<p>重启media-api工程只要能正常启动成功即可，稍后根据需求写接口。</p>
<h1 id="分布式文件系统"><a href="#分布式文件系统" class="headerlink" title="分布式文件系统"></a><strong>分布式文件系统</strong></h1><h2 id="什么是分布式文件系统"><a href="#什么是分布式文件系统" class="headerlink" title="什么是分布式文件系统"></a><strong>什么是分布式文件系统</strong></h2><p>简单来说就是大量计算机组成的一个容量超大的文件存储管理系统，外界看起来是一个整体。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602112640514.png" alt="image-20230602112640514" style="zoom: 50%;" /></p>
<p>优势：</p>
<p>1、性能 （多个计算机同时处理）</p>
<p>2、安全（多数具有备份能力）</p>
<p>3、访问快捷 （放在不同地域，就近访问提高速度）</p>
<p>市面上有哪些分布式文件系统的产品呢？</p>
<p>1、NFS</p>
<blockquote>
<p>NFS是基于UDP/IP协议的应用，其实现主要是采用远程过程调用RPC机制，RPC提供了一组与机器、操作系统以及低层传送协议无关的存取远程文件的操作。RPC采用了XDR的支持。XDR是一种与机器无关的数据描述编码的协议，他以独立与任意机器体系结构的格式对网上传送的数据进行编码和解码，支持在异构系统之间数据的传送。</p>
<p>特点</p>
<ul>
<li>在客户端上映射NFS服务器的驱动器</li>
<li>客户端通过万国访问NFS服务器的硬盘完全透明</li>
</ul>
</blockquote>
<p>2、GFS</p>
<blockquote>
<p>google</p>
<p>GFS是一个可扩展的分布式文件系统，用于大型的、分布式的、对大量数据进行访问的应用。它运行于廉价的普通硬件上，并提供容错功能。它可以给大量的用户提供总体性能较高的服务。<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/02/14/pSTw5xx.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSTw5xx.png" alt="img"></a></p>
<ul>
<li>GFS采用主从结构，一个GFS集群由一个master和大量的chunkserver组成</li>
<li>master存储了数据文件的元数据，一个文件被分成了若干块存储在多个chunkserver中</li>
<li>用户从master中获取数据元信息，向chunkserver存储数据</li>
</ul>
</blockquote>
<p>3、HDFS</p>
<blockquote>
<p>Hadoop 框架下的分布式文件系统</p>
<p>1）HDFS采用主从结构，一个HDFS集群由一个名称结点（nameNode）和若干数据结点(DataNode)组成。</p>
<p>2) 名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</p>
<p>3）客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</p>
</blockquote>
<p>4、云对象</p>
<p>云计算厂家</p>
<blockquote>
<ul>
<li>阿里云对象存储服务（Object Storage Service，简称 OSS）(本博客使用的就是<ul>
<li>官方网站：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/oss">https://www.aliyun.com/product/oss</a></li>
</ul>
</li>
<li>百度对象存储BOS提供稳定、安全、高效、高可扩展的云存储服务。<ul>
<li>官方网站：<a target="_blank" rel="noopener" href="https://cloud.baidu.com/product/bos.html">https://cloud.baidu.com/product/bos.html</a></li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h2><ul>
<li>本项目采用MinIO构建分布式文件系统，MinIO是一个非常轻量的服务，可以很简单的和其他应用结合使用。它兼容亚马逊S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等</li>
<li>它的一大特点就是轻量，使用简单、功能强大，支持各种平台，单个文件最大5TB，兼容提供了Java、Python、GO等多版本SDK支持</li>
<li>官网：<a target="_blank" rel="noopener" href="https://min.io/，">https://min.io/，</a></li>
<li>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/，">https://www.minio.org.cn/，</a> <a target="_blank" rel="noopener" href="http://docs.minio.org.cn/docs/">http://docs.minio.org.cn/docs/</a></li>
</ul>
<p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式MinIO避免了单点故障</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pS7VqFH.png" alt="img"></p>
<ul>
<li>MinIO使用<strong>纠删码技术</strong>来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块，冗余地分散存储在各个节点的磁盘上，所有可用的磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时，会通过纠删码算法计算对文件进行分块存储，除了将文件<strong>本身分成4个数据块，还会生成4个校验块，数据块和校验开会分散的存储在这8块硬盘上</strong></li>
</ul>
<p>使用纠删码的好处是即便丢失一半数量(N/2)的硬盘，仍可以恢复数据。例如上面集合中有4个以内的硬盘损害，仍可保证数据恢复，不影响上传和下载；但如果多余一半的硬盘损坏，则无法恢复</p>
<h3 id="安装-MinIO"><a href="#安装-MinIO" class="headerlink" title="安装 MinIO"></a>安装 MinIO</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><ul>
<li>MinIO下载地址：<a target="_blank" rel="noopener" href="https://dl.min.io/server/minio/release/">https://dl.min.io/server/minio/release/</a></li>
</ul>
<p>安装完毕后，CMD进入minio.exe所在目录，执行下面的命令，会在D盘创建4个目录，模拟4个硬盘</p>
<p>注意改成自己的目录</p>
<p><code>minio.exe server E:\software\MinIO\minio_data\data1 E:\software\MinIO\minio_data\data2 E:\software\MinIO\minio_data\data3 E:\software\MinIO\minio_data\data4</code></p>
<ul>
<li>默认账号密码均为<code>minioadmin</code>，访问<code>localhost:9000</code>进行登录</li>
</ul>
<p>进入后</p>
<p>之后创建两个buckets（文件目录）</p>
<ul>
<li><code>mediafiles</code>：普通文件</li>
<li><code>video</code>：视频文件</li>
</ul>
<p>将访问权限给位public</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602115201850.png" alt="image-20230602115201850"></p>
<h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><pre class="line-numbers language-none"><code class="language-none">docker pull minio&#x2F;minio

&#x2F;&#x2F;一个用来存放配置，一个用来存储上传文件的目录
&#x2F;&#x2F;启动前需要先创建Minio外部挂载的配置文件（ &#x2F;home&#x2F;minio&#x2F;config）,和存储上传文件的目录（ &#x2F;home&#x2F;minio&#x2F;data）
mkdir -p &#x2F;home&#x2F;minio&#x2F;config
mkdir -p &#x2F;home&#x2F;minio&#x2F;data


&#x2F;&#x2F;创建容器并运行
docker run -p 9000:9000 -p 9090:9090 \
     --net&#x3D;host \
     --name minio \
     -d --restart&#x3D;always \
     -e &quot;MINIO_ACCESS_KEY&#x3D;minioadmin&quot; \
     -e &quot;MINIO_SECRET_KEY&#x3D;minioadmin&quot; \
     -v &#x2F;home&#x2F;minio&#x2F;data:&#x2F;data \
     -v &#x2F;home&#x2F;minio&#x2F;config:&#x2F;root&#x2F;.minio \
     minio&#x2F;minio server \
     &#x2F;data --console-address &quot;:9090&quot; -address &quot;:9000&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="MinIO-java-SDK配置"><a href="#MinIO-java-SDK配置" class="headerlink" title="MinIO java SDK配置"></a>MinIO java SDK配置</h4><p>MinIO提供多个语言版本SDK的支持，下边找到java版本的文档：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p>
<p>最低需求Java 1.8或更高版本:</p>
<p>在media-service工程中添加依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>8.4.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.squareup.okhttp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>从官方文档中看到，需要三个参数才能连接到minio服务</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameters</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Endpoint</td>
<td style="text-align:center">URL to S3 service.</td>
</tr>
<tr>
<td style="text-align:center">Access Key</td>
<td style="text-align:center">Access key (aka user ID) of an account in the S3 service.</td>
</tr>
<tr>
<td style="text-align:center">Secret Key</td>
<td style="text-align:center">Secret key (aka password) of an account in the S3 service.</td>
</tr>
</tbody>
</table>
</div>
<h5 id="分析官方给出的代码如下"><a href="#分析官方给出的代码如下" class="headerlink" title="分析官方给出的代码如下"></a>分析官方给出的代码如下</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploader</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        
      <span class="token comment">// 1、创建客户端</span>
      <span class="token comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span>
      <span class="token comment">// 创建MinIO客户端，连接参数就是上述表格中的三个参数，127.0.0.1:9000、minioadmin、minioadmin</span>
      <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
          <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">"https://play.min.io"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">"Q3AM3UQ867SPQQA43P2F"</span><span class="token punctuation">,</span> <span class="token string">"zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
        
        
        <span class="token comment">// 创建桶</span>
      <span class="token comment">// Make 'asiatrip' bucket if not exist.</span>
      <span class="token comment">// 由于backet我们已经手动创建了，所以这段代码可以删掉</span>
      <span class="token keyword">boolean</span> found <span class="token operator">=</span>
          minioClient<span class="token punctuation">.</span><span class="token function">bucketExists</span><span class="token punctuation">(</span><span class="token class-name">BucketExistsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"asiatrip"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Make a new bucket called 'asiatrip'.</span>
        minioClient<span class="token punctuation">.</span><span class="token function">makeBucket</span><span class="token punctuation">(</span><span class="token class-name">MakeBucketArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"asiatrip"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Bucket 'asiatrip' already exists."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
        
        
        <span class="token comment">// 上传文件到桶</span>

      <span class="token comment">// Upload '/home/user/Photos/asiaphotos.zip' as object name 'asiaphotos-2015.zip' to bucket</span>
      <span class="token comment">// 'asiatrip'.</span>
      <span class="token comment">// 将 '/home/user/Photos/asiaphotos.zip' 文件命名为 'asiaphotos-2015.zip'</span>
      <span class="token comment">// 并上传到 'asiatrip' 里（示例代码创建的bucket）</span>
      minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
          <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"asiatrip"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"asiaphotos-2015.zip"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">"/home/user/Photos/asiaphotos.zip"</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这段输出也没有用，可以直接删掉</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
          <span class="token string">"'/home/user/Photos/asiaphotos.zip' is successfully uploaded as "</span>
              <span class="token operator">+</span> <span class="token string">"object 'asiaphotos-2015.zip' to bucket 'asiatrip'."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MinioException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error occurred: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HTTP trace: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">httpTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="上传测试"><a href="#上传测试" class="headerlink" title="上传测试"></a>上传测试</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">UploadObjectArgs</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinIOTest</span> <span class="token punctuation">&#123;</span>



    <span class="token comment">// 创建MinioClient对象</span>
    <span class="token keyword">static</span> <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
            <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">"http://192.168.101.65:9000"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">"minioadmin"</span><span class="token punctuation">,</span> <span class="token string">"minioadmin"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 上传测试方法
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
                    <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span>    <span class="token comment">// 同一个桶内对象名不能重复</span>
                            <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\111.png"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上传成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上传失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602132658369.png" alt="image-20230602132658369"></p>
<h5 id="删除测试"><a href="#删除测试" class="headerlink" title="删除测试"></a>删除测试</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        minioClient<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>
               <span class="token class-name">RemoveObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="查询测试"><a href="#查询测试" class="headerlink" title="查询测试"></a>查询测试</h5><p>通过查询文件查看文件是否存在minio中。</p>
<h5 id="下载校验"><a href="#下载校验" class="headerlink" title="下载校验"></a>下载校验</h5><p>校验文件的完整性，对文件计算出md5值，比较原始文件的md5和目标文件的md5，一致则说明完整</p>
<pre class="line-numbers language-none"><code class="language-none">@Test
public void getFileTest() &#123;
    try &#123;
        InputStream inputStream &#x3D; minioClient.getObject(GetObjectArgs.builder()
                .bucket(&quot;testbucket&quot;)
                .object(&quot;test&#x2F;111.png&quot;)
                .build());
        FileOutputStream fileOutputStream &#x3D; new FileOutputStream(&quot;E:\\test\\picture\\tmp1.png&quot;);
        byte[] buffer &#x3D; new byte[1024];
        int len;
        while ((len &#x3D; inputStream.read(buffer)) !&#x3D; -1) &#123;
            fileOutputStream.write(buffer,0,len);
        &#125;
        inputStream.close();
        fileOutputStream.close();
        System.out.println(&quot;下载成功&quot;);
    &#125; catch (Exception e) &#123;
        System.out.println(&quot;下载失败&quot;);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用IOUtils简化代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
 <span class="token annotation punctuation">@Test</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFileTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
         <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\temp1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//校验文件的完整性对文件的内容进行md5</span>
         <span class="token class-name">String</span> source_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">String</span> local_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>source_md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>local_md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
             <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"下载成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


     <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"下载失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="文件扩展名获取"><a href="#文件扩展名获取" class="headerlink" title="文件扩展名获取"></a>文件扩展名获取</h4><p>设置contentType可以通过com.j256.simplemagic.ContentType枚举类查看常用的mimeType（媒体类型）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//根据扩展名取出mimeType</span>
<span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span><span class="token string">".mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_OCTET_STREAM_VALUE<span class="token punctuation">;</span><span class="token comment">//通用mimeType，字节流</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="MD5校验"><a href="#MD5校验" class="headerlink" title="MD5校验"></a>MD5校验</h3><p>String local_md5 = DigestUtils.md5Hex(“输入流”);</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFileTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/111.png"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\temp1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//校验文件的完整性对文件的内容进行md5</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\temp1.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> minIO_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> down_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>minIO_md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>down_md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"minio与下载文件校验一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"minio与下载文件校验不一致？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//为什么？</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">FileInputStream</span> originInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\picture\\111.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> origin_local_md5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>originInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>origin_local_md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>down_md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"本地与下载文件校验一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"本地与下载文件校验不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        


    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"下载失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>输出如下</p>
<pre class="line-numbers language-none"><code class="language-none">minio与下载文件校验不一致？
本地与下载文件校验一致<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>为什么？</p>
<p>远程流不稳定，所以完整性校验只能 下载完整后校验。。。。。。</p>
<h2 id="功能1-上传文件"><a href="#功能1-上传文件" class="headerlink" title="功能1:上传文件"></a>功能1:上传文件</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>我们在新增课程的时候 需要有一个上传图片的功能</p>
<p>这个步骤其实用了两个微服务两个步骤</p>
<ul>
<li>1、图片上传： 将图片上传到 MinIO 并将图片信息（包括地址信息）存到媒资管理数据库中 </li>
<li>2、更新课程信息表： <strong>课程信息中保存课程图片路径</strong></li>
</ul>
<p>注意不能直接将图片地址复制到课程信息表（不好修改）</p>
<p>为了验证是否重复上传，一般使用 md5值作为文件信息的 主键。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602144223774.png" alt="image-20230602144223774"></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>nacos配置 media-service-dev</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>3306/xc_media<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;userUnicode=true&amp;useSSL=false&amp;</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
   <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">override-none</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">minio</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span><span class="token number">9000</span>
  <span class="token key atrule">accessKey</span><span class="token punctuation">:</span> minioadmin
  <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> minioadmin
  <span class="token key atrule">bucket</span><span class="token punctuation">:</span>
    <span class="token key atrule">files</span><span class="token punctuation">:</span> mediafiles
    <span class="token key atrule">videofiles</span><span class="token punctuation">:</span> video
<span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span> 
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>8088/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>process<span class="token punctuation">-</span>service
      <span class="token key atrule">address</span><span class="token punctuation">:</span> 
      <span class="token key atrule">ip</span><span class="token punctuation">:</span> 
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job/jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token

<span class="token key atrule">videoprocess</span><span class="token punctuation">:</span>
 <span class="token key atrule">ffmpegpath</span><span class="token punctuation">:</span> E<span class="token punctuation">:</span>/software/FFmpeg/ffmpeg.exe
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在media-service工程编写minio的配置类：</p>
<pre class="line-numbers language-none"><code class="language-none">package com.xuecheng.media.config;


 @Configuration
public class MinioConfig &#123;

 @Value(&quot;$&#123;minio.endpoint&#125;&quot;)
 private String endpoint;
 @Value(&quot;$&#123;minio.accessKey&#125;&quot;)
 private String accessKey;
 @Value(&quot;$&#123;minio.secretKey&#125;&quot;)
 private String secretKey;

 @Bean
 public MinioClient minioClient() &#123;

  MinioClient minioClient &#x3D;
          MinioClient.builder()
                  .endpoint(endpoint)
                  .credentials(accessKey, secretKey)
                  .build();
  return minioClient;
 &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h3><pre class="line-numbers language-none"><code class="language-none">根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。
首先分析接口：

请求地址：&#x2F;media&#x2F;upload&#x2F;coursefile
请求头内容：
Content-Type: multipart&#x2F;form-data;boundary&#x3D;….. 
FormData: filedata&#x3D;??, 
folder&#x3D;?, 
objectName&#x3D;?
form-data; name&#x3D;&quot;filedata&quot;; filename&#x3D;&quot;具体的文件名称&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602180026341.png" alt="image-20230602180026341"></p>
<p>接收DTO（上传应该就是把图片上传到系统并返回信息的过程）</p>
<p>定义上传返回信息模型类，虽然响应结果与MediaFiles表中的字段完全一致，但最好不要直接用MediaFiles类。因为该类属于PO类，如果后期我们要对响应结果进行修改，那么模型类也需要进行修改，但是MediaFiles是PO类，我们不能动。所以可以直接用一个类继承MediaFiles，里面什么属性都不用加</p>
<pre class="line-numbers language-none"><code class="language-none">@Data
public class UploadFileResultDto extends MediaFiles &#123;
  
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上传图片</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
filedata 上传的文件
folder 

*/</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"上传文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/upload/coursefile"</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>MULTIPART_FORM_DATA_VALUE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"folder"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先用 httpclinet测试一下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">### 上传文件
POST <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>media_host<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>coursefile
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> multipart<span class="token operator">/</span>form<span class="token operator">-</span>data<span class="token punctuation">;</span> boundary<span class="token operator">=</span><span class="token class-name">WebAppBoundary</span>

<span class="token operator">--</span><span class="token class-name">WebAppBoundary</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Disposition</span><span class="token operator">:</span> form<span class="token operator">-</span>data<span class="token punctuation">;</span> name<span class="token operator">=</span><span class="token string">"filedata"</span><span class="token punctuation">;</span> filename<span class="token operator">=</span><span class="token string">"1.jpg"</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>octet<span class="token operator">-</span>stream

<span class="token operator">&lt;</span> e<span class="token operator">:</span><span class="token operator">/</span>test<span class="token operator">/</span>picture<span class="token operator">/</span><span class="token number">222.</span>png
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口开发"><a href="#接口开发" class="headerlink" title="接口开发"></a><strong>接口开发</strong></h3><p>定义请求通用参数类（适用于更多的文件类型）：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadFileParamsDto</span> <span class="token punctuation">&#123;</span>

 <span class="token comment">/**
  * 文件名称
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> filename<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 文件content-type
 */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> contentType<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 文件类型（文档，图片，视频）
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> fileType<span class="token punctuation">;</span>
 <span class="token comment">/**
  * 文件大小
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> fileSize<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 标签
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 上传人
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 备注
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义service方法，MultipartFile是SpringMVC提供简化上传操作的工具类，不使用框架之前，都是使用原生的HttpServletRequest来接收上传的数据,文件是以二进制流传递到后端的。为了使接口更通用，我们可以用字节数组代替MultpartFile类型</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 上传文件
 * @param companyId 机构id
 * @param uploadFileParamsDto 上传文件信息
 * @param localFilePath 文件磁盘路径
 * @return 文件信息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>实现方法如下，主要分为两部分<ol>
<li>将文件上传到minio</li>
<li>将文件信息写入media_file表中</li>
</ol>
</li>
</ul>
<p>service实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MinioClient</span> minioClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

<span class="token comment">//普通文件桶</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;minio.bucket.files&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> bucket_Files<span class="token punctuation">;</span>


<span class="token comment">/**
 * @description 将文件写入minIO
 * @param localFilePath  文件地址
 * @param bucket  桶
 * @param objectName 对象名称
 * @return void
 * @author Mr.M
 * @date 2022/10/12 21:22
 */</span>


<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"文件不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//文件名称</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件扩展名</span>
    <span class="token class-name">String</span> extension <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件mimeType</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token function">getMimeType</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件的md5值</span>
    <span class="token class-name">String</span> fileMd5 <span class="token operator">=</span> <span class="token function">getFileMd5</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件的默认目录</span>
    <span class="token class-name">String</span> defaultFolderPath <span class="token operator">=</span> <span class="token function">getDefaultFolderPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存储到minio中的对象名(带目录)</span>
    <span class="token class-name">String</span>  objectName <span class="token operator">=</span> defaultFolderPath <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> exension<span class="token punctuation">;</span>
    <span class="token comment">//将文件上传到minio</span>
    <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">,</span> mimeType<span class="token punctuation">,</span> bucket_files<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件大小</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将文件信息存储到数据库</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> bucket_files<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//准备返回数据</span>
    <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileResultDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">,</span> uploadFileResultDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span><span class="token class-name">String</span> localFilePath<span class="token punctuation">,</span><span class="token class-name">String</span> mimeType<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UploadObjectArgs</span> testbucket <span class="token operator">=</span> <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span>localFilePath<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>testbucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"上传文件到minio成功,bucket:&#123;&#125;,objectName:&#123;&#125;"</span><span class="token punctuation">,</span>bucket<span class="token punctuation">,</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上传成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"上传文件到minio出错,bucket:&#123;&#125;,objectName:&#123;&#125;,错误原因:&#123;&#125;"</span><span class="token punctuation">,</span>bucket<span class="token punctuation">,</span>objectName<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"上传文件到文件系统失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * @description 将文件信息添加到文件表
 * @param companyId  机构id
 * @param fileMd5  文件md5值
 * @param uploadFileParamsDto  上传文件的信息
 * @param bucket  桶
 * @param objectName 对象名称
 * @return com.xuecheng.media.model.po.MediaFiles
 * @author Mr.M
 * @date 2022/10/12 21:22
 */</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//从数据库查询文件</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拷贝基本信息</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFilePath</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">"002003"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存文件信息到文件表</span>
        <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"保存文件信息到数据库失败,&#123;&#125;"</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"保存文件信息失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"保存文件信息到数据库成功,&#123;&#125;"</span><span class="token punctuation">,</span>mediaFiles<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>



<span class="token comment">//获取文件默认存储目录路径 年/月/日/</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getDefaultFolderPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> folder <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"/"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> folder<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//获取文件的md5</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFileMd5</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> fileMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fileMd5<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token class-name">String</span> extension<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>extension<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        extension <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token comment">//根据扩展名取出mimeType</span>
    <span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通用mimeType，字节流</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_OCTET_STREAM_VALUE<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>extensionMatch<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        mimeType <span class="token operator">=</span> extensionMatch<span class="token punctuation">.</span><span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> mimeType<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="完善接口"><a href="#完善接口" class="headerlink" title="完善接口"></a>完善接口</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"上传文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/upload/coursefile"</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>MULTIPART_FORM_DATA_VALUE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"folder"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
    <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileParamsDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件大小</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//图片</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">"001001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件名称</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFilename</span><span class="token punctuation">(</span>filedata<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//文件名称</span>
    <span class="token comment">//文件大小</span>
    <span class="token keyword">long</span> fileSize <span class="token operator">=</span> filedata<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">//创建临时文件(在服务器中，toamcat的一个指定地址上)</span>
    <span class="token class-name">File</span> tempFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"minio"</span><span class="token punctuation">,</span> <span class="token string">"temp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传的文件拷贝到临时文件</span>
    filedata<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>tempFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件路径</span>
    <span class="token class-name">String</span> absolutePath <span class="token operator">=</span> tempFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传文件</span>
    <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="测试接口"><a href="#测试接口" class="headerlink" title="测试接口"></a>测试接口</h3><p>关于测试中的 </p>
<p>—WebAppBoundary <a target="_blank" rel="noopener" href="https://blog.csdn.net/a1472750149/article/details/121266532">含义</a></p>
<p>以及为什么有两个 Content Type 其实 ，我们宏观上接受的 content type 是第一个</p>
<p>第二个content type 其实是表单自带的 content type</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602203916688.png" alt="image-20230602203916688" style="zoom:50%;" /></p>
<p>前后端联调：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230602215438425.png" alt="image-20230602215438425"></p>
<p>终于成功了，之前网关除了 conten总是不生效。。。问题在哪里，也没查出来，最后也没改啥，把所有服务重启了一遍才好。。。。。</p>
<p>我真的崩溃了。。</p>
<h3 id="Service事务优化（事务注解失效）"><a href="#Service事务优化（事务注解失效）" class="headerlink" title="Service事务优化（事务注解失效）"></a>Service事务优化（事务注解失效）</h3><p>上边的service方法优化后并测试通过，现在思考关于uploadFile方法的是否应该开启事务。</p>
<p>目前是在uploadFile方法上添加@Transactional，当调用uploadFile方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。</p>
<p>我们只将addMediaFilesToDb方法添加事务控制即可,uploadFile方法上的@Transactional注解去掉。</p>
<p>也就是 事物的范围应该更小</p>
<p>但是，发现<a target="_blank" rel="noopener" href="https://blog.csdn.net/duan196_118/article/details/105534351">事务失效了</a> （addMediaFilesToDb内添加除零异常）为什么在uploadFile 上加 @Transactional注解就能生效而 addMediaFilesToDb不行呢？</p>
<p>方法拥有事务的能力是因为spring aop生成代理了对象，<strong>通过代理对象调用事务方法才能直接生成事务</strong></p>
<p>debug会发现，只有 uploadFile  加注解调用的时 代理对象 的方法， 而 addMediaFilesToDb 加注解 走的不是代理 而是本类（相当于this. 方法 调用）</p>
<p>解决方案：</p>
<p>1、在MediaFileService的实现类中<strong>注入自己</strong> （这时 通过注入的对象调用（注入的对象一定是代理对象）），并把调用的函数内调用的整个事务函数<strong>提到接口</strong></p>
<p>可能有些人可能会有这样的疑问：这种做法会不会出现循环依赖问题？</p>
<p>答案：不会。</p>
<p>其实spring ioc内部的三级缓存保证了它，不会出现循环依赖问题。</p>
<p>2、通过AopContext.currentProxy()获取代理对象再调用</p>
<p>3、重新创建一个新的service类，里面有事务han’shu（不推荐）在原来的类中 注入新类</p>
<h2 id="功能2-上传视频（断点续传功能实现）"><a href="#功能2-上传视频（断点续传功能实现）" class="headerlink" title="功能2:上传视频（断点续传功能实现）"></a>功能2:上传视频（断点续传功能实现）</h2><p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。<strong>http协议本身对上传文件大小没有限制</strong>，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p>
<p>断点续传：上传过程中，网络断开，重新上传时，从已经断点处继续上传。</p>
<p>总体步骤</p>
<h3 id="文件的断点续传-解决方案-文件分块上传"><a href="#文件的断点续传-解决方案-文件分块上传" class="headerlink" title="文件的断点续传 - 解决方案 文件分块上传"></a>文件的断点续传 - 解决方案 文件分块上传</h3><ul>
<li><p>1、（前提）前端检查<strong>该大文件信息是否已存在</strong>？</p>
<p>​    前端像媒资服务请求查询要上传的文件是否存在，参数是当前文件的md5值</p>
<p>​    媒资服务根据文件md5值查询文件系统 文件信息是否已经上传，如果是将不再上传</p>
</li>
<li><p>2、如果分块文件不存在则前端请求媒资开始上传分块（分块是前端完成）</p>
<ul>
<li>前端遍历每一个分块</li>
<li><strong>查询当前分块是否存在</strong>，不存在则上传，存在则不上传/ <strong>无论是查询还是 上传，都要经过 媒资管理这个中介</strong>。</li>
<li><strong>上传</strong></li>
</ul>
</li>
<li><p>3、 上传完毕后，前端请求合并数据 ，媒资完成文件系统内的合并操作</p>
<ul>
<li>合并</li>
<li>合并完成校验合并后的文件是否完整（通过下载获取md5 与 当前文件的md5是否一致），如果完整则上传完成，否则删除文件</li>
<li>将信息录入到媒资数据库当中</li>
<li>入库完成后<strong>删除分块文件</strong></li>
</ul>
</li>
<li><p>4、处理废旧上传分块文件（用户中途穿一半不不传了，以后也不传）</p>
<ul>
<li>解决方案：为媒资文件设定状态（1、上传中途2、上传完毕）设置一个定时器，每隔一段时间如24小时检查上处于上传中途文件的创建事件是否超过了24小时，如果超过就清除分块文件。</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230610211926109.png" alt="image-20230610211926109"></p>
<p>所以。完成断电续传这个个功能需要暴露三个接口给前端</p>
<p>1、 检查整体文件 /  检查分块文件 </p>
<p>2、上传分块</p>
<p>3、合并分块</p>
<h4 id="热身：文件分块与合并"><a href="#热身：文件分块与合并" class="headerlink" title="热身：文件分块与合并"></a>热身：文件分块与合并</h4><p>java 随机流实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1、找到源文件</span>
        <span class="token class-name">File</span> sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\vvefdio\\sss.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将文件分块，分块文件的存储路径</span>
        <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> <span class="token string">"E:\\test\\vvefdio\\Chunk\\"</span><span class="token punctuation">;</span>

        <span class="token comment">// 分块文件的大小</span>
        <span class="token keyword">int</span> chunkSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span><span class="token number">1024</span> <span class="token operator">*</span><span class="token number">1</span> <span class="token punctuation">;</span><span class="token comment">// 1MB</span>
        <span class="token comment">// 分块文件的个数</span>
        <span class="token keyword">int</span> chunkNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span><span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 填充分块文件(随机流)</span>
        <span class="token class-name">RandomAccessFile</span> rand_r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取源文件</span>


        <span class="token comment">// 缓冲区 用于存储读取的数据</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>chunkSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>chunkNum<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">File</span> chunkFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkFilePath<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分块文件的 路径、名称</span>
            <span class="token comment">// 分块文件的写入流</span>
            <span class="token class-name">RandomAccessFile</span> rand_rw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>chunkFile<span class="token punctuation">,</span><span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len<span class="token operator">=</span>rand_r<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                rand_rw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把 buffer 里面的内容往 目标晚间里面写</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>chunkFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">>=</span>chunkSize<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            rand_rw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        rand_r<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将文件分块，分块文件的存储路径</span>
    <span class="token class-name">String</span> chunkFileFolder <span class="token operator">=</span> <span class="token string">"E:\\test\\vvefdio\\Chunk\\"</span><span class="token punctuation">;</span>
    <span class="token comment">// 分块文件的大小</span>
    <span class="token keyword">int</span> chunkSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span><span class="token number">1024</span> <span class="token operator">*</span><span class="token number">1</span> <span class="token punctuation">;</span><span class="token comment">// 1MB</span>
    <span class="token comment">// 合并文件</span>
    <span class="token class-name">File</span> mergeFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\vvefdio\\sss_merge.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取出所有的分块文件</span>
    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files_array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkFileFolder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">></span></span> files <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>files_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 按序读取</span>
    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">File</span> o1<span class="token punctuation">,</span> <span class="token class-name">File</span> o2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历分块，向合并文件写</span>
    <span class="token class-name">RandomAccessFile</span> rand_rw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">,</span><span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 读取 分块</span>
        <span class="token class-name">RandomAccessFile</span> rand_r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//</span>
        <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>len<span class="token operator">=</span>rand_r<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            rand_rw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        rand_r<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    rand_rw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 校验 md5</span>
    <span class="token comment">// 源文件</span>
    <span class="token class-name">File</span> soureFile<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"E:\\test\\vvefdio\\sss.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InputStream</span> sourceIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>soureFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s1<span class="token operator">=</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>sourceIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 合并文件</span>
    <span class="token comment">//File mergeFile= new File("E:\\test\\vvefdio\\sss_merge.mp4");</span>
    <span class="token class-name">InputStream</span> mergeIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>soureFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s2<span class="token operator">=</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>mergeIn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>s1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="热身：minio文件合并"><a href="#热身：minio文件合并" class="headerlink" title="热身：minio文件合并"></a>热身：minio文件合并</h4><p>合并分块是直接用 minio的提供的SDK接口</p>
<p>minio 上传分块</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 分块文件夹</span>
    <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> <span class="token string">"E:\\test\\vvefdio\\Chunk\\"</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
                <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/chunkFiles/"</span><span class="token operator">+</span>i<span class="token punctuation">)</span>    <span class="token comment">// 同一个桶内对象名不能重复</span>
                        <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span>chunkFilePath<span class="token operator">+</span>i<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>minio文件合并</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 合并文件</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServerException</span><span class="token punctuation">,</span> <span class="token class-name">InsufficientDataException</span><span class="token punctuation">,</span> <span class="token class-name">ErrorResponseException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidResponseException</span><span class="token punctuation">,</span> <span class="token class-name">XmlParserException</span><span class="token punctuation">,</span> <span class="token class-name">InternalException</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 获取分块文件目录，获取里面的所有应该合并的文件</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComposeSource</span><span class="token punctuation">></span></span> sources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ComposeSource</span> composeSource <span class="token operator">=</span> <span class="token class-name">ComposeSource</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/chunkFiles/"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>composeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>



    minioClient<span class="token punctuation">.</span><span class="token function">composeObject</span><span class="token punctuation">(</span>
            <span class="token class-name">ComposeObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"testbucket"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"test/mergeFile.mp4"</span><span class="token punctuation">)</span> <span class="token comment">// 合并后的name</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发现报错IllegalArgumentException: source  size 1048576 must be greater than 5242880</span>
    <span class="token comment">// 也就是 minio 默认分块文件大小应该是5MB</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>    发现报错IllegalArgumentException: source  size 1048576 must be greater than 5242880
    也就是 minio 默认分块文件大小应该是5MB

    把之前所有分块大小 改为5MB 重来
</code></pre><p>ok 测试成功</p>
<p><strong>查询（分块）文件时候在MinIO</strong></p>
<p>已经实现过查询文件了</p>
<h3 id="接口定义："><a href="#接口定义：" class="headerlink" title="接口定义："></a>接口定义：</h3><p>将整个大文件上传要用的接口 定义在 BigFilesController 这个类里面</p>
<p>从课程资料中拷贝RestResponse.java类到base工程下的model包下。</p>
<p>根据之前的讨论，需要暴露四个接口在外面</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"大文件上传接口"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"大文件上传接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BigFilesController</span> <span class="token punctuation">&#123;</span>



    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"文件上传前检查文件"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/upload/checkfile"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token function">checkfile</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileMd5"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5
    <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"分块文件上传前的检测"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/upload/checkchunk"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token function">checkchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileMd5"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"chunk"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"上传分块文件"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/upload/uploadchunk"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileMd5"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"chunk"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"合并文件"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/upload/mergechunks"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileMd5"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileName"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"chunkTotal"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>


<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口开发-1"><a href="#接口开发-1" class="headerlink" title="接口开发"></a>接口开发</h3><h4 id="检查文件和分块"><a href="#检查文件和分块" class="headerlink" title="检查文件和分块"></a><strong>检查文件和分块</strong></h4><p>MediaFileService 中定义 检查文件/分块 方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token function">checkChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 检查文件</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>
   <span class="token comment">// 数据库查询是否存在？</span>
  <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mediaFiles<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   <span class="token comment">// minio中书否存在？</span>
   <span class="token comment">// 桶</span>
   <span class="token class-name">String</span> bucket <span class="token operator">=</span> mediaFiles<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 存储目录</span>
   <span class="token class-name">String</span> filePath <span class="token operator">=</span> mediaFiles<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">InputStream</span> stream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    stream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">//文件已存在</span>
     <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>


  <span class="token punctuation">&#125;</span>
  <span class="token comment">//文件不存在</span>
  <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">// 查询分块文件是否存在</span>
 <span class="token comment">// 对于整个文件来说可以从minio查询 文件存储的位置，对于分块文件来说，需要自定义分块文件的存储路径，查询的时候也按照哥哥方式来查</span>
 <span class="token comment">// 我们直接以分块文件的前 2位作为一个目录</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> <span class="token function">checkChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">//得到分块文件目录</span>
  <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//得到分块文件的路径</span>
  <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> chunkFileFolderPath <span class="token operator">+</span> chunkIndex<span class="token punctuation">;</span>

  <span class="token comment">//文件流</span>
  <span class="token class-name">InputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
   fileInputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>
           <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>chunkFilePath<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//分块已存在</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token punctuation">&#125;</span>
  <span class="token comment">//分块未存在</span>
  <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">//得到分块文件的目录</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> <span class="token string">"chunk"</span> <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="上传分块文件"><a href="#上传分块文件" class="headerlink" title="上传分块文件"></a>上传分块文件</h4><p>service</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token keyword">int</span> chunk<span class="token punctuation">,</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunk<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//得到分块文件的目录路径</span>
    <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//得到分块文件的路径</span>
    <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> chunkFileFolderPath <span class="token operator">+</span> chunk<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//将文件存储至minIO</span>
    <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> bucket_videoFiles<span class="token punctuation">,</span>chunkFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"上传分块文件:&#123;&#125;,失败:&#123;&#125;"</span><span class="token punctuation">,</span>chunkFilePath<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token string">"上传分块失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>发现直接测试上传视屏会报错</p>
<p> 系统异常：</p>
<p>这还是之前的原因：</p>
<p>MinIO限制上传分块的文件大小位5MB</p>
<p>所以在前端把分块大小定为5MB以上（不然就得改MINIO SDK 源码）</p>
<ul>
<li>课程资料前端文件中有一个 uploadtools.ts 文件</li>
<li>将其覆盖在前端工程 src/utils 目录下的同名文件中</li>
<li>课程资料还有个 .vue 文件 ，将其 覆盖在src/module-organization/pages/media-manage/components/media-add-dialog.vue</li>
<li>重启前端服务</li>
</ul>
<p>发现还是报错</p>
<p>Maximum upload size exceeded; nested exception is java.lang.IllegalStateException: org.apache.tomcat.util.http.fileupload.impl.FileSizeLimitExceededException: The field file exceeds its maximum permitted size of 1048576 bytes.</p>
<p>这个错误是后端Springboot导致的</p>
<p>前端对文件分块的大小为5MB，SpringBoot web默认上传文件的大小限制为1MB，这里需要在media-api工程修改配置如下：</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">multipart</span><span class="token punctuation">:</span>
      <span class="token key atrule">max-file-size</span><span class="token punctuation">:</span> 50MB
      <span class="token key atrule">max-request-size</span><span class="token punctuation">:</span> 50MB
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试成功！</p>
<h4 id="合并分块"><a href="#合并分块" class="headerlink" title="合并分块"></a>合并分块</h4><p>service</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token keyword">int</span> chunkTotal<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//=====获取分块文件路径=====</span>
  <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//组成将分块文件路径组成 List&lt;ComposeSource></span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComposeSource</span><span class="token punctuation">></span></span> sourceObjectList <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">-></span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>chunkTotal<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token class-name">ComposeSource</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>chunkFileFolderPath<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//=====合并=====</span>
  <span class="token comment">//文件名称</span>
  <span class="token class-name">String</span> fileName <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//文件扩展名</span>
  <span class="token class-name">String</span> extName <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//合并文件路径</span>
  <span class="token class-name">String</span> mergeFilePath <span class="token operator">=</span> <span class="token function">getFilePathByMd5</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//合并文件</span>
   <span class="token class-name">ObjectWriteResponse</span> response <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">composeObject</span><span class="token punctuation">(</span>
           <span class="token class-name">ComposeObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>mergeFilePath<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">sources</span><span class="token punctuation">(</span>sourceObjectList<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"合并文件成功:&#123;&#125;"</span><span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"合并文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;"</span><span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"合并文件失败。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// ====验证md5====</span>
  <span class="token class-name">File</span> minioFile <span class="token operator">=</span> <span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>minioFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"下载合并后文件失败,mergeFilePath:&#123;&#125;"</span><span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"下载合并后文件失败。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> newFileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>minioFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//minio上文件的md5值</span>
   <span class="token class-name">String</span> md5Hex <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>newFileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//比较md5值，不一致则说明文件不完整</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fileMd5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>md5Hex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"文件合并校验失败，最终上传失败。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token comment">//文件大小</span>
   uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>minioFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"校验文件失败,fileMd5:&#123;&#125;,异常:&#123;&#125;"</span><span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">validfail</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"文件合并校验失败，最终上传失败。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>minioFile<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    minioFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">//文件入库</span>
  currentProxy<span class="token punctuation">.</span><span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">,</span>bucket_videoFiles<span class="token punctuation">,</span>mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//=====清除分块文件=====</span>
  <span class="token function">clearChunkFiles</span><span class="token punctuation">(</span>chunkFileFolderPath<span class="token punctuation">,</span>chunkTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">/**
  * 从minio下载文件
  * @param bucket 桶
  * @param objectName 对象名称
  * @return 下载后的文件
  */</span>
 <span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment">//临时文件</span>
  <span class="token class-name">File</span> minioFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
   <span class="token class-name">InputStream</span> stream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//创建临时文件</span>
   minioFile<span class="token operator">=</span><span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"minio"</span><span class="token punctuation">,</span> <span class="token string">".merge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>minioFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span>outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> minioFile<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>outputStream<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
     outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">/**
  * 得到合并后的文件的地址
  * @param fileMd5 文件id即md5值
  * @param fileExt 文件扩展名
  * @return
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFilePathByMd5</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">String</span> fileExt<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span>   fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span>fileMd5 <span class="token operator">+</span>fileExt<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token comment">/**
  * 清除分块文件
  * @param chunkFileFolderPath 分块文件路径
  * @param chunkTotal 分块文件总数
  */</span>
 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">clearChunkFiles</span><span class="token punctuation">(</span><span class="token class-name">String</span> chunkFileFolderPath<span class="token punctuation">,</span><span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeleteObject</span><span class="token punctuation">></span></span> deleteObjects <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">-></span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>chunkTotal<span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">DeleteObject</span><span class="token punctuation">(</span>chunkFileFolderPath<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">RemoveObjectsArgs</span> removeObjectsArgs <span class="token operator">=</span> <span class="token class-name">RemoveObjectsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">"video"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">objects</span><span class="token punctuation">(</span>deleteObjects<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&lt;</span><span class="token class-name">DeleteError</span><span class="token punctuation">></span><span class="token punctuation">></span></span> results <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">removeObjects</span><span class="token punctuation">(</span>removeObjectsArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
   results<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>r<span class="token operator">-></span><span class="token punctuation">&#123;</span>
    <span class="token class-name">DeleteError</span> deleteError <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
     deleteError <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"清楚分块文件失败,objectname:&#123;&#125;"</span><span class="token punctuation">,</span>deleteError<span class="token punctuation">.</span><span class="token function">objectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"清楚分块文件失败,chunkFileFolderPath:&#123;&#125;"</span><span class="token punctuation">,</span>chunkFileFolderPath<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口完善</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"合并文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/upload/mergechunks"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileMd5"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"fileName"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"chunkTotal"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>

    <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileParamsDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">"001002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token string">"课程视频"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFilename</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">mergechunks</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>chunkTotal<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611111805251.png" alt="image-20230611111805251"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611111628566.png" alt="image-20230611111628566"></p>
<p>成功！</p>
<h2 id="功能3-：文件预览"><a href="#功能3-：文件预览" class="headerlink" title="功能3 ：文件预览"></a>功能3 ：文件预览</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611115714410.png" alt="image-20230611115714410"></p>
<p>预览的方式是通过浏览器直接打开文件，对于图片和浏览器支持的视频格式可以直接浏览</p>
<p>本质上就是返回资源文件的url给前端</p>
<h3 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a>接口定义</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"预览文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/preview/&#123;mediaId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="接口开发-2"><a href="#接口开发-2" class="headerlink" title="接口开发"></a>接口开发</h2><h3 id="设置URL"><a href="#设置URL" class="headerlink" title="设置URL"></a>设置URL</h3><ul>
<li>有一些浏览器不支持的视频格式，不能在浏览器中直接浏览，所以我们要修改保存媒资信息到数据库的方法<ul>
<li>当文件是图片时，设置URL字段</li>
<li>当视频是MP4格式时，设置URL字段</li>
<li>其他情况暂不设置URL，需要文件处理后再设置URL字段</li>
</ul>
</li>
</ul>
<p>这就需要我们在原来的添加文件信息到数据库的那段代码里面做些修改了</p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   /**
</span><span class="token prefix unchanged"> </span><span class="token line">    * 将文件信息添加到文件表
</span><span class="token prefix unchanged"> </span><span class="token line">    *
</span><span class="token prefix unchanged"> </span><span class="token line">    * @param companyId           机构id
</span><span class="token prefix unchanged"> </span><span class="token line">    * @param uploadFileParamsDto 上传文件的信息
</span><span class="token prefix unchanged"> </span><span class="token line">    * @param objectName          对象名称
</span><span class="token prefix unchanged"> </span><span class="token line">    * @param fileMD5             文件的md5码
</span><span class="token prefix unchanged"> </span><span class="token line">    * @param bucket              桶
</span><span class="token prefix unchanged"> </span><span class="token line">    */
</span><span class="token prefix unchanged"> </span><span class="token line">   @Transactional
</span><span class="token prefix unchanged"> </span><span class="token line">   public MediaFiles addMediaFilesToDB(Long companyId, UploadFileParamsDto uploadFileParamsDto, String objectName, String fileMD5, String bucket) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">       // 保存到数据库
</span><span class="token prefix unchanged"> </span><span class="token line">       MediaFiles mediaFiles = mediaFilesMapper.selectById(fileMD5);
</span><span class="token prefix unchanged"> </span><span class="token line">       if (mediaFiles == null) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles = new MediaFiles();
</span><span class="token prefix unchanged"> </span><span class="token line">           BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setId(fileMD5);
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setFileId(fileMD5);
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setCompanyId(companyId);
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setBucket(bucket);
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setCreateDate(LocalDateTime.now());
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setStatus("1");
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setFilePath(objectName);
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">           // 获取源文件名的contentType
</span><span class="token prefix inserted">+</span><span class="token line">           String contentType = getContentType(objectName);
</span><span class="token prefix inserted">+</span><span class="token line">           // 如果是图片格式或者mp4格式，则设置URL属性，否则不设置
</span><span class="token prefix inserted">+</span><span class="token line">           if (contentType.contains("image") || contentType.contains("mp4")) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">               mediaFiles.setUrl("/" + bucket + "/" + objectName);
</span><span class="token prefix inserted">+</span><span class="token line">           &#125;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">           // 查阅数据字典，002003表示审核通过
</span><span class="token prefix unchanged"> </span><span class="token line">           mediaFiles.setAuditStatus("002003");
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       int insert = mediaFilesMapper.insert(mediaFiles);
</span><span class="token prefix unchanged"> </span><span class="token line">       if (insert &lt;= 0) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">           XueChengPlusException.cast("保存文件信息失败");
</span><span class="token prefix unchanged"> </span><span class="token line">       &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">       return mediaFiles;
</span><span class="token prefix unchanged"> </span><span class="token line">   &#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Service开发"><a href="#Service开发" class="headerlink" title="Service开发"></a>Service开发</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">MediaFiles</span> <span class="token function">getFileById</span><span class="token punctuation">(</span><span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">getFileById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"视频还没有转码处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"预览文件"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/preview/&#123;mediaId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">MediaFiles</span> mediaFile <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">getFileById</span><span class="token punctuation">(</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>mediaFile<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="功能4：视频处理（视频转码）"><a href="#功能4：视频处理（视频转码）" class="headerlink" title="功能4：视频处理（视频转码）"></a>功能4：视频处理（视频转码）</h2><p>为什么要转码？视频是每个课程必须有的，转码方便后续统一处理</p>
<p>首先我们要分清<strong>文件格式</strong>和<strong>编码格式</strong>：</p>
<p>文件格式，可以理解为后缀名扩展名，.mp4、.avi、.rmvb</p>
<p>编码格式，可以理解为具体的编码算法，对于一个视频文件来说，其<strong>音视频编码格式</strong> 包括 <strong>视频编码</strong> 和 <strong>音频编码</strong> 两部分</p>
<p><strong>音视频</strong>编码格式系列</p>
<p>1、MPEG系列</p>
<p>2、H.26X系列</p>
<p>需求：我们将文件格式统一转为mp4，视频编码统一转为H.264，音频AAC。</p>
<p>前提：</p>
<p>转码具体算法以及工具我们直接调用 FFmpeg，我们直接调用即可，主要是使用程序自动调用，转换。</p>
<p>下载 ffmpeg</p>
<p>可以将ffmpeg.exe配置到环境变量path中，进入视频目录直接运行：ffmpeg.exe -i 1.avi 1.mp4<br>转成mp3：ffmpeg -i nacos.avi nacos.mp3<br>转成gif：ffmpeg -i nacos.avi nacos.gif</p>
<p>将课程资料目录中的util.zip解压，将解压出的工具类拷贝至base工程。</p>
<p>其中Mp4VideoUtil类是用于将视频转为mp4格式，是我们项目要使用的工具类。</p>
<p>下边看下这个类的代码，并进行测试。</p>
<h3 id="工具类测试"><a href="#工具类测试" class="headerlink" title="工具类测试"></a>工具类测试</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//ffmpeg的路径</span>
    <span class="token class-name">String</span> ffmpeg_path <span class="token operator">=</span> <span class="token string">"E:\\software\\FFmpeg\\ffmpeg.exe"</span><span class="token punctuation">;</span><span class="token comment">//ffmpeg的安装位置</span>
    <span class="token comment">//源avi视频的路径</span>
    <span class="token class-name">String</span> video_path <span class="token operator">=</span> <span class="token string">"E:\\test\\vvefdio\\sss.avi"</span><span class="token punctuation">;</span>
    <span class="token comment">//转换后mp4文件的名称</span>
    <span class="token class-name">String</span> mp4_name <span class="token operator">=</span> <span class="token string">"sss_mp4.mp4"</span><span class="token punctuation">;</span>
    <span class="token comment">//转换后mp4文件的路径</span>
    <span class="token class-name">String</span> mp4_path <span class="token operator">=</span> <span class="token string">"E:\\test\\vvefdio\\sss_mp4.mp4"</span><span class="token punctuation">;</span>
    <span class="token comment">//创建工具类对象</span>
    <span class="token class-name">Mp4VideoUtil</span> videoUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mp4VideoUtil</span><span class="token punctuation">(</span>ffmpeg_path<span class="token punctuation">,</span>video_path<span class="token punctuation">,</span>mp4_name<span class="token punctuation">,</span>mp4_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//开始视频转换，成功将返回success</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> videoUtil<span class="token punctuation">.</span><span class="token function">generateMp4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="批量转码（分布式任务调度）"><a href="#批量转码（分布式任务调度）" class="headerlink" title="批量转码（分布式任务调度）"></a>批量转码（分布式任务调度）</h3><h4 id="什么是分布式任务调度？"><a href="#什么是分布式任务调度？" class="headerlink" title="什么是分布式任务调度？"></a>什么是分布式任务调度？</h4><p>一个视频转码相当于一个任务，转码是一个耗时的工作</p>
<ul>
<li><p>假如用户量多了，如何面对大量的转码任务？分布式任务调度</p>
</li>
<li><p>如何高效处理任务？ 多线程，但是单机运行能力有限，多个机器处理 -》 <strong>多个机器（服务实例）加多线程</strong></p>
</li>
</ul>
<ul>
<li><p>问题：（<strong>分布式</strong>） 如何 分配这些任务到各个机器的各个线程，（<strong>调度</strong>）又如何控制 任务开始时间 这就是分布式任务调度（分配一级时间）。</p>
<p>常用于以下场景：</p>
<ul>
<li>每隔24小时数据备份</li>
<li>12306 每个一段时间放票</li>
<li>商品发货成功后，向客户发送信息提醒</li>
</ul>
<p>根据CAP理论，更看重一致性的场景，对及时性（可用性）要求不高</p>
</li>
</ul>
<h5 id="单机下-任务调度的实现方式"><a href="#单机下-任务调度的实现方式" class="headerlink" title="单机下 任务调度的实现方式"></a>单机下 任务调度的实现方式</h5><p>发现基本都是定时、定间隔任务，简单情况可以使用 <strong>1、while（true ）+sleep 2、 Timer 和 3、 ScheduledExecutor 方案</strong>实现，但是对于复杂场景实现困难，如每一个月的固定时间？等等 还有一些第三放框架</p>
<p><strong>第三方Quartz方式实现</strong></p>
<p> Quartz 是一个功能强大的任务调度框架，它可以满足更多更复杂的调度需求，Quartz 设计的核心类包括 Scheduler, Job 以及 Trigger。其中，Job 负责定义需要执行的任务，Trigger 负责设置调度策略，Scheduler 将二者组装在一起，并触发任务开始执行。Quartz支持简单的按时间间隔调度、还支持按日历调度方式，通过设置CronTrigger表达式（包括：秒、分、时、日、月、周、年）进行任务调度。</p>
<p>如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> agrs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SchedulerException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//创建一个Scheduler</span>
    <span class="token class-name">SchedulerFactory</span> schedulerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Scheduler</span> scheduler <span class="token operator">=</span> schedulerFactory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建JobDetail</span>
    <span class="token class-name">JobBuilder</span> jobDetailBuilder <span class="token operator">=</span> <span class="token class-name">JobBuilder</span><span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span><span class="token class-name">MyJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jobDetailBuilder<span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"jobName"</span><span class="token punctuation">,</span><span class="token string">"jobGroupName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JobDetail</span> jobDetail <span class="token operator">=</span> jobDetailBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建触发的CronTrigger 支持按日历调度</span>
        <span class="token class-name">CronTrigger</span> trigger <span class="token operator">=</span> <span class="token class-name">TriggerBuilder</span><span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">"triggerName"</span><span class="token punctuation">,</span> <span class="token string">"triggerGroupName"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span><span class="token class-name">CronScheduleBuilder</span><span class="token punctuation">.</span><span class="token function">cronSchedule</span><span class="token punctuation">(</span><span class="token string">"0/2 * * * * ?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"todo something"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上单机方式一定无法满足 计算量 可用性的需求，分布式任务调度的要求更高，如下，单机无法满足。</p>
<h5 id="分布式任务调度的目标"><a href="#分布式任务调度的目标" class="headerlink" title="分布式任务调度的目标"></a>分布式任务调度的目标</h5><p>1、并行任务调度</p>
<p>2、高可用（失败重试）、弹性扩容</p>
<p>3、任务管理与监测</p>
<p>4、避免任务重复执行</p>
<h4 id="分布式任务调度中间件-xxl-job"><a href="#分布式任务调度中间件-xxl-job" class="headerlink" title="分布式任务调度中间件- xxl -job"></a>分布式任务调度中间件- xxl -job</h4><p>他是一个中间件（软件）</p>
<p>主要由  调度中心（管理者）、执行器（分布式部署）、任务 组成</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611135158058.png" alt="image-20230611135158058" style="zoom: 67%;" /></p>
<p>流程</p>
<p>​    1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p>
<p>​    2.达到任务触发条件，调度中心下发任务</p>
<p>​    3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p>
<p>​    4.执行器消费内存队列中的执行结果，主动上报给调度中心</p>
<p>​    5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p>
<h3 id="搭建XXL-JOB"><a href="#搭建XXL-JOB" class="headerlink" title="搭建XXL-JOB"></a><strong>搭建XXL-JOB</strong></h3><p>首先根据上面的介绍，需要明确，主要就是分 调度中心和 执行器 ，xxl job 作为 一个“外部中间件”</p>
<ul>
<li>使用IDEA打开项目<ul>
<li>xxl-job-admin：调度中心</li>
<li>xxl-job-core：公共依赖</li>
<li>xxj-job-executor-samples：执行器Sample示例<ul>
<li>xxl-job-executor-sample-springboot：SpringBoot版本，通过SpringBoot管理执行器</li>
<li>xxl-job-executor-sample-frameless：无框架版本</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>根据数据库脚本创建数据库，修改<strong>数据库连接信息</strong>和<strong>端口</strong>，启动xxl-job-admin，访问<a target="_blank" rel="noopener" href="http://local:18088/xxl-job-admin/">http://local:18088/xxl-job-admin/</a></p>
<p>admin/123456</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611144216890.png" alt="image-20230611144216890"></p>
<h4 id="配置调度中心（部署到linux）"><a href="#配置调度中心（部署到linux）" class="headerlink" title="配置调度中心（部署到linux）"></a>配置调度中心（部署到linux）</h4><p>将项目打包，放到linux上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611144530662.png" alt="image-20230611144530662"></p>
<pre class="line-numbers language-none"><code class="language-none">nohup java -jar &#x2F;绝对路径&#x2F;xxl-job-admin-2.3.1.jar &amp;


nohup java -jar &#x2F;usr&#x2F;local&#x2F;myjp&#x2F;xxl-job-admin-2.3.1.jar &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611145741004.png" alt="image-20230611145741004"></p>
<p>成功！</p>
<h4 id=""><a href="#" class="headerlink" title=" "></a> </h4><p>执行器是部署在微服务（实例）中的</p>
<h4 id="配置执行器"><a href="#配置执行器" class="headerlink" title="配置执行器"></a>配置执行器</h4><p>下面配置执行器，执行器负责与调度中心通信，接收调度中心发起的任务调度请求</p>
<p>1、配置：首先在media-service工程中添加依赖（父工程中完成了版本控制，这里的版本是2.3.1）</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.xuxueli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>xxl-job-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>2、将执行器服务上报给xxl job，那么在 nacos 配置中心中 对    media-service-dev.yaml 添加配置</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span> 
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>18088/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>process<span class="token punctuation">-</span>service
      <span class="token key atrule">address</span><span class="token punctuation">:</span> 
      <span class="token key atrule">ip</span><span class="token punctuation">:</span> 
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job/jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3、配置xxl-job的执行器配置类，放在 service config中</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxlJobConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">XxlJobConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.admin.addresses&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> adminAddresses<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.accessToken&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.executor.appname&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appname<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.executor.address&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.executor.ip&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.executor.port&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.executor.logpath&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> logPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;xxl.job.executor.logretentiondays&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> logRetentionDays<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">XxlJobSpringExecutor</span> <span class="token function">xxlJobExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">">>>>>>>>>>> xxl-job config init."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XxlJobSpringExecutor</span> xxlJobSpringExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XxlJobSpringExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAdminAddresses</span><span class="token punctuation">(</span>adminAddresses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAppname</span><span class="token punctuation">(</span>appname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogPath</span><span class="token punctuation">(</span>logPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogRetentionDays</span><span class="token punctuation">(</span>logRetentionDays<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> xxlJobSpringExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
    * 针对多网卡、容器内部署等情况，可借助 "spring-cloud-commons" 提供的 "InetUtils" 组件灵活定制注册IP；
    *
    *      1、引入依赖：
    *          &lt;dependency>
    *             &lt;groupId>org.springframework.cloud&lt;/groupId>
    *             &lt;artifactId>spring-cloud-commons&lt;/artifactId>
    *             &lt;version>$&#123;version&#125;&lt;/version>
    *         &lt;/dependency>
    *
    *      2、配置文件，或者容器启动变量
    *          spring.cloud.inetutils.preferred-networks: 'xxx.xxx.xxx.'
    *
    *      3、获取IP
    *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();
    */</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4、进入调度中心，添加执行器</p>
<p>如，我们要添加一个media-process-service   的执行器；（因为刚才我们在配置文件里面就是写的那个appName）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611154607311.png" alt="image-20230611154607311"></p>
<p>5、重启媒资管理服务模块，可以看到执行器在调入中心注册成功</p>
<p>报错：</p>
<p> Could not resolve placeholder ‘xxl.job.executor.address’ in value “${xxl.job.executor.address}”、</p>
<p>emmm 发现解析不了，干脆删除得了 (注意把配置文件一级配置类里面的 address 以及 ip 相关语句全部注释掉)</p>
<p>最后发现成功，就是这里的ip比较纳闷。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611165539385.png" alt="image-20230611165539385"></p>
<h4 id="执行任务"><a href="#执行任务" class="headerlink" title="执行任务"></a><strong>执行任务</strong></h4><p>下边编写任务，参考示例工程中任务类的编写方法</p>
<p>在媒资服务service包下新建jobhandler存放任务类，下边参考示例工程编写一个任务类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>service<span class="token punctuation">.</span>jobhandler</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleJob</span> <span class="token punctuation">&#123;</span>

 <span class="token comment">/**
  * 1、简单任务示例（Bean模式）
  */</span>
     <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"testJob"</span><span class="token punctuation">)</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始执行....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="在调度中心分配任务"><a href="#在调度中心分配任务" class="headerlink" title="在调度中心分配任务"></a>在调度中心分配任务</h4><p>在调度中心新建任务</p>
<p>选定执行器</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611172056417.png" alt="image-20230611172056417" style="zoom:50%;" /></p>
<h5 id="CRON表达式："><a href="#CRON表达式：" class="headerlink" title="CRON表达式："></a>CRON表达式：</h5><ul>
<li>每隔三秒执行一次</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611172247866.png" alt="image-20230611172247866" style="zoom:67%;" /></p>
<ul>
<li>每隔10分钟执行一次</li>
</ul>
<p>1、取消每秒</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611172725443.png" alt="image-20230611172725443" style="zoom:33%;" /></p>
<p>2、选分钟设置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611172828958.png" alt="image-20230611172828958" style="zoom:33%;" /></p>
<p>3、每天的 1点0分0秒</p>
<p>指定小时</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611173021725.png" alt="image-20230611173021725" style="zoom:33%;" /></p>
<p>指定分钟</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611173046161.png" alt="image-20230611173046161" style="zoom:33%;" /></p>
<p>指定秒</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611173106949.png" alt="image-20230611173106949" style="zoom:33%;" /></p>
<p>现在设置每5秒执行一次</p>
<p>0/5 <em> </em> <em> </em> ?</p>
<p>设置任务名称，@XxlJob(“testJob”) 中的 “testJob” 将其复制在下面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611173527652.png" alt="image-20230611173527652"></p>
<p>其他的不用配置</p>
<p>启动任务</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611173726084.png" alt="image-20230611173726084" style="zoom:33%;" /></p>
<p>可以看到任务成功启动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611173753366.png" alt="image-20230611173753366"></p>
<h5 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h5><h6 id="路由策略"><a href="#路由策略" class="headerlink" title="路由策略"></a>路由策略</h6><p>我们最常见的就是路由策略就是 固定、轮询、一致性哈希、随机 这五种</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611204339900.png" alt="image-20230611204339900"></p>
<p>第一个/ 最后一个：（固定） </p>
<p>轮询：</p>
<p>随机：</p>
<p>一致性哈希：</p>
<pre><code>- 普通哈希： 哈希值取模：缺点当模的数量改变时，前面的那些 全部失效，需要重新计算模值
- 一致性哈希：构成一个hash环，服务器（映射到环上）将其分段、 再讲任务映射到环上，当增加或减少服务器时是由一部分需要重新映射见下图
</code></pre><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611205754686.png" alt="image-20230611205754686" style="zoom:50%;" /></p>
<p>这里只有任务3需要重新映射，其他的都不需要重新映射</p>
<h6 id="调度过期策略"><a href="#调度过期策略" class="headerlink" title="调度过期策略"></a><strong>调度过期策略</strong></h6><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611222215428.png" alt="image-20230611222215428" style="zoom:67%;" /></p>
<p>忽略，如果上次调度没成功/过期，执行器的动作</p>
<h6 id="阻塞策略（相当于线程池的拒绝策略）"><a href="#阻塞策略（相当于线程池的拒绝策略）" class="headerlink" title="阻塞策略（相当于线程池的拒绝策略）"></a>阻塞策略（相当于线程池的拒绝策略）</h6><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611222426332.png" alt="image-20230611222426332" style="zoom:50%;" /></p>
<p>单机串型：暂时阻塞住</p>
<p>丢弃后续：被阻塞的丢弃</p>
<p>覆盖： 停止当前，调用当前</p>
<p>文档：</p>
<pre class="line-numbers language-none"><code class="language-none">高级配置：
    - 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；
        FIRST（第一个）：固定选择第一个机器；
        LAST（最后一个）：固定选择最后一个机器；
        ROUND（轮询）：；
        RANDOM（随机）：随机选择在线的机器；
        CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。
        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；
        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；
        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；
        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；
        SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；

    - 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度，通过子任务可以实现一个任务执行完成去执行另一个任务。
    - 调度过期策略：
        - 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；
        - 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；
    - 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；
        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；
        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；
        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；
    - 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；
    - 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="分片广播"><a href="#分片广播" class="headerlink" title="分片广播"></a>分片广播</h5><p>下边要重点说的是分片广播策略，分片是指是调度中心以执行器为维度进行分片，将集群中的执行器标上序号：0，1，2，3…，广播是指每次调度会向集群中的所有执行器发送任务调度，请求中携带分片参数。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611222822660.png" alt="image-20230611222822660" style="zoom:50%;" /></p>
<p>每个执行器收到调度请求同时接收分片参数。<br>xxl-job支持动态扩容执行器集群从而动态增加分片数量，当有任务量增加可以部署更多的执行器到集群中，调度中心会动态修改分片的数量。</p>
<p><strong>作业分片适用哪些场景呢？</strong></p>
<p>•     分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p>
<p>•     广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等。</p>
<p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p>
<p>Java语言任务获取分片参数方式：</p>
<p>BEAN、GLUE模式(Java)，可参考Sample示例执行器中的示例任务</p>
<p>下边测试作业分片：</p>
<p>1、定义作业分片的任务方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
  * 2、分片广播任务
  */</span>
 <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"shardingJobHandler"</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shardingJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">// 分片参数</span>
  <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"分片参数：当前分片序号 = &#123;&#125;, 总分片数 = &#123;&#125;"</span><span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始执行第"</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">"批任务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2、 开启多个实例 注意在配置文件中设置本地优先</p>
<pre class="line-numbers language-none"><code class="language-none"># 配置本地优先
  cloud:
    config:
      override-none: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">-Dserver.port&#x3D;63051 -Dxxl.job.executor.port&#x3D;9998
-Dserver.port&#x3D;63052 -Dxxl.job.executor.port&#x3D;9997<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>3、查看执行器是否注册到xxljob</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611224821109.png" alt="image-20230611224821109"></p>
<p>4、 调度任务</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611225201735.png" alt="image-20230611225201735" style="zoom:33%;" /></p>
<p>5、查看</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611225138105.png" alt="image-20230611225138105"></p>
<h4 id="保证任务不重复执行（一个任务分一个执行器）"><a href="#保证任务不重复执行（一个任务分一个执行器）" class="headerlink" title="保证任务不重复执行（一个任务分一个执行器）"></a><strong>保证任务不重复执行</strong>（一个任务分一个执行器）</h4><p>调度中心给每一个执行器分一个分片序号</p>
<p>任务 有不同的 id</p>
<p>方案： 求余 用任务的编号 id  除以 分片总数 求余 ，余数等于几就给对应的执行器执行</p>
<p>保证不重复执行的方式：</p>
<p>1、<strong>分配</strong>：调度器按照分片广播的方式调度执行器，每个执行器只有唯一的分片号。保证一个任务只分配到一个 执行器 ：求余</p>
<p>2、过期策略： 选择 忽略，过期了就忽略- 下次不过期再执行</p>
<p>3、<strong>阻塞处理策略</strong>：丢弃后续调度或单机串行方式 不要选择覆盖执行即可</p>
<p>4、<strong>任务的处理的幂等性</strong>（处理完设置状态/乐观锁）：一次请求和多次请求应该有同样的结果（解决重复支付、恶意刷单）</p>
<p>任务的幂等性如何保证？避免重复提交插入多条等i情况</p>
<p>1、数据库约束，通过唯一索引提交，只有一次提交成功</p>
<p>2、乐观锁： 版本号，只有版本号/状态对了才能进入，进入更改版本号</p>
<p>3、序列号：如 订单号， 一个订单生成时会附带一个token给用户，同时在内存（redis）中记录 token ，用户提交订单时，会将token id 再发给客户端，服务端清理 token并处理任务。 如果客户重复下单，服务器查询内存中是否存在，只有不存在的才会处理。</p>
<h4 id="视频处理整体流程"><a href="#视频处理整体流程" class="headerlink" title="视频处理整体流程"></a>视频处理整体流程</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611233039623.png" alt="image-20230611233039623"></p>
<p>所以再 上传数据库那里，上传完视频，要把要转码的视频 添加到一个转码任务表中。</p>
<p>转码流程如下</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611233155701.png" alt="image-20230611233155701" style="zoom:67%;" /></p>
<p>1、任务调度中心广播作业分片。</p>
<p>2、执行器收到广播作业分片，从数据库读取待处理任务，读取未处理及处理失败的任务。</p>
<p>3、执行器更新任务为处理中，根据任务内容从MinIO下载要处理的文件。</p>
<p>4、执行器启动多线程去处理任务。</p>
<p>5、任务处理完成，上传处理后的视频到MinIO。</p>
<p>6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p>
<h5 id="步骤1：上传视频时添加任务"><a href="#步骤1：上传视频时添加任务" class="headerlink" title="步骤1：上传视频时添加任务"></a>步骤1：上传视频时添加任务</h5><p>上传视频成功向视频处理待处理表添加记录，暂时只添加对avi视频的处理记录。</p>
<p>根据MIME Type去判断是否是avi视频，下边列出部分MIME Type</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230611234413035.png" alt="image-20230611234413035"></p>
<pre class="line-numbers language-diff" data-language="diff"><code class="language-diff"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">@Transactional
</span><span class="token prefix unchanged"> </span><span class="token line">public MediaFiles addMediaFilesToDb(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket,String objectName)&#123;
</span><span class="token prefix unchanged"> </span><span class="token line"> //从数据库查询文件
</span><span class="token prefix unchanged"> </span><span class="token line"> MediaFiles mediaFiles = mediaFilesMapper.selectById(fileMd5);
</span><span class="token prefix unchanged"> </span><span class="token line"> if (mediaFiles == null) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles = new MediaFiles();
</span><span class="token prefix unchanged"> </span><span class="token line">  //拷贝基本信息
</span><span class="token prefix unchanged"> </span><span class="token line">  BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setId(fileMd5);
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setFileId(fileMd5);
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setCompanyId(companyId);
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setUrl("/" + bucket + "/" + objectName);
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setBucket(bucket);
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setFilePath(objectName);
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setCreateDate(LocalDateTime.now());
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setAuditStatus("002003");
</span><span class="token prefix unchanged"> </span><span class="token line">  mediaFiles.setStatus("1");
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">  // 获取源文件名的contentType
</span><span class="token prefix unchanged"> </span><span class="token line">  String contentType = getMimeType(objectName);
</span><span class="token prefix unchanged"> </span><span class="token line">  // 如果是图片格式或者mp4格式，则设置URL属性，否则不设置
</span><span class="token prefix unchanged"> </span><span class="token line">  if (contentType.contains("image") || contentType.contains("mp4")) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">    mediaFiles.setUrl("/" + bucket + "/" + objectName);
</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">  //保存文件信息到文件表
</span><span class="token prefix unchanged"> </span><span class="token line">  int insert = mediaFilesMapper.insert(mediaFiles);
</span><span class="token prefix unchanged"> </span><span class="token line">  if (insert &lt; 0) &#123;
</span><span class="token prefix unchanged"> </span><span class="token line">   log.error("保存文件信息到数据库失败,&#123;&#125;",mediaFiles.toString());
</span><span class="token prefix unchanged"> </span><span class="token line">   XuechengPlusException.cast("保存文件信息失败");
</span><span class="token prefix unchanged"> </span><span class="token line">  &#125;
</span><span class="token prefix unchanged"> </span><span class="token line">  
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  // 如果是avi视频，则额外添加至视频待处理表
</span><span class="token prefix inserted">+</span><span class="token line">  if ("video/x-msvideo".equals(contentType)) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">      MediaProcess mediaProcess = new MediaProcess();
</span><span class="token prefix inserted">+</span><span class="token line">      BeanUtils.copyProperties(mediaFiles, mediaProcess);
</span><span class="token prefix inserted">+</span><span class="token line">      mediaProcess.setStatus("1"); // 未处理
</span><span class="token prefix inserted">+</span><span class="token line">      int processInsert = mediaProcessMapper.insert(mediaProcess);
</span><span class="token prefix inserted">+</span><span class="token line">      if (processInsert &lt;= 0) &#123;
</span><span class="token prefix inserted">+</span><span class="token line">         XuechengPlusException.cast("保存avi视频到待处理表失败");
</span><span class="token prefix inserted">+</span><span class="token line">      &#125;
</span><span class="token prefix inserted">+</span><span class="token line">  &#125;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   
</span><span class="token prefix unchanged"> </span><span class="token line">  log.debug("保存文件信息到数据库成功,&#123;&#125;",mediaFiles.toString());
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &#125;
</span><span class="token prefix unchanged"> </span><span class="token line"> return mediaFiles;
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="步骤2：-查询待处理任务"><a href="#步骤2：-查询待处理任务" class="headerlink" title="步骤2： 查询待处理任务"></a>步骤2： 查询待处理任务</h5><p>如何保证查询到的待处理视频记录不重复？</p>
<p>select * from 任务处理表  where 任务id%分片总数 = 分片id  and 状态位未处理或者处理实拍  and 重复次数&lt;3 limit 线程数</p>
<p>Mapper</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaProcessMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @description 根据分片参数获取待处理任务
     * @param shardTotal  分片总数
     * @param shardindex  分片序号
     * @param count 任务数
     * @return java.util.List&lt;com.xuecheng.media.model.po.MediaProcess> 
     * @date 2022/9/14 8:54
    */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from media_process t where t.id % #&#123;shardTotal&#125; = #&#123;shardIndex&#125; and (t.status = '1' or t.status = '3') and t.fail_count &lt; 3 limit #&#123;count&#125;"</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span> <span class="token function">selectListByShardIndex</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"shardTotal"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"shardIndex"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>service</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaFileProcessService</span> <span class="token punctuation">&#123;</span>


    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span> <span class="token function">getMediaProcessList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>service接口实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaFileProcessServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MediaFileProcessService</span> <span class="token punctuation">&#123;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaProcessMapper</span> mediaProcessMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span> <span class="token function">getMediaProcessList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span> mediaProcesses <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">selectListByShardIndex</span><span class="token punctuation">(</span>shardTotal<span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> mediaProcesses<span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>


<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="步骤3：实现分布式锁"><a href="#步骤3：实现分布式锁" class="headerlink" title="步骤3：实现分布式锁"></a>步骤3：实现分布式锁</h5><p>如果是多个执行器分布式部署，并不能保证同一个视频只有一个执行器去处理。所以使用分布式锁</p>
<p>分布式锁的实现方式</p>
<p>实现分布式锁的方案有很多，常用的如下：</p>
<p>1、基于数据库实现分布锁</p>
<p>利用数据库主键唯一性的特点，或利用数据库唯一索引、行级锁的特点，多个线程同时去更新相同的记录，谁更新成功谁就抢到锁。</p>
<p>2、基于redis实现锁</p>
<p>redis提供了分布式锁的实现方案，比如：SETNX、set nx、redisson等。</p>
<p>拿SETNX举例说明，SETNX命令的工作过程是去set一个不存在的key，多个线程去设置同一个key只会有一个线程设置成功，设置成功的的线程拿到锁。</p>
<p>3、使用zookeeper实现</p>
<p>zookeeper是一个分布式协调服务，主要解决分布式程序之间的同步的问题。zookeeper的结构类似的文件目录，多线程向zookeeper创建一个子目录(节点)只会有一个创建成功，利用此特点可以实现分布式锁，谁创建该结点成功谁就获得锁</p>
<p>我们这里选择第一种方式</p>
<p>用更新数据库唯一索引的语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> media_process m <span class="token keyword">set</span> m<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'4'</span> <span class="token keyword">where</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">or</span> m<span class="token punctuation">.</span><span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'3'</span><span class="token punctuation">)</span> <span class="token operator">and</span> m<span class="token punctuation">.</span>fail_count<span class="token operator">&lt;</span><span class="token number">3</span> <span class="token operator">and</span> m<span class="token punctuation">.</span>id<span class="token operator">=</span>?<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果是多个线程去执行该sql都将会执行成功，但需求是只能有一个线程抢到锁，所以此sql无法满足需求。</p>
<p>仔细想想这其实是一种CAS乐观锁</p>
<p>1、mapper</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;**
 * 开启一个任务
 * @param id 任务id
 * @return 更新记录数
 *&#x2F;
@Update(&quot;update media_process m set m.status&#x3D;&#39;4&#39; where (m.status&#x3D;&#39;1&#39; or m.status&#x3D;&#39;3&#39;) and m.fail_count&lt;3 and m.id&#x3D;#&#123;id&#125;&quot;)
int startTask(@Param(&quot;id&quot;) long id);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2、service方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 *  开启一个任务
 * @param id 任务id
 * @return true开启任务成功，false开启任务失败
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startTask</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//实现如下</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startTask</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">startTask</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token operator">?</span><span class="token boolean">false</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="步骤4：更新任务状态"><a href="#步骤4：更新任务状态" class="headerlink" title="步骤4：更新任务状态"></a>步骤4：更新任务状态</h5><p>任务结束需要更新任务状态在MediaFileProcessService接口添加方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">void</span> <span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token class-name">Long</span> taskId<span class="token punctuation">,</span><span class="token class-name">String</span> status<span class="token punctuation">,</span><span class="token class-name">String</span> fileId<span class="token punctuation">,</span><span class="token class-name">String</span> url<span class="token punctuation">,</span><span class="token class-name">String</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token class-name">Long</span> taskId<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> fileId<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMsg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//查出任务，如果不存在则直接返回</span>
    <span class="token class-name">MediaProcess</span> mediaProcess <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mediaProcess <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//处理失败，更新任务处理结果</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span> queryWrapperById <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MediaProcess</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//处理失败</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">MediaProcess</span> mediaProcess_u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcess_u<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcess_u<span class="token punctuation">.</span><span class="token function">setErrormsg</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcess_u<span class="token punctuation">.</span><span class="token function">setFailCount</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getFailCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcessMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>mediaProcess_u<span class="token punctuation">,</span>queryWrapperById<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"更新任务处理状态为失败，任务信息:&#123;&#125;"</span><span class="token punctuation">,</span>mediaProcess_u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//任务处理成功</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mediaFiles<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//更新媒资文件中的访问url</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFilesMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//处理成功，更新url和状态</span>
    mediaProcess<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcess<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcess<span class="token punctuation">.</span><span class="token function">setFinishDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcessMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//添加到历史记录</span>
    <span class="token class-name">MediaProcessHistory</span> mediaProcessHistory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaProcessHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">,</span> mediaProcessHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaProcessHistoryMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaProcessHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//删除mediaProcess</span>
    mediaProcessMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="步骤5：任务（处理视频）"><a href="#步骤5：任务（处理视频）" class="headerlink" title="步骤5：任务（处理视频）"></a>步骤5：任务（处理视频）</h5><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数。</p>
<p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待则添加超时设置，到达超时时间还没有处理完成仍结束任务。</p>
<p>在之前的jobhander包下创建执行器类，里面编写 对应的视频处理方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoTask</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaFileService</span> mediaFileService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaFileProcessService</span> mediaFileProcessService<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;videoprocess.ffmpegpath&#125;"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> ffmpegpath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"videoJobHandler"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">videoJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 分片参数</span>
    <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">></span></span> mediaProcessList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//取出cpu核心数作为一次处理数据的条数</span>
        <span class="token comment">// int processors = Runtime.getRuntime().availableProcessors();</span>
        <span class="token keyword">int</span> processors<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//一次处理视频数量不要超过cpu核心数</span>
        mediaProcessList <span class="token operator">=</span> mediaFileProcessService<span class="token punctuation">.</span><span class="token function">getMediaProcessList</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">,</span> processors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> mediaProcessList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"取出待处理视频任务&#123;&#125;条"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//启动size个线程的线程池</span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//计数器</span>
    <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将处理任务加入线程池</span>
    mediaProcessList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>mediaProcess <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//任务id</span>
                <span class="token class-name">Long</span> taskId <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//抢占任务</span>
                <span class="token keyword">boolean</span> b <span class="token operator">=</span> mediaFileProcessService<span class="token punctuation">.</span><span class="token function">startTask</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"开始执行任务:&#123;&#125;"</span><span class="token punctuation">,</span> mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//下边是处理逻辑</span>
                <span class="token comment">//桶</span>
                <span class="token class-name">String</span> bucket <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//存储路径</span>
                <span class="token class-name">String</span> filePath <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//原始视频的md5值</span>
                <span class="token class-name">String</span> fileId <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//原始文件名称</span>
                <span class="token class-name">String</span> filename <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将要处理的文件下载到服务器上</span>
                <span class="token class-name">File</span> originalFile <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>originalFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"下载待处理文件失败,originalFile:&#123;&#125;"</span><span class="token punctuation">,</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"下载待处理文件失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">//处理结束的视频文件</span>
                <span class="token class-name">File</span> mp4File <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    mp4File <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"mp4"</span><span class="token punctuation">,</span> <span class="token string">".mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"创建mp4临时文件失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"创建mp4临时文件失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">//视频处理结果</span>
                <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//开始处理视频</span>
                    <span class="token class-name">Mp4VideoUtil</span> videoUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mp4VideoUtil</span><span class="token punctuation">(</span>ffmpegpath<span class="token punctuation">,</span> originalFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mp4File<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mp4File<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//开始视频转换，成功将返回success</span>
                    result <span class="token operator">=</span> videoUtil<span class="token punctuation">.</span><span class="token function">generateMp4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"处理视频文件:&#123;&#125;,出错:&#123;&#125;"</span><span class="token punctuation">,</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//记录错误信息</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"处理视频失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;"</span><span class="token punctuation">,</span> bucket <span class="token operator">+</span> filePath<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
    
                <span class="token comment">//将mp4上传至minio</span>
                <span class="token comment">//mp4在minio的存储路径</span>
                <span class="token class-name">String</span> objectName <span class="token operator">=</span> <span class="token function">getFilePath</span><span class="token punctuation">(</span>fileId<span class="token punctuation">,</span> <span class="token string">".mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//访问url</span>
                <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> objectName<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    mediaFileService<span class="token punctuation">.</span><span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>mp4File<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"video/mp4"</span><span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"上传视频失败或入库失败,视频地址:&#123;&#125;,错误信息:&#123;&#125;"</span><span class="token punctuation">,</span> bucket <span class="token operator">+</span> objectName<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//最终还是失败了</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"处理后视频上传或入库失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span>
    countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">String</span> fileExt<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span>   fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span>fileMd5 <span class="token operator">+</span>fileExt<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h5><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612094148377.png" alt="image-20230612094148377" style="zoom:50%;" /></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612094209380.png" alt="image-20230612094209380" style="zoom: 50%;" /></p>
<p>处理中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612103411651.png" alt="image-20230612103411651"></p>
<p>处理后</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612103451085.png" alt="image-20230612103451085"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612103818150.png" alt="image-20230612103818150"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612103649060.png" alt="image-20230612103649060"></p>
<p>1、xxl-job的工作原理是什么? xxl-job是什么怎么工作?<br>XXL-JOB分布式任务调度服务由调用中心和执行器组成，调用中心负责按任务调度策略向执行器下发任务，执行器负责接收任务执行任务。<br>1)首先部署并启动xxl-job调度中心。(一个java工程)</p>
<p>2）首先在微服务添加xxl-job依赖，在微服务中配置执行器</p>
<p>3)启动微服务，执行器向调度中心上报自己。<br>4）在微服务中写一个任务方法并用xxl-job的注解去标记执行任务的方法名称。<br>5)在调度中心配置任务调度策略，调度策略就是每隔多长时间执行还是在每天或每月的固定时间去执行，比如每天0点执行，或每隔1小时执行一次等。<br>6)在调度中心启动任务。<br>7)）调度中心根据任务调度策略，到达时间就开始下发任务给执行器。8）执行器收到任务就开始执行任务。</p>
<h2 id="功能-5：绑定媒资"><a href="#功能-5：绑定媒资" class="headerlink" title="功能 5：绑定媒资"></a>功能 5：绑定媒资</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612110207095.png" alt="image-20230612110207095"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612111036120.png" alt="image-20230612111036120"></p>
<p>在内容管理模块定义请求参数模型类型：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ApiModel</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"BindTeachplanMediaDto"</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"教学计划-媒资绑定提交数据"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BindTeachplanMediaDto</span> <span class="token punctuation">&#123;</span>

<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"媒资文件id"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"媒资文件名称"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> fileName<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程计划标识"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> teachplanId<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a>接口定义</h3><pre class="line-numbers language-none"><code class="language-none">@ApiOperation(value &#x3D; &quot;课程计划和媒资信息绑定&quot;)
@PostMapping(&quot;&#x2F;teachplan&#x2F;association&#x2F;media&quot;)
public void associationMedia(@RequestBody BindTeachplanMediaDto bindTeachplanMediaDto)&#123;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接口开发-3"><a href="#接口开发-3" class="headerlink" title="接口开发"></a>接口开发</h3><p>service</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">TeachplanMedia</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>serviceImpl</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Transactional</span>
 <span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TeachplanMedia</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token comment">//教学计划id</span>
 <span class="token class-name">Long</span> teachplanId <span class="token operator">=</span> bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getTeachplanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Teachplan</span> teachplan <span class="token operator">=</span> teachplanMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>teachplan<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"教学计划不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token class-name">Integer</span> grade <span class="token operator">=</span> teachplan<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>grade<span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"只允许第二级教学计划绑定媒资文件"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">//课程id</span>
 <span class="token class-name">Long</span> courseId <span class="token operator">=</span> teachplan<span class="token punctuation">.</span><span class="token function">getCourseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//先删除原来该教学计划绑定的媒资</span>
 teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanMedia</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TeachplanMedia</span><span class="token operator">::</span><span class="token function">getTeachplanId</span><span class="token punctuation">,</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//再添加教学计划与媒资的绑定关系</span>
 <span class="token class-name">TeachplanMedia</span> teachplanMedia <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TeachplanMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setCourseId</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setTeachplanId</span><span class="token punctuation">(</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setMediaFilename</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setMediaId</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getMediaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>teachplanMedia<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> teachplanMedia<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口完善</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"课程计划和媒资信息绑定"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/teachplan/association/media"</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    teachplanService<span class="token punctuation">.</span><span class="token function">associationMedia</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612112848450.png" alt="image-20230612112848450"></p>
<h2 id="功能6：解除绑定"><a href="#功能6：解除绑定" class="headerlink" title="功能6：解除绑定"></a>功能6：解除绑定</h2><pre class="line-numbers language-none"><code class="language-none">delete &#x2F;teachplan&#x2F;association&#x2F;media&#x2F;&#123;teachPlanId&#125;&#x2F;&#123;mediaId&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接口定义</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程计划解除媒资信息绑定"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unassociationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>service</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** 解绑教学计划与媒资信息
 * @param teachPlanId       教学计划id
 * @param mediaId           媒资信息id
 */</span>
<span class="token keyword">void</span> <span class="token function">unassociationMedia</span><span class="token punctuation">(</span><span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span> <span class="token class-name">Long</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口实现</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unassociationMedia</span><span class="token punctuation">(</span><span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span> <span class="token class-name">Long</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanMedia</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TeachplanMedia</span><span class="token operator">::</span><span class="token function">getTeachplanId</span><span class="token punctuation">,</span> teachPlanId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TeachplanMedia</span><span class="token operator">::</span><span class="token function">getMediaId</span><span class="token punctuation">,</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完善</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程计划解除媒资信息绑定"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unassociationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    teachplanService<span class="token punctuation">.</span><span class="token function">unassociationMedia</span><span class="token punctuation">(</span>teachPlanId<span class="token punctuation">,</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现报错，</p>
<p>这不关我的事了吧没传过来居然是null ，我怎么搞？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230612115839009.png" alt="image-20230612115839009"></p>
<p>完毕</p>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91-md/" title="类MOOC系统开发3-课程发布模块开发.md"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">类MOOC系统开发3-课程发布模块开发.md</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/25/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%911-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发1-内容管理模块开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230525224811.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">类MOOC系统开发1-内容管理模块开发</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">taotaozi</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/differencer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/differencer?type=blog" target="_blank" title="Github"><i class="fab fa-CSDN"></i></a><a class="social-icon" href="https://space.bilibili.com/20713910" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a><a class="social-icon" href="/473439851" target="_blank" title="steam"><i class="fab fa-steam"></i></a><a class="social-icon" href="https://weibo.com/u/5856795355" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="mailto:1359114644@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">最近的新任务是 ： 努力啊</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E5%A4%A7%E4%BD%93%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-text">媒资管理大体功能介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86"><span class="toc-text">为什么要媒资管理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%88gateway%EF%BC%89"><span class="toc-text">搭建网关微服务（gateway）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud"><span class="toc-text">Spring Cloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BANacos"><span class="toc-text">搭建Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E6%8A%A5%EF%BC%88%E6%B3%A8%E5%86%8C%EF%BC%89%E6%9C%8D%E5%8A%A1"><span class="toc-text">上报（注册）服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E6%8A%A5%E5%9B%9B%E8%A6%81%E7%B4%A0"><span class="toc-text">上报四要素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">配置服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%88%E8%A2%AB%EF%BC%89%E9%85%8D%E7%BD%AE%E4%B8%89%E8%A6%81%E7%B4%A0"><span class="toc-text">（被）配置三要素</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">本地配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nacos%E9%85%8D%E7%BD%AE"><span class="toc-text">nacos配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%94%B9%E8%BF%9B"><span class="toc-text">配置改进</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEservice"><span class="toc-text">配置service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#api-%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE"><span class="toc-text">api 扩展配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">公用配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7%E9%97%AE%E9%A2%98"><span class="toc-text">配置优先级问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%A1%BA%E5%BA%8F"><span class="toc-text">读取顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7%E9%A1%BA%E5%BA%8F"><span class="toc-text">配置优先级顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B%EF%BC%9A%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%A4%9A%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="toc-text">举例：启动一个服务多个实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9Anocas-%E8%AE%BE%E7%BD%AE%E6%9C%AC%E5%9C%B0%E4%BC%98%E5%85%88"><span class="toc-text">解决方案：nocas 设置本地优先</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3"><span class="toc-text">搭建网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E7%BD%91%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-text">导入网关依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%AB%AF%E9%85%8D%E7%BD%AE-%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5"><span class="toc-text">远端配置(路由策略)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%AA%92%E8%B5%84%E5%B7%A5%E7%A8%8B"><span class="toc-text">搭建媒资工程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">分布式文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">什么是分布式文件系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MinIO"><span class="toc-text">MinIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-MinIO"><span class="toc-text">安装 MinIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#windows"><span class="toc-text">windows</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#linux"><span class="toc-text">linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MinIO-java-SDK%E9%85%8D%E7%BD%AE"><span class="toc-text">MinIO java SDK配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%AE%98%E6%96%B9%E7%BB%99%E5%87%BA%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B"><span class="toc-text">分析官方给出的代码如下</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%B5%8B%E8%AF%95"><span class="toc-text">上传测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%B5%8B%E8%AF%95"><span class="toc-text">删除测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%B5%8B%E8%AF%95"><span class="toc-text">查询测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%A0%A1%E9%AA%8C"><span class="toc-text">下载校验</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D%E8%8E%B7%E5%8F%96"><span class="toc-text">文件扩展名获取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MD5%E6%A0%A1%E9%AA%8C"><span class="toc-text">MD5校验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD1-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-text">功能1:上传文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-text">接口开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%96%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">完善接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%8E%A5%E5%8F%A3"><span class="toc-text">测试接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service%E4%BA%8B%E5%8A%A1%E4%BC%98%E5%8C%96%EF%BC%88%E4%BA%8B%E5%8A%A1%E6%B3%A8%E8%A7%A3%E5%A4%B1%E6%95%88%EF%BC%89"><span class="toc-text">Service事务优化（事务注解失效）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD2-%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%EF%BC%88%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-text">功能2:上传视频（断点续传功能实现）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-%E6%96%87%E4%BB%B6%E5%88%86%E5%9D%97%E4%B8%8A%E4%BC%A0"><span class="toc-text">文件的断点续传 - 解决方案 文件分块上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E8%BA%AB%EF%BC%9A%E6%96%87%E4%BB%B6%E5%88%86%E5%9D%97%E4%B8%8E%E5%90%88%E5%B9%B6"><span class="toc-text">热身：文件分块与合并</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E8%BA%AB%EF%BC%9Aminio%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6"><span class="toc-text">热身：minio文件合并</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89%EF%BC%9A"><span class="toc-text">接口定义：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-1"><span class="toc-text">接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%96%87%E4%BB%B6%E5%92%8C%E5%88%86%E5%9D%97"><span class="toc-text">检查文件和分块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%88%86%E5%9D%97%E6%96%87%E4%BB%B6"><span class="toc-text">上传分块文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E5%88%86%E5%9D%97"><span class="toc-text">合并分块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD3-%EF%BC%9A%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88"><span class="toc-text">功能3 ：文件预览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-text">接口定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-2"><span class="toc-text">接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEURL"><span class="toc-text">设置URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service%E5%BC%80%E5%8F%91"><span class="toc-text">Service开发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD4%EF%BC%9A%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%EF%BC%88%E8%A7%86%E9%A2%91%E8%BD%AC%E7%A0%81%EF%BC%89"><span class="toc-text">功能4：视频处理（视频转码）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B1%BB%E6%B5%8B%E8%AF%95"><span class="toc-text">工具类测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E8%BD%AC%E7%A0%81%EF%BC%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%EF%BC%89"><span class="toc-text">批量转码（分布式任务调度）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%EF%BC%9F"><span class="toc-text">什么是分布式任务调度？</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E4%B8%8B-%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-text">单机下 任务调度的实现方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E7%9B%AE%E6%A0%87"><span class="toc-text">分布式任务调度的目标</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E4%B8%AD%E9%97%B4%E4%BB%B6-xxl-job"><span class="toc-text">分布式任务调度中间件- xxl -job</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAXXL-JOB"><span class="toc-text">搭建XXL-JOB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%EF%BC%88%E9%83%A8%E7%BD%B2%E5%88%B0linux%EF%BC%89"><span class="toc-text">配置调度中心（部署到linux）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text"> </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-text">配置执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1"><span class="toc-text">执行任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E8%B0%83%E5%BA%A6%E4%B8%AD%E5%BF%83%E5%88%86%E9%85%8D%E4%BB%BB%E5%8A%A1"><span class="toc-text">在调度中心分配任务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CRON%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%9A"><span class="toc-text">CRON表达式：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-text">高级配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5"><span class="toc-text">路由策略</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="toc-text">调度过期策略</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E7%AD%96%E7%95%A5%EF%BC%88%E7%9B%B8%E5%BD%93%E4%BA%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5%EF%BC%89"><span class="toc-text">阻塞策略（相当于线程池的拒绝策略）</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%B9%BF%E6%92%AD"><span class="toc-text">分片广播</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E4%BB%BB%E5%8A%A1%E4%B8%8D%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%EF%BC%88%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E5%88%86%E4%B8%80%E4%B8%AA%E6%89%A7%E8%A1%8C%E5%99%A8%EF%BC%89"><span class="toc-text">保证任务不重复执行（一个任务分一个执行器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-text">视频处理整体流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41%EF%BC%9A%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%E6%97%B6%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1"><span class="toc-text">步骤1：上传视频时添加任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42%EF%BC%9A-%E6%9F%A5%E8%AF%A2%E5%BE%85%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1"><span class="toc-text">步骤2： 查询待处理任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A43%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">步骤3：实现分布式锁</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A44%EF%BC%9A%E6%9B%B4%E6%96%B0%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-text">步骤4：更新任务状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A45%EF%BC%9A%E4%BB%BB%E5%8A%A1%EF%BC%88%E5%A4%84%E7%90%86%E8%A7%86%E9%A2%91%EF%BC%89"><span class="toc-text">步骤5：任务（处理视频）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD-5%EF%BC%9A%E7%BB%91%E5%AE%9A%E5%AA%92%E8%B5%84"><span class="toc-text">功能 5：绑定媒资</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-text">接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-3"><span class="toc-text">接口开发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD6%EF%BC%9A%E8%A7%A3%E9%99%A4%E7%BB%91%E5%AE%9A"><span class="toc-text">功能6：解除绑定</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91-md/" title="类MOOC系统开发3-课程发布模块开发.md"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230612133618.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发3-课程发布模块开发.md"/></a><div class="content"><a class="title" href="/2023/06/12/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%913-%E8%AF%BE%E7%A8%8B%E5%8F%91%E5%B8%83%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91-md/" title="类MOOC系统开发3-课程发布模块开发.md">类MOOC系统开发3-课程发布模块开发.md</a><time datetime="2023-06-12T05:35:38.000Z" title="发表于 2023-06-12 13:35:38">2023-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发2-媒资管理模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发2-媒资管理模块开发"/></a><div class="content"><a class="title" href="/2023/06/01/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%912-%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发2-媒资管理模块开发">类MOOC系统开发2-媒资管理模块开发</a><time datetime="2023-06-01T07:27:10.000Z" title="发表于 2023-06-01 15:27:10">2023-06-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/25/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%911-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发1-内容管理模块开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230525224811.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发1-内容管理模块开发"/></a><div class="content"><a class="title" href="/2023/05/25/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%911-%E5%86%85%E5%AE%B9%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91/" title="类MOOC系统开发1-内容管理模块开发">类MOOC系统开发1-内容管理模块开发</a><time datetime="2023-05-25T14:46:56.000Z" title="发表于 2023-05-25 22:46:56">2023-05-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/22/%E7%AE%97%E6%B3%95_%E5%8D%95%E8%B0%83%E6%A0%88%E9%97%AE%E9%A2%98/" title="算法:单调栈问题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230522212237.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法:单调栈问题"/></a><div class="content"><a class="title" href="/2023/05/22/%E7%AE%97%E6%B3%95_%E5%8D%95%E8%B0%83%E6%A0%88%E9%97%AE%E9%A2%98/" title="算法:单调栈问题">算法:单调栈问题</a><time datetime="2023-05-22T13:20:06.000Z" title="发表于 2023-05-22 21:20:06">2023-05-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/22/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%910-%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="类MOOC系统开发0-项目基础环境搭建"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/20230522110116.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="类MOOC系统开发0-项目基础环境搭建"/></a><div class="content"><a class="title" href="/2023/05/22/%E7%B1%BBMOOC%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%910-%E9%A1%B9%E7%9B%AE%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="类MOOC系统开发0-项目基础环境搭建">类MOOC系统开发0-项目基础环境搭建</a><time datetime="2023-05-22T02:59:45.000Z" title="发表于 2023-05-22 10:59:45">2023-05-22</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/20230601152807.png')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By taotaozi</div><div class="footer_custom_text">世上最幸运的事就是喜欢上一个人</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'differencer/giscus',
    'data-repo-id': 'R_kgDOJMrL1A',
    'data-category-id': 'DIC_kwDOJMrL1M4CVC1y',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>