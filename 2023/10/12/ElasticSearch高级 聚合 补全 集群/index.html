<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>ElasticSearch高级 聚合 补全 集群 | tのblog</title><meta name="author" content="taotaozi"><meta name="copyright" content="taotaozi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="数据聚合 聚合(aggregations)可以让我们极其方便的实现对数据的统计、分析、运算。例如 什么品牌的手机最受欢迎？ 这些手机的平均价格、最高价格、最低价格？ 这些手机每月的销售情况如何？   实现这些统计功能的比数据库的SQL要方便很多，而且查询速度非常快，可以实现近实时搜索的效果  聚合的种类常见的聚合有三类  桶(Bucket)聚合：用来对文档分组  TermAggregation：按">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch高级 聚合 补全 集群">
<meta property="og:url" content="https://differencer.github.io/2023/10/12/ElasticSearch%E9%AB%98%E7%BA%A7%20%E8%81%9A%E5%90%88%20%E8%A1%A5%E5%85%A8%20%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="tのblog">
<meta property="og:description" content="数据聚合 聚合(aggregations)可以让我们极其方便的实现对数据的统计、分析、运算。例如 什么品牌的手机最受欢迎？ 这些手机的平均价格、最高价格、最低价格？ 这些手机每月的销售情况如何？   实现这些统计功能的比数据库的SQL要方便很多，而且查询速度非常快，可以实现近实时搜索的效果  聚合的种类常见的聚合有三类  桶(Bucket)聚合：用来对文档分组  TermAggregation：按">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 354273 sample.jpg">
<meta property="article:published_time" content="2023-10-12T09:05:52.000Z">
<meta property="article:modified_time" content="2023-04-13T08:50:21.511Z">
<meta property="article:author" content="taotaozi">
<meta property="article:tag" content="ElasticSearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 354273 sample.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://differencer.github.io/2023/10/12/ElasticSearch%E9%AB%98%E7%BA%A7%20%E8%81%9A%E5%90%88%20%E8%A1%A5%E5%85%A8%20%E9%9B%86%E7%BE%A4/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ElasticSearch高级 聚合 补全 集群',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-13 16:50:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 354273 sample.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="tのblog"><span class="site-name">tのblog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-sitemap"></i><span> 关于我</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly/"><i class="fa-fw fa fa-heart"></i><span> 关于主题</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ElasticSearch高级 聚合 补全 集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-12T09:05:52.000Z" title="发表于 2023-10-12 17:05:52">2023-10-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-13T08:50:21.511Z" title="更新于 2023-04-13 16:50:21">2023-04-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>43分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ElasticSearch高级 聚合 补全 集群"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="数据聚合"><a href="#数据聚合" class="headerlink" title="数据聚合"></a>数据聚合</h1><ul>
<li>聚合(aggregations)可以让我们极其方便的实现对数据的统计、分析、运算。例如<ol>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ol>
</li>
<li>实现这些统计功能的比数据库的SQL要方便很多，而且查询速度非常快，可以实现近实时搜索的效果</li>
</ul>
<h2 id="聚合的种类"><a href="#聚合的种类" class="headerlink" title="聚合的种类"></a>聚合的种类</h2><p>常见的聚合有三类</p>
<ol>
<li><p><code>桶(Bucket)聚合</code>：用来对文档分组</p>
<ul>
<li>TermAggregation：按照文档字段值分组，例如：按照<code>品牌名称</code>、<code>国家</code>分组</li>
<li>DateHistogram：按照日期阶梯分组，例如：<code>一周</code>为一组，或者<code>一月</code>为一组</li>
</ul>
</li>
<li><p><code>度量(Metric)聚合</code>：用于计算一些值，例如：最大值、最小值、平均值等</p>
<ul>
<li>Avg：求平均值</li>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求max、min、avg、sum等</li>
</ul>
</li>
<li><p><code>管道(pipeline)聚合</code>：以其他聚合的结果为基础做聚合</p>
</li>
</ol>
<p>   注意：<strong>参加聚合的字段必须是非分词字段</strong>，如keyword、日期、数值、布尔类型</p>
<h2 id="DSL实现聚合"><a href="#DSL实现聚合" class="headerlink" title="DSL实现聚合"></a>DSL实现聚合</h2><ul>
<li>现在，我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合</li>
</ul>
<h3 id="Bucket聚合语法"><a href="#Bucket聚合语法" class="headerlink" title="Bucket聚合语法"></a>Bucket聚合语法</h3><ul>
<li>基本语法如下<ul>
<li>聚合的三要素： 聚合名称（自定义）、聚合类型 （terms、stats等）、聚合字段</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">GET <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">&#123;</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                 <span class="token comment">// 定义聚合</span>
    <span class="token string">"NAME"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>               <span class="token comment">// 给聚合起个名字</span>
      <span class="token string">"AGG_TYPE"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token comment">// 聚合的类型</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例</p>
<pre class="line-numbers language-none"><code class="language-none">GET &#x2F;hotel&#x2F;_search
&#123;
  &quot;size&quot;: 0,                &#x2F;&#x2F; 设置size为0，结果中不包含文档，只包含聚合结果
  &quot;aggs&quot;: &#123;                 &#x2F;&#x2F; 定义聚合
    &quot;bucketAggName&quot;: &#123;      &#x2F;&#x2F; 给聚合起个名字
      &quot;terms&quot;: &#123;            &#x2F;&#x2F; 聚合的类型，这里按照品牌值聚合，所以选择terms
        &quot;field&quot;: &quot;brand&quot;,   &#x2F;&#x2F; 参与聚合的字段
        &quot;size&quot;: 5           &#x2F;&#x2F; 希望获取的聚合结果数量，由于品牌值可能很多，这里只获取5条看看效果
      &#125;
    &#125;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVSNss.png" alt="img"></p>
<h3 id="聚合结果排序"><a href="#聚合结果排序" class="headerlink" title="聚合结果排序"></a>聚合结果排序</h3><ul>
<li><p>默认情况下，Bucket聚合会统计Bucket内的文档数量，记为count，并且按照count降序排序</p>
</li>
<li><p>我们可以指定order属性，自定义聚合的排序方式</p>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">GET <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">&#123;</span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"bucketAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token string">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token string">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
        <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">5</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVSrJU.png" alt="img"></p>
<h3 id="限定聚合范围"><a href="#限定聚合范围" class="headerlink" title="限定聚合范围"></a>限定聚合范围</h3><ul>
<li>默认情况下，<strong>Bucket聚合是对索引库的所有文档做聚合。</strong>当数据量过大时，对内存消耗特别大</li>
<li>但真实场景下，用户会输入搜索条件</li>
<li>因此聚合必须是对<strong>搜索结果的聚合，那么聚合就必须添加限定条件</strong></li>
<li>我们可以限定要聚合的文档范围，只需要<strong>添加query条件</strong>即可</li>
<li>这里假设用户选择了1000元以上的酒店</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">GET <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">&#123;</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"gte"</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token comment">// 只对1000元以上的文档做聚合</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"bucketAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token string">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token string">"_count"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
        <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">5</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVpAwq.png" alt="img"></p>
<ul>
<li>从结果中看到，这次得到的酒店数量明显就减少了</li>
</ul>
<h3 id="Metric聚合语法"><a href="#Metric聚合语法" class="headerlink" title="Metric聚合语法"></a>Metric聚合语法</h3><ul>
<li>现在我们需要对桶内（如品牌）文档做运算，获取每个品牌的用户频分的min、max、avg等值</li>
<li><p>那么就需要用到Metric聚合了，例如stat聚合，就尅获取min、max、avg等值</p>
</li>
<li><p>语法如下</p>
</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"bucketAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"_count"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">5</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 是bucketAgg聚合的子聚合，也就是分组后对每组分别进行计算</span>
        <span class="token property">"scoreAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 子聚合名称</span>
          <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 聚合类型，stats可以计算min、max、avg等</span>
            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span>    <span class="token comment">// 聚合字段，这里计算用户评分的min、max、avg</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVp4ns.png" alt="img"></p>
<p>此外，我们还可以给聚合结果做排序，例如按照每个桶的酒店平均分做排序</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"bucketAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"scoreAgg.avg"</span><span class="token operator">:</span> <span class="token string">"desc"</span>    <span class="token comment">// 对scoreAgg.avg做降序排序</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">5</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"scoreAgg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSV9eHI.png" alt="img"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>aggs代表聚合，与query统计，此时query的作用是？<ul>
<li>限定聚合的文档范围</li>
</ul>
</li>
<li>聚合必须的三要素<ol>
<li>聚合名称</li>
<li>聚合类型</li>
<li>聚合字段</li>
</ol>
</li>
<li>聚合可配置的属性有<ol>
<li>size：指定聚合结果数量</li>
<li>order：指定聚合结果排序方式</li>
<li>field：指定聚合字段</li>
</ol>
</li>
</ul>
<h2 id="RestAPI实现聚合"><a href="#RestAPI实现聚合" class="headerlink" title="RestAPI实现聚合"></a>RestAPI实现聚合</h2><h3 id="API语法"><a href="#API语法" class="headerlink" title="API语法"></a>API语法</h3><ul>
<li><p>聚合条件与query统计，因此需要使用request.source()来指定聚合条件</p>
</li>
<li><p>聚合条件的语法</p>
<pre class="line-numbers language-JSON" data-language="JSON"><code class="language-JSON">request.source().size(0);
request.source().aggregation(
        AggregationBuilders
                .terms(&quot;brandAgg&quot;)
                .field(&quot;brand&quot;)
                .size(20));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVkiXF.png" alt="img"></p>
</li>
<li><p>聚合的结果解析也与之前的查询结果解析不同，API比较特殊，但同样也是JSON逐层解析</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);
Aggregations aggregations &#x3D; response.getAggregations();
Terms brandTerms &#x3D; aggregations.get(&quot;brandAgg&quot;);
List&lt;? extends Terms.Bucket&gt; buckets &#x3D; brandTerms.getBuckets();
for (Terms.Bucket bucket : buckets) &#123;
    String brandName &#x3D; bucket.getKeyAsString();
    System.out.println(brandName);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVk1ne.png" alt="img"></p>
</li>
<li><p>完整代码如下</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">@Test
void brandAggregationTest() throws IOException &#123;
    &#x2F;&#x2F; 1. 准备request对象
    SearchRequest request &#x3D; new SearchRequest(&quot;hotel&quot;);
    &#x2F;&#x2F; 2. 准备DSL
    &#x2F;&#x2F; 2.1 设置size
    request.source().size(0);
    &#x2F;&#x2F; 2.2 聚合
    request.source().aggregation(
            AggregationBuilders
                    .terms(&quot;brandAgg&quot;)
                    .field(&quot;brand&quot;)
                    .size(20));
    &#x2F;&#x2F; 3. 发出请求
    SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);
    &#x2F;&#x2F; 4. 解析结果
    Aggregations aggregations &#x3D; response.getAggregations();
    &#x2F;&#x2F; 4.1 根据聚合名称获取聚合结果
    Terms brandTerms &#x3D; aggregations.get(&quot;brandAgg&quot;);
    &#x2F;&#x2F; 4.2 获取桶
    List&lt;? extends Terms.Bucket&gt; buckets &#x3D; brandTerms.getBuckets();
    &#x2F;&#x2F; 4.3 遍历桶内元素
    for (Terms.Bucket bucket : buckets) &#123;
        &#x2F;&#x2F; 4.4 获取key，也就是品牌信息
        String brandName &#x3D; bucket.getKeyAsString();
        System.out.println(brandName);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="业务需求"><a href="#业务需求" class="headerlink" title="业务需求"></a>业务需求</h3><p>利用之前做的黑马旅游网，项目继续优化</p>
<p>需求：搜索页面的品牌、城市等信息，并不是在页面上直接写死的，而是通过聚合索引库中的酒店数据来动态获得的</p>
<p><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/07/pSVmTED.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVmTED.png" alt="img"></a></p>
<ul>
<li><p>目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会随着搜索结果的变化而变化。但是用户搜索条件改变时，搜索结果也会跟着变化</p>
</li>
<li><p>例如：用户在搜索框输入<code>王府井</code>，那搜索的酒店肯定就只能在<code>北京王府井附近</code>，因此，城市只能是北京，此时城市列表中就不应该显示上海、深圳、杭州了</p>
</li>
<li><p>也就是说，搜索结果中包含哪些城市，页面中就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌</p>
</li>
<li><p>那么如何得知搜索结果中包含了哪些品牌？如何得知搜索结果中包含了哪些城市？</p>
</li>
<li><p>使用聚合功能，利用Bucket聚合，对搜索结果中的文档，基于品牌分组、城市分组、星级分组等，就能得知包含哪些品牌、哪些城市了。</p>
</li>
<li><p>因为是对搜索结果聚合，因此聚合是<code>限定范围的聚合</code>，且限定条件与搜索文档一致</p>
</li>
<li><p>那么之前写的查询代码就可以直接用</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">private void buildBasicQuery(RequestParams params, SearchRequest request) &#123;
    &#x2F;&#x2F; 1. 构建BoolQuery
    BoolQueryBuilder boolQuery &#x3D; QueryBuilders.boolQuery();
    String key &#x3D; params.getKey();
    if (StringUtils.isEmpty(key)) &#123;
        boolQuery.must(QueryBuilders.matchAllQuery());
    &#125; else &#123;
        boolQuery.must(QueryBuilders.matchQuery(&quot;all&quot;, key));
    &#125;
    &#x2F;&#x2F; 品牌条件
    if (params.getBrand() !&#x3D; null &amp;&amp; !params.getBrand().equals(&quot;&quot;)) &#123;
        boolQuery.filter(QueryBuilders.termsQuery(&quot;brand&quot;, params.getBrand()));
    &#125;
    &#x2F;&#x2F; 城市条件
    if (params.getCity() !&#x3D; null &amp;&amp; !params.getCity().equals(&quot;&quot;)) &#123;
        boolQuery.filter(QueryBuilders.termsQuery(&quot;city&quot;, params.getCity()));
    &#125;
    &#x2F;&#x2F; 星级条件
    if (params.getStarName() !&#x3D; null &amp;&amp; !params.getStarName().equals(&quot;&quot;)) &#123;
        boolQuery.filter(QueryBuilders.termsQuery(&quot;starName&quot;, params.getStarName()));
    &#125;
    &#x2F;&#x2F; 价格条件
    if (params.getMaxPrice() !&#x3D; null &amp;&amp; params.getMinPrice() !&#x3D; null) &#123;
        boolQuery.filter(QueryBuilders
                .rangeQuery(&quot;price&quot;)
                .gt(params.getMinPrice())
                .lt(params.getMaxPrice()));
    &#125;

    &#x2F;&#x2F; 2.算分控制
    FunctionScoreQueryBuilder functionScoreQuery &#x3D;
            QueryBuilders.functionScoreQuery(
                    boolQuery, new FunctionScoreQueryBuilder.FilterFunctionBuilder[]&#123;
                            new FunctionScoreQueryBuilder.FilterFunctionBuilder(
                                    QueryBuilders.termsQuery(&quot;isAD&quot;, true),
                                    ScoreFunctionBuilders.weightFactorFunction(10))&#125;);
    request.source().query(functionScoreQuery);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="业务实现"><a href="#业务实现" class="headerlink" title="业务实现"></a>业务实现</h3><ul>
<li><p>查看浏览器，前端其实已经发出了请求</p>
<pre class="line-numbers language-PLAINTEXT" data-language="PLAINTEXT"><code class="language-PLAINTEXT">请求网址: http:&#x2F;&#x2F;localhost:8089&#x2F;hotel&#x2F;filters
请求方法: POST
请求载荷：&#123;key: &quot;王府井&quot;, page: 1, size: 5, sortBy: &quot;default&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>请求参数与搜索文档的参数完全一致，其返回值类型就是页面要展示的最终结果<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/07/pSVmTED.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVmTED.png" alt="img"></a></p>
</li>
<li><p>在web包下的HotelController中添加一个方法，遵循下面的要求</p>
<ol>
<li>请求方式：<code>POST</code></li>
<li>请求路径：<code>/hotel/filters</code></li>
<li>请求参数：<code>RequestParams</code>，与搜索文档一致</li>
<li>返回值类型：<code>Map(String, List&lt;String&gt;</code></li>
</ol>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/filters"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span> <span class="token function">getFilters</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RequestParams</span> params<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> hotelService<span class="token punctuation">.</span><span class="token function">getFilters</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>在IHotelService中定义方法</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">Map&lt;String, List&lt;String&gt;&gt; getFilters(RequestParams params);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>在HotelService中实现该方法</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">@Override
public Map&lt;String, List&lt;String&gt;&gt; getFilters(RequestParams params) &#123;
    try &#123;
        &#x2F;&#x2F; 1. 准备Request对象
        SearchRequest request &#x3D; new SearchRequest(&quot;hotel&quot;);
        &#x2F;&#x2F; 2. 准备DSL
        buildBasicQuery(params, request);
        &#x2F;&#x2F; 2.1 查询
        buildBasicQuery(params, request);
        &#x2F;&#x2F; 2.2 设置size为0，不查询文档数据
        request.source().size(0);
        &#x2F;&#x2F; 2.3 聚合
        request.source().aggregation(
                AggregationBuilders
                        .terms(&quot;brandAgg&quot;)
                        .field(&quot;brand&quot;)
                        .size(100)
        );
        request.source().aggregation(
                AggregationBuilders
                        .terms(&quot;cityAgg&quot;)
                        .field(&quot;city&quot;)
                        .size(100)
        );
        request.source().aggregation(
                AggregationBuilders
                        .terms(&quot;starAgg&quot;)
                        .field(&quot;starName&quot;)
                        .size(100)
        );
        &#x2F;&#x2F; 3. 发出请求
        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);
        HashMap&lt;String, List&lt;String&gt;&gt; result &#x3D; new HashMap&lt;&gt;();
        Aggregations aggregations &#x3D; response.getAggregations();
        &#x2F;&#x2F; 4. 解析结果
        &#x2F;&#x2F; 4.1 解析品牌结果
        Terms brandTerms &#x3D; aggregations.get(&quot;brandAgg&quot;);
        ArrayList&lt;String&gt; brandList &#x3D; new ArrayList&lt;&gt;();
        List&lt;? extends Terms.Bucket&gt; brandBuckets &#x3D; brandTerms.getBuckets();
        for (Terms.Bucket bucket : brandBuckets) &#123;
            String brandName &#x3D; bucket.getKeyAsString();
            brandList.add(brandName);
        &#125;
        result.put(&quot;brand&quot;, brandList);
        &#x2F;&#x2F; 4.2 解析城市结果
        Terms cityTerms &#x3D; aggregations.get(&quot;cityAgg&quot;);
        ArrayList&lt;String&gt; cityList &#x3D; new ArrayList&lt;&gt;();
        List&lt;? extends Terms.Bucket&gt; cityBuckets &#x3D; cityTerms.getBuckets();
        for (Terms.Bucket cityBucket : cityBuckets) &#123;
            String cityName &#x3D; cityBucket.getKeyAsString();
            cityList.add(cityName);
        &#125;
        result.put(&quot;city&quot;, cityList);
        &#x2F;&#x2F; 4.3 解析星级结果
        Terms starTerms &#x3D; aggregations.get(&quot;starAgg&quot;);
        ArrayList&lt;String&gt; starList &#x3D; new ArrayList&lt;&gt;();
        List&lt;? extends Terms.Bucket&gt; starBuckets &#x3D; starTerms.getBuckets();
        for (Terms.Bucket starBucket : starBuckets) &#123;
            String starName &#x3D; starBucket.getKeyAsString();
            starList.add(starName);
        &#125;
        result.put(&quot;starName&quot;, starList);
        return result;
    &#125; catch (IOException e) &#123;
        throw new RuntimeException(e);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>这下就是动态获取的品牌、城市、星级数据了<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/07/pSVYS4P.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVYS4P.png" alt="img"></a></p>
</li>
<li><p>当我们在搜索框输入内容时，也会根据搜索的结果来动态展示品牌、城市、星级数据<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/07/pSVYABj.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSVYABj.png" alt="img"></a></p>
</li>
<li><p>但是现在的代码并不是很优雅，所以我们可以把2.3的聚合操作，抽取为一个方法，IDEA中使用快捷键Ctrl + Alt + M可以快速抽取 (记得关闭网抑云的全局热键，不然会冲突)</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">private void buildAggregation(SearchRequest request) &#123;
    request.source().aggregation(
            AggregationBuilders
                    .terms(&quot;brandAgg&quot;)
                    .field(&quot;brand&quot;)
                    .size(100)
    );
    request.source().aggregation(
            AggregationBuilders
                    .terms(&quot;cityAgg&quot;)
                    .field(&quot;city&quot;)
                    .size(100)
    );
    request.source().aggregation(
            AggregationBuilders
                    .terms(&quot;starAgg&quot;)
                    .field(&quot;starName&quot;)
                    .size(100)
    );
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>4.1、4.2、4.3的解析结果，也可以抽取为一个方法</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">&#x2F;**
 * 通过聚合名称获取对应的key的集合
 * @param aggregations 聚合结果集
 * @param aggName 聚合名称
 * @return
 *&#x2F;
private ArrayList&lt;String&gt; getAggByName(Aggregations aggregations, String aggName) &#123;
    Terms brandTerms &#x3D; aggregations.get(aggName);
    ArrayList&lt;String&gt; brandList &#x3D; new ArrayList&lt;&gt;();
    List&lt;? extends Terms.Bucket&gt; brandBuckets &#x3D; brandTerms.getBuckets();
    for (Terms.Bucket bucket : brandBuckets) &#123;
        String brandName &#x3D; bucket.getKeyAsString();
        brandList.add(brandName);
    &#125;
    return brandList;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改完的代码就优雅多了</p>
<pre class="line-numbers language-JAVA" data-language="JAVA"><code class="language-JAVA">@Override
public Map&lt;String, List&lt;String&gt;&gt; getFilters(RequestParams params) &#123;
    try &#123;
        &#x2F;&#x2F; 1. 准备Request对象
        SearchRequest request &#x3D; new SearchRequest(&quot;hotel&quot;);
        &#x2F;&#x2F; 2. 准备DSL
        buildBasicQuery(params, request);
        &#x2F;&#x2F; 2.1 查询
        buildBasicQuery(params, request);
        &#x2F;&#x2F; 2.2 设置size为0，不查询文档数据
        request.source().size(0);
        &#x2F;&#x2F; 2.3 聚合
        buildAggregation(request);
        &#x2F;&#x2F; 3. 发出请求
        SearchResponse response &#x3D; client.search(request, RequestOptions.DEFAULT);
        HashMap&lt;String, List&lt;String&gt;&gt; result &#x3D; new HashMap&lt;&gt;();
        Aggregations aggregations &#x3D; response.getAggregations();
        &#x2F;&#x2F; 4. 解析结果
        &#x2F;&#x2F; 4.1 解析品牌结果，获取品牌名称集合
        ArrayList&lt;String&gt; brandList &#x3D; getAggByName(aggregations, &quot;brandName&quot;);
        result.put(&quot;brand&quot;, brandList);
        &#x2F;&#x2F; 4.2 解析城市结果，获取城市名称集合
        ArrayList&lt;String&gt; cityList &#x3D; getAggByName(aggregations, &quot;cityAgg&quot;);
        result.put(&quot;city&quot;, cityList);
        &#x2F;&#x2F; 4.3 解析星级结果，获取星级名称集合
        ArrayList&lt;String&gt; starList &#x3D; getAggByName(aggregations, &quot;starAgg&quot;);
        result.put(&quot;starName&quot;, starList);
        &#x2F;&#x2F; 5. 返回Map集合
        return result;
    &#125; catch (IOException e) &#123;
        throw new RuntimeException(e);
    &#125;
&#125;

&#x2F;**
 * 通过聚合名称获取对应的key的集合
 * @param aggregations 聚合结果集
 * @param aggName 聚合名称
 * @return
 *&#x2F;
private ArrayList&lt;String&gt; getAggByName(Aggregations aggregations, String aggName) &#123;
    Terms brandTerms &#x3D; aggregations.get(aggName);
    ArrayList&lt;String&gt; brandList &#x3D; new ArrayList&lt;&gt;();
    List&lt;? extends Terms.Bucket&gt; brandBuckets &#x3D; brandTerms.getBuckets();
    for (Terms.Bucket bucket : brandBuckets) &#123;
        String brandName &#x3D; bucket.getKeyAsString();
        brandList.add(brandName);
    &#125;
    return brandList;
&#125;

&#x2F;**
 * 聚合
 * @param request
 *&#x2F;
private void buildAggregation(SearchRequest request) &#123;
    request.source().aggregation(
            AggregationBuilders
                    .terms(&quot;brandAgg&quot;)
                    .field(&quot;brand&quot;)
                    .size(100)
    );
    request.source().aggregation(
            AggregationBuilders
                    .terms(&quot;cityAgg&quot;)
                    .field(&quot;city&quot;)
                    .size(100)
    );
    request.source().aggregation(
            AggregationBuilders
                    .terms(&quot;starAgg&quot;)
                    .field(&quot;starName&quot;)
                    .size(100)
    );
&#125;

&#x2F;**
 * 查询
 * @param params 接收前端的查询参数
 * @param request
 *&#x2F;
private void buildBasicQuery(RequestParams params, SearchRequest request) &#123;
    &#x2F;&#x2F; 1. 构建BoolQuery
    BoolQueryBuilder boolQuery &#x3D; QueryBuilders.boolQuery();
    String key &#x3D; params.getKey();
    if (StringUtils.isEmpty(key)) &#123;
        boolQuery.must(QueryBuilders.matchAllQuery());
    &#125; else &#123;
        boolQuery.must(QueryBuilders.matchQuery(&quot;all&quot;, key));
    &#125;
    &#x2F;&#x2F; 品牌条件
    if (params.getBrand() !&#x3D; null &amp;&amp; !params.getBrand().equals(&quot;&quot;)) &#123;
        boolQuery.filter(QueryBuilders.termsQuery(&quot;brand&quot;, params.getBrand()));
    &#125;
    &#x2F;&#x2F; 城市条件
    if (params.getCity() !&#x3D; null &amp;&amp; !params.getCity().equals(&quot;&quot;)) &#123;
        boolQuery.filter(QueryBuilders.termsQuery(&quot;city&quot;, params.getCity()));
    &#125;
    &#x2F;&#x2F; 星级条件
    if (params.getStarName() !&#x3D; null &amp;&amp; !params.getStarName().equals(&quot;&quot;)) &#123;
        boolQuery.filter(QueryBuilders.termsQuery(&quot;starName&quot;, params.getStarName()));
    &#125;
    &#x2F;&#x2F; 价格条件
    if (params.getMaxPrice() !&#x3D; null &amp;&amp; params.getMinPrice() !&#x3D; null) &#123;
        boolQuery.filter(QueryBuilders
                .rangeQuery(&quot;price&quot;)
                .gt(params.getMinPrice())
                .lt(params.getMaxPrice()));
    &#125;

    &#x2F;&#x2F; 2.算分控制
    FunctionScoreQueryBuilder functionScoreQuery &#x3D;
            QueryBuilders.functionScoreQuery(
                    boolQuery, new FunctionScoreQueryBuilder.FilterFunctionBuilder[]&#123;
                            new FunctionScoreQueryBuilder.FilterFunctionBuilder(
                                    QueryBuilders.termsQuery(&quot;isAD&quot;, true),
                                    ScoreFunctionBuilders.weightFactorFunction(10))&#125;);
    request.source().query(functionScoreQuery);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h1 id="自动补全"><a href="#自动补全" class="headerlink" title="自动补全"></a>自动补全</h1><ul>
<li>当用户在搜索框输入字符时，我们应该显示出与该字符相关的搜索项<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/08/pSZkGIs.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s1.ax1x.com/2023/01/08/pSZkGIs.png" alt="img"></a></li>
<li>这种根据用户输入的字母，提示完整词条的功能，就是自动补全</li>
<li>因为需要根据拼音字母来推断，因此要用到拼音分词功能</li>
</ul>
<h2 id="拼音分词器"><a href="#拼音分词器" class="headerlink" title="拼音分词器"></a>拼音分词器</h2><ul>
<li><p>要实现根据字母做补全，就必须对文档按照拼音分词。</p>
</li>
<li><p>在GitHub上刚好有ES的拼音分词插件。</p>
</li>
<li><p>地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p>
</li>
<li><p>这里依旧是下载7.12.1版本：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin/releases/tag/v7.12.1">https://github.com/medcl/elasticsearch-analysis-pinyin/releases/tag/v7.12.1</a></p>
</li>
<li><p>安装方式分三步</p>
<ol>
<li><p>解压</p>
</li>
<li><p>上传到虚拟机的ES的plugin目录</p>
<pre class="line-numbers language-none"><code class="language-none">BASH
&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;es-plugins&#x2F;_data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>重启ES</p>
<pre class="line-numbers language-none"><code class="language-none">BASH
docker restart es<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ol>
</li>
<li><p>重启完毕之后，测试我们的分词器是否安装成功，在kibana中编写DSL代码</p>
<pre class="line-numbers language-none"><code class="language-none">JSON
POST &#x2F;_analyze
&#123;
  &quot;text&quot;: [&quot;深岩银河是真滴好玩&quot;],
  &quot;analyzer&quot;: &quot;pinyin&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>得到的分词结果(部分)如下</p>
</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"tokens"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"shen"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"syyhszdhw"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"yan"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"yin"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"he"</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>暂时只是将每个字拆解成了拼音，还有一个首字母的全拼，但目前还不能满足我们的需求</li>
<li><code>深岩银河是真滴好玩</code>这句话，还没有被分词</li>
<li>每一个字拆解成一个拼音没什么用，单独的<code>shen</code>、<code>yan</code>显然没有<code>syyh</code>有用</li>
<li>结果中也没有出现汉字，也就意味着只有当用户输入拼音的时候，才会补全</li>
<li>为了满足我们的需求，我们需要来自定义分词器</li>
</ul>
<h2 id="自定义分词器"><a href="#自定义分词器" class="headerlink" title="自定义分词器"></a>自定义分词器</h2><ul>
<li>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是将每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器</li>
<li>ES中分词器(analyzer)的组成包含三个部分<ol>
<li>character filters：在tokenizer之前对文本进行处理，例如删除字符、替换字符等(前导空格，末尾空格，字符表情转对应文字，<code>:) -&gt; 开心</code>)</li>
<li>tokenizer：将文本按照一定规则切割成词条(term)。例如keyword，就是不分词；ik_smart，就是最少切分</li>
<li>tokenizer filter：将tokenizer输出的词条进一步处理。例如大小写切换、同一次处理、拼音处理等</li>
</ol>
</li>
</ul>
<p>例如：</p>
<ul>
<li><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230413105539974.png" alt="image-20230413105539974"></li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /test
<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                     <span class="token comment">// 自定义分词器</span>
        <span class="token property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 分词器名称</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>   <span class="token comment">// tokenizer部分</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span>            <span class="token comment">// tokenizer filter部分</span>
      <span class="token punctuation">&#125;</span>                                 <span class="token comment">// 由于这里并不需要处理特殊字符，所以没有character filters</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>但是默认的拼音分词器还是只能将<code>滋蹦</code>分解为<code>zi</code>、<code>beng</code>、<code>zb</code>这三个，而没有<code>zibeng</code></li>
<li>所以我们还需要自定义tokenizer filter拼音分词器</li>
<li>解决方案在其官方文档中给出了</li>
</ul>
<blockquote>
<p>The plugin includes analyzer: pinyin , tokenizer: pinyin and token-filter: pinyin.</p>
<p><code>Optional Parameters</code></p>
<p><code>keep_first_letter</code> when this option enabled, eg: 刘德华&gt;ldh, default: true<br><code>keep_separate_first_letter</code> when this option enabled, will keep first letters separately, eg: 刘德华&gt;l,d,h, default: false, NOTE: query result maybe too fuzziness due to term too frequency<br><code>limit_first_letter_length</code> set max length of the first_letter result, default: 16<br><code>keep_full_pinyin</code> when this option enabled, eg: 刘德华&gt; [liu,de,hua], default: true<br><code>keep_joined_full_pinyin</code> when this option enabled, eg: 刘德华&gt; [liudehua], default: false<br><code>keep_none_chinese</code> keep non chinese letter or number in result, default: true<br><code>keep_none_chinese_together</code> keep non chinese letter together, default: true, eg: DJ音乐家 -&gt; DJ,yin,yue,jia, when set to false, eg: DJ音乐家 -&gt; D,J,yin,yue,jia, NOTE: keep_none_chinese should be enabled first<br><code>keep_none_chinese_in_first_letter</code> keep non Chinese letters in first letter, eg: 刘德华AT2016-&gt;ldhat2016, default: true<br><code>keep_none_chinese_in_joined_full_pinyin</code> keep non Chinese letters in joined full pinyin, eg: 刘德华2016-&gt;liudehua2016, default: false<br><code>none_chinese_pinyin_tokenize</code> break non chinese letters into separate pinyin term if they are pinyin, default: true, eg: liudehuaalibaba13zhuanghan -&gt; liu,de,hua,a,li,ba,ba,13,zhuang,han, NOTE: keep_none_chinese and keep_none_chinese_together should be enabled first<br><code>keep_original</code> when this option enabled, will keep original input as well, default: false<br><code>lowercase</code> lowercase non Chinese letters, default: true<br><code>trim_whitespace</code> default: true<br><code>remove_duplicated_term</code> when this option enabled, duplicated term will be removed to save index, eg: de的&gt;de, default: false, NOTE: position related query maybe influenced<br><code>ignore_pinyin_offset</code> after 6.0, offset is strictly constrained, overlapped tokens are not allowed, with this parameter, overlapped token will allowed by ignore offset, please note, all position related query or highlight will become incorrect, you should use multi fields and specify different settings for different query purpose. if you need offset, please set it to false. default: true.</p>
</blockquote>
<ul>
<li>可以看到，默认情况下是<code>keep_full_pinyin</code>，会将<code>滋蹦</code>拆成<code>zi</code>和<code>beng</code>，我们要将这个选项设置为false</li>
<li>同时将<code>keep_joined_full_pinyin</code>设置为true，就会正常解析为<code>zibeng</code>了</li>
<li>我们还需要保留原始结果，故也需要将<code>keep_original</code>设置为<code>true</code></li>
<li>我们在实际应用中，根据自己的需求来配置就好了，那么这里声明的自定义分词器如下</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /test
<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230413110114922.png" alt="image-20230413110114922"></p>
<ul>
<li>我们自定义的分词器肯定是在mapping映射中用的，也就是在我们定义索引库的字段的时候用的</li>
<li>这样对字段创建倒排索引的时候，除了会创建中文的倒排索引，也会创建拼音的倒排索引</li>
<li>那我们建立一个索引库，定义一个<code>name</code>字段，其分词器不再使用之前的<code>ik_max_word</code>，而是使用我们的自定义分词器</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /test
<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>那我们现在来测试一下</li>
</ul>
<h3 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /test/_analyze
<span class="token punctuation">&#123;</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"实现自定义分词器"</span><span class="token punctuation">,</span>
  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>得到的结果(部分)如下，符合我们的需求了</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"tokens"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"实现"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"shixian"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"sx"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"自定义"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"token"</span> <span class="token operator">:</span> <span class="token string">"zidingyi"</span><span class="token punctuation">,</span>
      <span class="token property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"CN_WORD"</span><span class="token punctuation">,</span>
      <span class="token property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="测试2（同音字）"><a href="#测试2（同音字）" class="headerlink" title="测试2（同音字）"></a>测试2（同音字）</h3><p>但是现在还存在一点小问题，这里举个例子说明</p>
<ul>
<li>我们在创建的索引库中添加两个同音字，<code>狮子</code>和<code>柿子</code></li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /test/_doc/<span class="token number">1</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"柿子"</span>
<span class="token punctuation">&#125;</span>

POST /test/_doc/<span class="token number">2</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"狮子"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>那我们现在查询<code>掉进狮子笼怎么办</code>，结果中出现了<code>狮子</code>和<code>柿子</code>，这显然不是我们想要的</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /test/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"掉进狮子笼怎么办？在线等，挺急的"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSZuLq0.png" alt="img"></p>
<ul>
<li>那么为什么会出现这种问题呢？<ul>
<li><strong>拼音分词器</strong>适合在<strong>创建倒排索引</strong>的时候使用，但是<strong>不能在搜索的时候使用</strong>。<ul>
<li>例如我们的狮子分词之后变成<code>狮子</code>、<code>shizi</code>、<code>sz</code>，柿子分词后变成<code>柿子</code>、<code>shizi</code>、<code>sz</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/image-20230413111455677.png" alt="image-20230413111455677"></p>
<ul>
<li>因为这两个次的拼音是一样的，所以创建倒排索引的时候，<code>shizi</code>对应1、2这两条文档，如果对<code>shizi</code>查询，则会把<code>狮子</code>和<code>柿子</code>都查询出来</li>
<li>用户搜索<code>掉进狮子笼</code>，如果用我们自定义的分词器，最终也会分出<code>shizi</code>这个词条，进行搜索的时候，当然会查询出两条数据</li>
<li>那么怎么解决这个问题呢？<ul>
<li>我们在搜索的时候，使用<code>ik_smart</code>分词器，在<code>mapping</code>映射时，<strong>指定两个分词器（系统有这个两个分词器属性，我们仅需设置用什么即可）</strong>，<code>analyzer</code>和<code>search_analyzer</code><ul>
<li>其中<code>analyzer</code>是创建索引时使用的（使用拼音分词器,使用自定义的分词器）</li>
<li><code>search_analyzer</code>是搜索时使用的（不使用拼音分词器就使用ik分词器即可）</li>
</ul>
</li>
<li>步骤：</li>
<li>删掉原来的分词器(删掉原来的索引库) <code>delete  /test</code> </li>
<li>新建索引库和分词器, </li>
</ul>
</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /test
<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>再次插入文档，查询就会发现只有狮子这一种选项了！</li>
</ul>
<blockquote>
<p>小结</p>
<ul>
<li>如何使用拼音分词器？<ol>
<li>下载pinyin分词器</li>
<li>解压到ES的plugin目录</li>
<li>重启ES</li>
</ol>
</li>
<li>如何自定义分词器？<ul>
<li>创建索引库时，在settings中配置analysis，可以包含三部分<ol>
<li>character filter</li>
<li>tokenizer</li>
<li>filter</li>
</ol>
</li>
</ul>
</li>
<li>拼音分词器的注意事项？<ul>
<li>为了避免搜索到同音字，<strong>搜索时不要使用拼音分词器</strong>，添加<code>search_analyzer</code>属性</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="自动补全查询"><a href="#自动补全查询" class="headerlink" title="自动补全查询"></a>自动补全查询</h2><ul>
<li><p>ES提供额</p>
<p>Completion Suggester</p>
<p>查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束</p>
<ul>
<li>参与补全查询的字段必须是<code>completion</code>类型</li>
<li>字段的内容一般是用来补全的<strong>多个词条形成的数组</strong></li>
</ul>
</li>
</ul>
<p>例如这个索引库</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /test2
<span class="token punctuation">&#123;</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后插入一些测试数据</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /test2/_doc/<span class="token number">1</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sony"</span><span class="token punctuation">,</span> <span class="token string">"PS5"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>


POST /test2/_doc/<span class="token number">2</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SK-II"</span><span class="token punctuation">,</span> <span class="token string">"PITERA"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>


POST /test2/_doc/<span class="token number">3</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Nitendo"</span><span class="token punctuation">,</span> <span class="token string">"Switch"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>


POST /test2/_doc/<span class="token number">4</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sony"</span><span class="token punctuation">,</span> <span class="token string">"WF-1000XM4"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>补全查询的DSL语句如下</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /test2/_search
<span class="token punctuation">&#123;</span>
  <span class="token property">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"title_suggest"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>              <span class="token comment">// 给suggest取名</span>
      <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"P"</span><span class="token punctuation">,</span>                  <span class="token comment">// 补全查询关键字</span>
      <span class="token property">"completion"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>       
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span>           <span class="token comment">// 补全查询的字段</span>
        <span class="token property">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// 跳过重复的</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span>                  <span class="token comment">// 获取前10条结果</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果中成功查询到<code>PS5</code>和<code>PITERA</code></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"took"</span> <span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
  <span class="token property">"timed_out"</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">"_shards"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"successful"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"skipped"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"failed"</span> <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"total"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"value"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">"relation"</span> <span class="token operator">:</span> <span class="token string">"eq"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"max_score"</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"suggest"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"title_suggest"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"P"</span><span class="token punctuation">,</span>
        <span class="token property">"offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"length"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"options"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"PITERA"</span><span class="token punctuation">,</span>
            <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test2"</span><span class="token punctuation">,</span>
            <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
            <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
            <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
            <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"SK-II"</span><span class="token punctuation">,</span>
                <span class="token string">"PITERA"</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#123;</span>
            <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"PS5"</span><span class="token punctuation">,</span>
            <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"test2"</span><span class="token punctuation">,</span>
            <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
            <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
            <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
            <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"Sony"</span><span class="token punctuation">,</span>
                <span class="token string">"PS5"</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="实现酒店搜索框自动补全"><a href="#实现酒店搜索框自动补全" class="headerlink" title="实现酒店搜索框自动补全"></a>实现酒店搜索框自动补全</h2><ul>
<li>现在我们的hotel索引库还没有设置拼音分词器，需要修改索引库中的配置。但是索引库是无法修改的，只能先删掉再重新创建</li>
<li>另外，我们需要添加一个字段，用来做自动补全，将<code>brand</code>、<code>suggestion</code>、<code>city</code>等都放进去，作为自动补全的提示</li>
<li>那我们现在总结一下需要做的事<ol>
<li>修改hotel的索引结构，设置自定义拼音分词器</li>
<li>修改索引库的name、all字段，使用自定义分词器(其他字段已经是keyword类型的词条了，这两个text类型的还需要自定义分词)</li>
<li>索引库添加一个新字段<code>suggestion</code>，类型为<code>completion</code>类型，使用自定义的分词器</li>
<li>给HotelDoc类添加<code>suggestion</code>字段，内容包含<code>brand</code>、<code>business</code></li>
<li>重新导入数据到hotel库</li>
</ol>
</li>
</ul>
<h3 id="修改hotel映射结构"><a href="#修改hotel映射结构" class="headerlink" title="修改hotel映射结构"></a>修改hotel映射结构</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /hotel
<span class="token punctuation">&#123;</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"text_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"completion_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"remove_deplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> 
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_analyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span> 
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"city"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"starName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"business"</span><span class="token operator">:</span> -<span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
        <span class="token punctuation">,</span> <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"pic"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"all"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_analyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"suggestion"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"completion_analyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="修改HotelDoc实体"><a href="#修改HotelDoc实体" class="headerlink" title="修改HotelDoc实体"></a>修改HotelDoc实体</h3><ul>
<li>HotelDoc中要添加一个字段，用来做数组补全，内容可以是酒店品牌、城市、商圈、名称等信息。按照自动补全的要求，最好是这些字段的数组</li>
<li>因此我们可以在HotelDoc中添加一个suggestion字段，类型为<code>List&lt;String&gt;</code>，然后将brand、city、business等信息放到里面</li>
<li>由于某些business的信息是包含多个关键字，所以我们需要对其切分</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&quot;business&quot; : &quot;天安门&#x2F;王府井地区&quot;
&quot;business&quot; : &quot;永定门、南站、大红门、南苑地区&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelDoc</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brand<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> starName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> business<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> pic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> distance<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isAD<span class="token punctuation">;</span>
    <span class="token comment">// 新增suggestion属性</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> suggestion<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span><span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brand <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>city <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>starName <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>business <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBusiness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>location <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> hotel<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pic <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 组装suggestion</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>business<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>business<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"、"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// business有多个值、需要切分，根据数据库中的数据，这里按照/和、来切分</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> splits <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>business<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/|、"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suggestion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 添加元素</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suggestion<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suggestion<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 添加切分business后的结果</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>suggestion<span class="token punctuation">,</span> splits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suggestion <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>brand<span class="token punctuation">,</span> city<span class="token punctuation">,</span> business<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="重新导入"><a href="#重新导入" class="headerlink" title="重新导入"></a>重新导入</h3><ul>
<li>运行之前编写的批量导入数据功能，可以看到新的酒店数据中包含了suggestion，且切分了business，后面我们就根据suggestion这个字段来自动补全</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"hotel"</span><span class="token punctuation">,</span>
  <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
  <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"413460"</span><span class="token punctuation">,</span>
  <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">1.8905408</span><span class="token punctuation">,</span>
  <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"address"</span> <span class="token operator">:</span> <span class="token string">"东城天坛东里甲48号"</span><span class="token punctuation">,</span>
    <span class="token property">"brand"</span> <span class="token operator">:</span> <span class="token string">"7天酒店"</span><span class="token punctuation">,</span>
    <span class="token property">"business"</span> <span class="token operator">:</span> <span class="token string">"前门、崇文门商贸区"</span><span class="token punctuation">,</span>
    <span class="token property">"city"</span> <span class="token operator">:</span> <span class="token string">"北京"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span> <span class="token operator">:</span> <span class="token number">413460</span><span class="token punctuation">,</span>
    <span class="token property">"location"</span> <span class="token operator">:</span> <span class="token string">"39.875786, 116.421987"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"7天连锁酒店(北京天坛店)"</span><span class="token punctuation">,</span>
    <span class="token property">"pic"</span> <span class="token operator">:</span> <span class="token string">"https://m.tuniucdn.com/fb2/t1/G2/M00/C7/D8/Cii-T1knCK6IWTtxAAI0plLButMAAKYTAJu-woAAjS-422_w200_h200_c1_t0.jpg"</span><span class="token punctuation">,</span>
    <span class="token property">"price"</span> <span class="token operator">:</span> <span class="token number">753</span><span class="token punctuation">,</span>
    <span class="token property">"score"</span> <span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
    <span class="token property">"starName"</span> <span class="token operator">:</span> <span class="token string">"二钻"</span><span class="token punctuation">,</span>
    <span class="token property">"suggestion"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"7天酒店"</span><span class="token punctuation">,</span>
      <span class="token string">"北京"</span><span class="token punctuation">,</span>
      <span class="token string">"前门"</span><span class="token punctuation">,</span>
      <span class="token string">"崇文门商贸区"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="自动补全查询的API"><a href="#自动补全查询的API" class="headerlink" title="自动补全查询的API"></a>自动补全查询的API</h3><ul>
<li>前面我们只是学了自动补全查询的DSL，那现在我们来学习对应的JavaAPI</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"test2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">suggest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuggestBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSuggestion</span><span class="token punctuation">(</span>
                <span class="token string">"title_suggest"</span><span class="token punctuation">,</span>
                <span class="token class-name">SuggestBuilders</span><span class="token punctuation">.</span><span class="token function">completionSuggestion</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">"p"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">skipDuplicates</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSZrUET.png" alt="img"></p>
<p>自动补全的结果也比较特殊，解析的代码如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Suggest</span> suggest <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getSuggest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CompletionSuggestion</span> suggestion <span class="token operator">=</span> suggest<span class="token punctuation">.</span><span class="token function">getSuggestion</span><span class="token punctuation">(</span><span class="token string">"title_suggest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span><span class="token punctuation">></span></span> options <span class="token operator">=</span> suggestion<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span> option <span class="token operator">:</span> options<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> text <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSZrD29.png" alt="img"></p>
<h3 id="实现搜索框自动补全"><a href="#实现搜索框自动补全" class="headerlink" title="实现搜索框自动补全"></a>实现搜索框自动补全</h3><ul>
<li>当我们在搜索框输入<code>s</code>时，会看到请求</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">请求网址: http:&#x2F;&#x2F;localhost:8089&#x2F;hotel&#x2F;suggestion?key&#x3D;s
请求方法: GET
请求载荷：key: s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>需求：当我们在搜索框输入<code>s</code>时，会显示以<code>s</code>为首字母的词条</li>
<li>那我们在HotelController中定义方法，遵循以下要求<ol>
<li>请求方式：<code>GET</code></li>
<li>请求路径：<code>/hotel/suggestion</code></li>
<li>请求参数：<code>key</code></li>
<li>返回值类型： <code>List&lt;String&gt;</code></li>
</ol>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getSuggestion</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 准备Request对象</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 准备DSL</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">suggest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SuggestBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSuggestion</span><span class="token punctuation">(</span>
                        <span class="token string">"suggestions"</span><span class="token punctuation">,</span>
                        <span class="token class-name">SuggestBuilders</span>
                                <span class="token punctuation">.</span><span class="token function">completionSuggestion</span><span class="token punctuation">(</span><span class="token string">"suggestion"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">skipDuplicates</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 发起请求</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 解析结果</span>
        <span class="token class-name">Suggest</span> suggest <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getSuggest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.1 根据补全查询名称，获取补全结果</span>
        <span class="token class-name">CompletionSuggestion</span> suggestions <span class="token operator">=</span> suggest<span class="token punctuation">.</span><span class="token function">getSuggestion</span><span class="token punctuation">(</span><span class="token string">"suggestions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2 获取options</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span><span class="token punctuation">></span></span> options <span class="token operator">=</span> suggestions<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3 遍历 这里可以提前声明集合的大小，只能是options.size()</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CompletionSuggestion<span class="token punctuation">.</span>Entry<span class="token punctuation">.</span>Option</span> option <span class="token operator">:</span> options<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 将每条补全结果都加入到集合中</span>
            <span class="token class-name">String</span> text <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 5. 返回补全结果集合</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启服务，自动补全功能已经实现了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSZr7rt.png" alt="img"></p>
<p>无论用户输入中文还是拼音都能正确显示补全结果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSZsCq0.png" alt="img"></p>
<p>如果搜中文不显示补全，那肯定是创建索引库的时候，没指定suggestion的search_analyzer为ik_smart</p>
<h1 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h1><ul>
<li>ES中的酒店数据来自于MySQL的数据库，因此MySQL数据发生改变时，ES也必须跟着改变，这就是ES与MySQL之间的数据同步问题</li>
<li>但是在微服务中，负责酒店管理(操作MySQL)的业务，与负责酒店搜索(操作ES)的业务可能在两个<code>不同</code>的微服务上，那么数据同步又该如何实现呢？<ul>
<li>两个服务只能访问MySQL 或者 ES中的一个，这样才符合微服务业务隔离的效果</li>
</ul>
</li>
</ul>
<h2 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h2><ul>
<li>常见的数据沟通过不方案有三种<ol>
<li>同步调用</li>
<li>异步通知</li>
<li>监听binlog</li>
</ol>
</li>
</ul>
<h3 id="同步调用"><a href="#同步调用" class="headerlink" title="同步调用"></a>同步调用</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSeSOT1.png" alt="img"></p>
<ul>
<li>流程如下<ol>
<li>hotel-demo对外提供接口，用来更新ES中的数据</li>
<li>酒店管理服务在完成数据库操作后，直接调用hotel-demo提供的接口</li>
</ol>
</li>
<li>但是这样存在一些问题<ol>
<li>耦合度太高，hotel-admin原本只需要将数据写入数据库，但现在写入数据库之后，还要调用hotel-demo提供的更新ES的接口，形成了业务耦合</li>
<li>性能差，例如原本的写入数据库只需要50ms，调用hotel-demo提供的更新ES的接口耗时150ms，那么总耗时就达到了0.2s，性能自然就下降了。且如果<code>1.2</code>和<code>1.3</code>发生了异常，那么整个业务也都出问题了</li>
</ol>
</li>
</ul>
<h3 id="异步通知"><a href="#异步通知" class="headerlink" title="异步通知"></a>异步通知</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSeSvY6.png" alt="img"></p>
<ul>
<li>流程如下<ol>
<li>hotel-admin对MySQL数库数据完成增删改后，发送MQ消息</li>
<li>hotel-demo监听MQ，接收到消息后完成ES数据修改</li>
</ol>
</li>
<li>这样就解除了业务间的耦合，也提高了性能，但是比较依赖于MQ的可靠性，并且引入了新的中间件，实现起来的复杂度有所上升</li>
</ul>
<h3 id="监听binlog"><a href="#监听binlog" class="headerlink" title="监听binlog"></a>监听binlog</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSeSxfK.png" alt="img"></p>
<ul>
<li>流程如下<ol>
<li>给mysql开启binlog功能</li>
<li>mysql完成增删改操作，都会记录在binlog中</li>
<li>hotel-demo基于canal监听binlog变化，实时更新ES中的内容</li>
</ol>
</li>
<li>相比较于异步通知来说，此种方式完全接触了耦合，既不用给MQ发消息，也不用调用hotel-demo提供的接口。但是由于要开启mysql的binlog功能，所以对mysql的压力很大，并且要引入新的中间件<code>canal</code>，实现起来比较复杂</li>
</ul>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><ul>
<li>同步调用<ul>
<li>优点：实现简单</li>
<li>缺点：业务耦合度高</li>
</ul>
</li>
<li>异步通知<ul>
<li>优点：低耦合，实现难度一般</li>
<li>缺点：依赖MQ的可靠性</li>
</ul>
</li>
<li>监听binlog<ul>
<li>优点：完全解除服务间的耦合</li>
<li>缺点：开启binlog增加数据库负担、实现复杂度高</li>
</ul>
</li>
</ul>
<h2 id="实现数据同步"><a href="#实现数据同步" class="headerlink" title="实现数据同步"></a>实现数据同步</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ul>
<li><p>使用黑马提供的hotel-admin项目作为酒店管理的微服务。</p>
</li>
<li><p>当酒店数据发生增删改时，要求对ES中的数据也完成相同的操作</p>
</li>
<li><p>需要注意的一点是，ES中新增数据和修改数据是同一个操作，因为在RestClient的API中，全量修改与新增的API完全一致，判断的依据是ID</p>
<ul>
<li>若新增时，ID已经存在，则修改(删除再新增)</li>
<li>若新增时，ID不存在，则新增</li>
</ul>
</li>
<li><p>实现思路如下</p>
<ol>
<li>导入黑马提供的hotel-admin，启动并测试酒店数据的CRUD</li>
<li>声明exchange、queue、RountingKey</li>
<li>在hotel-admin中的增删改业务中，完成消息发送</li>
<li>在hotel-demo中完成消息监听，并更新ES中数据</li>
<li>启动并测试数据同步功能</li>
</ol>
</li>
</ul>
<h3 id="导入demo"><a href="#导入demo" class="headerlink" title="导入demo"></a>导入demo</h3><ul>
<li>导入黑马提供的hotel-admin，修改application.yml配置文件，将数据库连接信息改成自己的，访问<a target="_blank" rel="noopener" href="http://localhost:8099/">http://localhost:8099/</a> 就能看到管理页面了</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSeVjDf.png" alt="img"></p>
<p>其中已经包含了酒店的CRUD功能</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveHotel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    hotelService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidParameterException</span><span class="token punctuation">(</span><span class="token string">"id不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    hotelService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    hotelService<span class="token punctuation">.</span><span class="token function">removeById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="声明交换机、队列"><a href="#声明交换机、队列" class="headerlink" title="声明交换机、队列"></a>声明交换机、队列</h3><ul>
<li>MQ结构如图</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSemQnx.png" alt="img"></p>
<ul>
<li>引入依赖<ul>
<li>使用RabbitMQ，我们首先要在hotel-demo和hotel-admin引入SpringAMQP的依赖</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-XML" data-language="XML"><code class="language-XML">&lt;!--amqp--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-amqp&lt;&#x2F;artifactId&gt;
&lt;&#x2F;dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>配置RabbitMQ的连接信息<ul>
<li>在hotel-demo和hotel-admin的application.yml文件中添加配置</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-YML" data-language="YML"><code class="language-YML">spring:
  rabbitmq:
    host: 192.168.96.128 # 主机名
    port: 5672 #端口
    username: root # 用户名
    password: root # 密码
    virtual-host: &#x2F; # 虚拟主机<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>声明交换机和队列名称<ul>
<li>在hotel-demo和hotel-admin的constants包下新建一个MqConstants类</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConstants</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
    * 交换机
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HOTEL_EXCHANGE <span class="token operator">=</span> <span class="token string">"hotel.topic"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
    * 监听新增和修改的队列
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HOTEL_INSERT_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.insert.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
    * 监听删除的队列
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HOTEL_DELETE_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.delete.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
    * 新增和修改的RoutingKey
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HOTEL_INSERT_KEY <span class="token operator">=</span> <span class="token string">"hotel.insert"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
    * 删除的RoutingKey
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> HOTEL_DELETE_KEY <span class="token operator">=</span> <span class="token string">"hotel.delete"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>声明交换机和队列<ul>
<li>在hotel-demo中，定义配置类，声明队列、交换机</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TopicExchange</span> <span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">insertQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deleteQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="发送MQ消息"><a href="#发送MQ消息" class="headerlink" title="发送MQ消息"></a>发送MQ消息</h3><ul>
<li>在hotel-admin中的增删改业务中，分别发送MQ消息</li>
<li>但是发送的消息MQ是会保存的，而MQ又是基于内存的，所以我们要发送的内容要尽可能的小<ul>
<li>因此不建议直接把整个hotel对象发送，太消耗内存了</li>
<li>只发送一个酒店id就足以满足需求了</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveHotel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        hotelService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">,</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidParameterException</span><span class="token punctuation">(</span><span class="token string">"id不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        hotelService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">,</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        hotelService<span class="token punctuation">.</span><span class="token function">removeById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_KEY<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="接收MQ消息"><a href="#接收MQ消息" class="headerlink" title="接收MQ消息"></a>接收MQ消息</h3><ul>
<li>hotel-demo接收到MQ消息要做的事情包括<ol>
<li>新增消息：根据传递的hotel的id查询hotel信息，然后新增一条数据到索引库(修改同理)</li>
<li>删除消息：根据传递的hotel的id删除索引库中的一条数据</li>
</ol>
</li>
<li>我们在mq包下新增一个类HotelListener</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelListener</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 监听酒店新增/修改业务
     * @param id 酒店的id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelInsertQueue</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        hotelService<span class="token punctuation">.</span><span class="token function">insertById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 监听酒店删除业务
     * @param id 酒店的id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelDeleteQueue</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        hotelService<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>然后在IHotelService中创建这两个方法</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IHotelService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hotel</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">void</span> <span class="token function">insertById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>并在HotelService中实现业务逻辑</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 根据id查询酒店数据</span>
        <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 转换为文档类型</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 准备Request对象</span>
        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 准备文档</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 发送请求</span>
        client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 准备Request对象</span>
        <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 发送请求</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>重启这两个服务，并测试</li>
</ul>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><ul>
<li>单机的ES做数据存储，必然会面临两个问题<ol>
<li>海量数据存储问题：将索引库从逻辑上拆分为N个分片(shard)，存储到多个节点</li>
<li>单点故障问题：将分片数据在不同节点备份(replica)</li>
</ol>
</li>
<li>ES集群相关概念<ul>
<li>集群(cluster)：一组拥有共同cluster name的节点</li>
<li>节点(node)：集群中的一个ES示例</li>
<li>分片(shard)：索引可以被拆分为不同的部分进行存储，称为分片。<ul>
<li>在集群环境下，一个索引的不同分片可以拆分到不同的节点中。</li>
<li>解决问题：数据量太大，单点存储有限的问题</li>
</ul>
</li>
<li>主分片(Primary shard)：相对于副本分片的定义</li>
<li>副本分片(Replica shard)：每个主分片都可以有一个或多个副本，数据与主分片一样</li>
</ul>
</li>
<li>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本太高了</li>
<li>为了在高可用和成本间寻求平衡，我们可以这样做<ol>
<li>首先对数据分片，存储到不同节点</li>
<li>然后对每个分片进行备份，放到对方节点，完成互相备份</li>
</ol>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8Cjg.png" alt="img" style="zoom:67%;" /></p>
<ul>
<li>现在，每个分片都有1个备份，存储在3个节点：<ul>
<li>node0：保存了分片0和1</li>
<li>node1：保存了分片0和2</li>
<li>node2：保存了分片1和2</li>
</ul>
</li>
</ul>
<h2 id="搭建ES集群"><a href="#搭建ES集群" class="headerlink" title="搭建ES集群"></a>搭建ES集群</h2><ul>
<li>部署es集群可以直接使用docker-compose来完成，不过虚拟机至少要有<code>4G</code>的内存空间（额我就不整了）</li>
<li>首先编写一个docker-compose文件</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">version: <span class="token string">'2.2'</span>
services:
  es01:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es01
    environment:
      - node.name<span class="token operator">=</span>es01
      - cluster.name<span class="token operator">=</span>es-docker-cluster
      - discovery.seed_hosts<span class="token operator">=</span>es02,es03
      - cluster.initial_master_nodes<span class="token operator">=</span>es01,es02,es03
      - bootstrap.memory_lock<span class="token operator">=</span>true
      - <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - <span class="token number">9200</span>:9200
    networks:
      - elastic
  es02:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es02
    environment:
      - node.name<span class="token operator">=</span>es02
      - cluster.name<span class="token operator">=</span>es-docker-cluster
      - discovery.seed_hosts<span class="token operator">=</span>es01,es03
      - cluster.initial_master_nodes<span class="token operator">=</span>es01,es02,es03
      - bootstrap.memory_lock<span class="token operator">=</span>true
      - <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data02:/usr/share/elasticsearch/data
	ports:
      - <span class="token number">9201</span>:9200
    networks:
      - elastic
  es03:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es03
    environment:
      - node.name<span class="token operator">=</span>es03
      - cluster.name<span class="token operator">=</span>es-docker-cluster
      - discovery.seed_hosts<span class="token operator">=</span>es01,es02
      - cluster.initial_master_nodes<span class="token operator">=</span>es01,es02,es03
      - bootstrap.memory_lock<span class="token operator">=</span>true
      - <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data03:/usr/share/elasticsearch/data
	ports:
      - <span class="token number">9202</span>:9200
    networks:
      - elastic

volumes:
  data01:
    driver: <span class="token builtin class-name">local</span>
  data02:
    driver: <span class="token builtin class-name">local</span>
  data03:
    driver: <span class="token builtin class-name">local</span>

networks:
  elastic:
    driver: bridge<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>运行docker-compose文件集群部署</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>索引库分片</li>
<li>cerobro</li>
</ul>
<h2 id="集群脑裂问题"><a href="#集群脑裂问题" class="headerlink" title="集群脑裂问题"></a>集群脑裂问题</h2><h3 id="集群职责划分"><a href="#集群职责划分" class="headerlink" title="集群职责划分"></a>集群职责划分</h3><ul>
<li>ES中集群节点有不同的职责划分</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">节点类型</th>
<th style="text-align:center">配置参数</th>
<th style="text-align:center">默认值</th>
<th style="text-align:center">节点职责</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">master eligible（备选/主节点）</td>
<td style="text-align:center">node.master</td>
<td style="text-align:center">true</td>
<td style="text-align:center">备选主节点:主节点可以管理和记录集群状态、决定分片在哪个节点、处理创建和删除索引库的请求</td>
</tr>
<tr>
<td style="text-align:center">data</td>
<td style="text-align:center">node.data</td>
<td style="text-align:center">true</td>
<td style="text-align:center">数据节点:存储数据、搜索、聚合、CRUD</td>
</tr>
<tr>
<td style="text-align:center">ingest</td>
<td style="text-align:center">node.ingest</td>
<td style="text-align:center">true</td>
<td style="text-align:center">数据存储之前的预处理</td>
</tr>
<tr>
<td style="text-align:center">coordinating（不做业务，路由加负载均衡加合并数据）</td>
<td style="text-align:center">上面3个参数都为false则为coordinating节点</td>
<td style="text-align:center">无</td>
<td style="text-align:center">路由请求到其它节点合并其它节点处理的结果，返回给用户</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>默认情况下，急群众的任何一个节点都同时具备上述四种角色</li>
<li>但真实的集群一定要将集群职责分离<ul>
<li>master节点：对CPU要求高，但是对内存要求低</li>
<li>data节点：对CPU和内存要求都高</li>
<li>coordinating节点：对网络带宽、CPU要求高</li>
</ul>
</li>
<li>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且可以避免业务之间的互相干扰</li>
<li>一个典型的ES集群职责划分如下图<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe8mCV.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8mCV.png" alt="img"></a></li>
</ul>
<h3 id="脑裂问题"><a href="#脑裂问题" class="headerlink" title="脑裂问题"></a>脑裂问题</h3><ul>
<li>脑裂是因为集群中的节点失联导致的。</li>
<li>例如一个集群中，主节点与其他节点失联<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe8RxS.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8RxS.png" alt="img"></a></li>
<li>此时node2和node3会认为node1宕机，就会重新选主<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe8fKg.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8fKg.png" alt="img"></a></li>
<li>当node3当选后，集群继续对外提供服务，node2和node3自成一个集群，node1自成一个集群。这两个集群数据不同步，出现数据差异</li>
<li>当网络恢复后，因为急群众有两个master节点，集群状态的不一致，会出现脑裂的情况<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe8HP0.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8HP0.png" alt="img"></a></li>
<li>解决脑裂的方案是，要求选品超过<code>( eligible节点数量 + 1 ）/ 2</code>才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</li>
<li>例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。</li>
</ul>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><ul>
<li>master eligible节点的作用是什么？<ul>
<li>参与集群选主</li>
<li>主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求</li>
</ul>
</li>
<li>data节点的作用是什么？<ul>
<li>数据的CRUD</li>
</ul>
</li>
<li>coordinating节点的作用是什么？<ul>
<li>路由请求到其他节点</li>
<li>合并查询到的结果，返回给用户</li>
</ul>
</li>
</ul>
<h2 id="集群分布式存储"><a href="#集群分布式存储" class="headerlink" title="集群分布式存储"></a>集群分布式存储</h2><ul>
<li><p>当新增文档时，应该保存到不同分片，保证数据均衡，那么coordinating node如何确定数据该存储到哪个分片呢？</p>
</li>
<li><p>ES会通过hash算法来计算文档应该存储到哪个分片</p>
<pre class="line-numbers language-PLAINTEXT" data-language="PLAINTEXT"><code class="language-PLAINTEXT">shard &#x3D; hash(_routing) % number_of_shards<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>说明：_routing默认是文档的id，算法与分片数量有关，因此索引库一旦创建，分片数量不能修改</p>
</li>
<li><p>新增文档的流程如下<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe80DH.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe80DH.png" alt="img"></a></p>
</li>
<li><p>解读</p>
</li>
<li><ol>
<li>新增一个id=1的文档</li>
</ol>
</li>
<li><ol>
<li>对id做hash运算，假如得到的是2，则应该存储到shard-2</li>
</ol>
</li>
<li><ol>
<li>shard-2的主分片在node3节点，将数据路由到node3</li>
</ol>
</li>
<li><ol>
<li>保存文档</li>
</ol>
</li>
<li><ol>
<li>同步给shard-2的副本replica-2，在node2节点</li>
</ol>
</li>
<li><ol>
<li>返回结果给coordinating-node节点</li>
</ol>
</li>
</ul>
<h2 id="集群分布式查询"><a href="#集群分布式查询" class="headerlink" title="集群分布式查询"></a>集群分布式查询</h2><ul>
<li>ES的查询分成两个阶段<ol>
<li>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</li>
<li>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe8Bbd.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8Bbd.png" alt="img"></a></li>
</ol>
</li>
</ul>
<h2 id="集群故障转移"><a href="#集群故障转移" class="headerlink" title="集群故障转移"></a>集群故障转移</h2><ul>
<li>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</li>
</ul>
<ol>
<li><p>例如一个集群结构如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8sUI.png" alt="img"></p>
<ul>
<li>现在，node1是主节点，其它两个节点是从节点。</li>
</ul>
</li>
<li><p>突然，node1发生了故障：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8y5t.png" alt="img"></p>
<ul>
<li>宕机后的第一件事，需要重新选主，例如选中了node2：<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe8g8f.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8g8f.png" alt="img"></a></li>
<li>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：<br><a target="_blank" rel="noopener" href="https://s1.ax1x.com/2023/01/09/pSe8228.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/pSe8228.png" alt="img"></a></li>
</ul>
</li>
</ol>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/04/13/leetcode%E5%B2%9B%E5%B1%BF%E7%B1%BB%E9%97%AE%E9%A2%98/" title="leetcode岛屿类问题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 355581 sample.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">leetcode岛屿类问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/12/ElasticSearch%E5%85%A5%E9%97%A8%E5%8F%8AJavaRestClient/" title="ElasticSearch入门及JavaRestClient"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 158839 animal bicycle bird book clouds hatsune_miku kneehighs school_uniform sky tears vocaloid xiayu93.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-12</div><div class="title">ElasticSearch入门及JavaRestClient</div></div></a></div><div><a href="/2022/10/11/ElasticSearch%E5%85%A5%E9%97%A8%E5%8F%8A%E7%AE%80%E5%8D%95DSL/" title="ElasticSearch入门及简单DSL"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 355526 sample.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-11</div><div class="title">ElasticSearch入门及简单DSL</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">taotaozi</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/differencer"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://blog.csdn.net/differencer?type=blog" target="_blank" title="Github"><i class="fab fa-CSDN"></i></a><a class="social-icon" href="https://space.bilibili.com/20713910" target="_blank" title="Bilibili"><i class="fab fa-bilibili"></i></a><a class="social-icon" href="/473439851" target="_blank" title="steam"><i class="fab fa-steam"></i></a><a class="social-icon" href="https://weibo.com/u/5856795355" target="_blank" title="Weibo"><i class="fab fa-weibo"></i></a><a class="social-icon" href="mailto:1359114644@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">最近的新任务是 ： 努力啊</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-text">数据聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-text">聚合的种类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DSL%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-text">DSL实现聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bucket%E8%81%9A%E5%90%88%E8%AF%AD%E6%B3%95"><span class="toc-text">Bucket聚合语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E7%BB%93%E6%9E%9C%E6%8E%92%E5%BA%8F"><span class="toc-text">聚合结果排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%AE%9A%E8%81%9A%E5%90%88%E8%8C%83%E5%9B%B4"><span class="toc-text">限定聚合范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metric%E8%81%9A%E5%90%88%E8%AF%AD%E6%B3%95"><span class="toc-text">Metric聚合语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RestAPI%E5%AE%9E%E7%8E%B0%E8%81%9A%E5%90%88"><span class="toc-text">RestAPI实现聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API%E8%AF%AD%E6%B3%95"><span class="toc-text">API语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E9%9C%80%E6%B1%82"><span class="toc-text">业务需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-text">业务实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-text">自动补全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E9%9F%B3%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">拼音分词器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">自定义分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%951"><span class="toc-text">测试1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%952%EF%BC%88%E5%90%8C%E9%9F%B3%E5%AD%97%EF%BC%89"><span class="toc-text">测试2（同音字）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E6%9F%A5%E8%AF%A2"><span class="toc-text">自动补全查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%85%92%E5%BA%97%E6%90%9C%E7%B4%A2%E6%A1%86%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-text">实现酒店搜索框自动补全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9hotel%E6%98%A0%E5%B0%84%E7%BB%93%E6%9E%84"><span class="toc-text">修改hotel映射结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9HotelDoc%E5%AE%9E%E4%BD%93"><span class="toc-text">修改HotelDoc实体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%AF%BC%E5%85%A5"><span class="toc-text">重新导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E6%9F%A5%E8%AF%A2%E7%9A%84API"><span class="toc-text">自动补全查询的API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%90%9C%E7%B4%A2%E6%A1%86%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-text">实现搜索框自动补全</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-text">数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-text">思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-text">同步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-text">异步通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%ACbinlog"><span class="toc-text">监听binlog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-text">实现数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5demo"><span class="toc-text">导入demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E4%BA%A4%E6%8D%A2%E6%9C%BA%E3%80%81%E9%98%9F%E5%88%97"><span class="toc-text">声明交换机、队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81MQ%E6%B6%88%E6%81%AF"><span class="toc-text">发送MQ消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6MQ%E6%B6%88%E6%81%AF"><span class="toc-text">接收MQ消息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-text">集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAES%E9%9B%86%E7%BE%A4"><span class="toc-text">搭建ES集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-text">集群脑裂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%81%8C%E8%B4%A3%E5%88%92%E5%88%86"><span class="toc-text">集群职责划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-text">脑裂问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-text">集群分布式存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E6%9F%A5%E8%AF%A2"><span class="toc-text">集群分布式查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">集群故障转移</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/12/ElasticSearch%E9%AB%98%E7%BA%A7%20%E8%81%9A%E5%90%88%20%E8%A1%A5%E5%85%A8%20%E9%9B%86%E7%BE%A4/" title="ElasticSearch高级 聚合 补全 集群"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 354273 sample.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ElasticSearch高级 聚合 补全 集群"/></a><div class="content"><a class="title" href="/2023/10/12/ElasticSearch%E9%AB%98%E7%BA%A7%20%E8%81%9A%E5%90%88%20%E8%A1%A5%E5%85%A8%20%E9%9B%86%E7%BE%A4/" title="ElasticSearch高级 聚合 补全 集群">ElasticSearch高级 聚合 补全 集群</a><time datetime="2023-10-12T09:05:52.000Z" title="发表于 2023-10-12 17:05:52">2023-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/13/leetcode%E5%B2%9B%E5%B1%BF%E7%B1%BB%E9%97%AE%E9%A2%98/" title="leetcode岛屿类问题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 355581 sample.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="leetcode岛屿类问题"/></a><div class="content"><a class="title" href="/2023/04/13/leetcode%E5%B2%9B%E5%B1%BF%E7%B1%BB%E9%97%AE%E9%A2%98/" title="leetcode岛屿类问题">leetcode岛屿类问题</a><time datetime="2023-04-13T13:41:13.000Z" title="发表于 2023-04-13 21:41:13">2023-04-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/08/hexo-butterfly-%E5%AE%9E%E9%AA%8C%E5%AE%A4/" title="hexo butterfly 实验室">hexo butterfly 实验室</a><time datetime="2023-04-08T13:29:08.000Z" title="发表于 2023-04-08 21:29:08">2023-04-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/08/HTTP-TCP-UDP-IP-%E5%8D%8F%E8%AE%AE-%E6%95%B0%E6%8D%AE%E5%A4%B4%E6%A0%BC%E5%BC%8F/" title="HTTP TCP UDP IP 协议 数据头格式（待写）">HTTP TCP UDP IP 协议 数据头格式（待写）</a><time datetime="2023-04-08T10:16:24.000Z" title="发表于 2023-04-08 18:16:24">2023-04-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/08/leetcode-%E5%AD%97%E7%AC%A6%E4%B8%B2-%E5%9B%9E%E6%96%87%E4%B8%B2%E4%B8%93%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/" title="leetcode 字符串 回文串专题(持续更新)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://differencer.oss-cn-beijing.aliyuncs.com/img/u=3639477684,2799207577&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="leetcode 字符串 回文串专题(持续更新)"/></a><div class="content"><a class="title" href="/2023/04/08/leetcode-%E5%AD%97%E7%AC%A6%E4%B8%B2-%E5%9B%9E%E6%96%87%E4%B8%B2%E4%B8%93%E9%A2%98-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/" title="leetcode 字符串 回文串专题(持续更新)">leetcode 字符串 回文串专题(持续更新)</a><time datetime="2023-04-08T09:07:06.000Z" title="发表于 2023-04-08 17:07:06">2023-04-08</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://differencer.oss-cn-beijing.aliyuncs.com/img/Konachan.com - 354273 sample.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By taotaozi</div><div class="footer_custom_text">世上最幸运的事就是喜欢上一个人</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'differencer/giscus',
    'data-repo-id': 'R_kgDOJMrL1A',
    'data-category-id': 'DIC_kwDOJMrL1M4CVC1y',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !false) {
  if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="富强,民主,文明,和谐" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>